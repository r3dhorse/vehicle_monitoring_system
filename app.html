<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Vehicle Monitoring System">
    <meta name="generator" content="Vehicle Monitoring System">
    <meta name="description" content="Professional Vehicle Monitoring and Management System">
    <base target="_top">
    <title>Vehicle Monitoring System</title>
    
    <!-- Preconnect to CDN for faster loading -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    
    <!-- Load CSS with media attribute for better performance -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" media="all">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" media="all">
    
    <style>
        /* CSS Reset and Performance Optimizations */
        * {
            box-sizing: border-box;
        }
        
        /* Optimize rendering performance */
        .vehicle-card, .btn, .modal {
            will-change: transform;
        }
        
        /* Mobile-first responsive design */
        @media (max-width: 767px) {
            .navbar-nav {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
                margin-top: 1rem;
            }
            
            .navbar-brand {
                font-size: 1rem;
            }
            
            .stats-card {
                margin-bottom: 1rem;
            }
            
            .vehicle-status-columns .col-lg-6 {
                margin-bottom: 1rem;
            }
            
            .vehicle-list {
                max-height: 400px;
            }
            
            .add-vehicle-btn {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
            }
            
            .login-card {
                margin: 1rem;
            }
            
            .modal-dialog {
                margin: 0.5rem;
            }
            
            .vehicle-info {
                font-size: 0.8rem;
            }
            
            .plate-number {
                font-size: 1rem;
            }
            
            /* Optimize form layouts for mobile */
            .row.mb-4 > div[class*="col-"] {
                margin-bottom: 1rem;
            }
            
            /* Touch-friendly button sizes */
            .btn {
                min-height: 44px;
                padding: 0.5rem 1rem;
            }
            
            .btn-sm {
                min-height: 36px;
            }
            
            /* Responsive table in modals */
            .table-responsive {
                font-size: 0.875rem;
            }
        }
        
        /* Tablet responsive adjustments */
        @media (min-width: 768px) and (max-width: 991px) {
            .vehicle-status-columns .col-lg-6 {
                margin-bottom: 1rem;
            }
        }
        
        /* Performance optimizations */
        img, svg, video {
            max-width: 100%;
            height: auto;
        }
        
        /* Reduce animations on low-power devices */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Touch device optimizations */
        .touch-device .vehicle-card {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .touch-active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        
        /* Loading state optimizations */
        .skeleton-loader {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Viewport height fix for mobile */
        .dashboard-page {
            min-height: 100vh;
            min-height: calc(var(--vh, 1vh) * 100);
        }
        
        /* Optimize modal for mobile */
        @media (max-width: 576px) {
            .modal-dialog {
                margin: 0;
                width: 100%;
                max-width: 100%;
                height: 100%;
            }
            
            .modal-content {
                height: 100%;
                border-radius: 0;
            }
            
            .modal-body {
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
        .login-page {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
        }
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .login-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px 20px 0 0;
            padding: 2rem 1.5rem 1.5rem;
            text-align: center;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        .alert { border-radius: 10px; border: none; }
        .hidden { display: none !important; }
        
        .dashboard-page { min-height: 100vh; background: #f8f9fa; }
        .navbar-brand { font-weight: 600; }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        .stats-card .card-body {
            position: relative;
            z-index: 2;
        }
        .stats-card::before {
            content: "";
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transform: rotate(45deg);
            transition: all 0.5s ease;
        }
        .stats-card:hover::before {
            top: -60%;
            right: -60%;
        }
        .stats-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 3rem;
            opacity: 0.3;
        }
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0;
            transition: all 0.3s ease;
        }
        .stats-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0;
        }
        .stats-percentage {
            font-size: 0.8rem;
            margin-top: 0.5rem;
            opacity: 0.8;
        }
        .stats-progress {
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            margin-top: 0.5rem;
            overflow: hidden;
        }
        .stats-progress-bar {
            height: 100%;
            background: rgba(255,255,255,0.8);
            border-radius: 2px;
            transition: width 1s ease;
        }
        
        @keyframes pulse-once {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .pulse-once {
            animation: pulse-once 0.6s ease-in-out;
        }
        
        /* Summary card styles */
        .summary-card {
            background: white;
            border: 1px solid #e3e6f0;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .summary-stats {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .summary-item {
            text-align: center;
            flex: 1;
            min-width: 100px;
        }
        
        .summary-item i {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }
        
        .summary-item .value {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }
        
        .summary-item .label {
            font-size: 0.75rem;
            color: #6c757d;
            margin: 0;
        }
        
        @media (max-width: 768px) {
            .stats-number {
                font-size: 2rem;
            }
            .stats-icon {
                font-size: 2rem;
                right: 15px;
            }
            .summary-stats {
                gap: 0.5rem;
            }
        }
        .vehicle-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            border: none;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid transparent;
            -webkit-tap-highlight-color: transparent;
        }
        .vehicle-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        @media (hover: none) {
            .vehicle-card:hover {
                transform: none;
            }
            .vehicle-card:active {
                transform: scale(0.98);
            }
        }
        .vehicle-card.status-in {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        .vehicle-card.status-out {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        .vehicle-card.access-banned {
            border: 3px solid #dc3545 !important;
            border-left: 4px solid #dc3545 !important;
        }
        .vehicle-card.access-no-access {
            border: 3px solid #fd7e14 !important;
            border-left: 4px solid #fd7e14 !important;
        }
        
        /* Transaction logs styles */
        .transaction-logs {
            border-top: 1px solid #dee2e6;
            background-color: #f8f9fa;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.85rem;
            min-height: 50px;
        }
        .transaction-logs::-webkit-scrollbar {
            width: 4px;
        }
        .transaction-logs::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .transaction-logs::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 2px;
        }
        .transaction-log-item {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.2s ease;
        }
        .transaction-log-item:hover {
            background-color: #e9ecef;
        }
        .transaction-log-item:last-child {
            border-bottom: none;
        }
        .log-timestamp {
            font-size: 0.75rem;
            color: #6c757d;
        }
        .log-action {
            font-weight: 600;
            display: inline-block;
            padding: 0.1rem 0.4rem;
            border-radius: 3px;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }
        .log-action.action-in {
            color: #155724;
            background-color: #d4edda;
        }
        .log-action.action-out {
            color: #721c24;
            background-color: #f8d7da;
        }
        .log-details {
            color: #495057;
            margin-top: 0.25rem;
            font-size: 0.8rem;
        }
        .logs-loading {
            text-align: center;
            padding: 1rem;
            color: #6c757d;
            font-size: 0.85rem;
        }
        .logs-empty {
            text-align: center;
            padding: 1rem;
            color: #6c757d;
            font-style: italic;
            font-size: 0.85rem;
        }
        .logs-header {
            padding: 0.5rem 0.75rem;
            background-color: #e9ecef;
            font-weight: 600;
            font-size: 0.85rem;
            color: #495057;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .logs-header:hover {
            background-color: #dee2e6;
        }
        .logs-toggle {
            cursor: pointer;
            user-select: none;
            font-size: 0.9rem;
        }
        
        .vehicle-status-columns .card {
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        /* Transaction logs table styles */
        #transactionLogsContainer {
            max-height: 600px;
            overflow-y: auto;
        }
        #transactionLogsContainer::-webkit-scrollbar {
            width: 6px;
        }
        #transactionLogsContainer::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        #transactionLogsContainer::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        #transactionLogsContainer::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .transaction-table th {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #dee2e6;
            background-color: #f8f9fa !important;
        }
        .transaction-table td {
            font-size: 0.85rem;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
        }
        .transaction-action {
            font-weight: 600;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
        }
        .transaction-action.action-in {
            color: #155724;
            background-color: #d4edda;
        }
        .transaction-action.action-out {
            color: #721c24;
            background-color: #f8d7da;
        }
        .transaction-time {
            color: #6c757d;
            font-size: 0.8rem;
        }
        .transaction-plate {
            font-weight: 600;
            color: #495057;
        }
        .transaction-driver {
            color: #6c757d;
        }
        .transaction-gate {
            color: #6c757d;
        }
        .vehicle-status-columns .card-header {
            font-weight: 600;
            border-bottom: none;
        }
        .vehicle-list {
            max-height: 600px;
            overflow-y: auto;
        }
        .vehicle-list::-webkit-scrollbar {
            width: 6px;
        }
        .vehicle-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .vehicle-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .vehicle-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .lazy-loading-indicator {
            padding: 20px;
            opacity: 0.7;
        }
        .vehicle-card {
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .vehicle-info {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .no-vehicles {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        .no-vehicles i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        .status-in { background-color: #28a745; color: white; }
        .status-out { background-color: #dc3545; color: white; }
        .loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .gate-selector {
            border-left: 3px solid #667eea;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        .gate-selector:focus {
            border-left-color: #764ba2;
            box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
        }
        .plate-number {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #2c3e50;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 4px 8px;
            border-radius: 6px;
            border: 2px solid #dee2e6;
            display: inline-block;
        }
        .vehicle-actions {
            display: flex;
            gap: 4px;
        }
        .vehicle-plate {
            flex: 1;
        }
        .add-vehicle-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
            display: none; /* Hidden by default */
        }
        .add-vehicle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6);
        }
        .role-badge {
            font-size: 0.8rem;
            padding: 4px 8px;
        }
        .role-badge.super-admin {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }
        .role-badge.admin {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        .role-badge.supervisor {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }
        .role-badge.security {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
        }
        .role-badge.user {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
        }
        .user-management-modal .modal-dialog {
            max-width: 900px;
        }
        .user-card {
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }
        .user-card.super-admin { border-left-color: #dc3545; }
        .user-card.admin { border-left-color: #28a745; }
        .user-card.supervisor { border-left-color: #ffc107; }
        .user-card.security { border-left-color: #17a2b8; }
        .user-card.user { border-left-color: #6c757d; }
        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .permission-item {
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        /* Vehicle Management Enhancements */
        .table-responsive {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .table-responsive::-webkit-scrollbar {
            width: 6px;
        }
        
        .table-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-5">
                    <div class="login-card">
                        <div class="login-header">
                            <i class="bi bi-truck fs-1 mb-3"></i>
                            <h1 class="h3 mb-0">Vehicle Monitoring System</h1>
                            <p class="mb-0 mt-2 opacity-75">Sign in to your account</p>
                        </div>
                        
                        <div class="p-4">
                            <div id="loginMsg" class="mb-3"></div>
                            
                            <form onsubmit="event.preventDefault(); login();">
                                <div class="mb-3">
                                    <label class="form-label" for="username">
                                        <i class="bi bi-person me-2"></i>Username
                                    </label>
                                    <input type="text" class="form-control" id="username" required>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="form-label" for="password">
                                        <i class="bi bi-lock me-2"></i>Password
                                    </label>
                                    <input type="password" class="form-control" id="password" required>
                                </div>
                                
                                <button type="submit" id="loginBtn" class="btn btn-primary w-100">
                                    <i class="bi bi-box-arrow-in-right me-2"></i>Sign In
                                </button>
                            </form>
                            
                            <!-- <div class="text-center mt-4">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Default admin: admin / admin123
                                </small>
                            </div> -->

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="dashboard-page hidden">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <i class="bi bi-truck me-2"></i><span class="d-none d-sm-inline">Vehicle Monitoring System</span><span class="d-inline d-sm-none">VMS</span>
                </a>
                  <span class="navbar-text me-3">
                      <i class="bi bi-person-circle me-1"></i>
                      <span id="userRole" class="badge role-badge"></span>
                      <small class="text-light ms-1">(<span id="currentUsername"></span>)</small>
                  </span>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarContent">
                    <div class="navbar-nav ms-auto">
                    <button class="btn btn-outline-light btn-sm me-3" id="vehicleManagementBtn" style="display: none;" onclick="showVehicleManagement()">
                        <i class="bi bi-truck me-1"></i>Manage Vehicles
                    </button>
                    <button class="btn btn-outline-light btn-sm me-3" id="gateManagementBtn" style="display: none;" onclick="showGateManagement()">
                        <i class="bi bi-door-open me-1"></i>Manage Gates
                    </button>
                    <div class="dropdown me-3" id="userManagementDropdown" style="display: none;">
                        <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-people me-1"></i>Users
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="showUserManagement()">
                                <i class="bi bi-person-gear me-2"></i>Manage Users
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="showRoleSettings()">
                                <i class="bi bi-shield-check me-2"></i>Role Settings
                            </a></li>
                        </ul>
                    </div>
                   
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">
                        <i class="bi bi-box-arrow-right me-1"></i>Logout
                    </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container-fluid py-4">
            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <div class="card stats-card">
                        <div class="card-body">
                            <i class="bi bi-truck stats-icon"></i>
                            <h3 class="stats-number" id="totalVehicles">0</h3>
                            <p class="stats-label">Total Vehicles</p>
                            <div class="stats-percentage" id="totalVehiclesChange">
                                <i class="bi bi-dash"></i> Registered
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card stats-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                        <div class="card-body">
                            <i class="bi bi-arrow-down-circle stats-icon"></i>
                            <h3 class="stats-number" id="vehiclesIn">0</h3>
                            <p class="stats-label">Vehicles In</p>
                            <div class="stats-percentage" id="vehiclesInPercentage">
                                <i class="bi bi-percent"></i> <span>0%</span> of total
                            </div>
                            <div class="stats-progress">
                                <div class="stats-progress-bar" id="vehiclesInProgress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card stats-card" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                        <div class="card-body">
                            <i class="bi bi-arrow-up-circle stats-icon"></i>
                            <h3 class="stats-number" id="vehiclesOut">0</h3>
                            <p class="stats-label">Vehicles Out</p>
                            <div class="stats-percentage" id="vehiclesOutPercentage">
                                <i class="bi bi-percent"></i> <span>0%</span> of total
                            </div>
                            <div class="stats-progress">
                                <div class="stats-progress-bar" id="vehiclesOutProgress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Summary Card -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="summary-card">
                        <div class="summary-stats">
                            <div class="summary-item">
                                <i class="bi bi-activity text-primary"></i>
                                <p class="value" id="occupancyRate">0%</p>
                                <p class="label">Occupancy Rate</p>
                            </div>
                            <div class="summary-item">
                                <i class="bi bi-clock-history text-info"></i>
                                <p class="value" id="lastUpdate">Just now</p>
                                <p class="label">Last Update</p>
                            </div>
                            <div class="summary-item">
                                <i class="bi bi-geo-alt-fill text-warning"></i>
                                <p class="value" id="activeGateDisplay">-</p>
                                <p class="label">Active Gate</p>
                            </div>
                            <div class="summary-item">
                                <i class="bi bi-arrow-left-right text-secondary"></i>
                                <p class="value" id="recentActivity">0</p>
                                <p class="label">Today's Activity</p>
                            </div>
                            <div class="summary-item">
                                <i class="bi bi-check-circle-fill text-success"></i>
                                <p class="value" id="accessCount">0</p>
                                <p class="label">Access Allowed</p>
                            </div>
                            <div class="summary-item">
                                <i class="bi bi-exclamation-triangle-fill text-warning"></i>
                                <p class="value" id="noAccessCount">0</p>
                                <p class="label">No Access</p>
                            </div>
                            <div class="summary-item">
                                <i class="bi bi-x-circle-fill text-danger"></i>
                                <p class="value" id="bannedCount">0</p>
                                <p class="label">Banned</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="row mb-4">
                <div class="col-12 col-md-3 mb-2 mb-md-0">
                    <label class="form-label mb-1 d-none d-md-block">
                        <small><i class="bi bi-search me-1"></i>Search by:</small>
                    </label>
                    <input type="text" class="form-control" id="searchInput" 
                           placeholder="Search vehicles..." 
                           onkeyup="debounceFilter()">
                </div>
                <div class="col-6 col-md-2 mb-2 mb-md-0">
                    <label class="form-label mb-1 d-none d-md-block">
                        <small><i class="bi bi-filter me-1"></i>Status:</small>
                    </label>
                    <select class="form-select" id="filterStatus" onchange="filterVehicles()">
                        <option value="">All Vehicles</option>
                        <option value="IN">🟢 Checked IN</option>
                        <option value="OUT">🔴 Checked OUT</option>
                    </select>
                </div>
                <div class="col-6 col-md-3 mb-2 mb-md-0">
                    <label class="form-label mb-1 d-none d-md-block">
                        <small><i class="bi bi-geo-alt me-1"></i>Gate:</small>
                    </label>
                    <div class="input-group">
                        <select class="form-select gate-selector" id="gateSelector">
                            <option value="">Loading...</option>
                        </select>
                        <button class="btn btn-outline-secondary" type="button" onclick="refreshGateSelector()" title="Refresh gates">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                </div>
                <div class="col-12 col-md-4 text-center text-md-end mt-2 mt-md-0 d-flex align-items-end justify-content-center justify-content-md-end gap-2">
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()" title="Clear all filters">
                        <i class="bi bi-x-circle me-1"></i><span class="d-none d-lg-inline">Clear</span>
                    </button>
                    <button class="btn btn-primary" onclick="refreshDashboard()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                    </button>
                </div>
            </div>

            <!-- Vehicle Cards and Transaction Logs -->
            <div class="row vehicle-status-columns">
                <!-- Transaction Logs Column -->
                <div class="col-lg-4">
                    <div class="card h-100">
                        <div class="card-header bg-info text-white">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-clock-history me-2"></i>
                                    Recent Transactions
                                    <span class="badge bg-light text-info ms-2" id="transactionLogsBadge">0</span>
                                </h5>
                                <button class="btn btn-outline-light btn-sm" onclick="loadRecentTransactionLogs()" title="Refresh Transactions">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div id="transactionLogsContainer">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th scope="col" style="width: 15%;">Time</th>
                                                <th scope="col" style="width: 20%;">Plate</th>
                                                <th scope="col" style="width: 20%;">Driver</th>
                                                <th scope="col" style="width: 20%;">Gate</th>
                                                <th scope="col" style="width: 25%;">Transaction</th>
                                            </tr>
                                        </thead>
                                        <tbody id="transactionLogsTableBody">
                                            <tr>
                                                <td colspan="5" class="text-center py-4">
                                                    <div class="spinner-border text-info" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <p class="mt-2 text-muted mb-0">Loading transactions...</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vehicles IN Column -->
                <div class="col-lg-4">
                    <div class="card h-100">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-arrow-down-circle me-2"></i>
                                Vehicles IN
                                <span class="badge bg-light text-success ms-2" id="vehiclesInBadge">0</span>
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div id="vehiclesInContainer" class="p-3">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-success" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Loading vehicles...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vehicles OUT Column -->
                <div class="col-lg-4">
                    <div class="card h-100">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-arrow-up-circle me-2"></i>
                                Vehicles OUT
                                <span class="badge bg-light text-danger ms-2" id="vehiclesOutBadge">0</span>
                            </h5>
                        </div>
                        <div class="card-body p-0">
                            <div id="vehiclesOutContainer" class="p-3">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-danger" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Loading vehicles...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner hidden">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Add Vehicle Button -->
    <button class="btn btn-primary add-vehicle-btn" onclick="showVehicleManagement()" title="Manage Vehicles" id="addVehicleBtn">
        <i class="bi bi-plus-lg fs-4"></i>
    </button>


    <!-- Vehicle Details Modal -->
    <div class="modal fade" id="vehicleDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailsModalTitle">Vehicle Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailsModalBody">
                    <!-- Details will be loaded here -->
                </div>
                <div class="modal-footer" id="detailsModalFooter">
                    <!-- Action buttons will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Vehicle Modal -->
    <div class="modal fade" id="editVehicleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil-square me-2"></i>Edit Vehicle
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editVehicleForm">
                        <input type="hidden" id="editVehicleIndex">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Plate Number <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editPlateNumber" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Make/Model <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editModel" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Color</label>
                                    <input type="text" class="form-control" id="editColor">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Year</label>
                                    <input type="number" class="form-control" id="editYear" min="1900" max="2030">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Type</label>
                                    <select class="form-select" id="editType">
                                        <option value="Car">Car</option>
                                        <option value="Truck">Truck</option>
                                        <option value="Van">Van</option>
                                        <option value="Motorcycle">Motorcycle</option>
                                        <option value="Bus">Bus</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Department/Company</label>
                                    <input type="text" class="form-control" id="editDepartment">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Current Driver</label>
                                    <select class="form-select" id="editDriver">
                                        <option value="">Select a driver...</option>
                                        <!-- Options will be loaded dynamically -->
                                    </select>
                                    <div class="form-text">Currently assigned driver</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Assigned Drivers</label>
                                    <input type="text" class="form-control" id="editAssignedDrivers" placeholder="Comma separated IDs">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Access Status</label>
                                    <select class="form-select" id="editAccessStatus">
                                        <option value="Access">Access</option>
                                        <option value="No Access">No Access</option>
                                        <option value="Banned">Banned</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="editStatus">
                                        <option value="OUT">Checked Out</option>
                                        <option value="IN">Checked In</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="saveVehicleEdit()">
                        <i class="bi bi-check-lg me-2"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- User Management Modal -->
    <div class="modal fade user-management-modal" id="userManagementModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-people me-2"></i>User Management
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Manage Users</h6>
                        <button class="btn btn-primary btn-sm" onclick="showAddUserForm()">
                            <i class="bi bi-plus-lg me-1"></i>Add User
                        </button>
                    </div>
                    
                    <!-- Add/Edit Form -->
                    <div id="userForm" class="mb-3" style="display: none;">
                        <div class="card">
                            <div class="card-body">
                                <h6 id="userFormTitle">Add New User</h6>
                                <form id="addEditUserForm">
                                    <input type="hidden" id="editUserIndex" value="-1">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="userUsername" class="form-label">Username *</label>
                                                <input type="text" class="form-control" id="userUsername" required 
                                                       placeholder="e.g., john_doe">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="userRole" class="form-label">Role *</label>
                                                <select class="form-select" id="userRole" required>
                                                    <option value="user">User</option>
                                                    <option value="security">Security</option>
                                                    <option value="supervisor">Supervisor</option>
                                                    <option value="admin">Admin</option>
                                                    <option value="super-admin">Super Admin</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-primary" onclick="saveUser()">
                                            <i class="bi bi-check-lg me-1"></i>Save
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="cancelUserForm()">
                                            Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- User List -->
                    <div id="userListContainer">
                        <div class="text-center py-3">
                            <div class="spinner-border" role="status"></div>
                            <p class="mt-2 text-muted">Loading users...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Role Settings Modal -->
    <div class="modal fade" id="roleSettingsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="bi bi-shield-check me-2"></i>Role Settings & Permissions
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-12 mb-4">
                            <h6>Role Hierarchy & Permissions</h6>
                            <div class="permissions-grid">
                                <div class="permission-item">
                                    <div class="role-badge super-admin mb-2">Super Admin</div>
                                    <small>
                                        • Full system access<br>
                                        • Manage all users<br>
                                        • System configuration<br>
                                        • All vehicle operations
                                    </small>
                                </div>
                                <div class="permission-item">
                                    <div class="role-badge admin mb-2">Admin</div>
                                    <small>
                                        • Manage vehicles<br>
                                        • Manage drivers<br>
                                        • View all reports<br>
                                        • Manage regular users
                                    </small>
                                </div>
                                <div class="permission-item">
                                    <div class="role-badge supervisor mb-2">Supervisor</div>
                                    <small>
                                        • View all vehicles<br>
                                        • Generate reports<br>
                                        • Check in/out vehicles<br>
                                        • View activity logs
                                    </small>
                                </div>
                                <div class="permission-item">
                                    <div class="role-badge security mb-2">Security</div>
                                    <small>
                                        • Check in/out vehicles<br>
                                        • View vehicle status<br>
                                        • Basic gate operations<br>
                                        • View assigned areas
                                    </small>
                                </div>
                                <div class="permission-item">
                                    <div class="role-badge user mb-2">User</div>
                                    <small>
                                        • View own vehicles<br>
                                        • Basic check in/out<br>
                                        • View personal logs<br>
                                        • Limited access
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gate Management Modal -->
    <div class="modal fade" id="gateManagementModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-door-open me-2"></i>Gate Management
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Manage Gates</h6>
                        <button class="btn btn-primary btn-sm" onclick="showAddGateForm()">
                            <i class="bi bi-plus-lg me-1"></i>Add Gate
                        </button>
                    </div>
                    
                    <!-- Add/Edit Form -->
                    <div id="gateForm" class="mb-3" style="display: none;">
                        <div class="card">
                            <div class="card-body">
                                <h6 id="gateFormTitle">Add New Gate</h6>
                                <form id="addEditGateForm">
                                    <input type="hidden" id="editGateIndex" value="-1">
                                    <div class="mb-3">
                                        <label for="gateName" class="form-label">Gate Name *</label>
                                        <input type="text" class="form-control" id="gateName" required 
                                               placeholder="e.g., Main Gate">
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-primary" onclick="saveGate()">
                                            <i class="bi bi-check-lg me-1"></i>Save
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="cancelGateForm()">
                                            Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gate List -->
                    <div id="gateListContainer">
                        <div class="text-center py-3">
                            <div class="spinner-border" role="status"></div>
                            <p class="mt-2 text-muted">Loading gates...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vehicle Management Modal -->
    <div class="modal fade" id="vehicleManagementModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-truck me-2"></i>Vehicle Management
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6 class="mb-3">Add New Vehicle</h6>
                    
                    <!-- Add Vehicle Form -->
                    <form id="addVehicleForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vehiclePlateNumber" class="form-label">Plate Number *</label>
                                    <input type="text" class="form-control" id="vehiclePlateNumber" required 
                                           placeholder="e.g., ABC-123">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vehicleModel" class="form-label">Make/Model *</label>
                                    <input type="text" class="form-control" id="vehicleModel" required 
                                           placeholder="e.g., Toyota Camry">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vehicleColor" class="form-label">Color</label>
                                    <input type="text" class="form-control" id="vehicleColor" 
                                           placeholder="e.g., White">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vehicleDepartment" class="form-label">Department/Company</label>
                                    <input type="text" class="form-control" id="vehicleDepartment" 
                                           placeholder="e.g., IT Department">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="vehicleYear" class="form-label">Year</label>
                                    <input type="number" class="form-control" id="vehicleYear" 
                                           placeholder="2023" min="1900" max="2030">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="vehicleType" class="form-label">Type</label>
                                    <select class="form-select" id="vehicleType">
                                        <option value="Car">Car</option>
                                        <option value="Truck">Truck</option>
                                        <option value="Van">Van</option>
                                        <option value="SUV">SUV</option>
                                        <option value="Motorcycle">Motorcycle</option>
                                        <option value="Bus">Bus</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="vehicleStatus" class="form-label">Status</label>
                                    <select class="form-select" id="vehicleStatus">
                                        <option value="OUT">OUT</option>
                                        <option value="IN">IN</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vehicleDriver" class="form-label">Current Driver</label>
                                    <input type="text" class="form-control" id="vehicleDriver" 
                                           placeholder="Driver name or ID">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vehicleAccessStatus" class="form-label">Access Status</label>
                                    <select class="form-select" id="vehicleAccessStatus">
                                        <option value="Access">Access</option>
                                        <option value="No Access">No Access</option>
                                        <option value="Banned">Banned</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="vehicleAssignedDrivers" class="form-label">Assigned Drivers</label>
                            <input type="text" class="form-control" id="vehicleAssignedDrivers" 
                                   placeholder="Comma-separated driver names or IDs">
                            <small class="text-muted">Enter multiple drivers separated by commas</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveVehicle()">
                        <i class="bi bi-check-lg me-2"></i>Add Vehicle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

    <!-- Load scripts with defer for better performance -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
    <script>
        let currentUser = null;
        let vehicleData = [];
        let allVehicles = [];
        
        // Lazy loading configuration
        const VEHICLES_PER_BATCH = window.innerWidth <= 768 ? 5 : 10; // Smaller batch for mobile
        let vehiclesInIndex = 0;
        let vehiclesOutIndex = 0;
        let isLoadingMore = false;
        let vehiclesInObserver = null;
        let vehiclesOutObserver = null;
        let filterTimeout = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Application starting...');
            
            // Check for existing session first
            checkExistingSession();
            
            // Preload critical resources
            preloadResources();
        });
        
        function checkExistingSession() {
            // Check if user session exists in sessionStorage
            const storedUser = sessionStorage.getItem('currentUser');
            
            if (storedUser) {
                try {
                    currentUser = JSON.parse(storedUser);
                    console.log('Restored user session:', currentUser.username);
                    showDashboard();
                    return;
                } catch (error) {
                    console.error('Error parsing stored user session:', error);
                    // Clear invalid session data
                    sessionStorage.removeItem('currentUser');
                }
            }
            
            // No valid session found, show login page
            showLoginPage();
        }

        function saveSession() {
            // Save current user session to sessionStorage
            if (currentUser) {
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            }
        }

        function clearSession() {
            // Clear user session from storage
            sessionStorage.removeItem('currentUser');
            sessionStorage.removeItem('selectedGate');
            sessionStorage.removeItem('todayActivity');
        }

        function preloadResources() {
            // Preload images and icons that will be used
            const imagesToPreload = [
                'bi-truck', 'bi-arrow-down-circle', 'bi-arrow-up-circle',
                'bi-person-fill', 'bi-people-fill', 'bi-building'
            ];
            
            // Create a hidden div to trigger icon font loading
            const preloadDiv = document.createElement('div');
            preloadDiv.style.position = 'absolute';
            preloadDiv.style.left = '-9999px';
            preloadDiv.style.visibility = 'hidden';
            
            imagesToPreload.forEach(icon => {
                const i = document.createElement('i');
                i.className = `bi ${icon}`;
                preloadDiv.appendChild(i);
            });
            
            document.body.appendChild(preloadDiv);
            
            // Remove after a short delay
            setTimeout(() => preloadDiv.remove(), 100);
        }

        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('dashboardPage').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('dashboardPage').classList.remove('hidden');
            
            // Update user role display
            const roleElement = document.getElementById('userRole');
            const usernameElement = document.getElementById('currentUsername');
            roleElement.textContent = currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1);
            roleElement.className = `badge role-badge ${currentUser.role}`;
            usernameElement.textContent = currentUser.username;
            
            // Show/hide features based on role permissions
            updateUIBasedOnRole();
            
            loadVehicles();
            loadActiveGates();
            
            // Setup scroll listeners for manual scroll-based loading as fallback
            setupScrollListeners();
            
            // Optimize for mobile
            optimizeForMobile();
            
            // Initialize filter UI
            initializeFilterUI();
        }

        function updateUIBasedOnRole() {
            const role = currentUser.role;
            
            // Show/hide add vehicle button
            const addVehicleBtn = document.getElementById('addVehicleBtn');
            if (hasPermission('manage_vehicles')) {
                addVehicleBtn.style.display = 'block';
            } else {
                addVehicleBtn.style.display = 'none';
            }
            
            // Show/hide user management dropdown
            const userManagementDropdown = document.getElementById('userManagementDropdown');
            if (hasPermission('manage_users')) {
                userManagementDropdown.style.display = 'block';
            } else {
                userManagementDropdown.style.display = 'none';
            }
            
            // Show/hide vehicle management button
            const vehicleManagementBtn = document.getElementById('vehicleManagementBtn');
            if (hasPermission('manage_vehicles')) {
                vehicleManagementBtn.style.display = 'inline-block';
            } else {
                vehicleManagementBtn.style.display = 'none';
            }
            
            
            // Show/hide gate management button
            const gateManagementBtn = document.getElementById('gateManagementBtn');
            if (hasPermission('manage_gates')) {
                gateManagementBtn.style.display = 'inline-block';
            } else {
                gateManagementBtn.style.display = 'none';
            }
        }

        function hasPermission(permission) {
            const role = currentUser.role;
            const permissions = {
                'super-admin': ['manage_users', 'manage_vehicles', 'manage_drivers', 'manage_gates', 'view_all', 'system_config'],
                'admin': ['manage_vehicles', 'manage_drivers', 'manage_gates', 'view_all', 'manage_regular_users'],
                'supervisor': ['view_all', 'vehicle_operations', 'manage_gates', 'generate_reports'],
                'security': ['vehicle_operations', 'gate_operations', 'view_assigned'],
                'user': ['view_own', 'basic_operations']
            };
            
            return permissions[role]?.includes(permission) || false;
        }

        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            
            if (!username || !password) {
                showMessage('Please enter both username and password', 'danger');
                return;
            }

            loginBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Signing in...';
            loginBtn.disabled = true;

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        currentUser = { username: username, role: result.role };
                        saveSession(); // Save session to prevent logout on refresh
                        showMessage('Login successful!', 'success');
                        setTimeout(() => {
                            showDashboard();
                        }, 1000);
                    } else {
                        showMessage('Invalid username or password', 'danger');
                        resetLoginForm();
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Login error:', error);
                    showMessage('Login failed. Please try again.', 'danger');
                    resetLoginForm();
                })
                .loginUser(username, password);
        }

        function resetLoginForm() {
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.innerHTML = '<i class="bi bi-box-arrow-in-right me-2"></i>Sign In';
            loginBtn.disabled = false;
            document.getElementById('password').value = '';
        }

        function loadVehicles() {
            showLoading(true);
            const startTime = performance.now();
            
            // Clear logs cache on refresh
            vehicleLogsCache = {};
            logsLoadingState = {};
            
            // Load vehicles only - transactions removed for better performance
            google.script.run
                .withSuccessHandler(function(vehicles) {
                    const loadTime = performance.now() - startTime;
                    console.log(`Vehicles loaded: ${vehicles.length} in ${loadTime.toFixed(2)}ms`);
                    
                    allVehicles = vehicles || [];
                    vehicleData = allVehicles;
                    
                    // Display vehicles
                    displayVehicles();
                    updateStatistics();
                    showLoading(false);
                    
                    // Load transaction logs and preload vehicle logs for better UX
                    setTimeout(() => {
                        loadRecentTransactionLogs();
                        testTransactionLogsFunction();
                        preloadAllVehicleLogs();
                    }, 500);
                    
                    // Enhanced performance monitoring with actionable insights
                    if (loadTime > 3000) {
                        console.warn('%c⚠️ Performance Alert', 'color: #ffc107; font-weight: bold;',
                            `\n📈 Load Time: ${(loadTime / 1000).toFixed(2)}s (Target: <3s)`
                            + `\n📊 Vehicle Count: ${vehicles.length} records loaded`
                            + '\n🔧 Recommendations:'
                            + '\n   • Enable server-side pagination for large datasets'
                            + '\n   • Consider implementing virtual scrolling'
                            + '\n   • Check network connection stability'
                            + '\n   • Contact administrator if issue persists'
                            + '\n💡 Current system uses lazy loading to improve user experience');
                        
                        // Show user-friendly notification for very slow loads
                        if (loadTime > 5000) {
                            showToast('Large dataset detected. Consider refreshing if loading seems slow.', 'info');
                        }
                    } else {
                        console.log(`%c✅ Performance Good`, 'color: #28a745; font-weight: bold;', `Load time: ${(loadTime / 1000).toFixed(2)}s`);
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading vehicles:', error);
                    showToast('Failed to load vehicles: ' + error, 'danger');
                    showLoading(false);
                    
                    // Show retry option for network errors
                    if (error.toString().includes('NetworkError')) {
                        setTimeout(() => {
                            if (confirm('Network error detected. Would you like to retry?')) {
                                loadVehicles();
                            }
                        }, 1000);
                    }
                })
                .getVehicleList();
        }

        function displayVehicles() {
            const vehiclesInContainer = document.getElementById('vehiclesInContainer');
            const vehiclesOutContainer = document.getElementById('vehiclesOutContainer');
            
            // Disconnect existing observers
            if (vehiclesInObserver) vehiclesInObserver.disconnect();
            if (vehiclesOutObserver) vehiclesOutObserver.disconnect();
            
            // Clear containers
            vehiclesInContainer.innerHTML = '';
            vehiclesOutContainer.innerHTML = '';
            
            // Reset indices
            vehiclesInIndex = 0;
            vehiclesOutIndex = 0;

            if (vehicleData.length <= 1) {
                vehiclesInContainer.innerHTML = `
                    <div class="no-vehicles">
                        <i class="bi bi-truck"></i>
                        <p>No vehicles checked in</p>
                    </div>
                `;
                vehiclesOutContainer.innerHTML = `
                    <div class="no-vehicles">
                        <i class="bi bi-truck"></i>
                        <p>No vehicles checked out</p>
                    </div>
                `;
                return;
            }

            // Separate and store vehicles globally for lazy loading
            window.vehiclesInArray = [];
            window.vehiclesOutArray = [];

            // Separate vehicles by status
            for (let i = 1; i < vehicleData.length; i++) {
                const vehicle = vehicleData[i];
                if (!vehicle || vehicle.length < 7) continue;

                const plateNumber = vehicle[0] || '';
                const model = vehicle[1] || '';
                const status = vehicle[6] || 'OUT';
                const driver = vehicle[7] || 'Unassigned';

                const vehicleData_item = { plateNumber, model, status, driver, index: i };

                if (status === 'IN') {
                    window.vehiclesInArray.push(vehicleData_item);
                } else {
                    window.vehiclesOutArray.push(vehicleData_item);
                }
            }

            // Display vehicles with lazy loading
            if (window.vehiclesInArray.length === 0) {
                vehiclesInContainer.innerHTML = `
                    <div class="no-vehicles">
                        <i class="bi bi-truck"></i>
                        <p>No vehicles checked in</p>
                    </div>
                `;
            } else {
                vehiclesInContainer.innerHTML = '<div class="vehicle-list" id="vehiclesInList"></div>';
                loadMoreVehicles('in');
                setupIntersectionObserver('in');
            }

            if (window.vehiclesOutArray.length === 0) {
                vehiclesOutContainer.innerHTML = `
                    <div class="no-vehicles">
                        <i class="bi bi-truck"></i>
                        <p>No vehicles checked out</p>
                    </div>
                `;
            } else {
                vehiclesOutContainer.innerHTML = '<div class="vehicle-list" id="vehiclesOutList"></div>';
                loadMoreVehicles('out');
                setupIntersectionObserver('out');
            }

            // Update badge counts with total counts
            document.getElementById('vehiclesInBadge').textContent = window.vehiclesInArray.length;
            document.getElementById('vehiclesOutBadge').textContent = window.vehiclesOutArray.length;
        }

        function createVehicleListItem(plateNumber, model, status, driver, index) {
            const item = document.createElement('div');
            
            // Get vehicle details for enhanced display
            const vehicle = vehicleData[index];
            const color = vehicle[2] || 'Unknown';
            const department = vehicle[3] || 'Unknown';
            const year = vehicle[4] || '';
            const type = vehicle[5] || 'Car';
            const assignedDrivers = vehicle[8] || '';
            const accessStatus = vehicle[9] || 'Access';
            
            // Build CSS classes including access status
            let cssClasses = `card vehicle-card status-${status.toLowerCase()}`;
            if (accessStatus === 'Banned') {
                cssClasses += ' access-banned';
            } else if (accessStatus === 'No Access') {
                cssClasses += ' access-no-access';
            }
            
            item.className = cssClasses;

            // Get appropriate icon for vehicle type
            let typeIcon = 'bi-truck';
            let typeColor = 'text-secondary';
            switch(type.toLowerCase()) {
                case 'car':
                    typeIcon = 'bi-car-front-fill';
                    typeColor = 'text-primary';
                    break;
                case 'truck':
                    typeIcon = 'bi-truck';
                    typeColor = 'text-danger';
                    break;
                case 'van':
                    typeIcon = 'bi-minecart';
                    typeColor = 'text-info';
                    break;
                case 'suv':
                    typeIcon = 'bi-car-front';
                    typeColor = 'text-success';
                    break;
                case 'motorcycle':
                    typeIcon = 'bi-bicycle';
                    typeColor = 'text-warning';
                    break;
                case 'bus':
                    typeIcon = 'bi-bus-front-fill';
                    typeColor = 'text-purple';
                    break;
                default:
                    typeIcon = 'bi-truck';
                    typeColor = 'text-secondary';
            }

            // Format assigned drivers display
            let assignedDriversDisplay = '';
            if (assignedDrivers && assignedDrivers.trim()) {
                const drivers = assignedDrivers.split(',').map(d => d.trim()).filter(d => d);
                if (drivers.length > 0) {
                    if (drivers.length === 1) {
                        assignedDriversDisplay = drivers[0];
                    } else if (drivers.length <= 3) {
                        assignedDriversDisplay = drivers.join(', ');
                    } else {
                        assignedDriversDisplay = `${drivers.slice(0, 2).join(', ')} +${drivers.length - 2} more`;
                    }
                }
            }


            item.innerHTML = `
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="vehicle-plate">
                            <h5 class="plate-number mb-1">${plateNumber}</h5>
                            <small class="text-muted">${year} ${color}</small>
                        </div>
                        <div class="vehicle-actions">
                            <button class="btn btn-sm btn-outline-secondary me-1" 
                                    onclick="showVehicleDetails(${index})" title="View Details">
                                <i class="bi bi-info-circle"></i>
                            </button>
                            <button class="btn btn-sm ${status === 'IN' ? 'btn-outline-danger' : 'btn-outline-success'}" 
                                    onclick="toggleVehicleStatus(${index})" title="${status === 'IN' ? 'Check Out' : 'Check In'}">
                                <i class="bi ${status === 'IN' ? 'bi-box-arrow-right' : 'bi-box-arrow-in-left'}"></i>
                            </button>
                        </div>
                    </div>
                    <div class="vehicle-info">
                        <div class="mb-1">
                            <i class="bi ${typeIcon} me-2 ${typeColor}"></i>
                            <small class="fw-medium">${type} - ${model}</small>
                        </div>
                        <div class="mb-1">
                            <i class="bi bi-person-fill me-2 text-success"></i>
                            <small><strong>Current:</strong> ${driver}</small>
                        </div>
                        ${assignedDriversDisplay ? `
                        <div class="mb-1">
                            <i class="bi bi-people-fill me-2 text-info"></i>
                            <small><strong>Assigned:</strong> ${assignedDriversDisplay}</small>
                        </div>
                        ` : ''}
                        <div>
                            <i class="bi bi-building me-2 text-warning"></i>
                            <small>${department}</small>
                        </div>
                    </div>
                </div>
            `;


            return item;
        }

        // Keep the old function for compatibility
        function createVehicleCard(plateNumber, model, status, driver, index) {
            return createVehicleListItem(plateNumber, model, status, driver, index);
        }

        function toggleVehicleStatus(index) {
            // Validate gate selection first
            if (!validateGateSelection()) {
                return;
            }

            const vehicle = vehicleData[index];
            const currentStatus = vehicle[6] || 'OUT';
            const newStatus = currentStatus === 'IN' ? 'OUT' : 'IN';
            
            // Get the selected gate using our helper function
            const selectedGate = getCurrentGate();
            const gate = selectedGate.id;

            const logData = {
                plateNumber: vehicle[0],
                driverId: vehicle[7] || 'Unknown',
                action: newStatus,
                gate: gate,
                remarks: '',
                username: currentUser.username // Add the current user's username
            };

            showLoading(true);
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result && result.success) {
                        vehicleData[index][6] = newStatus;
                        displayVehicles();
                        updateStatistics();
                        showToast(`Vehicle ${newStatus === 'IN' ? 'checked in' : 'checked out'} at ${selectedGate.name}!`, 'success');
                        
                        // Increment today's activity
                        let todayActivity = parseInt(sessionStorage.getItem('todayActivity') || '0');
                        todayActivity++;
                        sessionStorage.setItem('todayActivity', todayActivity.toString());
                        document.getElementById('recentActivity').textContent = todayActivity;
                        
                        // Refresh transaction logs to show the new entry
                        setTimeout(() => {
                            loadRecentTransactionLogs();
                        }, 1000);
                        
                    }
                    showLoading(false);
                })
                .withFailureHandler(function(error) {
                    showToast('Failed to update vehicle status: ' + error, 'danger');
                    showLoading(false);
                })
                .logVehicleAction(logData);
        }

        function debounceFilter() {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                filterVehicles();
            }, 300);
        }

        function filterVehicles() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filterStatus = document.getElementById('filterStatus').value;

            // Show filter feedback
            showFilterFeedback(searchTerm, filterStatus);

            // Reset to all vehicles if no filters
            if (!searchTerm && !filterStatus) {
                vehicleData = allVehicles;
                displayVehicles();
                updateStatistics();
                return;
            }

            // Apply filters
            vehicleData = allVehicles.filter((vehicle, index) => {
                if (index === 0) return true; // Keep header

                const plateNumber = (vehicle[0] || '').toLowerCase();
                const model = (vehicle[1] || '').toLowerCase();
                const driver = (vehicle[7] || '').toLowerCase();
                const department = (vehicle[3] || '').toLowerCase();
                const assignedDrivers = (vehicle[8] || '').toLowerCase();
                const status = vehicle[6] || 'OUT';

                const matchesSearch = !searchTerm || 
                    plateNumber.includes(searchTerm) || 
                    model.includes(searchTerm) ||
                    driver.includes(searchTerm) ||
                    department.includes(searchTerm) ||
                    assignedDrivers.includes(searchTerm);

                const matchesStatus = !filterStatus || status === filterStatus;

                return matchesSearch && matchesStatus;
            });

            // Reset lazy loading and display filtered results
            displayVehicles();
            updateStatistics();
        }

        function clearFilters() {
            // Clear all filter inputs
            document.getElementById('searchInput').value = '';
            document.getElementById('filterStatus').value = '';
            
            // Reset data and display
            vehicleData = allVehicles;
            displayVehicles();
            updateStatistics();
            
            // Show feedback
            showToast('Filters cleared - showing all vehicles', 'info');
        }
        
        // Transaction logs functions
        let vehicleLogsCache = {};
        let logsLoadingState = {};
        
        function toggleLogs(plateNumber) {
            console.log('toggleLogs called for:', plateNumber);
            const cleanPlateNumber = plateNumber.replace(/[^a-zA-Z0-9]/g, '-');
            const logsContainer = document.getElementById(`logs-${cleanPlateNumber}`);
            const toggleIcon = document.getElementById(`logs-toggle-${cleanPlateNumber}`);
            
            console.log('Found container:', !!logsContainer, 'Found icon:', !!toggleIcon);
            
            if (!logsContainer) {
                console.error('Logs container not found for:', cleanPlateNumber);
                return;
            }
            
            const isHidden = logsContainer.style.display === 'none' || 
                            window.getComputedStyle(logsContainer).display === 'none';
            
            if (isHidden) {
                // Show logs
                logsContainer.style.display = 'block';
                if (toggleIcon) toggleIcon.className = 'bi bi-chevron-up';
                
                // Load logs if not already loaded
                if (!vehicleLogsCache[plateNumber] && !logsLoadingState[plateNumber]) {
                    console.log('Loading logs for:', plateNumber);
                    loadVehicleLogs(plateNumber);
                }
            } else {
                // Hide logs
                logsContainer.style.display = 'none';
                if (toggleIcon) toggleIcon.className = 'bi bi-chevron-down';
            }
        }
        
        function loadVehicleLogs(plateNumber) {
            console.log('loadVehicleLogs called for:', plateNumber);
            
            // Check cache first
            if (vehicleLogsCache[plateNumber]) {
                console.log('Using cached logs for:', plateNumber);
                displayVehicleLogs(plateNumber, vehicleLogsCache[plateNumber]);
                return;
            }
            
            // Mark as loading
            logsLoadingState[plateNumber] = true;
            
            // Show loading state
            const cleanPlateNumber = plateNumber.replace(/[^a-zA-Z0-9]/g, '-');
            const logsContainer = document.getElementById(`logs-${cleanPlateNumber}`);
            if (!logsContainer) {
                console.error('Logs container not found for:', cleanPlateNumber);
                return;
            }
            
            logsContainer.innerHTML = `
                <div class="logs-loading">
                    <div class="spinner-border spinner-border-sm text-secondary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div>Loading activity...</div>
                </div>
            `;
            
            // Fetch logs from server
            console.log('Calling getVehicleTransactionLogs for:', plateNumber);
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Success loading logs for', plateNumber, ':', result);
                    logsLoadingState[plateNumber] = false;
                    if (result && result.logs) {
                        vehicleLogsCache[plateNumber] = result.logs;
                        displayVehicleLogs(plateNumber, result.logs);
                    } else {
                        const cleanPlateNumber = plateNumber.replace(/[^a-zA-Z0-9]/g, '-');
                        const container = document.getElementById(`logs-${cleanPlateNumber}`);
                        if (container) {
                            container.innerHTML = '<div class="logs-empty">No recent activity</div>';
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading vehicle logs for', plateNumber, ':', error);
                    logsLoadingState[plateNumber] = false;
                    const cleanPlateNumber = plateNumber.replace(/[^a-zA-Z0-9]/g, '-');
                    const container = document.getElementById(`logs-${cleanPlateNumber}`);
                    if (container) {
                        container.innerHTML = '<div class="logs-empty text-danger">Failed to load activity: ' + error.message + '</div>';
                    }
                })
                .getVehicleTransactionLogs(plateNumber, 10);
        }
        
        function displayVehicleLogs(plateNumber, logs) {
            const cleanPlateNumber = plateNumber.replace(/[^a-zA-Z0-9]/g, '-');
            const logsContainer = document.getElementById(`logs-${cleanPlateNumber}`);
            if (!logsContainer) return;
            
            if (!logs || logs.length === 0) {
                logsContainer.innerHTML = '<div class="logs-empty">No recent activity</div>';
                return;
            }
            
            let logsHtml = '';
            if (Array.isArray(logs)) {
                logs.forEach(log => {
                    if (!log) return; // Skip null/undefined log entries
                const timestamp = new Date(log.timestamp);
                const formattedTime = formatLogTimestamp(timestamp);
                const actionClass = log.action === 'IN' ? 'action-in' : 'action-out';
                
                logsHtml += `
                    <div class="transaction-log-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <span class="log-timestamp">${formattedTime}</span>
                                <span class="log-action ${actionClass}">${log.action}</span>
                            </div>
                        </div>
                        <div class="log-details">
                            <i class="bi bi-person-fill"></i> ${log.driverId || 'Unknown'} • 
                            <i class="bi bi-geo-alt"></i> ${log.gate || 'Unknown'}
                            ${log.remarks ? ` • ${log.remarks}` : ''}
                        </div>
                    </div>
                `;
                });
            }
            
            logsContainer.innerHTML = logsHtml;
        }
        
        function formatLogTimestamp(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) {
                return 'Just now';
            } else if (diffMins < 60) {
                return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
            } else if (diffHours < 24) {
                return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            } else if (diffDays < 7) {
                return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            } else {
                return date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        }
        
        // Preload logs for all vehicles (optimized batch loading)
        function preloadAllVehicleLogs() {
            if (!currentUser || !vehicleData || vehicleData.length <= 1) return;
            
            // Only preload if we have a reasonable number of vehicles
            if (vehicleData.length > 50) return;
            
            console.log('Preloading vehicle logs for', vehicleData.length - 1, 'vehicles');
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Preload success:', result);
                    if (result && result.vehicleLogs && typeof result.vehicleLogs === 'object') {
                        try {
                            // Cache all vehicle logs with proper null checking
                            const vehicleKeys = Object.keys(result.vehicleLogs);
                            vehicleKeys.forEach(plateNumber => {
                                if (result.vehicleLogs[plateNumber]) {
                                    vehicleLogsCache[plateNumber] = result.vehicleLogs[plateNumber];
                                }
                            });
                            console.log('Cached logs for', vehicleKeys.length, 'vehicles');
                        } catch (error) {
                            console.error('Error caching vehicle logs:', error);
                        }
                    } else {
                        console.warn('Invalid or missing vehicleLogs in result:', result);
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Error preloading vehicle logs:', error);
                })
                .getAllVehicleTransactionLogs(5);
        }
        
        // Test function to check if backend functions are available
        function testTransactionLogsFunction() {
            console.log('Testing transaction logs function...');
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Test successful - transaction logs available:', result);
                })
                .withFailureHandler(function(error) {
                    console.error('Test failed - transaction logs not available:', error);
                })
                .getVehicleTransactionLogs('ABC-123', 5);
        }
        
        // Load recent transaction logs for the main table
        function loadRecentTransactionLogs() {
            console.log('Loading recent transaction logs...');
            
            // Show loading state
            const tableBody = document.getElementById('transactionLogsTableBody');
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4">
                            <div class="spinner-border text-info" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2 text-muted mb-0">Loading transactions...</p>
                        </td>
                    </tr>
                `;
            }
            
            google.script.run
                .withSuccessHandler(function(result) {
                    console.log('Transaction logs loaded:', result);
                    if (result && result.logs && Array.isArray(result.logs)) {
                        displayTransactionLogsTable(result.logs);
                        updateTransactionLogsBadge(result.logs.length);
                    } else {
                        console.warn('Invalid or missing logs in result:', result);
                        displayTransactionLogsTable([]);
                        updateTransactionLogsBadge(0);
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading transaction logs:', error);
                    displayTransactionLogsTable([]);
                    const tableBody = document.getElementById('transactionLogsTableBody');
                    if (tableBody) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center py-4 text-danger">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <p class="mt-2 mb-0">Failed to load transactions</p>
                                </td>
                            </tr>
                        `;
                    }
                })
                .getTransactionLogs(1, 20); // Get latest 20 transactions
        }
        
        // Display transaction logs in the table
        function displayTransactionLogsTable(logs) {
            const tableBody = document.getElementById('transactionLogsTableBody');
            if (!tableBody) return;
            
            if (!logs || logs.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-4 text-muted">
                            <i class="bi bi-clock-history"></i>
                            <p class="mt-2 mb-0">No recent transactions</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let tableHtml = '';
            if (Array.isArray(logs)) {
                logs.forEach(log => {
                    if (!log) return; // Skip null/undefined log entries
                const timestamp = new Date(log.timestamp);
                const timeStr = formatTransactionTime(timestamp);
                const actionClass = log.action === 'IN' ? 'action-in' : 'action-out';
                
                tableHtml += `
                    <tr>
                        <td class="transaction-time">${timeStr}</td>
                        <td class="transaction-plate">${log.plateNumber || 'Unknown'}</td>
                        <td class="transaction-driver">${log.driverId || 'Unknown'}</td>
                        <td class="transaction-gate">${log.gate || 'Unknown'}</td>
                        <td>
                            <span class="transaction-action ${actionClass}">
                                ${log.action || 'Unknown'}
                            </span>
                        </td>
                    </tr>
                `;
                });
            }
            
            tableBody.innerHTML = tableHtml;
        }
        
        // Format transaction time for table display
        function formatTransactionTime(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            
            if (diffMins < 1) {
                return 'Now';
            } else if (diffMins < 60) {
                return `${diffMins}m ago`;
            } else if (diffHours < 24) {
                return `${diffHours}h ago`;
            } else {
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        }
        
        // Update transaction logs badge count
        function updateTransactionLogsBadge(count) {
            const badge = document.getElementById('transactionLogsBadge');
            if (badge) {
                badge.textContent = count;
            }
        }
        
        // Refresh entire dashboard
        function refreshDashboard() {
            console.log('Refreshing entire dashboard...');
            loadVehicles();
            loadRecentTransactionLogs();
        }

        function showFilterFeedback(searchTerm, filterStatus) {
            // Update clear button visibility
            const clearBtn = document.querySelector('button[onclick="clearFilters()"]');
            if (searchTerm || filterStatus) {
                clearBtn.style.opacity = '1';
                clearBtn.disabled = false;
            } else {
                clearBtn.style.opacity = '0.5';
                clearBtn.disabled = true;
            }
        }

        function initializeFilterUI() {
            // Initialize clear button state
            const clearBtn = document.querySelector('button[onclick="clearFilters()"]');
            if (clearBtn) {
                clearBtn.style.opacity = '0.5';
                clearBtn.disabled = true;
            }
            
            // Add enhanced search placeholder
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.setAttribute('placeholder', 'Search plate number');
            }
        }

        function updateStatistics() {
            if (!vehicleData || vehicleData.length <= 1) {
                animateNumber('totalVehicles', 0);
                animateNumber('vehiclesIn', 0);
                animateNumber('vehiclesOut', 0);
                animateNumber('accessCount', 0);
                animateNumber('noAccessCount', 0);
                animateNumber('bannedCount', 0);
                updatePercentages(0, 0, 0);
                updateSummaryStats(0);
                return;
            }

            let total = vehicleData.length - 1;
            let vehiclesIn = 0;
            let vehiclesOut = 0;
            let accessCount = 0;
            let noAccessCount = 0;
            let bannedCount = 0;

            for (let i = 1; i < vehicleData.length; i++) {
                if (vehicleData[i]) {
                    // Count by status
                    if (vehicleData[i][6] === 'IN') {
                        vehiclesIn++;
                    } else {
                        vehiclesOut++;
                    }
                    
                    // Count by access status
                    const accessStatus = vehicleData[i][9] || 'Access';
                    if (accessStatus === 'Access') {
                        accessCount++;
                    } else if (accessStatus === 'No Access') {
                        noAccessCount++;
                    } else if (accessStatus === 'Banned') {
                        bannedCount++;
                    }
                }
            }

            // Animate numbers
            animateNumber('totalVehicles', total);
            animateNumber('vehiclesIn', vehiclesIn);
            animateNumber('vehiclesOut', vehiclesOut);
            animateNumber('accessCount', accessCount);
            animateNumber('noAccessCount', noAccessCount);
            animateNumber('bannedCount', bannedCount);

            // Update percentages and progress bars
            updatePercentages(total, vehiclesIn, vehiclesOut);
            
            // Update summary stats
            updateSummaryStats(vehiclesIn);
            
            // Add pulse effect on update
            addPulseEffect();
        }

        function animateNumber(elementId, targetNumber) {
            const element = document.getElementById(elementId);
            const currentNumber = parseInt(element.textContent) || 0;
            const increment = targetNumber > currentNumber ? 1 : -1;
            const steps = Math.abs(targetNumber - currentNumber);
            const duration = Math.min(1000, steps * 50); // Max 1 second animation
            const stepDuration = duration / steps;

            if (steps === 0) return;

            let current = currentNumber;
            const timer = setInterval(() => {
                current += increment;
                element.textContent = current;
                
                if (current === targetNumber) {
                    clearInterval(timer);
                    // Add a subtle scale effect when complete
                    element.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        element.style.transform = 'scale(1)';
                    }, 200);
                }
            }, stepDuration);
        }

        function updatePercentages(total, vehiclesIn, vehiclesOut) {
            if (total === 0) {
                document.querySelector('#vehiclesInPercentage span').textContent = '0%';
                document.querySelector('#vehiclesOutPercentage span').textContent = '0%';
                document.getElementById('vehiclesInProgress').style.width = '0%';
                document.getElementById('vehiclesOutProgress').style.width = '0%';
                return;
            }

            const inPercentage = Math.round((vehiclesIn / total) * 100);
            const outPercentage = Math.round((vehiclesOut / total) * 100);

            // Update percentage text
            document.querySelector('#vehiclesInPercentage span').textContent = inPercentage + '%';
            document.querySelector('#vehiclesOutPercentage span').textContent = outPercentage + '%';

            // Animate progress bars
            setTimeout(() => {
                document.getElementById('vehiclesInProgress').style.width = inPercentage + '%';
                document.getElementById('vehiclesOutProgress').style.width = outPercentage + '%';
            }, 100);
        }

        function addPulseEffect() {
            const cards = document.querySelectorAll('.stats-card');
            cards.forEach(card => {
                card.classList.add('pulse-once');
                setTimeout(() => {
                    card.classList.remove('pulse-once');
                }, 600);
            });
        }

        function updateSummaryStats(vehiclesIn) {
            // Update occupancy rate
            const total = vehicleData ? vehicleData.length - 1 : 0;
            const occupancyRate = total > 0 ? Math.round((vehiclesIn / total) * 100) : 0;
            document.getElementById('occupancyRate').textContent = occupancyRate + '%';
            
            // Update last update time
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('lastUpdate').textContent = timeString;
            
            // Update active gate display
            const currentGate = getCurrentGate();
            if (currentGate) {
                document.getElementById('activeGateDisplay').textContent = currentGate.name;
            }
            
            // Update today's activity (this would need actual data from logs)
            // For now, we'll just show a placeholder
            const todayActivity = sessionStorage.getItem('todayActivity') || '0';
            document.getElementById('recentActivity').textContent = todayActivity;
        }

        function logout() {
            currentUser = null;
            clearSession(); // Clear stored session data
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginMsg').innerHTML = '';
            showLoginPage();
            showToast('You have been logged out successfully', 'info');
        }

        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (show) {
                spinner.classList.remove('hidden');
            } else {
                spinner.classList.add('hidden');
            }
        }

        function showMessage(message, type) {
            const loginMsg = document.getElementById('loginMsg');
            const icons = {
                success: 'bi-check-circle-fill',
                danger: 'bi-exclamation-triangle-fill'
            };

            loginMsg.className = `alert alert-${type} mb-3 d-flex align-items-center`;
            loginMsg.innerHTML = `
                <i class="bi ${icons[type]} me-2"></i>
                <div>${message}</div>
            `;
        }

        function showToast(message, type) {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.innerHTML += toastHtml;
            const toast = new bootstrap.Toast(document.getElementById(toastId));
            toast.show();
            
            setTimeout(() => {
                const toastElement = document.getElementById(toastId);
                if (toastElement) {
                    toastElement.remove();
                }
            }, 5000);
        }


        function showVehicleDetails(index) {
            const vehicle = vehicleData[index];
            const modal = new bootstrap.Modal(document.getElementById('vehicleDetailsModal'));
            
            document.getElementById('detailsModalTitle').textContent = 'Vehicle Details - ' + vehicle[0];
            
            const accessStatus = vehicle[9] || 'Access';
            const accessClass = accessStatus === 'Access' ? 'bg-success' : 
                               accessStatus === 'No Access' ? 'bg-warning' : 'bg-danger';
            const accessTextClass = accessStatus === 'No Access' ? 'text-dark' : 'text-white';
            
            document.getElementById('detailsModalBody').innerHTML = `
                <div class="row">
                    <div class="col-12 mb-3">
                        <div class="plate-number text-center fs-4">${vehicle[0]}</div>
                    </div>
                </div>
                <table class="table table-striped">
                    <tr><th width="40%">Make/Model</th><td>${vehicle[1] || ''}</td></tr>
                    <tr><th>Color</th><td>${vehicle[2] || ''}</td></tr>
                    <tr><th>Department</th><td>${vehicle[3] || ''}</td></tr>
                    <tr><th>Year</th><td>${vehicle[4] || ''}</td></tr>
                    <tr><th>Type</th><td>${vehicle[5] || ''}</td></tr>
                    <tr><th>Status</th><td><span class="badge ${vehicle[6] === 'IN' ? 'status-in' : 'status-out'}">${vehicle[6] || 'OUT'}</span></td></tr>
                    <tr><th>Current Driver</th><td>${vehicle[7] || 'Unassigned'}</td></tr>
                    <tr><th>Assigned Drivers</th><td>${vehicle[8] || 'None'}</td></tr>
                    <tr><th>Access Status</th><td><span class="badge ${accessClass} ${accessTextClass}">${accessStatus}</span></td></tr>
                </table>
            `;
            
            // Add action buttons based on user role
            const footer = document.getElementById('detailsModalFooter');
            if (currentUser.role === 'admin') {
                footer.innerHTML = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning" onclick="editVehicle(${index})">
                        <i class="bi bi-pencil-square me-2"></i>Edit
                    </button>
                    <button type="button" class="btn btn-danger" onclick="deleteVehicle(${index})">
                        <i class="bi bi-trash me-2"></i>Delete
                    </button>
                `;
            } else if (currentUser.role === 'security') {
                footer.innerHTML = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning" onclick="editVehicle(${index})">
                        <i class="bi bi-person-gear me-2"></i>Change Driver
                    </button>
                `;
            } else {
                footer.innerHTML = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                `;
            }
            
            modal.show();
        }

        function updateCurrentDriverDropdown() {
            const assignedDriversValue = document.getElementById('editAssignedDrivers').value.trim();
            const currentDriverSelect = document.getElementById('editDriver');
            const currentValue = currentDriverSelect.value; // Save current selection
            
            // Clear existing options
            currentDriverSelect.innerHTML = '<option value="">Select a driver...</option>';
            
            if (assignedDriversValue) {
                // Split the assigned drivers by comma and trim whitespace
                const assignedDrivers = assignedDriversValue.split(',')
                    .map(driver => driver.trim())
                    .filter(driver => driver.length > 0);
                
                // Add each assigned driver as an option
                assignedDrivers.forEach(driver => {
                    const option = document.createElement('option');
                    option.value = driver;
                    option.textContent = driver;
                    currentDriverSelect.appendChild(option);
                });
                
                // Restore previous selection if it's still in the list
                if (currentValue && assignedDrivers.includes(currentValue)) {
                    currentDriverSelect.value = currentValue;
                }
            }
        }

        function editVehicle(index) {
            if (currentUser.role !== 'admin' && currentUser.role !== 'security') {
                showToast('Only administrators and security personnel can edit vehicles', 'danger');
                return;
            }
            
            const vehicle = vehicleData[index];
            
            // Hide details modal and show edit modal
            bootstrap.Modal.getInstance(document.getElementById('vehicleDetailsModal')).hide();
            
            // Populate edit form
            document.getElementById('editVehicleIndex').value = index;
            document.getElementById('editPlateNumber').value = vehicle[0] || '';
            document.getElementById('editModel').value = vehicle[1] || '';
            document.getElementById('editColor').value = vehicle[2] || '';
            document.getElementById('editDepartment').value = vehicle[3] || '';
            document.getElementById('editYear').value = vehicle[4] || '';
            document.getElementById('editType').value = vehicle[5] || 'Car';
            document.getElementById('editStatus').value = vehicle[6] || 'OUT';
            document.getElementById('editAssignedDrivers').value = vehicle[8] || '';
            document.getElementById('editAccessStatus').value = vehicle[9] || 'Access';
            
            // Populate current driver dropdown from assigned drivers
            updateCurrentDriverDropdown();
            document.getElementById('editDriver').value = vehicle[7] || '';
            
            // Add event listener to assigned drivers field to update current driver options
            const assignedDriversField = document.getElementById('editAssignedDrivers');
            if (!assignedDriversField.hasAttribute('data-listener-added')) {
                assignedDriversField.addEventListener('input', updateCurrentDriverDropdown);
                assignedDriversField.setAttribute('data-listener-added', 'true');
            }
            
            // Restrict Security role to only edit current driver field
            if (currentUser.role === 'security') {
                // Disable all fields except current driver
                const fieldsToDisable = [
                    'editPlateNumber', 'editModel', 'editColor', 'editDepartment', 
                    'editYear', 'editType', 'editStatus', 'editAssignedDrivers', 'editAccessStatus'
                ];
                
                fieldsToDisable.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.disabled = true;
                        field.style.backgroundColor = '#f8f9fa';
                        field.style.opacity = '0.6';
                    }
                });
                
                // Ensure current driver field is enabled and highlighted
                const driverField = document.getElementById('editDriver');
                if (driverField) {
                    driverField.disabled = false;
                    driverField.style.backgroundColor = '';
                    driverField.style.opacity = '';
                    driverField.style.borderColor = '#007bff';
                    driverField.focus();
                }
                
                // Update modal title for Security users
                const modalTitle = document.querySelector('#editVehicleModal .modal-title');
                if (modalTitle) {
                    modalTitle.textContent = 'Change Current Driver';
                }
            } else {
                // Reset all fields for admin users
                const allFields = [
                    'editPlateNumber', 'editModel', 'editColor', 'editDepartment', 
                    'editYear', 'editType', 'editStatus', 'editAssignedDrivers', 'editAccessStatus', 'editDriver'
                ];
                
                allFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.disabled = false;
                        field.style.backgroundColor = '';
                        field.style.opacity = '';
                        field.style.borderColor = '';
                    }
                });
                
                // Reset modal title for admin users
                const modalTitle = document.querySelector('#editVehicleModal .modal-title');
                if (modalTitle) {
                    modalTitle.textContent = 'Edit Vehicle';
                }
            }
            
            // Show edit modal
            const modal = new bootstrap.Modal(document.getElementById('editVehicleModal'));
            modal.show();
        }

        function saveVehicleEdit() {
            const index = parseInt(document.getElementById('editVehicleIndex').value);
            
            // Handle Security role - only update current driver
            if (currentUser.role === 'security') {
                const newDriverValue = document.getElementById('editDriver').value || '';
                
                // Create updated vehicle data with only driver field changed
                const currentVehicle = allVehicles[index];
                const updatedVehicleData = [...currentVehicle]; // Copy existing data
                updatedVehicleData[7] = newDriverValue; // Update only current driver field
                
                showLoading(true);
                google.script.run
                    .withSuccessHandler(function(success) {
                        if (success) {
                            // Update local data
                            allVehicles[index] = updatedVehicleData;
                            
                            // Update UI
                            displayVehicles();
                            
                            // Hide modal and show success
                            bootstrap.Modal.getInstance(document.getElementById('editVehicleModal')).hide();
                            showToast('Driver updated successfully', 'success');
                        } else {
                            showToast('Failed to update driver', 'danger');
                        }
                        showLoading(false);
                    })
                    .withFailureHandler(function(error) {
                        showToast('Error updating driver: ' + error, 'danger');
                        showLoading(false);
                    })
                    .updateVehicleRecord(index, updatedVehicleData, currentUser.role);
                
                return; // Exit early for Security users
            }
            
            // Handle Admin role - full edit capability
            const plateNumber = document.getElementById('editPlateNumber').value.trim();
            const model = document.getElementById('editModel').value.trim();
            
            if (!plateNumber || !model) {
                showToast('Plate number and model are required', 'danger');
                return;
            }
            
            // Check if plate number already exists (excluding current vehicle)
            for (let i = 1; i < allVehicles.length; i++) {
                if (i !== index && allVehicles[i][0] === plateNumber) {
                    showToast('Another vehicle with this plate number already exists', 'danger');
                    return;
                }
            }
            
            const updatedVehicleData = [
                plateNumber,
                model,
                document.getElementById('editColor').value || '',
                document.getElementById('editDepartment').value || '',
                document.getElementById('editYear').value || '',
                document.getElementById('editType').value || 'Car',
                document.getElementById('editStatus').value || 'OUT',
                document.getElementById('editDriver').value || '',
                document.getElementById('editAssignedDrivers').value || '',
                document.getElementById('editAccessStatus').value || 'Access'
            ];
            
            showLoading(true);
            google.script.run
                .withSuccessHandler(function(success) {
                    if (success) {
                        // Update local data
                        allVehicles[index] = updatedVehicleData;
                        vehicleData = allVehicles;
                        
                        // Update display
                        displayVehicles();
                        updateStatistics();
                        
                        // Hide modal
                        bootstrap.Modal.getInstance(document.getElementById('editVehicleModal')).hide();
                        
                        showToast('Vehicle updated successfully!', 'success');
                    }
                    showLoading(false);
                })
                .withFailureHandler(function(error) {
                    showToast('Failed to update vehicle: ' + error, 'danger');
                    showLoading(false);
                })
                .updateVehicleRecord(index, updatedVehicleData, currentUser.role);
        }

        function deleteVehicle(index) {
            if (currentUser.role !== 'admin') {
                showToast('Only administrators can delete vehicles', 'danger');
                return;
            }
            
            const vehicle = vehicleData[index];
            const plateNumber = vehicle[0];
            
            // Confirm deletion
            if (!confirm(`Are you sure you want to delete vehicle ${plateNumber}?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            showLoading(true);
            google.script.run
                .withSuccessHandler(function(success) {
                    if (success) {
                        // Remove from local data
                        allVehicles.splice(index, 1);
                        vehicleData = allVehicles;
                        
                        // Update display
                        displayVehicles();
                        updateStatistics();
                        
                        // Hide modal
                        bootstrap.Modal.getInstance(document.getElementById('vehicleDetailsModal')).hide();
                        
                        showToast('Vehicle deleted successfully!', 'success');
                    }
                    showLoading(false);
                })
                .withFailureHandler(function(error) {
                    showToast('Failed to delete vehicle: ' + error, 'danger');
                    showLoading(false);
                })
                .deleteVehicleRecord(index, currentUser.role);
        }

        // User Management Functions
        let allUsers = [];

        function showUserManagement() {
            if (!hasPermission('manage_users')) {
                showToast('Access denied: Insufficient permissions', 'danger');
                return;
            }

            const modal = new bootstrap.Modal(document.getElementById('userManagementModal'));
            modal.show();
            
            loadUsers();
        }

        function loadUsers() {
            google.script.run
                .withSuccessHandler(function(data) {
                    allUsers = data;
                    displayUsers();
                })
                .withFailureHandler(function(error) {
                    showToast('Failed to load users: ' + error, 'danger');
                })
                .getUserList();
        }

        function displayUsers() {
            const container = document.getElementById('userListContainer');
            
            if (allUsers.length <= 1) {
                container.innerHTML = '<div class="text-center py-3 text-muted">No users found</div>';
                return;
            }

            let usersHtml = '<div class="list-group">';
            
            for (let i = 1; i < allUsers.length; i++) {
                const user = allUsers[i];
                const role = user[2] || 'user';
                const roleDisplay = role.charAt(0).toUpperCase() + role.slice(1);
                
                usersHtml += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-bold">${user[0]}</span>
                            <span class="badge role-badge ${role} ms-2">${roleDisplay}</span>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" onclick="editUser(${i})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${i})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }
            
            usersHtml += '</div>';
            container.innerHTML = usersHtml;
        }

        function showAddUserForm() {
            document.getElementById('userForm').style.display = 'block';
            document.getElementById('userFormTitle').textContent = 'Add New User';
            document.getElementById('editUserIndex').value = '-1';
            document.getElementById('userUsername').value = '';
            document.getElementById('userRole').value = 'user';
            document.getElementById('userUsername').focus();
        }

        function editUser(index) {
            const user = allUsers[index];
            document.getElementById('userForm').style.display = 'block';
            document.getElementById('userFormTitle').textContent = 'Edit User';
            document.getElementById('editUserIndex').value = index;
            
            // Populate form
            document.getElementById('userUsername').value = user[0] || '';
            document.getElementById('userRole').value = user[2] || 'user';
            
            document.getElementById('userUsername').focus();
        }

        function cancelUserForm() {
            document.getElementById('userForm').style.display = 'none';
            document.getElementById('addEditUserForm').reset();
        }

        function saveUser() {
            const index = parseInt(document.getElementById('editUserIndex').value);
            const username = document.getElementById('userUsername').value.trim();
            const role = document.getElementById('userRole').value;

            if (!username || !role) {
                showToast('Username and role are required', 'danger');
                return;
            }

            // Check if username already exists (excluding current user)
            for (let i = 1; i < allUsers.length; i++) {
                if (i !== index && allUsers[i][0] === username) {
                    showToast('Username already exists', 'danger');
                    return;
                }
            }

            const userData = {
                username: username,
                role: role
            };

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        loadUsers();
                        cancelUserForm();
                        showToast(`User ${result.action} successfully!`, 'success');
                    }
                })
                .withFailureHandler(function(error) {
                    showToast('Failed to save user: ' + error, 'danger');
                })
                .saveUser(userData, currentUser.role, index);
        }

        function deleteUser(index) {
            if (!hasPermission('manage_users')) {
                showToast('Access denied: Insufficient permissions', 'danger');
                return;
            }

            const user = allUsers[index];
            const username = user[0];

            // Prevent deleting yourself
            if (username === currentUser.username) {
                showToast('Cannot delete your own account', 'danger');
                return;
            }

            if (!confirm(`Are you sure you want to delete user "${username}"?`)) {
                return;
            }

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        loadUsers();
                        showToast('User deleted successfully!', 'success');
                    }
                })
                .withFailureHandler(function(error) {
                    showToast('Failed to delete user: ' + error, 'danger');
                })
                .deleteUser(index, currentUser.role);
        }

        function showRoleSettings() {
            const modal = new bootstrap.Modal(document.getElementById('roleSettingsModal'));
            modal.show();
        }

        // Gate Management Functions - Simplified
        let allGates = [];
        let activeGates = [];

        function loadActiveGates() {
            google.script.run
                .withSuccessHandler(function(gates) {
                    activeGates = gates;
                    updateGateSelector();
                })
                .withFailureHandler(function(error) {
                    console.error('Failed to load active gates:', error);
                    // Fallback to default gates
                    activeGates = [
                        { id: 'Main Gate', name: 'Main Gate' },
                        { id: 'Back Gate', name: 'Back Gate' }
                    ];
                    updateGateSelector();
                })
                .getActiveGates();
        }

        function updateGateSelector() {
            const gateSelector = document.getElementById('gateSelector');
            if (!gateSelector) return;

            // Clear existing options
            gateSelector.innerHTML = '';

            // Show loading state if no gates
            if (!activeGates || activeGates.length === 0) {
                const loadingOption = document.createElement('option');
                loadingOption.value = '';
                loadingOption.textContent = '⚠️ No gates available';
                loadingOption.disabled = true;
                gateSelector.appendChild(loadingOption);
                return;
            }

            // Add active gates with enhanced icon mapping
            activeGates.forEach(gate => {
                const option = document.createElement('option');
                option.value = gate.id;
                
                // Enhanced icon mapping based on gate name
                let icon = '🏛️'; // Default gate icon
                const gateName = gate.name.toLowerCase();
                
                if (gateName.includes('main') || gateName.includes('front')) icon = '🏛️';
                else if (gateName.includes('back') || gateName.includes('rear') || gateName.includes('side')) icon = '🚪';
                else if (gateName.includes('parking') || gateName.includes('park')) icon = '🅿️';
                else if (gateName.includes('service') || gateName.includes('maintenance')) icon = '🔧';
                else if (gateName.includes('emergency') || gateName.includes('exit')) icon = '🚨';
                else if (gateName.includes('security') || gateName.includes('guard')) icon = '🛡️';
                else if (gateName.includes('visitor') || gateName.includes('guest')) icon = '👥';
                else if (gateName.includes('delivery') || gateName.includes('cargo')) icon = '📦';
                else if (gateName.includes('pedestrian') || gateName.includes('walk')) icon = '🚶';
                
                option.textContent = `${icon} ${gate.name}`;
                gateSelector.appendChild(option);
            });

            // Restore previously selected gate or select first gate
            const savedGate = sessionStorage.getItem('selectedGate');
            let gateSelected = false;
            
            if (savedGate) {
                // Check if saved gate still exists
                const gateExists = activeGates.find(gate => gate.id === savedGate);
                if (gateExists) {
                    gateSelector.value = savedGate;
                    gateSelected = true;
                }
            }
            
            // If no saved gate or saved gate doesn't exist, select first gate
            if (!gateSelected && activeGates.length > 0) {
                gateSelector.value = activeGates[0].id;
                sessionStorage.setItem('selectedGate', activeGates[0].id);
            }
            
            // Add change event listener for persistence (only once)
            if (!gateSelector.hasAttribute('data-listener-added')) {
                gateSelector.addEventListener('change', function() {
                    if (this.value) {
                        sessionStorage.setItem('selectedGate', this.value);
                        const gateName = this.options[this.selectedIndex].text;
                        showToast(`Switched to ${gateName}`, 'info');
                    }
                });
                gateSelector.setAttribute('data-listener-added', 'true');
            }
        }

        function refreshGateSelector() {
            // Show loading state
            const gateSelector = document.getElementById('gateSelector');
            if (gateSelector) {
                gateSelector.innerHTML = '<option value="">🔄 Refreshing gates...</option>';
            }
            
            // Reload gates and update selector
            loadActiveGates();
            
            // Show feedback
            showToast('Refreshing gates...', 'info');
        }

        function getCurrentGate() {
            const gateSelector = document.getElementById('gateSelector');
            if (gateSelector && gateSelector.value) {
                return {
                    id: gateSelector.value,
                    name: gateSelector.options[gateSelector.selectedIndex].text.replace(/^[^\s]+\s/, '') // Remove emoji
                };
            }
            return null;
        }

        function validateGateSelection() {
            const gate = getCurrentGate();
            if (!gate) {
                showToast('Please select a gate before performing vehicle operations', 'warning');
                return false;
            }
            return true;
        }

        function showGateManagement() {
            if (!hasPermission('manage_gates')) {
                showToast('Access denied: Insufficient permissions', 'danger');
                return;
            }

            const modal = new bootstrap.Modal(document.getElementById('gateManagementModal'));
            modal.show();
            
            loadGates();
        }

        function loadGates() {
            google.script.run
                .withSuccessHandler(function(data) {
                    allGates = data;
                    displayGates();
                })
                .withFailureHandler(function(error) {
                    showToast('Failed to load gates: ' + error, 'danger');
                })
                .getGateList();
        }

        function displayGates() {
            const container = document.getElementById('gateListContainer');
            
            if (allGates.length <= 1) {
                container.innerHTML = '<div class="text-center py-3 text-muted">No gates found</div>';
                return;
            }

            let gatesHtml = '<div class="list-group">';
            
            for (let i = 1; i < allGates.length; i++) {
                const gate = allGates[i];
                gatesHtml += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>${gate[0]}</span>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" onclick="editGate(${i})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteGate(${i})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }
            
            gatesHtml += '</div>';
            container.innerHTML = gatesHtml;
        }

        function showAddGateForm() {
            document.getElementById('gateForm').style.display = 'block';
            document.getElementById('gateFormTitle').textContent = 'Add New Gate';
            document.getElementById('editGateIndex').value = '-1';
            document.getElementById('gateName').value = '';
            document.getElementById('gateName').focus();
        }

        function editGate(index) {
            const gate = allGates[index];
            document.getElementById('gateForm').style.display = 'block';
            document.getElementById('gateFormTitle').textContent = 'Edit Gate';
            document.getElementById('editGateIndex').value = index;
            document.getElementById('gateName').value = gate[0];
            document.getElementById('gateName').focus();
        }

        function cancelGateForm() {
            document.getElementById('gateForm').style.display = 'none';
            document.getElementById('addEditGateForm').reset();
        }

        function saveGate() {
            const gateName = document.getElementById('gateName').value.trim();
            const editIndex = parseInt(document.getElementById('editGateIndex').value);

            if (!gateName) {
                showToast('Gate name is required', 'danger');
                return;
            }

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        loadGates();
                        loadActiveGates(); // Refresh gate selector
                        cancelGateForm();
                        showToast(`Gate ${result.action} successfully!`, 'success');
                    }
                })
                .withFailureHandler(function(error) {
                    showToast('Failed to save gate: ' + error, 'danger');
                })
                .saveGate(gateName, currentUser.role, editIndex);
        }

        function deleteGate(index) {
            const gate = allGates[index];
            
            if (!confirm(`Are you sure you want to delete "${gate[0]}"?`)) {
                return;
            }

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        loadGates();
                        loadActiveGates(); // Refresh gate selector
                        showToast('Gate deleted successfully!', 'success');
                    }
                })
                .withFailureHandler(function(error) {
                    showToast('Failed to delete gate: ' + error, 'danger');
                })
                .deleteGate(index, currentUser.role);
        }


        function showVehicleManagement() {
            if (!hasPermission('manage_vehicles')) {
                showToast('Access denied: Insufficient permissions', 'danger');
                return;
            }

            document.getElementById('addVehicleForm').reset();
            const modal = new bootstrap.Modal(document.getElementById('vehicleManagementModal'));
            modal.show();
            
            // Focus on first input field
            setTimeout(() => {
                document.getElementById('vehiclePlateNumber').focus();
            }, 300);
        }




        function loadMoreVehicles(type) {
            if (isLoadingMore) return;
            isLoadingMore = true;

            const listElement = type === 'in' ? 
                document.getElementById('vehiclesInList') : 
                document.getElementById('vehiclesOutList');
            
            const vehiclesArray = type === 'in' ? window.vehiclesInArray : window.vehiclesOutArray;
            const currentIndex = type === 'in' ? vehiclesInIndex : vehiclesOutIndex;
            
            if (!listElement || !vehiclesArray || currentIndex >= vehiclesArray.length) {
                isLoadingMore = false;
                return;
            }

            // Remove any existing loading indicator
            const existingLoader = listElement.querySelector('.lazy-loading-indicator');
            if (existingLoader) existingLoader.remove();

            // Load next batch
            const endIndex = Math.min(currentIndex + VEHICLES_PER_BATCH, vehiclesArray.length);
            const fragment = document.createDocumentFragment();
            
            for (let i = currentIndex; i < endIndex; i++) {
                const vehicle = vehiclesArray[i];
                const card = createVehicleListItem(
                    vehicle.plateNumber, 
                    vehicle.model, 
                    vehicle.status, 
                    vehicle.driver, 
                    vehicle.index
                );
                fragment.appendChild(card);
            }
            
            listElement.appendChild(fragment);
            
            // Update index
            if (type === 'in') {
                vehiclesInIndex = endIndex;
            } else {
                vehiclesOutIndex = endIndex;
            }
            
            // Add loading indicator if more items remain
            if (endIndex < vehiclesArray.length) {
                const loadingIndicator = document.createElement('div');
                loadingIndicator.className = 'lazy-loading-indicator text-center py-3';
                loadingIndicator.innerHTML = `
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Loading more vehicles...</span>
                    </div>
                    <p class="text-muted small mt-2">Loading more vehicles...</p>
                `;
                listElement.appendChild(loadingIndicator);
            }
            
            setTimeout(() => { isLoadingMore = false; }, 100);
        }

        function setupIntersectionObserver(type) {
            const options = {
                root: null,
                rootMargin: '100px',
                threshold: 0.1
            };

            const callback = (entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        loadMoreVehicles(type);
                    }
                });
            };

            const observer = new IntersectionObserver(callback, options);
            const listElement = type === 'in' ? 
                document.getElementById('vehiclesInList') : 
                document.getElementById('vehiclesOutList');
            
            if (listElement) {
                // Observe the list container for when it comes into view
                const observerTarget = setInterval(() => {
                    const loader = listElement.querySelector('.lazy-loading-indicator');
                    if (loader) {
                        observer.observe(loader);
                        clearInterval(observerTarget);
                    }
                }, 100);
                
                // Store observer reference
                if (type === 'in') {
                    vehiclesInObserver = observer;
                } else {
                    vehiclesOutObserver = observer;
                }
            }
        }

        function setupScrollListeners() {
            // Set up scroll event listeners for the vehicle list containers
            const vehiclesInContainer = document.querySelector('#vehiclesInContainer');
            const vehiclesOutContainer = document.querySelector('#vehiclesOutContainer');
            
            if (vehiclesInContainer) {
                vehiclesInContainer.addEventListener('scroll', function() {
                    const list = this.querySelector('.vehicle-list');
                    if (list && this.scrollTop + this.clientHeight >= this.scrollHeight - 50) {
                        loadMoreVehicles('in');
                    }
                }, { passive: true }); // Passive listener for better scroll performance
            }
            
            if (vehiclesOutContainer) {
                vehiclesOutContainer.addEventListener('scroll', function() {
                    const list = this.querySelector('.vehicle-list');
                    if (list && this.scrollTop + this.clientHeight >= this.scrollHeight - 50) {
                        loadMoreVehicles('out');
                    }
                }, { passive: true }); // Passive listener for better scroll performance
            }
        }
        
        function optimizeForMobile() {
            // Detect if mobile device
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile || window.innerWidth <= 768) {
                // Reduce animation durations for better performance
                document.documentElement.style.setProperty('--animation-duration', '0.1s');
                
                // Add touch-friendly classes
                document.body.classList.add('touch-device');
                
                // Optimize vehicle card interactions
                const vehicleCards = document.querySelectorAll('.vehicle-card');
                vehicleCards.forEach(card => {
                    card.addEventListener('touchstart', function() {
                        this.classList.add('touch-active');
                    }, { passive: true });
                    
                    card.addEventListener('touchend', function() {
                        setTimeout(() => this.classList.remove('touch-active'), 100);
                    }, { passive: true });
                });
                
                // Improve modal backdrop for mobile
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    modal.addEventListener('shown.bs.modal', function() {
                        // Prevent body scroll when modal is open
                        document.body.style.overflow = 'hidden';
                        document.body.style.position = 'fixed';
                        document.body.style.width = '100%';
                    });
                    
                    modal.addEventListener('hidden.bs.modal', function() {
                        // Restore body scroll
                        document.body.style.overflow = '';
                        document.body.style.position = '';
                        document.body.style.width = '';
                    });
                });
            }
            
            // Add viewport height fix for mobile browsers
            function setViewportHeight() {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }
            
            setViewportHeight();
            window.addEventListener('resize', setViewportHeight);
            window.addEventListener('orientationchange', setViewportHeight);
        }

        function saveVehicle() {
            const plateNumber = document.getElementById('vehiclePlateNumber').value.trim();
            const model = document.getElementById('vehicleModel').value.trim();

            if (!plateNumber || !model) {
                showToast('Plate number and make/model are required', 'danger');
                return;
            }

            const vehicleData = {
                plateNumber: plateNumber,
                model: model,
                color: document.getElementById('vehicleColor').value.trim(),
                department: document.getElementById('vehicleDepartment').value.trim(),
                year: document.getElementById('vehicleYear').value,
                type: document.getElementById('vehicleType').value,
                status: document.getElementById('vehicleStatus').value,
                driver: document.getElementById('vehicleDriver').value.trim(),
                assignedDrivers: document.getElementById('vehicleAssignedDrivers').value.trim(),
                accessStatus: document.getElementById('vehicleAccessStatus').value
            };

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        loadVehicles(); // Refresh main dashboard
                        document.getElementById('addVehicleForm').reset();
                        bootstrap.Modal.getInstance(document.getElementById('vehicleManagementModal')).hide();
                        showToast('Vehicle added successfully!', 'success');
                    }
                })
                .withFailureHandler(function(error) {
                    showToast('Failed to save vehicle: ' + error, 'danger');
                })
                .saveVehicleRecord(vehicleData, currentUser.role, -1);
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check session and initialize
            const savedSession = sessionStorage.getItem('currentUser');
            if (savedSession) {
                currentUser = JSON.parse(savedSession);
                showDashboard();
            } else {
                showLoginPage();
            }
        });

    </script>
</body>
</html>