<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Vehicle Monitoring System">
    <meta name="generator" content="Vehicle Monitoring System">
    <meta name="description" content="Professional Vehicle Monitoring and Management System">
    <base target="_top">
    <title>Vehicle Monitoring System</title>
    
    <!-- Preconnect to CDN for faster loading -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    
    <!-- Load CSS with media attribute for better performance -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" media="all">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" media="all">
    
    <!-- QR Code Scanner Library -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <style>
        /* CSS Reset and Performance Optimizations */
        * {
            box-sizing: border-box;
        }
        
        /* Optimize rendering performance */
        .vehicle-card, .btn, .modal {
            will-change: transform;
        }
        
        /* Enhanced search input styling */
        #searchInput {
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
            padding-left: 2.5rem;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236c757d' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 0.75rem center;
            background-size: 1rem;
        }
        
        #searchInput:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
            outline: none;
        }
        
        #searchInput::placeholder {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        /* Mobile-first responsive design */
        @media (max-width: 767px) {
            .navbar-nav {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
                margin-top: 1rem;
            }
            
            .navbar-brand {
                font-size: 1rem;
            }
            
            .stats-card {
                margin-bottom: 1rem;
            }
            
            .vehicle-status-columns .col-lg-6 {
                margin-bottom: 1rem;
            }
            
            .vehicle-list {
                max-height: 400px;
            }
            
            .add-vehicle-btn {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
            }
            
            .qr-scanner-btn {
                bottom: 20px;
                left: 20px; /* Position in lower left on mobile */
                width: 50px;
                height: 50px;
            }
            
            .login-card {
                margin: 1rem;
            }
            
            .modal-dialog {
                margin: 0.5rem;
            }
            
            .vehicle-info {
                font-size: 0.8rem;
            }
            
            .plate-number {
                font-size: 1rem;
            }
            
            /* Optimize form layouts for mobile */
            .row.mb-4 > div[class*="col-"] {
                margin-bottom: 1rem;
            }
            
            /* Touch-friendly button sizes */
            .btn {
                min-height: 44px;
                padding: 0.5rem 1rem;
            }
            
            .btn-sm {
                min-height: 36px;
            }
            
            /* Responsive table in modals */
            .table-responsive {
                font-size: 0.875rem;
            }
        }
        
        /* Tablet responsive adjustments */
        @media (min-width: 768px) and (max-width: 991px) {
            .vehicle-status-columns .col-lg-6 {
                margin-bottom: 1rem;
            }
        }
        
        /* Performance optimizations */
        img, svg, video {
            max-width: 100%;
            height: auto;
        }
        
        /* Reduce animations on low-power devices */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Touch device optimizations */
        .touch-device .vehicle-card {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .touch-active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        
        /* Loading state optimizations */
        .skeleton-loader {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Viewport height fix for mobile */
        .dashboard-page {
            min-height: 100vh;
            min-height: calc(var(--vh, 1vh) * 100);
        }
        
        /* Optimize modal for mobile */
        @media (max-width: 576px) {
            .modal-dialog {
                margin: 0;
                width: 100%;
                max-width: 100%;
                height: 100%;
            }
            
            .modal-content {
                height: 100%;
                border-radius: 0;
            }
            
            .modal-body {
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
        .login-page {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
        }
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .login-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px 20px 0 0;
            padding: 2rem 1.5rem 1.5rem;
            text-align: center;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        .alert { border-radius: 10px; border: none; }
        .hidden { display: none !important; }
        
        .dashboard-page { min-height: 100vh; background: #f8f9fa; }
        .navbar-brand { font-weight: 600; }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        .stats-card .card-body {
            position: relative;
            z-index: 2;
        }
        .stats-card::before {
            content: "";
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transform: rotate(45deg);
            transition: all 0.5s ease;
        }
        .stats-card:hover::before {
            top: -60%;
            right: -60%;
        }
        .stats-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 3rem;
            opacity: 0.3;
        }
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0;
            transition: all 0.3s ease;
        }
        .stats-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0;
        }
        .stats-percentage {
            font-size: 0.8rem;
            margin-top: 0.5rem;
            opacity: 0.8;
        }
        .stats-progress {
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            margin-top: 0.5rem;
            overflow: hidden;
        }
        .stats-progress-bar {
            height: 100%;
            background: rgba(255,255,255,0.8);
            border-radius: 2px;
            transition: width 1s ease;
        }
        
        @keyframes pulse-once {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .pulse-once {
            animation: pulse-once 0.6s ease-in-out;
        }
        
        /* Summary card styles */
        .summary-card {
            background: white;
            border: 1px solid #e3e6f0;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .summary-stats {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .summary-item {
            text-align: center;
            flex: 1;
            min-width: 100px;
        }
        
        .summary-item i {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }
        
        .summary-item .value {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }
        
        .summary-item .label {
            font-size: 0.75rem;
            color: #6c757d;
            margin: 0;
        }
        
        @media (max-width: 768px) {
            .stats-number {
                font-size: 2rem;
            }
            .stats-icon {
                font-size: 2rem;
                right: 15px;
            }
            .summary-stats {
                gap: 0.5rem;
            }
        }
        .vehicle-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            border: none;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid transparent;
            -webkit-tap-highlight-color: transparent;
        }
        .vehicle-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        @media (hover: none) {
            .vehicle-card:hover {
                transform: none;
            }
            .vehicle-card:active {
                transform: scale(0.98);
            }
        }
        .vehicle-card.status-in {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        .vehicle-card.status-out {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        .vehicle-card.access-banned {
            border: 3px solid #dc3545 !important;
            border-left: 4px solid #dc3545 !important;
        }
        .vehicle-card.access-no-access {
            border: 3px solid #fd7e14 !important;
            border-left: 4px solid #fd7e14 !important;
        }
        .vehicle-status-columns .card {
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        .vehicle-status-columns .card-header {
            font-weight: 600;
            border-bottom: none;
        }
        .vehicle-list {
            max-height: 600px;
            overflow-y: auto;
        }
        .vehicle-list::-webkit-scrollbar {
            width: 6px;
        }
        .vehicle-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .vehicle-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .vehicle-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .lazy-loading-indicator {
            padding: 20px;
            opacity: 0.7;
        }
        .vehicle-card {
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .vehicle-info {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .no-vehicles {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        .no-vehicles i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        .status-in { background-color: #28a745; color: white; }
        .status-out { background-color: #dc3545; color: white; }
        
        /* Transaction Logs Table Styles */
        .transaction-logs-container {
            border-radius: 0 0 0.375rem 0.375rem;
        }
        .transaction-logs-container::-webkit-scrollbar {
            width: 6px;
        }
        .transaction-logs-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        .transaction-logs-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .transaction-logs-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        #transactionLogsTable {
            font-size: 0.8rem;
        }
        #transactionLogsTable thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
            padding: 8px 6px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        #transactionLogsTable tbody tr {
            transition: all 0.2s ease;
        }
        #transactionLogsTable tbody tr:hover {
            background-color: #f1f3f5 !important;
        }
        #transactionLogsTable tbody td {
            padding: 6px 6px;
            vertical-align: middle;
            border-bottom: 1px solid #f1f1f1;
        }
        .badge-sm {
            font-size: 0.65rem;
            padding: 2px 6px;
        }
        
        /* Responsive adjustments for transaction logs */
        @media (max-width: 1199px) {
            .col-lg-4 {
                margin-bottom: 1rem;
            }
        }
        
        /* QR Scanner Styles */
        .qr-scanner-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .qr-scanner-video {
            width: 100%;
            height: auto;
            border-radius: 8px;
            background: #000;
        }
        
        .qr-scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .qr-scanner-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid #28a745;
            border-radius: 12px;
            background: rgba(40, 167, 69, 0.1);
            pointer-events: none;
        }
        
        .qr-scanner-guide::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px dashed #28a745;
            border-radius: 12px;
            animation: qr-pulse 2s infinite;
        }
        
        @keyframes qr-pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        .qr-scanner-status {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            text-align: center;
            min-width: 200px;
        }
        
        .qr-scanner-canvas {
            display: none;
        }
        
        .camera-access-error {
            text-align: center;
            padding: 40px 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }
        
        @media (max-width: 991px) {
            .transaction-logs-container {
                height: 400px !important;
            }
        }
        
        .loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .gate-selector {
            border-left: 3px solid #667eea;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        .gate-selector:focus {
            border-left-color: #764ba2;
            box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
        }
        .plate-number {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #2c3e50;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 4px 8px;
            border-radius: 6px;
            border: 2px solid #dee2e6;
            display: inline-block;
        }
        .vehicle-actions {
            display: flex;
            gap: 4px;
        }
        .vehicle-plate {
            flex: 1;
        }
        .add-vehicle-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
            display: none; /* Hidden by default */
        }
        .add-vehicle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6);
        }
        
        .qr-scanner-btn {
            position: fixed;
            bottom: 30px;
            right: 100px; /* Position to the left of add button */
            width: 60px;
            height: 60px;
            border-radius: 50%;
            box-shadow: 0 4px 20px rgba(40, 167, 69, 0.4);
            z-index: 1000;
            transition: all 0.3s ease;
            display: none; /* Hidden by default */
        }
        
        .qr-scanner-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(40, 167, 69, 0.6);
        }
        .role-badge {
            font-size: 0.8rem;
            padding: 4px 8px;
        }
        .role-badge.super-admin {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }
        .role-badge.admin {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        .role-badge.security {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
        }
        .user-management-modal .modal-dialog {
            max-width: min(95vw, 900px);
            margin: 1rem auto;
        }
        .user-card {
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }
        .user-card.super-admin { border-left-color: #dc3545; }
        .user-card.admin { border-left-color: #28a745; }
        .user-card.security { border-left-color: #17a2b8; }
        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .permission-item {
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        /* Vehicle Management Enhancements */
        .table-responsive {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .table-responsive::-webkit-scrollbar {
            width: 6px;
        }
        
        .table-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Enhanced Action Buttons Styling */
        .vehicle-row .btn-group:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
        }
        
        .vehicle-row .btn:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
        }
        
        .vehicle-row .btn:active {
            transform: scale(0.98);
        }
        
        .vehicle-row .btn-primary:hover {
            background: linear-gradient(135deg, #0056b3 0%, #004085 100%) !important;
        }
        
        .vehicle-row .btn-success:hover {
            background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%) !important;
        }
        
        .vehicle-row .btn-danger:hover {
            background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%) !important;
        }
        
        .vehicle-row .btn[disabled] {
            background: #6c757d !important;
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%) !important;
            cursor: not-allowed !important;
            transform: none !important;
        }
        
        /* Add subtle animation on row hover */
        .vehicle-row:hover {
            background-color: #f8f9fa !important;
            transition: background-color 0.2s ease;
        }
        
        /* Improve button responsiveness on mobile */
        @media (max-width: 768px) {
            .vehicle-row .btn-group {
                box-shadow: none !important;
            }
            
            .vehicle-row .btn {
                font-size: 0.75rem !important;
                padding: 4px 8px !important;
            }
            
            .vehicle-row .btn:hover {
                transform: none;
            }
            
            .vehicle-row .btn:active {
                transform: scale(0.95);
                background-color: rgba(0,0,0,0.1);
            }
        }
        
        /* Role Badge Styles */
        .role-badge {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-radius: 4px;
            padding: 4px 8px;
            border: 1px solid;
        }
        
        .badge-super-admin {
            background: linear-gradient(135deg, #dc3545 0%, #bd2130 100%);
            color: white;
            border-color: #bd2130;
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
        }
        
        .badge-admin {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border-color: #0056b3;
            box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
        }
        
        .badge-security {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
            border-color: #1e7e34;
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
        }
        
        /* Role badge hover effects */
        .role-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-5">
                    <div class="login-card">
                        <div class="login-header">
                            <i class="bi bi-truck fs-1 mb-3"></i>
                            <h1 class="h3 mb-0">Vehicle Monitoring System</h1>
                            <p class="mb-0 mt-2 opacity-75">Sign in to your account</p>
                        </div>
                        
                        <div class="p-4">
                            <div id="loginMsg" class="mb-3"></div>
                            
                            <form onsubmit="event.preventDefault(); login();">
                                <div class="mb-3">
                                    <label class="form-label" for="username">
                                        <i class="bi bi-person me-2"></i>Username
                                    </label>
                                    <input type="text" class="form-control" id="username" required>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="form-label" for="password">
                                        <i class="bi bi-lock me-2"></i>Password
                                    </label>
                                    <input type="password" class="form-control" id="password" required>
                                </div>
                                
                                <button type="submit" id="loginBtn" class="btn btn-primary w-100">
                                    <i class="bi bi-box-arrow-in-right me-2"></i>Sign In
                                </button>
                            </form>
                            
                            <!-- <div class="text-center mt-4">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    Default admin: admin / admin123
                                </small>
                            </div> -->

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="dashboard-page hidden">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <i class="bi bi-truck me-2"></i><span class="d-none d-sm-inline">Vehicle Monitoring System</span><span class="d-inline d-sm-none">VMS</span>
                </a>
                  <span class="navbar-text me-3">
                      <i class="bi bi-person-circle me-1"></i>
                      <span id="currentRole" class="badge role-badge"></span>
                      <small class="text-light ms-1">(<span id="currentUsername"></span>)</small>
                  </span>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarContent">
                    <div class="navbar-nav ms-auto">
                    <button class="btn btn-outline-light btn-sm me-3" id="vehicleManagementBtn" style="display: none;" onclick="showVehicleManagement()">
                        <i class="bi bi-truck me-1"></i>Manage Vehicles
                    </button>
                    <button class="btn btn-outline-light btn-sm me-3" id="gateManagementBtn" style="display: none;" onclick="showGateManagement()">
                        <i class="bi bi-door-open me-1"></i>Manage Gates
                    </button>
                    <div class="dropdown me-3" id="userManagementDropdown" style="display: none;">
                        <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-people me-1"></i>Users
                        </button>
                        <ul class="dropdown-menu">
                            <li><button type="button" class="dropdown-item" onclick="showUserManagement()">
                                <i class="bi bi-person-gear me-2"></i>Manage Users
                            </button></li>
                            <li><button type="button" class="dropdown-item" onclick="showRoleSettings()">
                                <i class="bi bi-shield-check me-2"></i>Role Settings
                            </button></li>
                        </ul>
                    </div>
                   
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">
                        <i class="bi bi-box-arrow-right me-1"></i>Logout
                    </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container-fluid py-4">
            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <div class="card stats-card">
                        <div class="card-body">
                            <i class="bi bi-truck stats-icon"></i>
                            <h3 class="stats-number" id="totalVehicles">0</h3>
                            <p class="stats-label">Total Vehicles</p>
                            <div class="stats-percentage" id="totalVehiclesChange">
                                <i class="bi bi-dash"></i> Registered
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card stats-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                        <div class="card-body">
                            <i class="bi bi-arrow-down-circle stats-icon"></i>
                            <h3 class="stats-number" id="vehiclesIn">0</h3>
                            <p class="stats-label">Vehicles In</p>
                            <div class="stats-percentage" id="vehiclesInPercentage">
                                <i class="bi bi-percent"></i> <span>0%</span> of total
                            </div>
                            <div class="stats-progress">
                                <div class="stats-progress-bar" id="vehiclesInProgress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card stats-card" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                        <div class="card-body">
                            <i class="bi bi-arrow-up-circle stats-icon"></i>
                            <h3 class="stats-number" id="vehiclesOut">0</h3>
                            <p class="stats-label">Vehicles Out</p>
                            <div class="stats-percentage" id="vehiclesOutPercentage">
                                <i class="bi bi-percent"></i> <span>0%</span> of total
                            </div>
                            <div class="stats-progress">
                                <div class="stats-progress-bar" id="vehiclesOutProgress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Summary Card -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="summary-card">
                        <div class="summary-stats">
                            <div class="summary-item">
                                <i class="bi bi-clock-history text-info"></i>
                                <p class="value" id="lastUpdate">Just now</p>
                                <p class="label">Last Update</p>
                            </div>
                            <div class="summary-item">
                                <i class="bi bi-geo-alt-fill text-warning"></i>
                                <p class="value" id="activeGateDisplay">-</p>
                                <p class="label">Active Gate</p>
                            </div>
                            <div class="summary-item">
                                <i class="bi bi-arrow-left-right text-secondary"></i>
                                <p class="value" id="recentActivity">0</p>
                                <p class="label">Today's Activity</p>
                            </div>
                            <div class="summary-item">
                                <i class="bi bi-check-circle-fill text-success"></i>
                                <p class="value" id="accessCount">0</p>
                                <p class="label">Access Allowed</p>
                            </div>
                            <div class="summary-item">
                                <i class="bi bi-exclamation-triangle-fill text-warning"></i>
                                <p class="value" id="noAccessCount">0</p>
                                <p class="label">No Access</p>
                            </div>
                            <div class="summary-item">
                                <i class="bi bi-x-circle-fill text-danger"></i>
                                <p class="value" id="bannedCount">0</p>
                                <p class="label">Banned</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="row mb-4">
                <div class="col-12 col-md-3 mb-2 mb-md-0">
                    <label class="form-label mb-1 d-none d-md-block">
                        <small>
                            <i class="bi bi-search me-1"></i>Search by:
                            <i class="bi bi-info-circle ms-1 text-primary" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top" 
                               title="Search across: Plate Number, Model/Make, Department, Current Driver, and Assigned Drivers"
                               style="cursor: help;"></i>
                        </small>
                    </label>
                    <input type="text" class="form-control" id="searchInput" 
                           placeholder="Search plate, model, department, driver..." 
                           onkeyup="debounceFilter()"
                           title="Search by plate number, model/make, department, or driver"
                           autocomplete="off">
                    <small class="text-muted d-none d-md-block mt-1">
                        <i class="bi bi-lightbulb me-1"></i>Tip: Type any part of plate, model, dept, or driver name
                    </small>
                </div>
                <div class="col-6 col-md-2 mb-2 mb-md-0">
                    <label class="form-label mb-1 d-none d-md-block">
                        <small><i class="bi bi-filter me-1"></i>Status:</small>
                    </label>
                    <select class="form-select" id="filterStatus" onchange="filterVehicles()">
                        <option value="">All Status</option>
                        <option value="IN">üü¢ Checked IN</option>
                        <option value="OUT">üî¥ Checked OUT</option>
                    </select>
                </div>
                <div class="col-6 col-md-2 mb-2 mb-md-0">
                    <label class="form-label mb-1 d-none d-md-block">
                        <small><i class="bi bi-shield me-1"></i>Access:</small>
                    </label>
                    <select class="form-select" id="filterAccessStatus" onchange="filterVehicles()">
                        <option value="">All Access</option>
                        <option value="Access">‚úÖ Access</option>
                        <option value="No Access">‚ö†Ô∏è No Access</option>
                        <option value="Banned">üö´ Banned</option>
                    </select>
                </div>
                <div class="col-6 col-md-2 mb-2 mb-md-0">
                    <label class="form-label mb-1 d-none d-md-block">
                        <small><i class="bi bi-geo-alt me-1"></i>Gate:</small>
                    </label>
                    <div class="input-group">
                        <select class="form-select gate-selector" id="gateSelector">
                            <option value="">Loading...</option>
                        </select>
                        <button class="btn btn-outline-secondary" type="button" onclick="refreshGateSelector()" title="Refresh gates">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                </div>
                <div class="col-12 col-md-3 text-center text-md-end mt-2 mt-md-0 d-flex align-items-end justify-content-center justify-content-md-end gap-2">
                    <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()" title="Clear all filters">
                        <i class="bi bi-x-circle me-1"></i><span class="d-none d-lg-inline">Clear</span>
                    </button>
                    <button class="btn btn-primary" onclick="refreshDashboard()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                    </button>
                </div>
            </div>

            <!-- Pagination Controls -->
            <div class="row mb-3" id="paginationRow" style="display: none;">
                <div class="col-12">
                    <nav aria-label="Vehicle list pagination">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="pagination-info">
                                <small class="text-muted" id="paginationInfo">Showing 1-50 of 1500 vehicles</small>
                            </div>
                            <ul class="pagination pagination-sm mb-0">
                                <li class="page-item" id="prevPageItem">
                                    <button class="page-link" onclick="changePage('prev')" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </button>
                                </li>
                                <li class="page-item active" id="currentPageItem">
                                    <span class="page-link" id="currentPageNumber">1</span>
                                </li>
                                <li class="page-item" id="nextPageItem">
                                    <button class="page-link" onclick="changePage('next')" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </button>
                                </li>
                            </ul>
                            <div class="page-size-selector">
                                <small class="text-muted me-2">Show:</small>
                                <select class="form-select form-select-sm d-inline-block w-auto" id="pageSizeSelector" onchange="changePageSize()">
                                    <option value="25">25</option>
                                    <option value="50" selected>50</option>
                                    <option value="100">100</option>
                                    <option value="200">200</option>
                                </select>
                            </div>
                        </div>
                    </nav>
                </div>
            </div>

            <!-- Vehicle Table and Transaction Logs -->
            <div class="row">
                <!-- Vehicles Table -->
                <div class="col-lg-8">
                    <div class="card h-100">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-car-front me-2"></i>
                                Vehicle List
                                <span class="badge bg-light text-primary ms-2" id="totalVehiclesBadge">0</span>
                            </h5>
                            <div class="d-flex gap-2">
                                <span class="badge bg-success d-flex align-items-center">
                                    <i class="bi bi-arrow-down-circle me-1"></i>
                                    IN: <span id="vehiclesInBadge" class="ms-1">0</span>
                                </span>
                                <span class="badge bg-danger d-flex align-items-center">
                                    <i class="bi bi-arrow-up-circle me-1"></i>
                                    OUT: <span id="vehiclesOutBadge" class="ms-1">0</span>
                                </span>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="vehicle-logs-container" style="height: 600px; overflow-y: auto;">
                                <table class="table table-sm table-hover mb-0" id="vehiclesTable">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th style="width: 60px; font-size: 0.85rem;">ID</th>
                                            <th style="width: 90px; font-size: 0.85rem;">Plate #</th>
                                            <th style="width: 110px; font-size: 0.85rem;">Make/Model</th>
                                            <th style="width: 80px; font-size: 0.85rem;" class="d-none d-md-table-cell">Department</th>
                                            <th style="width: 80px; font-size: 0.85rem;" class="d-none d-lg-table-cell">Driver</th>
                                            <th style="width: 60px; font-size: 0.85rem;" class="text-center">Status</th>
                                            <th style="width: 70px; font-size: 0.85rem;" class="d-none d-xl-table-cell">Access</th>
                                            <th style="width: 60px; font-size: 0.85rem;" class="text-center">Actions</th>
                                            <th style="width: 75px; font-size: 0.85rem;" class="text-center">Transaction</th>
                                        </tr>
                                    </thead>
                                    <tbody id="vehiclesTableBody">
                                        <tr>
                                            <td colspan="9" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p class="mt-2 text-muted">Loading vehicles...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="noVehiclesMessage" class="text-center py-4 d-none">
                                <i class="bi bi-car-front text-muted" style="font-size: 3rem;"></i>
                                <p class="text-muted mt-2 mb-0">No vehicles found</p>
                                <small class="text-muted">Try adjusting your search criteria</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transaction Logs Column -->
                <div class="col-lg-4">
                    <div class="card h-100">
                        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="bi bi-clock-history me-2"></i>
                                Recent Transactions
                                <span class="badge bg-light text-secondary ms-2" id="transactionCount">50</span>
                            </h6>
                            <button class="btn btn-sm btn-light" onclick="refreshTransactionLogs()" title="Refresh logs">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="transaction-logs-container" style="height: 600px; overflow-y: auto;">
                                <table class="table table-sm table-hover mb-0" id="transactionLogsTable">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th style="width: 80px; font-size: 0.85rem; padding: 8px 8px;">Time</th>
                                            <th style="width: 70px; font-size: 0.85rem; padding: 8px 8px;">Plate</th>
                                            <th style="width: 60px; font-size: 0.85rem; padding: 8px 8px;">Gate</th>
                                            <th style="width: 50px; font-size: 0.85rem; padding: 8px 8px;" class="text-center">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactionLogsBody">
                                        <tr>
                                            <td colspan="4" class="text-center py-3">
                                                <div class="spinner-border spinner-border-sm text-secondary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p class="mt-2 text-muted mb-0 small">Loading logs...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="noTransactionsMessage" class="text-center py-3 d-none">
                                <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                                <p class="text-muted mt-2 mb-0 small">No transactions found</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner hidden">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- QR Scanner Button -->
    <button class="btn btn-success qr-scanner-btn" onclick="showQRScanner()" title="QR Code Scanner" id="qrScannerBtn">
        <i class="bi bi-qr-code fs-4"></i>
    </button>
    
    <!-- Add Vehicle Button -->
    <button class="btn btn-primary add-vehicle-btn" onclick="showVehicleManagement()" title="Manage Vehicles" id="addVehicleBtn">
        <i class="bi bi-plus-lg fs-4"></i>
    </button>

    


    <!-- Vehicle Details Modal -->
    <div class="modal fade" id="vehicleDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailsModalTitle">Vehicle Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailsModalBody">
                    <!-- Details will be loaded here -->
                </div>
                <div class="modal-footer" id="detailsModalFooter">
                    <!-- Action buttons will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Vehicle Modal -->
    <div class="modal fade" id="editVehicleModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil-square me-2"></i>Edit Vehicle
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Loading Overlay -->
                    <div id="editVehicleLoading" class="d-none position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-white bg-opacity-75" style="z-index: 1050;">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-2 text-muted">Saving changes...</div>
                        </div>
                    </div>
                    <form id="editVehicleForm">
                        <input type="hidden" id="editVehicleIndex">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Plate Number <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editPlateNumber" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Make/Model <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="editModel" required>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Color</label>
                                    <input type="text" class="form-control" id="editColor">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Year</label>
                                    <input type="number" class="form-control" id="editYear" min="1900" max="2030">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Type</label>
                                    <select class="form-select" id="editType">
                                        <option value="Car">Car</option>
                                        <option value="Truck">Truck</option>
                                        <option value="Van">Van</option>
                                        <option value="Motorcycle">Motorcycle</option>
                                        <option value="Bus">Bus</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Department/Company</label>
                                    <input type="text" class="form-control" id="editDepartment">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Current Driver</label>
                                    <select class="form-select" id="editDriver">
                                        <option value="">Select a driver...</option>
                                        <!-- Options will be loaded dynamically -->
                                    </select>
                                    <div class="form-text">Currently assigned driver</div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Assigned Drivers</label>
                                    <input type="text" class="form-control" id="editAssignedDrivers" placeholder="Comma separated IDs">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Access Status</label>
                                    <select class="form-select" id="editAccessStatus">
                                        <option value="Access">Access</option>
                                        <option value="No Access">No Access</option>
                                        <option value="Banned">Banned</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="editStatus">
                                        <option value="OUT">Checked Out</option>
                                        <option value="IN">Checked In</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="saveVehicleEdit()">
                        <i class="bi bi-check-lg me-2"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Enhanced User Management Modal -->
    <div class="modal fade user-management-modal" id="userManagementModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h4 class="modal-title fw-bold">
                        <i class="bi bi-people-fill me-3"></i>User Management Dashboard
                    </h4>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Header with Search and Add Button -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center gap-3">
                            <h5 class="mb-0 text-primary fw-bold">
                                <i class="bi bi-list-ul me-2"></i>
                                User Directory
                                <span class="badge bg-primary ms-2" id="totalUsersCount">0</span>
                            </h5>
                        </div>
                        <div class="d-flex gap-2">
                            <div class="input-group" style="width: 300px;">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="bi bi-search text-muted"></i>
                                </span>
                                <input type="text" class="form-control border-start-0" id="userSearchInput" 
                                       placeholder="Search users..." onkeyup="filterUsers()">
                            </div>
                            <button class="btn btn-primary px-4" onclick="showAddUserForm()">
                                <i class="bi bi-plus-circle me-2"></i>Add User
                            </button>
                            <button class="btn btn-outline-secondary" onclick="loadUsers()" title="Refresh">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quick Add Form (Initially Hidden) -->
                    <div id="userForm" class="mb-4" style="display: none;">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light border-0">
                                <h6 class="mb-0 text-primary fw-bold" id="userFormTitle">‚ú® Add New User</h6>
                            </div>
                            <div class="card-body">
                                <form id="addEditUserForm">
                                    <input type="hidden" id="editUserIndex" value="-1">
                                    
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label class="form-label fw-semibold">Username *</label>
                                            <input type="text" class="form-control" id="userUsername" required 
                                                   placeholder="john_doe">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-semibold">Full Name *</label>
                                            <input type="text" class="form-control" id="userFullName" required 
                                                   placeholder="John Doe">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-semibold">Email *</label>
                                            <input type="email" class="form-control" id="userEmail" required 
                                                   placeholder="john@company.com">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-semibold">Role *</label>
                                            <select class="form-select" id="userRole" required>
                                                <option value="security">Security</option>
                                                <option value="admin">Admin</option>
                                                <option value="super-admin">Super Admin</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-semibold">
                                                Password *
                                                <small class="text-muted" id="passwordRequiredLabel">(Min 6 chars)</small>
                                                <small class="text-muted d-none" id="passwordOptionalLabel">(Leave blank to keep current)</small>
                                            </label>
                                            <div class="input-group">
                                                <input type="password" class="form-control" id="userPassword" 
                                                       placeholder="Enter password" minlength="6">
                                                <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility()">
                                                    <i class="bi bi-eye" id="passwordToggleIcon"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-semibold">Confirm Password *</label>
                                            <input type="password" class="form-control" id="userPasswordConfirm" 
                                                   placeholder="Confirm password" minlength="6" oninput="validatePasswords()">
                                            <div class="invalid-feedback" id="passwordMismatchError">
                                                Passwords do not match
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-semibold">Status *</label>
                                            <select class="form-select" id="userStatus" required>
                                                <option value="active">‚úÖ Active</option>
                                                <option value="inactive">‚è∏Ô∏è Inactive</option>
                                                <option value="suspended">üö´ Suspended</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex gap-2 mt-4">
                                        <button type="button" class="btn btn-primary px-4" onclick="saveUser()">
                                            <i class="bi bi-check-circle me-2"></i>Save User
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary px-4" onclick="cancelUserForm()">
                                            <i class="bi bi-x-circle me-2"></i>Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Modern User Table -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                <table class="table table-hover mb-0" id="usersDataTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="px-4 py-3 border-0">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-person-circle me-2 text-primary"></i>
                                                    <span class="fw-bold">User</span>
                                                </div>
                                            </th>
                                            <th class="px-4 py-3 border-0">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-shield-check me-2 text-success"></i>
                                                    <span class="fw-bold">Role</span>
                                                </div>
                                            </th>
                                            <th class="px-4 py-3 border-0">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-envelope me-2 text-info"></i>
                                                    <span class="fw-bold">Contact</span>
                                                </div>
                                            </th>
                                            <th class="px-4 py-3 border-0">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-circle-fill me-2 text-warning"></i>
                                                    <span class="fw-bold">Status</span>
                                                </div>
                                            </th>
                                            <th class="px-4 py-3 border-0">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-calendar3 me-2 text-secondary"></i>
                                                    <span class="fw-bold">Created</span>
                                                </div>
                                            </th>
                                            <th class="px-4 py-3 border-0 text-center">
                                                <div class="d-flex align-items-center justify-content-center">
                                                    <i class="bi bi-gear me-2 text-dark"></i>
                                                    <span class="fw-bold">Actions</span>
                                                </div>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="userTableBody">
                                        <!-- Dynamic content will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loading/Empty State -->
                    <div id="userListContainer" class="d-none">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3 text-muted">Loading users...</p>
                        </div>
                    </div>
                    
                    <!-- No Users State -->
                    <div id="noUsersState" class="text-center py-5 d-none">
                        <div class="mb-4">
                            <i class="bi bi-people text-muted" style="font-size: 4rem;"></i>
                        </div>
                        <h5 class="text-muted">No Users Found</h5>
                        <p class="text-muted mb-4">Get started by adding your first user to the system.</p>
                        <button class="btn btn-primary" onclick="showAddUserForm()">
                            <i class="bi bi-plus-circle me-2"></i>Add First User
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Role Settings Modal -->
    <div class="modal fade" id="roleSettingsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="bi bi-shield-check me-2"></i>Role Settings & Permissions
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-12 mb-4">
                            <h6>Role Hierarchy & Permissions</h6>
                            <div class="permissions-grid">
                                <div class="permission-item">
                                    <div class="role-badge super-admin mb-2">Super Admin</div>
                                    <small>
                                        ‚Ä¢ Full system access<br>
                                        ‚Ä¢ Manage all users<br>
                                        ‚Ä¢ All vehicle operations<br>
                                        ‚Ä¢ System configuration
                                    </small>
                                </div>
                                <div class="permission-item">
                                    <div class="role-badge admin mb-2">Admin</div>
                                    <small>
                                        ‚Ä¢ Manage vehicles<br>
                                        ‚Ä¢ Manage gates<br>
                                        ‚Ä¢ Manage users (except Super Admin)<br>
                                        ‚Ä¢ View all reports
                                    </small>
                                </div>
                                <div class="permission-item">
                                    <div class="role-badge security mb-2">Security</div>
                                    <small>
                                        ‚Ä¢ Check in/out vehicles<br>
                                        ‚Ä¢ View vehicle status<br>
                                        ‚Ä¢ Basic gate operations<br>
                                        ‚Ä¢ View assigned areas<br>
                                        ‚Ä¢ QR code scanning
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gate Management Modal -->
    <div class="modal fade" id="gateManagementModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-door-open me-2"></i>Gate Management
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Manage Gates</h6>
                        <button class="btn btn-primary btn-sm" onclick="showAddGateForm()">
                            <i class="bi bi-plus-lg me-1"></i>Add Gate
                        </button>
                    </div>
                    
                    <!-- Add/Edit Form -->
                    <div id="gateForm" class="mb-3" style="display: none;">
                        <div class="card">
                            <div class="card-body">
                                <h6 id="gateFormTitle">Add New Gate</h6>
                                <form id="addEditGateForm">
                                    <input type="hidden" id="editGateIndex" value="-1">
                                    <div class="mb-3">
                                        <label for="gateName" class="form-label">Gate Name *</label>
                                        <input type="text" class="form-control" id="gateName" required 
                                               placeholder="e.g., Main Gate">
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-primary" onclick="saveGate()">
                                            <i class="bi bi-check-lg me-1"></i>Save
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="cancelGateForm()">
                                            Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gate List -->
                    <div id="gateListContainer">
                        <div class="text-center py-3">
                            <div class="spinner-border" role="status"></div>
                            <p class="mt-2 text-muted">Loading gates...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vehicle Management Modal -->
    <div class="modal fade" id="vehicleManagementModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-truck me-2"></i>Vehicle Management
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Loading Overlay -->
                    <div id="addVehicleLoading" class="d-none position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-white bg-opacity-75" style="z-index: 1050;">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-2 text-muted">Adding vehicle...</div>
                        </div>
                    </div>
                    <h6 class="mb-3">Add New Vehicle</h6>
                    
                    <!-- Add Vehicle Form -->
                    <form id="addVehicleForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vehiclePlateNumber" class="form-label">Plate Number *</label>
                                    <input type="text" class="form-control" id="vehiclePlateNumber" required 
                                           placeholder="e.g., ABC-123">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vehicleModel" class="form-label">Make/Model *</label>
                                    <input type="text" class="form-control" id="vehicleModel" required 
                                           placeholder="e.g., Toyota Camry">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vehicleColor" class="form-label">Color</label>
                                    <input type="text" class="form-control" id="vehicleColor" 
                                           placeholder="e.g., White">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vehicleDepartment" class="form-label">Department/Company</label>
                                    <input type="text" class="form-control" id="vehicleDepartment" 
                                           placeholder="e.g., IT Department">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="vehicleYear" class="form-label">Year</label>
                                    <input type="number" class="form-control" id="vehicleYear" 
                                           placeholder="2023" min="1900" max="2030">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="vehicleType" class="form-label">Type</label>
                                    <select class="form-select" id="vehicleType">
                                        <option value="Car">Car</option>
                                        <option value="Truck">Truck</option>
                                        <option value="Van">Van</option>
                                        <option value="SUV">SUV</option>
                                        <option value="Motorcycle">Motorcycle</option>
                                        <option value="Bus">Bus</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="vehicleStatus" class="form-label">Status</label>
                                    <select class="form-select" id="vehicleStatus">
                                        <option value="OUT">OUT</option>
                                        <option value="IN">IN</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vehicleDriver" class="form-label">Current Driver</label>
                                    <input type="text" class="form-control" id="vehicleDriver" 
                                           placeholder="Driver name or ID">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vehicleAccessStatus" class="form-label">Access Status</label>
                                    <select class="form-select" id="vehicleAccessStatus">
                                        <option value="Access">Access</option>
                                        <option value="No Access">No Access</option>
                                        <option value="Banned">Banned</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="vehicleAssignedDrivers" class="form-label">Assigned Drivers</label>
                            <input type="text" class="form-control" id="vehicleAssignedDrivers" 
                                   placeholder="Comma-separated driver names or IDs">
                            <small class="text-muted">Enter multiple drivers separated by commas</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveVehicle()">
                        <i class="bi bi-check-lg me-2"></i>Add Vehicle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div class="modal fade" id="qrScannerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-qr-code me-2"></i>QR Code Scanner
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" onclick="stopQRScanner()"></button>
                </div>
                <div class="modal-body">
                    <!-- Gates Dropdown at the top -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0"><i class="bi bi-door-open me-1"></i>Select Gate:</label>
                                <select class="form-select" id="qrGateSelect" style="flex: 1;">
                                    <option value="">Loading gates...</option>
                                </select>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="loadGatesForQRScanner()" title="Refresh gates">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3">Camera Scanner</h6>
                            <div class="qr-scanner-container" id="qrScannerContainer">
                                <video id="qrScannerVideo" class="qr-scanner-video" autoplay playsinline></video>
                                <canvas id="qrScannerCanvas" class="qr-scanner-canvas"></canvas>
                                <div class="qr-scanner-overlay">
                                    <div class="qr-scanner-guide"></div>
                                    <div class="qr-scanner-status" id="qrScannerStatus">
                                        Position QR code within the frame
                                    </div>
                                </div>
                                <div class="camera-access-error d-none" id="cameraError">
                                    <i class="bi bi-camera-video-off fs-1 text-muted mb-3"></i>
                                    <h6>Camera Access Required</h6>
                                    <p class="text-muted">Please allow camera access to scan QR codes.<br>Refresh the page and try again.</p>
                                    <button class="btn btn-primary btn-sm" onclick="initQRScanner()">
                                        <i class="bi bi-camera me-1"></i>Request Camera Access
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">Scan Result</h6>
                            <div class="scan-result-container" id="scanResultContainer">
                                <div class="text-center text-muted py-4" id="noScanResult">
                                    <i class="bi bi-qr-code-scan fs-1 mb-3"></i>
                                    <p>Scan a QR code to view vehicle details</p>
                                </div>
                                <div class="d-none" id="scanResultData">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-truck me-2"></i>Vehicle Information
                                            </h6>
                                            <div class="mb-3">
                                                <strong>Plate Number:</strong>
                                                <span class="ms-2 badge bg-primary" id="scannedPlate">-</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Access Status:</strong>
                                                <span class="ms-2 badge" id="scannedAccessStatus">-</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Current Status:</strong>
                                                <span class="ms-2 badge" id="scannedCurrentStatus">-</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Driver:</strong>
                                                <span class="ms-2" id="scannedDriver">-</span>
                                            </div>
                                            <div class="alert alert-info" id="nextActionInfo">
                                                <i class="bi bi-info-circle me-2"></i>
                                                <span id="nextActionText">Select a gate to log transaction</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Transaction Form -->
                            <div class="d-none" id="transactionForm">
                                <div class="card mt-3">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="bi bi-door-open me-2"></i>Log Transaction
                                        </h6>
                                        <form id="qrTransactionForm">
                                            <div class="mb-3">
                                                <label class="form-label">Action</label>
                                                <div class="btn-group w-100" role="group">
                                                    <input type="radio" class="btn-check" name="qrAction" id="qrActionIN" value="IN">
                                                    <label class="btn btn-outline-success" for="qrActionIN">
                                                        <i class="bi bi-arrow-left me-1"></i>Vehicle IN
                                                    </label>
                                                    <input type="radio" class="btn-check" name="qrAction" id="qrActionOUT" value="OUT">
                                                    <label class="btn btn-outline-danger" for="qrActionOUT">
                                                        <i class="bi bi-arrow-right me-1"></i>Vehicle OUT
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Driver ID</label>
                                                <input type="text" class="form-control" id="qrDriverId" placeholder="Driver ID">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">Remarks (Optional)</label>
                                                <input type="text" class="form-control" id="qrRemarks" placeholder="Additional notes">
                                            </div>
                                            <button type="submit" class="btn btn-primary w-100">
                                                <i class="bi bi-check-lg me-1"></i>Log Transaction
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="initQRScanner()" id="restartScannerBtn">
                       Next Vehicle <i class="bi-car-front-fill"></i> 
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

    <!-- Load scripts with defer for better performance -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
    <script>
        let currentUser = null;
        let vehicleData = [];
        let allVehicles = [];
        let userPermissions = null; // Store user permissions from backend
        
        // Session management functions
        function saveSession() {
            if (currentUser) {
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                console.log('Session saved for user:', currentUser.username);
            }
        }
        
        function clearSession() {
            sessionStorage.removeItem('currentUser');
            sessionStorage.removeItem('selectedGate');
            sessionStorage.removeItem('todayActivity');
            console.log('Session cleared');
        }
        
        function restoreSession() {
            try {
                const storedUser = sessionStorage.getItem('currentUser');
                if (storedUser) {
                    currentUser = JSON.parse(storedUser);
                    console.log('Session restored for user:', currentUser.username, 'with role:', currentUser.role);
                    return true;
                }
            } catch (error) {
                console.error('Error restoring session:', error);
                clearSession();
            }
            return false;
        }
        
        // Table optimization configuration
        const DISPLAY_BATCH_SIZE = 100; // Load vehicles in batches for large datasets
        let filterTimeout = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Application starting...');
            
            // Initialize Bootstrap tooltips
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
            
            // Check for existing session first
            checkExistingSession();
            
            // Preload critical resources
            preloadResources();
        });
        
        function checkExistingSession() {
            // Try to restore session using the new function
            if (restoreSession()) {
                console.log('User session restored, fetching permissions and showing dashboard');
                
                // Fetch permissions for the restored session
                fetchUserPermissions()
                    .then(() => {
                        showDashboard();
                    })
                    .catch((error) => {
                        console.error('Failed to load permissions for restored session:', error);
                        // Still show dashboard but warn user
                        showMessage('Session restored but failed to load permissions. Please refresh the page.', 'warning');
                        showDashboard();
                    });
            } else {
                console.log('No valid session found, showing login page');
                showLoginPage();
            }
        }

        // Duplicate functions removed - using the ones defined earlier

        function preloadResources() {
            // Preload images and icons that will be used
            const imagesToPreload = [
                'bi-truck', 'bi-arrow-down-circle', 'bi-arrow-up-circle',
                'bi-person-fill', 'bi-people-fill', 'bi-building'
            ];
            
            // Create a hidden div to trigger icon font loading
            const preloadDiv = document.createElement('div');
            preloadDiv.style.position = 'absolute';
            preloadDiv.style.left = '-9999px';
            preloadDiv.style.visibility = 'hidden';
            
            imagesToPreload.forEach(icon => {
                const i = document.createElement('i');
                i.className = `bi ${icon}`;
                preloadDiv.appendChild(i);
            });
            
            document.body.appendChild(preloadDiv);
            
            // Remove after a short delay
            setTimeout(() => preloadDiv.remove(), 100);
        }

        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('dashboardPage').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('dashboardPage').classList.remove('hidden');
            
            // Update user role display
            const usernameElement = document.getElementById('currentUsername');
            usernameElement.textContent = currentUser.username;
            
            // Update role badge using the dedicated function
            updateRoleBadge(currentUser.role);
            
            // Show/hide features based on role permissions (only if permissions are loaded)
            if (userPermissions) {
                updateUIBasedOnRole();
            } else {
                console.warn('Permissions not loaded yet when showing dashboard');
            }
            
            loadVehicles();
            loadActiveGates();
            loadTransactionLogs();
            loadDatabaseStatistics(); // Load database statistics separately
            
            
            // Optimize for mobile
            optimizeForMobile();
            
            // Initialize filter UI
            initializeFilterUI();
        }

        function updateUIBasedOnRole() {
            if (!userPermissions) {
                console.warn('User permissions not loaded, cannot update UI');
                return;
            }
            
            const role = currentUser.role;
            console.log('Updating UI for role:', role);
            
            // Show/hide add vehicle button
            const addVehicleBtn = document.getElementById('addVehicleBtn');
            if (hasPermission('vehicles', 'create')) {
                addVehicleBtn.style.display = 'block';
            } else {
                addVehicleBtn.style.display = 'none';
            }
            
            // Show/hide QR scanner button  
            const qrScannerBtn = document.getElementById('qrScannerBtn');
            if (hasPermission('gates', 'transactions')) {
                qrScannerBtn.style.display = 'block';
            } else {
                qrScannerBtn.style.display = 'none';
            }
            
            // Show/hide user management dropdown (only super-admin)
            const userManagementDropdown = document.getElementById('userManagementDropdown');
            if (hasPermission('users', 'read') && role === 'super-admin') {
                userManagementDropdown.style.display = 'block';
            } else {
                userManagementDropdown.style.display = 'none';
            }
            
            // Show/hide vehicle management button
            const vehicleManagementBtn = document.getElementById('vehicleManagementBtn');
            if (hasPermission('vehicles', 'read') || hasPermission('vehicles', 'create')) {
                vehicleManagementBtn.style.display = 'inline-block';
            } else {
                vehicleManagementBtn.style.display = 'none';
            }
            
            // Show/hide gate management button (only super-admin)
            const gateManagementBtn = document.getElementById('gateManagementBtn');
            if ((hasPermission('gates', 'read') || hasPermission('gates', 'create')) && role === 'super-admin') {
                gateManagementBtn.style.display = 'inline-block';
            } else {
                gateManagementBtn.style.display = 'none';
            }
            
            // Update role badge with appropriate styling
            updateRoleBadge(role);
        }

        function updateRoleBadge(role) {
            const roleElement = document.getElementById('currentRole');
            if (roleElement) {
                // Remove existing role classes
                roleElement.classList.remove('badge-super-admin', 'badge-admin', 'badge-security');
                
                // Add appropriate class and text
                switch(role) {
                    case 'super-admin':
                        roleElement.classList.add('badge-super-admin');
                        roleElement.textContent = 'Super Admin';
                        break;
                    case 'admin':
                        roleElement.classList.add('badge-admin');
                        roleElement.textContent = 'Admin';
                        break;
                    case 'security':
                        roleElement.classList.add('badge-security');
                        roleElement.textContent = 'Security';
                        break;
                    default:
                        roleElement.textContent = role;
                }
            }
        }

        /**
         * Fetch user permissions from backend
         */
        function fetchUserPermissions() {
            if (!currentUser || !currentUser.role) {
                console.warn('No current user or role available');
                return Promise.resolve(false);
            }
            
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result && result.success) {
                            userPermissions = result.permissions;
                            console.log('User permissions loaded:', userPermissions);
                            resolve(true);
                        } else {
                            console.error('Failed to load permissions:', result.error);
                            reject(result.error || 'Failed to load permissions');
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error fetching permissions:', error);
                        reject(error);
                    })
                    .getPermissionsForFrontend(currentUser.role);
            });
        }

        /**
         * Check if user has specific permission based on backend permission system
         * @param {string} resource - Resource type (users, vehicles, gates, system)
         * @param {string} action - Action type (create, read, update, delete, etc.)
         * @returns {boolean} - Whether permission is granted
         */
        function hasPermission(resource, action) {
            if (!userPermissions || !currentUser) {
                console.warn('User permissions not loaded or no current user');
                return false;
            }
            
            const resourcePerms = userPermissions[resource];
            if (!resourcePerms) {
                console.warn(`Resource '${resource}' not found in permissions`);
                return false;
            }
            
            return resourcePerms[action] === true;
        }

        /**
         * Legacy permission check function for backward compatibility
         * Maps old permission strings to new resource/action format
         */
        function hasLegacyPermission(permission) {
            const permissionMap = {
                'manage_users': () => hasPermission('users', 'create') || hasPermission('users', 'update'),
                'manage_users_limited': () => hasPermission('users', 'create') || hasPermission('users', 'update'),
                'manage_vehicles': () => hasPermission('vehicles', 'create') || hasPermission('vehicles', 'update'),
                'manage_drivers': () => hasPermission('vehicles', 'updateDriver'),
                'manage_gates': () => hasPermission('gates', 'create') || hasPermission('gates', 'update'),
                'view_all': () => hasPermission('vehicles', 'read') || hasPermission('users', 'read'),
                'system_config': () => hasPermission('system', 'exportLogs') || hasPermission('system', 'clearData'),
                'scan_vehicles': () => hasPermission('gates', 'transactions'),
                'vehicle_operations': () => hasPermission('vehicles', 'updateDriver'),
                'gate_operations': () => hasPermission('gates', 'transactions'),
                'view_assigned': () => hasPermission('vehicles', 'read'),
                'full_system_access': () => currentUser.role === 'super-admin'
            };
            
            const checkFunction = permissionMap[permission];
            return checkFunction ? checkFunction() : false;
        }

        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            
            if (!username || !password) {
                showMessage('Please enter both username and password', 'danger');
                return;
            }

            loginBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Signing in...';
            loginBtn.disabled = true;

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        currentUser = { username: username, role: result.role };
                        saveSession(); // Save session to prevent logout on refresh
                        showMessage('Login successful!', 'success');
                        
                        // Fetch user permissions after successful login
                        fetchUserPermissions()
                            .then(() => {
                                setTimeout(() => {
                                    showDashboard();
                                }, 1000);
                            })
                            .catch((error) => {
                                console.error('Failed to load permissions:', error);
                                showMessage('Login successful but failed to load permissions. Some features may not work correctly.', 'warning');
                                setTimeout(() => {
                                    showDashboard();
                                }, 1000);
                            });
                    } else {
                        // Show specific error message if provided (for account status issues)
                        const errorMessage = result.message || 'Invalid username or password';
                        showMessage(errorMessage, 'danger');
                        resetLoginForm();
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Login error:', error);
                    showMessage('Login failed. Please try again.', 'danger');
                    resetLoginForm();
                })
                .loginUser(username, password);
        }

        function resetLoginForm() {
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.innerHTML = '<i class="bi bi-box-arrow-in-right me-2"></i>Sign In';
            loginBtn.disabled = false;
            document.getElementById('password').value = '';
        }

        function loadDatabaseStatistics() {
            // Load database statistics directly from the database
            google.script.run
                .withSuccessHandler(function(stats) {
                    if (stats && !stats.error) {
                        console.log('Database statistics loaded:', stats);
                        
                        // Update the main statistics cards with database data
                        animateNumber('totalVehicles', stats.totalRegistered || 0);
                        animateNumber('vehiclesIn', stats.totalIn || 0);
                        animateNumber('vehiclesOut', stats.totalOut || 0);
                        
                        // Update access status counts from database data
                        animateNumber('accessCount', stats.accessCount || 0);
                        animateNumber('noAccessCount', stats.noAccessCount || 0);
                        animateNumber('bannedCount', stats.bannedCount || 0);
                        
                        // Update percentages and progress bars
                        updatePercentages(stats.totalRegistered || 0, stats.totalIn || 0, stats.totalOut || 0);
                        
                        // Update summary stats
                        updateSummaryStats(stats.totalIn || 0);
                        
                        // Add pulse effect on update
                        addPulseEffect();
                        
                        console.log(`%c‚úÖ Database Statistics Loaded`, 'color: #28a745; font-weight: bold;', 
                                   `Total: ${stats.totalRegistered}, IN: ${stats.totalIn}, OUT: ${stats.totalOut}, Access: ${stats.accessCount}, No Access: ${stats.noAccessCount}, Banned: ${stats.bannedCount}`);
                    } else {
                        console.error('Error loading database statistics:', stats.error);
                        showToast('Failed to load database statistics', 'warning');
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading database statistics:', error);
                    showToast('Failed to load database statistics: ' + error, 'danger');
                })
                .getDatabaseStatistics();
        }

        function refreshDashboard() {
            // Refresh all dashboard data
            loadVehicles();
            loadDatabaseStatistics(); 
            loadTransactionLogs();
            showToast('Dashboard refreshed', 'success');
        }

        function loadVehicles(searchCriteria = {}) {
            showLoading(true);
            const startTime = performance.now();
            
            // Default search criteria for initial load
            const defaultCriteria = {
                searchTerm: '',
                statusFilter: '',
                accessStatusFilter: '',
                departmentFilter: '',
                pageSize: 50,
                pageOffset: 0,
                ...searchCriteria
            };
            
            console.log('Loading vehicles with criteria:', defaultCriteria);
            
            // Load vehicles and get total count for pagination
            Promise.all([
                new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .getVehicleList(defaultCriteria);
                }),
                new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .getVehicleCount(defaultCriteria);
                })
            ]).then(([vehicles, totalCount]) => {
                const loadTime = performance.now() - startTime;
                console.log(`Vehicles loaded: ${vehicles.length} in ${loadTime.toFixed(2)}ms`);
                
                allVehicles = vehicles || [];
                vehicleData = allVehicles;
                
                // Display vehicles and update pagination
                displayVehicles();
                updateStatistics();
                updatePaginationControls(vehicles.length - 1, totalCount); // Subtract header row
                showLoading(false);
                
                // Enhanced performance monitoring with actionable insights
                if (loadTime > 3000) {
                    console.warn('%c‚ö†Ô∏è Performance Alert', 'color: #ffc107; font-weight: bold;',
                        `\nüìà Load Time: ${(loadTime / 1000).toFixed(2)}s (Target: <3s)`
                        + `\nüìä Vehicle Count: ${vehicles.length} records loaded`
                        + '\nüîß Recommendations:'
                        + '\n   ‚Ä¢ Search terms help reduce dataset size'
                        + '\n   ‚Ä¢ Use filters to narrow results'
                        + '\n   ‚Ä¢ Check network connection stability'
                        + '\n   ‚Ä¢ Contact administrator if issue persists'
                        + '\nüí° Current system uses server-side search for better performance');
                    
                    // Show user-friendly notification for very slow loads
                    if (loadTime > 5000) {
                        showToast('Large dataset detected. Try using search filters for faster results.', 'info');
                    }
                } else {
                    console.log(`%c‚úÖ Performance Good`, 'color: #28a745; font-weight: bold;', `Load time: ${(loadTime / 1000).toFixed(2)}s`);
                }
            }).catch((error) => {
                console.error('Error loading vehicles:', error);
                showToast('Failed to load vehicles: ' + error, 'danger');
                showLoading(false);
                
                // Show retry option for network errors
                if (error.toString().includes('NetworkError')) {
                    setTimeout(() => {
                        if (confirm('Network error detected. Would you like to retry?')) {
                            loadVehicles(searchCriteria);
                        }
                    }, 1000);
                }
            });
        }

        function displayVehicles() {
            const vehiclesTableBody = document.getElementById('vehiclesTableBody');
            const noVehiclesMessage = document.getElementById('noVehiclesMessage');
            
            if (!vehiclesTableBody) {
                console.error('Vehicles table body not found');
                return;
            }

            // Clear existing content
            vehiclesTableBody.innerHTML = '';
            
            if (vehicleData.length <= 1) {
                // Show no vehicles message
                vehiclesTableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <i class="bi bi-car-front text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-2 mb-0">No vehicles found</p>
                            <small class="text-muted">Try adjusting your search criteria</small>
                        </td>
                    </tr>
                `;
                
                // Update badge counts
                document.getElementById('vehiclesInBadge').textContent = '0';
                document.getElementById('vehiclesOutBadge').textContent = '0';
                document.getElementById('totalVehiclesBadge').textContent = '0';
                return;
            }

            // Count vehicles by status
            let vehiclesInCount = 0;
            let vehiclesOutCount = 0;
            
            // Build table rows
            for (let i = 1; i < vehicleData.length; i++) {
                const vehicle = vehicleData[i];
                if (!vehicle || vehicle.length < 11) continue;

                const vehicleId = vehicle[0] || '';
                const plateNumber = vehicle[1] || '';
                const model = vehicle[2] || '';
                const color = vehicle[3] || '';
                const department = vehicle[4] || '';
                const year = vehicle[5] || '';
                const type = vehicle[6] || '';
                const status = vehicle[7] || 'OUT';
                const currentDriver = vehicle[8] || 'Unassigned';
                const assignedDrivers = vehicle[9] || '';
                const accessStatus = vehicle[10] || 'Access';

                // Count by status
                if (status === 'IN') {
                    vehiclesInCount++;
                } else {
                    vehiclesOutCount++;
                }

                // Create table row
                const row = createVehicleTableRow(
                    vehicleId, plateNumber, model, color, department, year, type, 
                    status, currentDriver, assignedDrivers, accessStatus, i
                );
                
                vehiclesTableBody.appendChild(row);
            }

            // Update badge counts
            document.getElementById('vehiclesInBadge').textContent = vehiclesInCount;
            document.getElementById('vehiclesOutBadge').textContent = vehiclesOutCount;
            document.getElementById('totalVehiclesBadge').textContent = vehicleData.length - 1;
            
            // Optimize table performance for large datasets
            optimizeTablePerformance();
        }

        function createVehicleTableRow(vehicleId, plateNumber, model, color, department, year, type, status, currentDriver, assignedDrivers, accessStatus, index) {
            const row = document.createElement('tr');
            row.className = `vehicle-row ${status === 'IN' ? 'table-success' : 'table-light'}`;
            
            // Determine access status styling
            let accessTextClass = 'text-success';
            if (accessStatus === 'No Access') accessTextClass = 'text-warning';
            if (accessStatus === 'Banned') accessTextClass = 'text-danger';
            
            // Determine status text
            const statusText = status === 'IN' 
                ? '<small class="text-success">IN</small>'
                : '<small class="text-danger">OUT</small>';
            
            // Create modern action buttons following UI/UX best practices
            const detailsButton = `
                <button class="btn btn-outline-primary btn-sm vehicle-action-btn" 
                        onclick="showVehicleDetails(${index})" 
                        title="View vehicle details and information"
                        aria-label="View details for vehicle ${plateNumber}"
                        data-bs-toggle="tooltip"
                        style="
                            padding: 8px 12px; 
                            font-size: 0.9rem; 
                            font-weight: 600;
                            border-radius: 8px; 
                            border: 2px solid #007bff;
                            color: #007bff;
                            background: white;
                            transition: all 0.15s ease-in-out; 
                            box-shadow: 0 1px 3px rgba(0, 123, 255, 0.1);
                            min-height: 36px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            position: relative;
                            overflow: hidden;
                            width: 100%;
                        "
                        onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0, 123, 255, 0.25)'; this.style.background='#007bff'; this.style.color='white';"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0, 123, 255, 0.1)'; this.style.background='white'; this.style.color='#007bff';"
                        onfocus="this.style.boxShadow='0 0 0 3px rgba(0, 123, 255, 0.25)';"
                        onblur="this.style.boxShadow='0 1px 3px rgba(0, 123, 255, 0.1)';">
                    <i class="bi bi-info-circle me-1" aria-hidden="true"></i>
                    <span>Details</span>
                </button>
            `;

            const transactionButton = `
                <button class="btn ${status === 'IN' ? 'btn-outline-danger' : 'btn-outline-success'} btn-sm vehicle-action-btn" 
                        onclick="toggleVehicleStatus(${index})" 
                        title="${status === 'IN' ? 'Check out this vehicle' : 'Check in this vehicle'}"
                        aria-label="${status === 'IN' ? 'Check out' : 'Check in'} vehicle ${plateNumber}"
                        data-bs-toggle="tooltip"
                        ${accessStatus === 'Banned' ? 'disabled aria-disabled="true"' : ''}
                        style="
                            padding: 8px 12px; 
                            font-size: 0.9rem; 
                            font-weight: 600;
                            border-radius: 8px; 
                            border: 2px solid ${status === 'IN' ? '#dc3545' : '#28a745'};
                            color: ${status === 'IN' ? '#dc3545' : '#28a745'};
                            background: white;
                            transition: all 0.15s ease-in-out; 
                            box-shadow: 0 1px 3px ${status === 'IN' ? 'rgba(220, 53, 69, 0.1)' : 'rgba(40, 167, 69, 0.1)'};
                            min-width: 64px; 
                            min-height: 36px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            position: relative;
                            overflow: hidden;
                            width: 100%;
                            ${accessStatus === 'Banned' ? 'opacity: 0.5; cursor: not-allowed; filter: grayscale(1);' : ''}
                        "
                        ${accessStatus !== 'Banned' ? `
                            onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px ${status === 'IN' ? 'rgba(220, 53, 69, 0.25)' : 'rgba(40, 167, 69, 0.25)'}'; this.style.background='${status === 'IN' ? '#dc3545' : '#28a745'}'; this.style.color='white';"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px ${status === 'IN' ? 'rgba(220, 53, 69, 0.1)' : 'rgba(40, 167, 69, 0.1)'}'; this.style.background='white'; this.style.color='${status === 'IN' ? '#dc3545' : '#28a745'}';"
                            onfocus="this.style.boxShadow='0 0 0 3px ${status === 'IN' ? 'rgba(220, 53, 69, 0.25)' : 'rgba(40, 167, 69, 0.25)'}';"
                            onblur="this.style.boxShadow='0 1px 3px ${status === 'IN' ? 'rgba(220, 53, 69, 0.1)' : 'rgba(40, 167, 69, 0.1)'}';"
                        ` : ''}>
                    <i class="bi bi-${status === 'IN' ? 'box-arrow-right' : 'box-arrow-in-left'} me-1" aria-hidden="true"></i>
                    <span class="action-text">${status === 'IN' ? 'OUT' : 'IN'}</span>
                    <div class="loading-spinner d-none" style="
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        width: 16px;
                        height: 16px;
                    ">
                        <div class="spinner-border" style="width: 16px; height: 16px;" role="status">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                    </div>
                </button>
            `;
            
            row.innerHTML = `
                <td style="padding: 8px 8px; font-size: 0.8rem;" class="text-muted">${vehicleId}</td>
                <td style="padding: 8px 8px; font-size: 0.9rem;" class="fw-bold text-primary">${plateNumber}</td>
                <td style="padding: 8px 8px; font-size: 0.85rem;">
                    <div class="fw-semibold">${model}</div>
                    <small class="text-muted">${year} ${color}</small>
                </td>
                <td style="padding: 8px 8px; font-size: 0.85rem;" class="d-none d-md-table-cell">
                    <small>${department}</small>
                </td>
                <td style="padding: 8px 8px; font-size: 0.85rem;" class="d-none d-lg-table-cell">
                    <small>${currentDriver}</small>
                </td>
                <td style="padding: 8px 8px; font-size: 0.85rem;" class="text-center">${statusText}</td>
                <td style="padding: 8px 8px; font-size: 0.85rem;" class="d-none d-xl-table-cell">
                    <small class="${accessTextClass}">${accessStatus}</small>
                </td>
                <td style="padding: 8px 8px;" class="text-center">${detailsButton}</td>
                <td style="padding: 8px 8px;" class="text-center">${transactionButton}</td>
            `;
            
            return row;
        }

        function createVehicleListItem(plateNumber, model, status, driver, index) {
            const item = document.createElement('div');
            
            // Get vehicle details for enhanced display
            const vehicle = vehicleData[index];
            const color = vehicle[3] || 'Unknown';
            const department = vehicle[4] || 'Unknown';
            const year = vehicle[5] || '';
            const type = vehicle[6] || 'Car';
            const assignedDrivers = vehicle[9] || '';
            const accessStatus = vehicle[10] || 'Access';
            
            // Build CSS classes including access status
            let cssClasses = `card vehicle-card status-${status.toLowerCase()}`;
            if (accessStatus === 'Banned') {
                cssClasses += ' access-banned';
            } else if (accessStatus === 'No Access') {
                cssClasses += ' access-no-access';
            }
            
            item.className = cssClasses;

            // Get appropriate icon for vehicle type
            let typeIcon = 'bi-truck';
            let typeColor = 'text-secondary';
            switch(type.toLowerCase()) {
                case 'car':
                    typeIcon = 'bi-car-front-fill';
                    typeColor = 'text-primary';
                    break;
                case 'truck':
                    typeIcon = 'bi-truck';
                    typeColor = 'text-danger';
                    break;
                case 'van':
                    typeIcon = 'bi-minecart';
                    typeColor = 'text-info';
                    break;
                case 'suv':
                    typeIcon = 'bi-car-front';
                    typeColor = 'text-success';
                    break;
                case 'motorcycle':
                    typeIcon = 'bi-bicycle';
                    typeColor = 'text-warning';
                    break;
                case 'bus':
                    typeIcon = 'bi-bus-front-fill';
                    typeColor = 'text-purple';
                    break;
                default:
                    typeIcon = 'bi-truck';
                    typeColor = 'text-secondary';
            }

            // Format assigned drivers display
            let assignedDriversDisplay = '';
            if (assignedDrivers && assignedDrivers.trim()) {
                const drivers = assignedDrivers.split(',').map(d => d.trim()).filter(d => d);
                if (drivers.length > 0) {
                    if (drivers.length === 1) {
                        assignedDriversDisplay = drivers[0];
                    } else if (drivers.length <= 3) {
                        assignedDriversDisplay = drivers.join(', ');
                    } else {
                        assignedDriversDisplay = `${drivers.slice(0, 2).join(', ')} +${drivers.length - 2} more`;
                    }
                }
            }


            item.innerHTML = `
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="vehicle-plate">
                            <h5 class="plate-number mb-1">${plateNumber}</h5>
                            <small class="text-muted">${year} ${color}</small>
                        </div>
                        <div class="vehicle-actions">
                            <button class="btn btn-sm btn-outline-secondary me-1" 
                                    onclick="showVehicleDetails(${index})" title="View Details">
                                <i class="bi bi-info-circle"></i>
                            </button>
                            <button class="btn btn-sm ${status === 'IN' ? 'btn-outline-danger' : 'btn-outline-success'}" 
                                    onclick="toggleVehicleStatus(${index})" title="${status === 'IN' ? 'Check Out' : 'Check In'}">
                                <i class="bi ${status === 'IN' ? 'bi-box-arrow-right' : 'bi-box-arrow-in-left'}"></i>
                            </button>
                        </div>
                    </div>
                    <div class="vehicle-info">
                        <div class="mb-1">
                            <i class="bi ${typeIcon} me-2 ${typeColor}"></i>
                            <small class="fw-medium">${type} - ${model}</small>
                        </div>
                        <div class="mb-1">
                            <i class="bi bi-person-fill me-2 text-success"></i>
                            <small><strong>Current:</strong> ${driver}</small>
                        </div>
                        ${assignedDriversDisplay ? `
                        <div class="mb-1">
                            <i class="bi bi-people-fill me-2 text-info"></i>
                            <small><strong>Assigned:</strong> ${assignedDriversDisplay}</small>
                        </div>
                        ` : ''}
                        <div>
                            <i class="bi bi-building me-2 text-warning"></i>
                            <small>${department}</small>
                        </div>
                    </div>
                </div>
            `;

            return item;
        }

        // Keep the old function for compatibility
        function createVehicleCard(plateNumber, model, status, driver, index) {
            return createVehicleListItem(plateNumber, model, status, driver, index);
        }

        function toggleVehicleStatus(index) {
            // Add error handling for vehicle data
            if (!vehicleData || vehicleData.length === 0) {
                showToast('No vehicle data available', 'warning');
                return;
            }
            
            if (index < 0 || index >= vehicleData.length) {
                showToast('Invalid vehicle index', 'danger');
                return;
            }
            
            const vehicle = vehicleData[index];
            if (!vehicle) {
                showToast('Vehicle data not found', 'danger');
                console.error('Vehicle not found at index:', index, 'vehicleData length:', vehicleData.length);
                return;
            }
            
            console.log('Toggling status for vehicle:', vehicle[0], 'at index:', index);
            
            // Validate gate selection first
            if (!validateGateSelection()) {
                return;
            }
            
            const currentStatus = vehicle[7] || 'OUT'; // Status is at index 7
            const newStatus = currentStatus === 'IN' ? 'OUT' : 'IN';
            
            // Get the selected gate using our helper function
            const selectedGate = getCurrentGate();
            const gate = selectedGate.id;

            const logData = {
                plateNumber: vehicle[1], // Plate number is at index 1, not 0 (which is ID)
                driverId: vehicle[8] || 'Unknown', // Current driver is at index 8
                action: newStatus,
                gate: gate,
                remarks: '',
                username: currentUser.username // Add the current user's username
            };

            showLoading(true);
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result && result.success) {
                        vehicleData[index][7] = newStatus;
                        displayVehicles();
                        updateStatistics();
                        showToast(`Vehicle ${newStatus === 'IN' ? 'checked in' : 'checked out'} at ${selectedGate.name}!`, 'success');
                        
                        // Increment today's activity
                        let todayActivity = parseInt(sessionStorage.getItem('todayActivity') || '0');
                        todayActivity++;
                        sessionStorage.setItem('todayActivity', todayActivity.toString());
                        document.getElementById('recentActivity').textContent = todayActivity;
                        
                    }
                    showLoading(false);
                })
                .withFailureHandler(function(error) {
                    showToast('Failed to update vehicle status: ' + error, 'danger');
                    showLoading(false);
                })
                .logVehicleAction(logData);
        }

        function debounceFilter() {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                filterVehicles();
            }, 300);
        }

        function filterVehicles() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            const filterStatus = document.getElementById('filterStatus').value;
            const filterAccessStatus = document.getElementById('filterAccessStatus').value;

            // Show filter feedback
            showFilterFeedback(searchTerm, filterStatus, filterAccessStatus);

            // Build search criteria for server-side filtering
            const searchCriteria = {
                searchTerm: searchTerm,
                statusFilter: filterStatus,
                accessStatusFilter: filterAccessStatus,
                departmentFilter: '',
                pageSize: 50,
                pageOffset: 0
            };

            // Use server-side search for better performance with large datasets
            loadVehicles(searchCriteria);
        }

        function clearFilters() {
            // Clear all filter inputs
            document.getElementById('searchInput').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterAccessStatus').value = '';
            
            // Reset to default search criteria (load all vehicles)
            loadVehicles();
            
            // Show feedback
            showToast('Filters cleared - showing all vehicles', 'info');
        }

        function showFilterFeedback(searchTerm, filterStatus, filterAccessStatus) {
            // Update clear button visibility
            const clearBtn = document.querySelector('button[onclick="clearFilters()"]');
            if (searchTerm || filterStatus || filterAccessStatus) {
                clearBtn.style.opacity = '1';
                clearBtn.disabled = false;
            } else {
                clearBtn.style.opacity = '0.5';
                clearBtn.disabled = true;
            }
        }

        function initializeFilterUI() {
            // Initialize clear button state
            const clearBtn = document.querySelector('button[onclick="clearFilters()"]');
            if (clearBtn) {
                clearBtn.style.opacity = '0.5';
                clearBtn.disabled = true;
            }
        }

        // Pagination functionality
        let currentPage = 1;
        let pageSize = 50;
        let totalVehicles = 0;

        function changePage(direction) {
            const totalPages = Math.ceil(totalVehicles / pageSize);
            
            if (direction === 'prev' && currentPage > 1) {
                currentPage--;
            } else if (direction === 'next' && currentPage < totalPages) {
                currentPage++;
            }
            
            // Load vehicles for the new page
            const searchTerm = document.getElementById('searchInput').value.trim();
            const filterStatus = document.getElementById('filterStatus').value;
            const filterAccessStatus = document.getElementById('filterAccessStatus').value;
            
            const searchCriteria = {
                searchTerm: searchTerm,
                statusFilter: filterStatus,
                accessStatusFilter: filterAccessStatus,
                departmentFilter: '',
                pageSize: pageSize,
                pageOffset: (currentPage - 1) * pageSize
            };
            
            loadVehicles(searchCriteria);
        }

        function changePageSize() {
            const newPageSize = parseInt(document.getElementById('pageSizeSelector').value);
            pageSize = newPageSize;
            currentPage = 1; // Reset to first page when changing page size
            
            // Reload vehicles with new page size
            const searchTerm = document.getElementById('searchInput').value.trim();
            const filterStatus = document.getElementById('filterStatus').value;
            const filterAccessStatus = document.getElementById('filterAccessStatus').value;
            
            const searchCriteria = {
                searchTerm: searchTerm,
                statusFilter: filterStatus,
                accessStatusFilter: filterAccessStatus,
                departmentFilter: '',
                pageSize: pageSize,
                pageOffset: 0
            };
            
            loadVehicles(searchCriteria);
        }

        function updatePaginationControls(vehicleCount, totalCount) {
            const paginationRow = document.getElementById('paginationRow');
            const paginationInfo = document.getElementById('paginationInfo');
            const prevPageItem = document.getElementById('prevPageItem');
            const nextPageItem = document.getElementById('nextPageItem');
            const currentPageNumber = document.getElementById('currentPageNumber');
            
            totalVehicles = totalCount;
            const totalPages = Math.ceil(totalCount / pageSize);
            const startIndex = (currentPage - 1) * pageSize + 1;
            const endIndex = Math.min(currentPage * pageSize, totalCount);
            
            // Show pagination controls if there are more vehicles than page size
            if (totalCount > pageSize) {
                paginationRow.style.display = 'block';
                
                // Update pagination info
                paginationInfo.textContent = `Showing ${startIndex}-${endIndex} of ${totalCount} vehicles`;
                
                // Update current page number
                currentPageNumber.textContent = currentPage;
                
                // Update previous button state
                if (currentPage <= 1) {
                    prevPageItem.classList.add('disabled');
                } else {
                    prevPageItem.classList.remove('disabled');
                }
                
                // Update next button state
                if (currentPage >= totalPages) {
                    nextPageItem.classList.add('disabled');
                } else {
                    nextPageItem.classList.remove('disabled');
                }
            } else {
                paginationRow.style.display = 'none';
            }
        }

        function updateStatistics() {
            // This function is now simplified - all statistics come from database via loadDatabaseStatistics()
            // This function is kept for compatibility and any future enhancements that might need table-based calculations
            
            console.log('updateStatistics called - all stats now loaded from database via loadDatabaseStatistics()');
            
            // No longer needed since all statistics are fetched directly from database
            // Access status counts, vehicle totals, IN/OUT counts all come from getDatabaseStatistics()
        }

        function animateNumber(elementId, targetNumber) {
            const element = document.getElementById(elementId);
            const currentNumber = parseInt(element.textContent) || 0;
            const increment = targetNumber > currentNumber ? 1 : -1;
            const steps = Math.abs(targetNumber - currentNumber);
            const duration = Math.min(1000, steps * 50); // Max 1 second animation
            const stepDuration = duration / steps;

            if (steps === 0) return;

            let current = currentNumber;
            const timer = setInterval(() => {
                current += increment;
                element.textContent = current;
                
                if (current === targetNumber) {
                    clearInterval(timer);
                    // Add a subtle scale effect when complete
                    element.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        element.style.transform = 'scale(1)';
                    }, 200);
                }
            }, stepDuration);
        }

        function updatePercentages(total, vehiclesIn, vehiclesOut) {
            if (total === 0) {
                document.querySelector('#vehiclesInPercentage span').textContent = '0%';
                document.querySelector('#vehiclesOutPercentage span').textContent = '0%';
                document.getElementById('vehiclesInProgress').style.width = '0%';
                document.getElementById('vehiclesOutProgress').style.width = '0%';
                return;
            }

            const inPercentage = Math.round((vehiclesIn / total) * 100);
            const outPercentage = Math.round((vehiclesOut / total) * 100);

            // Update percentage text
            document.querySelector('#vehiclesInPercentage span').textContent = inPercentage + '%';
            document.querySelector('#vehiclesOutPercentage span').textContent = outPercentage + '%';

            // Animate progress bars
            setTimeout(() => {
                document.getElementById('vehiclesInProgress').style.width = inPercentage + '%';
                document.getElementById('vehiclesOutProgress').style.width = outPercentage + '%';
            }, 100);
        }

        function addPulseEffect() {
            const cards = document.querySelectorAll('.stats-card');
            cards.forEach(card => {
                card.classList.add('pulse-once');
                setTimeout(() => {
                    card.classList.remove('pulse-once');
                }, 600);
            });
        }

        function updateSummaryStats(vehiclesIn, totalRegistered = null) {
            // Update last update time
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('lastUpdate').textContent = timeString;
            
            // Update active gate display
            const currentGate = getCurrentGate();
            if (currentGate) {
                document.getElementById('activeGateDisplay').textContent = currentGate.name;
            }
            
            // Update today's activity (this would need actual data from logs)
            // For now, we'll just show a placeholder
            const todayActivity = sessionStorage.getItem('todayActivity') || '0';
            document.getElementById('recentActivity').textContent = todayActivity;
        }

        function logout() {
            currentUser = null;
            clearSession(); // Clear stored session data
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginMsg').innerHTML = '';
            showLoginPage();
            showToast('You have been logged out successfully', 'info');
        }

        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (show) {
                spinner.classList.remove('hidden');
            } else {
                spinner.classList.add('hidden');
            }
        }

        function showVehicleModalLoading(show, modalType) {
            const loadingOverlayId = modalType === 'add' ? 'addVehicleLoading' : 'editVehicleLoading';
            const modalId = modalType === 'add' ? 'vehicleManagementModal' : 'editVehicleModal';
            
            const loadingOverlay = document.getElementById(loadingOverlayId);
            const modal = document.getElementById(modalId);
            
            if (show) {
                // Show loading overlay
                loadingOverlay.classList.remove('d-none');
                loadingOverlay.classList.add('d-flex');
                
                // Disable all buttons and form elements in the modal EXCEPT Cancel and X buttons
                const buttons = modal.querySelectorAll('button:not([data-bs-dismiss="modal"])');
                const inputs = modal.querySelectorAll('input, select, textarea');
                
                buttons.forEach(btn => {
                    if (!btn.hasAttribute('data-bs-dismiss')) {
                        btn.setAttribute('data-original-disabled', btn.disabled);
                        btn.disabled = true;
                    }
                });
                
                inputs.forEach(input => {
                    input.setAttribute('data-original-disabled', input.disabled);
                    input.disabled = true;
                });
            } else {
                // Hide loading overlay
                loadingOverlay.classList.add('d-none');
                loadingOverlay.classList.remove('d-flex');
                
                // Re-enable all buttons and form elements
                const buttons = modal.querySelectorAll('button:not([data-bs-dismiss="modal"])');
                const inputs = modal.querySelectorAll('input, select, textarea');
                
                buttons.forEach(btn => {
                    if (!btn.hasAttribute('data-bs-dismiss')) {
                        const wasOriginallyDisabled = btn.getAttribute('data-original-disabled') === 'true';
                        btn.disabled = wasOriginallyDisabled;
                        btn.removeAttribute('data-original-disabled');
                    }
                });
                
                inputs.forEach(input => {
                    const wasOriginallyDisabled = input.getAttribute('data-original-disabled') === 'true';
                    input.disabled = wasOriginallyDisabled;
                    input.removeAttribute('data-original-disabled');
                });
            }
        }

        function showMessage(message, type) {
            const loginMsg = document.getElementById('loginMsg');
            const icons = {
                success: 'bi-check-circle-fill',
                danger: 'bi-exclamation-triangle-fill'
            };

            loginMsg.className = `alert alert-${type} mb-3 d-flex align-items-center`;
            loginMsg.innerHTML = `
                <i class="bi ${icons[type]} me-2"></i>
                <div>${message}</div>
            `;
        }

        function showToast(message, type) {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.innerHTML += toastHtml;
            const toast = new bootstrap.Toast(document.getElementById(toastId));
            toast.show();
            
            setTimeout(() => {
                const toastElement = document.getElementById(toastId);
                if (toastElement) {
                    toastElement.remove();
                }
            }, 5000);
        }


        function showVehicleDetails(index) {
            // Add error handling
            if (!vehicleData || vehicleData.length === 0) {
                showToast('No vehicle data available', 'warning');
                return;
            }
            
            if (index < 0 || index >= vehicleData.length) {
                showToast('Invalid vehicle index', 'danger');
                return;
            }
            
            const vehicle = vehicleData[index];
            if (!vehicle) {
                showToast('Vehicle data not found', 'danger');
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('vehicleDetailsModal'));
            
            document.getElementById('detailsModalTitle').textContent = 'Vehicle Details - ' + vehicle[1]; // Show plate number, not ID
            
            const accessStatus = vehicle[10] || 'Access'; // Access status is at index 10
            const accessClass = accessStatus === 'Access' ? 'bg-success' : 
                               accessStatus === 'No Access' ? 'bg-warning' : 'bg-danger';
            const accessTextClass = accessStatus === 'No Access' ? 'text-dark' : 'text-white';
            
            document.getElementById('detailsModalBody').innerHTML = `
                <div class="row">
                    <div class="col-12 mb-3">
                        <div class="text-center">
                            <small class="text-muted">Vehicle ID: ${vehicle[0]}</small>
                        </div>
                        <div class="plate-number text-center fs-4">${vehicle[1]}</div>
                    </div>
                </div>
                <table class="table table-striped">
                    <tr><th width="40%">Make/Model</th><td>${vehicle[2] || ''}</td></tr>
                    <tr><th>Color</th><td>${vehicle[3] || ''}</td></tr>
                    <tr><th>Department</th><td>${vehicle[4] || ''}</td></tr>
                    <tr><th>Year</th><td>${vehicle[5] || ''}</td></tr>
                    <tr><th>Type</th><td>${vehicle[6] || ''}</td></tr>
                    <tr><th>Status</th><td><span class="badge ${vehicle[7] === 'IN' ? 'status-in' : 'status-out'}">${vehicle[7] || 'OUT'}</span></td></tr>
                    <tr><th>Current Driver</th><td>${vehicle[8] || 'Unassigned'}</td></tr>
                    <tr><th>Assigned Drivers</th><td>${vehicle[9] || 'None'}</td></tr>
                    <tr><th>Access Status</th><td><span class="badge ${accessClass} ${accessTextClass}">${accessStatus}</span></td></tr>
                </table>
            `;
            
            // Add action buttons based on user permissions
            const footer = document.getElementById('detailsModalFooter');
            if (hasPermission('vehicles', 'update')) {
                // Super Admin, Admin - full edit and delete capability
                footer.innerHTML = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning" onclick="editVehicle(${index})">
                        <i class="bi bi-pencil-square me-2"></i>Edit
                    </button>
                    ${hasPermission('vehicles', 'delete') ? `
                    <button type="button" class="btn btn-danger" onclick="deleteVehicle(${index})">
                        <i class="bi bi-trash me-2"></i>Delete
                    </button>
                    ` : ''}
                `;
            } else if (hasPermission('vehicles', 'updateDriver')) {
                // Security - limited edit capability (driver only)
                footer.innerHTML = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-warning" onclick="editVehicle(${index})">
                        <i class="bi bi-person-gear me-2"></i>Change Driver
                    </button>
                `;
            } else {
                // No edit permissions - view only
                footer.innerHTML = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                `;
            }
            
            modal.show();
        }

        function updateCurrentDriverDropdown() {
            const assignedDriversValue = document.getElementById('editAssignedDrivers').value.trim();
            const currentDriverSelect = document.getElementById('editDriver');
            const currentValue = currentDriverSelect.value; // Save current selection
            
            // Clear existing options
            currentDriverSelect.innerHTML = '<option value="">Select a driver...</option>';
            
            if (assignedDriversValue) {
                // Split the assigned drivers by comma and trim whitespace
                const assignedDrivers = assignedDriversValue.split(',')
                    .map(driver => driver.trim())
                    .filter(driver => driver.length > 0);
                
                // Add each assigned driver as an option
                assignedDrivers.forEach(driver => {
                    const option = document.createElement('option');
                    option.value = driver;
                    option.textContent = driver;
                    currentDriverSelect.appendChild(option);
                });
                
                // Restore previous selection if it's still in the list
                if (currentValue && assignedDrivers.includes(currentValue)) {
                    currentDriverSelect.value = currentValue;
                }
            }
        }

        function editVehicle(index) {
            if (!hasPermission('vehicles', 'update') && !hasPermission('vehicles', 'updateDriver')) {
                showToast('Access denied: Insufficient permissions to edit vehicles', 'danger');
                return;
            }
            
            const vehicle = vehicleData[index];
            
            // Hide details modal and show edit modal
            bootstrap.Modal.getInstance(document.getElementById('vehicleDetailsModal')).hide();
            
            // Populate edit form with correct indices
            document.getElementById('editVehicleIndex').value = index;
            document.getElementById('editPlateNumber').value = vehicle[1] || ''; // Plate number is at index 1
            document.getElementById('editModel').value = vehicle[2] || '';      // Make/Model is at index 2
            document.getElementById('editColor').value = vehicle[3] || '';      // Color is at index 3
            document.getElementById('editDepartment').value = vehicle[4] || ''; // Department is at index 4
            document.getElementById('editYear').value = vehicle[5] || '';       // Year is at index 5
            document.getElementById('editType').value = vehicle[6] || 'Car';    // Type is at index 6
            document.getElementById('editStatus').value = vehicle[7] || 'OUT';  // Status is at index 7
            document.getElementById('editAssignedDrivers').value = vehicle[9] || ''; // Assigned drivers is at index 9
            document.getElementById('editAccessStatus').value = vehicle[10] || 'Access'; // Access status is at index 10
            
            // Populate current driver dropdown from assigned drivers
            updateCurrentDriverDropdown();
            document.getElementById('editDriver').value = vehicle[8] || '';     // Current driver is at index 8
            
            // Add event listener to assigned drivers field to update current driver options
            const assignedDriversField = document.getElementById('editAssignedDrivers');
            if (!assignedDriversField.hasAttribute('data-listener-added')) {
                assignedDriversField.addEventListener('input', updateCurrentDriverDropdown);
                assignedDriversField.setAttribute('data-listener-added', 'true');
            }
            
            // Restrict users who can only update driver to current driver field only
            if (hasPermission('vehicles', 'updateDriver') && !hasPermission('vehicles', 'update')) {
                // Disable all fields except current driver
                const fieldsToDisable = [
                    'editPlateNumber', 'editModel', 'editColor', 'editDepartment', 
                    'editYear', 'editType', 'editStatus', 'editAssignedDrivers', 'editAccessStatus'
                ];
                
                fieldsToDisable.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.disabled = true;
                        field.style.backgroundColor = '#f8f9fa';
                        field.style.opacity = '0.6';
                    }
                });
                
                // Ensure current driver field is enabled and highlighted
                const driverField = document.getElementById('editDriver');
                if (driverField) {
                    driverField.disabled = false;
                    driverField.style.backgroundColor = '';
                    driverField.style.opacity = '';
                    driverField.style.borderColor = '#007bff';
                    driverField.focus();
                }
                
                // Update modal title for Security users
                const modalTitle = document.querySelector('#editVehicleModal .modal-title');
                if (modalTitle) {
                    modalTitle.textContent = 'Change Current Driver';
                }
            } else {
                // Reset all fields for admin, supervisor, and super-admin users
                const allFields = [
                    'editPlateNumber', 'editModel', 'editColor', 'editDepartment', 
                    'editYear', 'editType', 'editStatus', 'editAssignedDrivers', 'editAccessStatus', 'editDriver'
                ];
                
                allFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.disabled = false;
                        field.style.backgroundColor = '';
                        field.style.opacity = '';
                        field.style.borderColor = '';
                    }
                });
                
                // Reset modal title for privileged users
                const modalTitle = document.querySelector('#editVehicleModal .modal-title');
                if (modalTitle) {
                    modalTitle.textContent = 'Edit Vehicle';
                }
            }
            
            // Show edit modal
            const modal = new bootstrap.Modal(document.getElementById('editVehicleModal'));
            modal.show();
        }

        function saveVehicleEdit() {
            const index = parseInt(document.getElementById('editVehicleIndex').value);
            
            // Handle Security role - only update current driver
            if (currentUser.role === 'security') {
                const newDriverValue = document.getElementById('editDriver').value || '';
                
                // Create updated vehicle data with only driver field changed
                const currentVehicle = vehicleData[index]; // Use vehicleData instead of allVehicles
                const updatedVehicleData = [...currentVehicle]; // Copy existing data
                updatedVehicleData[8] = newDriverValue; // Update only current driver field
                
                showVehicleModalLoading(true, 'edit');
                google.script.run
                    .withSuccessHandler(function(success) {
                        if (success) {
                            // Update local data
                            vehicleData[index] = updatedVehicleData;
                            
                            // Reload vehicles to ensure consistency
                            loadVehicles();
                            
                            // Update UI
                            displayVehicles();
                            
                            // Hide modal and show success
                            bootstrap.Modal.getInstance(document.getElementById('editVehicleModal')).hide();
                            showToast('Driver updated successfully', 'success');
                        } else {
                            showToast('Failed to update driver', 'danger');
                        }
                        showVehicleModalLoading(false, 'edit');
                    })
                    .withFailureHandler(function(error) {
                        showToast('Error updating driver: ' + error, 'danger');
                        showVehicleModalLoading(false, 'edit');
                    })
                    .updateVehicleRecord(index, updatedVehicleData, currentUser.role);
                
                return; // Exit early for Security users
            }
            
            // Handle Admin, Supervisor, and Super-Admin roles - full edit capability
            const plateNumber = document.getElementById('editPlateNumber').value.trim();
            const model = document.getElementById('editModel').value.trim();
            
            if (!plateNumber || !model) {
                showToast('Plate number and model are required', 'danger');
                return;
            }
            
            // Define currentVehicle for admin role
            const currentVehicle = vehicleData[index];
            
            // Find the actual index in allVehicles for backend
            let actualIndex = -1;
            if (allVehicles && allVehicles.length > 1) {
                for (let i = 1; i < allVehicles.length; i++) {
                    if (allVehicles[i][0] === currentVehicle[0]) {
                        actualIndex = i;
                        break;
                    }
                }
            }
            
            // If not found in allVehicles, use index as fallback
            if (actualIndex === -1) {
                actualIndex = index;
            }
            
            // Check if plate number already exists (excluding current vehicle)
            const originalPlate = currentVehicle[1]; // Get original plate number from index 1
            const vehicleId = currentVehicle[0]; // Get vehicle ID from index 0
            
            // Only check for duplicates if the plate number has changed
            if (plateNumber !== originalPlate) {
                for (let i = 1; i < vehicleData.length; i++) {
                    if (vehicleData[i][1] === plateNumber) {
                        showToast('Another vehicle with this plate number already exists', 'danger');
                        return;
                    }
                }
            }
            
            const updatedVehicleData = [
                vehicleId,           // Keep original ID at index 0
                plateNumber,         // Plate number at index 1
                model,               // Make/Model at index 2
                document.getElementById('editColor').value || '',      // Color at index 3
                document.getElementById('editDepartment').value || '', // Department at index 4
                document.getElementById('editYear').value || '',       // Year at index 5
                document.getElementById('editType').value || 'Car',    // Type at index 6
                document.getElementById('editStatus').value || 'OUT',  // Status at index 7
                document.getElementById('editDriver').value || '',     // Current Driver at index 8
                document.getElementById('editAssignedDrivers').value || '', // Assigned Drivers at index 9
                document.getElementById('editAccessStatus').value || 'Access' // Access Status at index 10
            ];
            
            showVehicleModalLoading(true, 'edit');
            google.script.run
                .withSuccessHandler(function(success) {
                    if (success) {
                        // Update local data
                        vehicleData[index] = updatedVehicleData;
                        
                        // Reload vehicles to ensure consistency
                        loadVehicles();
                        
                        // Update display
                        displayVehicles();
                        updateStatistics();
                        
                        // Hide modal
                        bootstrap.Modal.getInstance(document.getElementById('editVehicleModal')).hide();
                        
                        showToast('Vehicle updated successfully!', 'success');
                    }
                    showVehicleModalLoading(false, 'edit');
                })
                .withFailureHandler(function(error) {
                    showToast('Failed to update vehicle: ' + error, 'danger');
                    showVehicleModalLoading(false, 'edit');
                })
                .updateVehicleRecord(actualIndex, updatedVehicleData, currentUser.role);
        }

        function deleteVehicle(index) {
            if (!hasPermission('vehicles', 'delete')) {
                showToast('Access denied: Only Super Admin can delete vehicles', 'danger');
                return;
            }
            
            const vehicle = vehicleData[index];
            const plateNumber = vehicle[1];
            
            // Confirm deletion
            if (!confirm(`Are you sure you want to delete vehicle ${plateNumber}?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            showLoading(true);
            google.script.run
                .withSuccessHandler(function(success) {
                    if (success) {
                        // Remove from local data
                        allVehicles.splice(index, 1);
                        vehicleData = allVehicles;
                        
                        // Update display
                        displayVehicles();
                        updateStatistics();
                        
                        // Hide modal
                        bootstrap.Modal.getInstance(document.getElementById('vehicleDetailsModal')).hide();
                        
                        showToast('Vehicle deleted successfully!', 'success');
                    }
                    showLoading(false);
                })
                .withFailureHandler(function(error) {
                    showToast('Failed to delete vehicle: ' + error, 'danger');
                    showLoading(false);
                })
                .deleteVehicleRecord(index, currentUser.role);
        }

        // User Management Functions
        let allUsers = [];

        function showUserManagement() {
            // Debug logging
            console.log('Current user:', currentUser);
            console.log('Has user read permission:', hasPermission('users', 'read'));
            console.log('Has user create permission:', hasPermission('users', 'create'));
            
            if (!hasPermission('users', 'read')) {
                showToast('Access denied: Insufficient permissions for user management', 'danger');
                return;
            }

            const modal = new bootstrap.Modal(document.getElementById('userManagementModal'));
            modal.show();
            
            loadUsers();
        }

        function loadUsers() {
            console.log('Loading users...');
            console.log('Current user object:', currentUser);
            console.log('Current user role:', currentUser ? currentUser.role : 'undefined');
            
            // Check if user is logged in and has proper role
            if (!currentUser || !currentUser.role) {
                console.error('User not logged in or role missing');
                showToast('‚ùå User session invalid. Please log in again.', 'danger');
                return;
            }
            
            if (currentUser.role !== 'super-admin' && currentUser.role !== 'admin') {
                console.error('User does not have sufficient role:', currentUser.role);
                showToast('‚ùå Access denied: Admin or Super Admin role required', 'danger');
                return;
            }
            
            // Show loading animation in the modern table
            showUserLoadingState();
            
            google.script.run
                .withSuccessHandler(function(data) {
                    console.log('‚úÖ Users data received successfully:', data);
                    console.log('Data length:', data ? data.length : 'null');
                    allUsers = data;
                    displayUsers();
                    showToast('‚úÖ Users loaded successfully', 'success');
                })
                .withFailureHandler(function(error) {
                    console.error('‚ùå Error loading users:', error);
                    showToast('‚ùå Failed to load users: ' + error, 'danger');
                    
                    // Show detailed error state
                    container.innerHTML = `
                        <div class="text-center py-5 text-danger">
                            <i class="bi bi-exclamation-triangle-fill fs-1 mb-3"></i>
                            <div class="fw-bold mb-2">Failed to Load Users</div>
                            <div class="text-muted mb-3">${error}</div>
                            <div class="small text-info mb-3">
                                Debug Info:<br>
                                User: ${currentUser ? currentUser.username : 'undefined'}<br>
                                Role: ${currentUser ? currentUser.role : 'undefined'}
                            </div>
                            <button class="btn btn-outline-primary" onclick="loadUsers()">
                                <i class="bi bi-arrow-clockwise me-2"></i>Retry
                            </button>
                        </div>
                    `;
                })
                .getUserList(currentUser.role);
        }
        
        function showUserLoadingState() {
            const tableBody = document.getElementById('userTableBody');
            const usersTable = document.getElementById('usersDataTable');
            const noUsersState = document.getElementById('noUsersState');
            const userListContainer = document.getElementById('userListContainer');
            const totalUsersCount = document.getElementById('totalUsersCount');
            
            // Hide other states
            if (noUsersState) noUsersState.classList.add('d-none');
            if (userListContainer) userListContainer.classList.add('d-none');
            
            // Show table and loading in tbody
            if (usersTable) usersTable.style.display = 'table';
            if (totalUsersCount) totalUsersCount.textContent = '...';
            
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <div class="d-flex flex-column align-items-center">
                                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <h6 class="text-muted mb-2">Loading User Directory</h6>
                                <p class="text-muted mb-1">Fetching user data from database...</p>
                                <small class="text-info">Role: ${currentUser ? currentUser.role : 'undefined'}</small>
                                <div class="mt-3">
                                    <div class="progress" style="width: 200px; height: 4px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                             style="width: 100%"></div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        function displayUsers() {
            console.log('=== displayUsers called ===');
            console.log('allUsers:', allUsers);
            console.log('allUsers length:', allUsers ? allUsers.length : 'null');
            
            // Check if new UI elements exist, if not fall back to old UI
            const modernTable = document.getElementById('usersDataTable');
            const legacyContainer = document.getElementById('userListContainer');
            
            if (modernTable) {
                console.log('Using modern table UI');
                // Hide legacy container and show modern table
                if (legacyContainer) {
                    legacyContainer.classList.add('d-none');
                }
                modernTable.closest('.card').style.display = 'block';
                displayUsersModern();
            } else if (legacyContainer) {
                console.log('Using legacy container UI');
                // Show legacy container and hide modern table if it exists
                legacyContainer.classList.remove('d-none');
                if (modernTable) {
                    modernTable.closest('.card').style.display = 'none';
                }
                displayUsersLegacy();
            } else {
                console.error('No UI container found for users');
            }
        }
        
        function displayUsersLegacy() {
            const container = document.getElementById('userListContainer');
            
            if (!allUsers || allUsers.length < 2) {
                container.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-people fs-1 mb-3"></i>
                        <p class="mb-0">No users found</p>
                        <small>Click "Add User" to create your first user</small>
                        <div class="mt-3 text-info small">
                            Debug: allUsers length = ${allUsers ? allUsers.length : 'null'}
                        </div>
                    </div>
                `;
                return;
            }

            let usersHtml = '<div class="list-group">';
            
            for (let i = 1; i < allUsers.length; i++) {
                const user = allUsers[i];
                const username = user[1] || 'Unknown';
                const role = user[3] || 'security';
                const fullName = user[4] || 'No name provided';
                const email = user[5] || 'No email provided';
                const status = user[6] || 'active';
                const createdDate = user[7] ? new Date(user[7]).toLocaleDateString() : 'Unknown';
                
                const roleDisplay = role.charAt(0).toUpperCase() + role.slice(1);
                const isCurrentUser = username === currentUser.username;
                const userCardClass = isCurrentUser ? 'border-primary bg-light' : '';
                
                // Get role-specific icon and colors
                let roleIcon = 'bi-person';
                let roleColor = 'text-secondary';
                switch(role) {
                    case 'super-admin': 
                        roleIcon = 'bi-shield-fill-check'; 
                        roleColor = 'text-danger';
                        break;
                    case 'admin': 
                        roleIcon = 'bi-person-gear'; 
                        roleColor = 'text-warning';
                        break;
                    case 'security': 
                        roleIcon = 'bi-shield'; 
                        roleColor = 'text-primary';
                        break;
                    default: 
                        roleIcon = 'bi-person';
                        roleColor = 'text-secondary';
                }
                
                // Status badge styling
                let statusBadge = '';
                let statusIcon = '';
                switch(status) {
                    case 'active':
                        statusBadge = 'badge bg-success';
                        statusIcon = '‚úÖ';
                        break;
                    case 'inactive':
                        statusBadge = 'badge bg-warning text-dark';
                        statusIcon = '‚è∏Ô∏è';
                        break;
                    case 'suspended':
                        statusBadge = 'badge bg-danger';
                        statusIcon = 'üö´';
                        break;
                    default:
                        statusBadge = 'badge bg-secondary';
                        statusIcon = '‚ùì';
                }
                
                usersHtml += `
                    <div class="list-group-item ${userCardClass}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="${roleIcon} me-2 ${roleColor}"></i>
                                    <span class="fw-bold fs-6">${username}</span>
                                    ${isCurrentUser ? '<span class="badge bg-info ms-2">You</span>' : ''}
                                    <span class="badge role-badge ${role} ms-2">${roleDisplay}</span>
                                    <span class="${statusBadge} ms-2">${statusIcon} ${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                                </div>
                                <div class="mb-2">
                                    <div class="text-muted small">
                                        <i class="bi bi-person-fill me-1"></i>
                                        <strong>${fullName}</strong>
                                    </div>
                                    <div class="text-muted small">
                                        <i class="bi bi-envelope me-1"></i>
                                        ${email}
                                    </div>
                                </div>
                                <div class="text-muted small">
                                    <i class="bi bi-calendar-plus me-1"></i>
                                    <span>Created: ${createdDate}</span>
                                </div>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="editUser(${i})" 
                                        title="Edit User Details"
                                        ${isCurrentUser && currentUser.role !== 'super-admin' ? 'disabled' : ''}>
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info" 
                                        onclick="viewUserDetails(${i})" 
                                        title="View User Details">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="deleteUser(${i})" 
                                        title="Delete User"
                                        ${isCurrentUser || (currentUser.role === 'admin' && role === 'super-admin') ? 'disabled' : ''}>
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            usersHtml += '</div>';
            
            // Add user count summary
            const userCount = allUsers.length - 1;
            const countSummary = `
                <div class="mt-3 text-center">
                    <div class="badge bg-primary fs-6 px-3 py-2">
                        <i class="bi bi-people me-2"></i>
                        Total Users: ${userCount}
                    </div>
                </div>
            `;
            
            container.innerHTML = usersHtml + countSummary;
        }
        
        function displayUsersModern() {
            const tableBody = document.getElementById('userTableBody');
            const noUsersState = document.getElementById('noUsersState');
            const usersTable = document.getElementById('usersDataTable');
            const totalUsersCount = document.getElementById('totalUsersCount');
            
            if (!allUsers || allUsers.length < 2) {
                usersTable.style.display = 'none';
                noUsersState.classList.remove('d-none');
                if (totalUsersCount) totalUsersCount.textContent = '0';
                return;
            }

            usersTable.style.display = 'table';
            noUsersState.classList.add('d-none');
            
            const userCount = allUsers.length - 1;
            if (totalUsersCount) totalUsersCount.textContent = userCount;
            
            let tableRows = '';
            
            for (let i = 1; i < allUsers.length; i++) {
                const user = allUsers[i];
                const username = user[1] || 'Unknown';
                const role = user[3] || 'security';
                const fullName = user[4] || 'No name provided';
                const email = user[5] || 'No email provided';
                const status = user[6] || 'active';
                const createdDate = user[7] ? new Date(user[7]).toLocaleDateString() : 'Unknown';
                
                const roleDisplay = role.charAt(0).toUpperCase() + role.slice(1);
                const isCurrentUser = username === currentUser.username;
                
                // Get role-specific styling
                let roleIcon = 'bi-person';
                let roleColor = 'text-secondary';
                switch(role) {
                    case 'super-admin': 
                        roleIcon = 'bi-shield-fill-check'; 
                        roleColor = 'text-danger';
                        break;
                    case 'admin': 
                        roleIcon = 'bi-person-gear'; 
                        roleColor = 'text-warning';
                        break;
                    case 'security': 
                        roleIcon = 'bi-shield'; 
                        roleColor = 'text-primary';
                        break;
                    default: 
                        roleIcon = 'bi-person';
                        roleColor = 'text-secondary';
                }
                
                // Status styling
                let statusBadge = '';
                let statusIcon = '';
                switch(status) {
                    case 'active':
                        statusBadge = 'badge bg-success';
                        statusIcon = '‚úÖ';
                        break;
                    case 'inactive':
                        statusBadge = 'badge bg-warning text-dark';
                        statusIcon = '‚è∏Ô∏è';
                        break;
                    case 'suspended':
                        statusBadge = 'badge bg-danger';
                        statusIcon = 'üö´';
                        break;
                    default:
                        statusBadge = 'badge bg-secondary';
                        statusIcon = '‚ùì';
                }
                
                const rowClass = isCurrentUser ? 'table-primary' : '';
                
                tableRows += `
                    <tr class="${rowClass}" data-user-index="${i}">
                        <td class="px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="rounded-circle bg-light d-flex align-items-center justify-content-center" 
                                         style="width: 40px; height: 40px;">
                                        <i class="${roleIcon} ${roleColor}"></i>
                                    </div>
                                </div>
                                <div>
                                    <div class="fw-bold text-dark">${username}</div>
                                    <div class="text-muted small">${fullName}</div>
                                    ${isCurrentUser ? '<span class="badge bg-info mt-1">Current User</span>' : ''}
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="badge role-badge ${role} px-3 py-2">
                                <i class="${roleIcon} me-1"></i>${roleDisplay}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-dark">${email}</div>
                            <small class="text-muted">
                                <i class="bi bi-envelope-fill me-1"></i>Contact
                            </small>
                        </td>
                        <td class="px-4 py-3">
                            <span class="${statusBadge} px-3 py-2">
                                ${statusIcon} ${status.charAt(0).toUpperCase() + status.slice(1)}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-dark">${createdDate}</div>
                            <small class="text-muted">
                                <i class="bi bi-calendar3 me-1"></i>Registration
                            </small>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="editUser(${i})" 
                                        title="Edit User Details"
                                        ${isCurrentUser && currentUser.role !== 'super-admin' ? 'disabled' : ''}>
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info" 
                                        onclick="viewUserDetails(${i})" 
                                        title="View User Details">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="deleteUser(${i})" 
                                        title="Delete User"
                                        ${isCurrentUser || (currentUser.role === 'admin' && role === 'super-admin') ? 'disabled' : ''}>
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }
            
            tableBody.innerHTML = tableRows;
        }

        // Enhanced password toggle functionality
        function togglePasswordVisibility() {
            const passwordField = document.getElementById('userPassword');
            const toggleButton = document.getElementById('togglePassword');
            const toggleIcon = toggleButton.querySelector('i');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleIcon.className = 'bi bi-eye-slash';
                toggleButton.title = 'Hide password';
            } else {
                passwordField.type = 'password';
                toggleIcon.className = 'bi bi-eye';
                toggleButton.title = 'Show password';
            }
        }

        // Enhanced password validation
        function validatePasswords() {
            const password = document.getElementById('userPassword').value;
            const confirmPassword = document.getElementById('userPasswordConfirm').value;
            const confirmField = document.getElementById('userPasswordConfirm');
            const errorDiv = document.getElementById('passwordMismatchError');
            
            // Remove previous validation classes
            confirmField.classList.remove('is-invalid', 'is-valid');
            
            if (password !== confirmPassword) {
                confirmField.classList.add('is-invalid');
                errorDiv.style.display = 'block';
                return false;
            } else if (password && confirmPassword) {
                confirmField.classList.add('is-valid');
                errorDiv.style.display = 'none';
                return true;
            }
            
            errorDiv.style.display = 'none';
            return true;
        }

        function showAddUserForm() {
            document.getElementById('userForm').style.display = 'block';
            document.getElementById('userFormTitle').textContent = 'Add New User';
            document.getElementById('editUserIndex').value = '-1';
            
            // Reset form fields
            document.getElementById('userUsername').value = '';
            document.getElementById('userFullName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userRole').value = 'security';
            document.getElementById('userPassword').value = '';
            document.getElementById('userPasswordConfirm').value = '';
            document.getElementById('userStatus').value = 'active';
            document.getElementById('userCreatedDate').value = '';
            
            // Show password required label and make password required
            document.getElementById('passwordRequiredLabel').classList.remove('d-none');
            document.getElementById('passwordOptionalLabel').classList.add('d-none');
            document.getElementById('userPassword').required = true;
            document.getElementById('userPasswordConfirm').required = true;
            
            // Clear validation classes
            document.getElementById('userPasswordConfirm').classList.remove('is-invalid', 'is-valid');
            
            // Add password validation listeners
            const passwordField = document.getElementById('userPassword');
            const confirmField = document.getElementById('userPasswordConfirm');
            
            passwordField.addEventListener('input', validatePasswords);
            confirmField.addEventListener('input', validatePasswords);
            
            document.getElementById('userUsername').focus();
        }

        function editUser(index) {
            const user = allUsers[index];
            document.getElementById('userForm').style.display = 'block';
            document.getElementById('userFormTitle').textContent = 'Edit User';
            document.getElementById('editUserIndex').value = index;
            
            // Populate form with all fields
            document.getElementById('userUsername').value = user[1] || '';
            document.getElementById('userRole').value = user[3] || 'security';
            document.getElementById('userFullName').value = user[4] || '';
            document.getElementById('userEmail').value = user[5] || '';
            document.getElementById('userStatus').value = user[6] || 'active';
            
            // Format and display created date
            const createdDate = user[7] ? new Date(user[7]).toLocaleDateString() : 'Not set';
            document.getElementById('userCreatedDate').value = createdDate;
            
            // Clear password fields for editing
            document.getElementById('userPassword').value = '';
            document.getElementById('userPasswordConfirm').value = '';
            
            // Show password optional label and make password not required for edits
            document.getElementById('passwordRequiredLabel').classList.add('d-none');
            document.getElementById('passwordOptionalLabel').classList.remove('d-none');
            document.getElementById('userPassword').required = false;
            document.getElementById('userPasswordConfirm').required = false;
            
            // Clear validation classes
            document.getElementById('userPasswordConfirm').classList.remove('is-invalid', 'is-valid');
            
            // Add password validation listeners
            const passwordField = document.getElementById('userPassword');
            const confirmField = document.getElementById('userPasswordConfirm');
            
            passwordField.addEventListener('input', validatePasswords);
            confirmField.addEventListener('input', validatePasswords);
            
            document.getElementById('userUsername').focus();
        }

        function cancelUserForm() {
            document.getElementById('userForm').style.display = 'none';
            document.getElementById('addEditUserForm').reset();
            
            // Clear validation classes and error displays
            document.getElementById('userPasswordConfirm').classList.remove('is-invalid', 'is-valid');
            document.getElementById('passwordMismatchError').style.display = 'none';
            
            // Reset password field type
            const passwordField = document.getElementById('userPassword');
            const toggleButton = document.getElementById('togglePassword');
            const toggleIcon = toggleButton.querySelector('i');
            
            passwordField.type = 'password';
            toggleIcon.className = 'bi bi-eye';
            toggleButton.title = 'Show password';
        }

        function saveUser() {
            const index = parseInt(document.getElementById('editUserIndex').value);
            const username = document.getElementById('userUsername').value.trim();
            const fullName = document.getElementById('userFullName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const role = document.getElementById('userRole').value;
            const password = document.getElementById('userPassword').value;
            const confirmPassword = document.getElementById('userPasswordConfirm').value;
            const status = document.getElementById('userStatus').value;
            
            // Basic validation
            if (!username || !role || !fullName || !email) {
                showToast('Username, Full Name, Email, and Role are required', 'danger');
                return;
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('Please enter a valid email address', 'danger');
                document.getElementById('userEmail').focus();
                return;
            }
            
            // Password validation for new users
            const isNewUser = index === -1;
            if (isNewUser && !password) {
                showToast('Password is required for new users', 'danger');
                document.getElementById('userPassword').focus();
                return;
            }
            
            // Password confirmation validation
            if (password && !confirmPassword) {
                showToast('Please confirm your password', 'danger');
                document.getElementById('userPasswordConfirm').focus();
                return;
            }
            
            // Password match validation
            if (password && password !== confirmPassword) {
                showToast('Passwords do not match', 'danger');
                document.getElementById('userPasswordConfirm').focus();
                return;
            }
            
            // Password length validation
            if (password && password.length < 6) {
                showToast('Password must be at least 6 characters long', 'danger');
                document.getElementById('userPassword').focus();
                return;
            }

            // Check if username already exists (excluding current user)
            if (allUsers) {
                for (let i = 1; i < allUsers.length; i++) {
                if (i !== index && allUsers[i][1] === username) {
                    showToast('Username already exists', 'danger');
                    document.getElementById('userUsername').focus();
                    return;
                }
                }
            }

            // Build user data object
            const userData = {
                username: username,
                fullName: fullName,
                email: email,
                role: role,
                status: status
            };
            
            // Only include password if it's provided
            if (password) {
                userData.password = password;
            }

            // Show loading feedback
            const saveButton = event.target;
            const originalText = saveButton.innerHTML;
            saveButton.disabled = true;
            saveButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';

            google.script.run
                .withSuccessHandler(function(result) {
                    saveButton.disabled = false;
                    saveButton.innerHTML = originalText;
                    
                    if (result.success) {
                        loadUsers();
                        cancelUserForm();
                        
                        // Enhanced success message
                        const action = isNewUser ? 'created' : 'updated';
                        let message = `User ${username} ${action} successfully!`;
                        if (password && !isNewUser) {
                            message += ' Password has been updated.';
                        }
                        showToast(message, 'success');
                    } else {
                        showToast(result.message || 'Failed to save user', 'danger');
                    }
                })
                .withFailureHandler(function(error) {
                    saveButton.disabled = false;
                    saveButton.innerHTML = originalText;
                    showToast('Failed to save user: ' + error, 'danger');
                })
                .saveUser(userData, currentUser.role, index);
        }

        function deleteUser(index) {
            if (!hasPermission('users', 'delete')) {
                showToast('Access denied: Only Super Admin can delete users', 'danger');
                return;
            }

            const user = allUsers[index];
            const username = user[1];
            const role = user[3] || 'user';

            // Prevent deleting yourself
            if (username === currentUser.username) {
                showToast('Cannot delete your own account', 'danger');
                return;
            }

            // This check is now handled by the backend permission system
            // Only super-admin role has 'delete' permission for users

            // Enhanced confirmation dialog with role information
            const confirmMessage = `‚ö†Ô∏è DELETE USER CONFIRMATION ‚ö†Ô∏è\n\nUsername: ${username}\nRole: ${role.charAt(0).toUpperCase() + role.slice(1)}\n\nThis action cannot be undone.\nAre you sure you want to permanently delete this user?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }

            // Show loading feedback
            const deleteButton = event.target.closest('button');
            const originalContent = deleteButton.innerHTML;
            deleteButton.disabled = true;
            deleteButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>';

            google.script.run
                .withSuccessHandler(function(result) {
                    deleteButton.disabled = false;
                    deleteButton.innerHTML = originalContent;
                    
                    if (result.success) {
                        loadUsers();
                        showToast(`User "${username}" deleted successfully!`, 'success');
                    } else {
                        showToast(result.message || 'Failed to delete user', 'danger');
                    }
                })
                .withFailureHandler(function(error) {
                    deleteButton.disabled = false;
                    deleteButton.innerHTML = originalContent;
                    showToast('Failed to delete user: ' + error, 'danger');
                })
                .deleteUser(index, currentUser.role);
        }

        function showRoleSettings() {
            const modal = new bootstrap.Modal(document.getElementById('roleSettingsModal'));
            modal.show();
        }

        // Gate Management Functions - Simplified
        let allGates = [];
        let activeGates = [];

        function loadActiveGates() {
            google.script.run
                .withSuccessHandler(function(gates) {
                    activeGates = gates;
                    updateGateSelector();
                })
                .withFailureHandler(function(error) {
                    console.error('Failed to load active gates:', error);
                    // Fallback to default gates
                    activeGates = [
                        { id: 'Main Gate', name: 'Main Gate' },
                        { id: 'Back Gate', name: 'Back Gate' }
                    ];
                    updateGateSelector();
                })
                .getActiveGates();
        }

        function updateGateSelector() {
            const gateSelector = document.getElementById('gateSelector');
            if (!gateSelector) return;

            // Clear existing options
            gateSelector.innerHTML = '';

            // Show loading state if no gates
            if (!activeGates || activeGates.length === 0) {
                const loadingOption = document.createElement('option');
                loadingOption.value = '';
                loadingOption.textContent = '‚ö†Ô∏è No gates available';
                loadingOption.disabled = true;
                gateSelector.appendChild(loadingOption);
                return;
            }

            // Add active gates with enhanced icon mapping
            activeGates.forEach(gate => {
                const option = document.createElement('option');
                option.value = gate.id;
                
                // Enhanced icon mapping based on gate name
                let icon = 'üèõÔ∏è'; // Default gate icon
                const gateName = gate.name.toLowerCase();
                
                if (gateName.includes('main') || gateName.includes('front')) icon = 'üèõÔ∏è';
                else if (gateName.includes('back') || gateName.includes('rear') || gateName.includes('side')) icon = 'üö™';
                else if (gateName.includes('parking') || gateName.includes('park')) icon = 'üÖøÔ∏è';
                else if (gateName.includes('service') || gateName.includes('maintenance')) icon = 'üîß';
                else if (gateName.includes('emergency') || gateName.includes('exit')) icon = 'üö®';
                else if (gateName.includes('security') || gateName.includes('guard')) icon = 'üõ°Ô∏è';
                else if (gateName.includes('visitor') || gateName.includes('guest')) icon = 'üë•';
                else if (gateName.includes('delivery') || gateName.includes('cargo')) icon = 'üì¶';
                else if (gateName.includes('pedestrian') || gateName.includes('walk')) icon = 'üö∂';
                
                option.textContent = `${icon} ${gate.name}`;
                gateSelector.appendChild(option);
            });

            // Restore previously selected gate or select first gate
            const savedGate = sessionStorage.getItem('selectedGate');
            let gateSelected = false;
            
            if (savedGate) {
                // Check if saved gate still exists
                const gateExists = activeGates.find(gate => gate.id === savedGate);
                if (gateExists) {
                    gateSelector.value = savedGate;
                    gateSelected = true;
                }
            }
            
            // If no saved gate or saved gate doesn't exist, select first gate
            if (!gateSelected && activeGates.length > 0) {
                gateSelector.value = activeGates[0].id;
                sessionStorage.setItem('selectedGate', activeGates[0].id);
            }
            
            // Add change event listener for persistence (only once)
            if (!gateSelector.hasAttribute('data-listener-added')) {
                gateSelector.addEventListener('change', function() {
                    if (this.value) {
                        sessionStorage.setItem('selectedGate', this.value);
                        const gateName = this.options[this.selectedIndex].text;
                        showToast(`Switched to ${gateName}`, 'info');
                    }
                });
                gateSelector.setAttribute('data-listener-added', 'true');
            }
        }

        function refreshGateSelector() {
            // Show loading state
            const gateSelector = document.getElementById('gateSelector');
            if (gateSelector) {
                gateSelector.innerHTML = '<option value="">üîÑ Refreshing gates...</option>';
            }
            
            // Reload gates and update selector
            loadActiveGates();
            
            // Show feedback
            showToast('Refreshing gates...', 'info');
        }

        function getCurrentGate() {
            const gateSelector = document.getElementById('gateSelector');
            if (gateSelector && gateSelector.value) {
                return {
                    id: gateSelector.value,
                    name: gateSelector.options[gateSelector.selectedIndex].text.replace(/^[^\s]+\s/, '') // Remove emoji
                };
            }
            return null;
        }

        function validateGateSelection() {
            const gate = getCurrentGate();
            if (!gate) {
                showToast('Please select a gate before performing vehicle operations', 'warning');
                return false;
            }
            return true;
        }

        function showGateManagement() {
            if (!hasPermission('gates', 'create') && !hasPermission('gates', 'read')) {
                showToast('Access denied: Insufficient permissions for gate management', 'danger');
                return;
            }

            const modal = new bootstrap.Modal(document.getElementById('gateManagementModal'));
            modal.show();
            
            loadGates();
        }

        function loadGates() {
            google.script.run
                .withSuccessHandler(function(data) {
                    allGates = data;
                    displayGates();
                })
                .withFailureHandler(function(error) {
                    showToast('Failed to load gates: ' + error, 'danger');
                })
                .getGateList();
        }

        function displayGates() {
            const container = document.getElementById('gateListContainer');
            
            if (allGates.length <= 1) {
                container.innerHTML = '<div class="text-center py-3 text-muted">No gates found</div>';
                return;
            }

            let gatesHtml = '<div class="list-group">';
            
            for (let i = 1; i < allGates.length; i++) {
                const gate = allGates[i];
                gatesHtml += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>${gate[0]}</span>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" onclick="editGate(${i})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteGate(${i})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }
            
            gatesHtml += '</div>';
            container.innerHTML = gatesHtml;
        }

        function showAddGateForm() {
            document.getElementById('gateForm').style.display = 'block';
            document.getElementById('gateFormTitle').textContent = 'Add New Gate';
            document.getElementById('editGateIndex').value = '-1';
            document.getElementById('gateName').value = '';
            document.getElementById('gateName').focus();
        }

        function editGate(index) {
            const gate = allGates[index];
            document.getElementById('gateForm').style.display = 'block';
            document.getElementById('gateFormTitle').textContent = 'Edit Gate';
            document.getElementById('editGateIndex').value = index;
            document.getElementById('gateName').value = gate[0];
            document.getElementById('gateName').focus();
        }

        function cancelGateForm() {
            document.getElementById('gateForm').style.display = 'none';
            document.getElementById('addEditGateForm').reset();
        }

        function saveGate() {
            const gateName = document.getElementById('gateName').value.trim();
            const editIndex = parseInt(document.getElementById('editGateIndex').value);

            if (!gateName) {
                showToast('Gate name is required', 'danger');
                return;
            }

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        loadGates();
                        loadActiveGates(); // Refresh gate selector
                        cancelGateForm();
                        showToast(`Gate ${result.action} successfully!`, 'success');
                    }
                })
                .withFailureHandler(function(error) {
                    showToast('Failed to save gate: ' + error, 'danger');
                })
                .saveGate(gateName, currentUser.role, editIndex);
        }

        function deleteGate(index) {
            const gate = allGates[index];
            
            if (!confirm(`Are you sure you want to delete "${gate[0]}"?`)) {
                return;
            }

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        loadGates();
                        loadActiveGates(); // Refresh gate selector
                        showToast('Gate deleted successfully!', 'success');
                    }
                })
                .withFailureHandler(function(error) {
                    showToast('Failed to delete gate: ' + error, 'danger');
                })
                .deleteGate(index, currentUser.role);
        }


        function showVehicleManagement() {
            if (!hasPermission('vehicles', 'create')) {
                showToast('Access denied: Insufficient permissions to create vehicles', 'danger');
                return;
            }

            document.getElementById('addVehicleForm').reset();
            const modal = new bootstrap.Modal(document.getElementById('vehicleManagementModal'));
            modal.show();
            
            // Focus on first input field
            setTimeout(() => {
                document.getElementById('vehiclePlateNumber').focus();
            }, 300);
        }




        // Table optimization functions for large datasets
        function optimizeTablePerformance() {
            const table = document.getElementById('vehiclesTable');
            if (!table) return;
            
            // Add virtual scrolling optimization for very large datasets
            if (vehicleData.length > DISPLAY_BATCH_SIZE) {
                console.log(`Large dataset detected: ${vehicleData.length} vehicles. Consider implementing virtual scrolling.`);
            }
        }
        
        function optimizeForMobile() {
            // Detect if mobile device
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile || window.innerWidth <= 768) {
                // Reduce animation durations for better performance
                document.documentElement.style.setProperty('--animation-duration', '0.1s');
                
                // Add touch-friendly classes
                document.body.classList.add('touch-device');
                
                // Optimize vehicle card interactions
                const vehicleCards = document.querySelectorAll('.vehicle-card');
                vehicleCards.forEach(card => {
                    card.addEventListener('touchstart', function() {
                        this.classList.add('touch-active');
                    }, { passive: true });
                    
                    card.addEventListener('touchend', function() {
                        setTimeout(() => this.classList.remove('touch-active'), 100);
                    }, { passive: true });
                });
                
                // Improve modal backdrop for mobile
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    modal.addEventListener('shown.bs.modal', function() {
                        // Prevent body scroll when modal is open
                        document.body.style.overflow = 'hidden';
                        document.body.style.position = 'fixed';
                        document.body.style.width = '100%';
                    });
                    
                    modal.addEventListener('hidden.bs.modal', function() {
                        // Restore body scroll
                        document.body.style.overflow = '';
                        document.body.style.position = '';
                        document.body.style.width = '';
                    });
                });
            }
            
            // Add viewport height fix for mobile browsers
            function setViewportHeight() {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }
            
            setViewportHeight();
            window.addEventListener('resize', setViewportHeight);
            window.addEventListener('orientationchange', setViewportHeight);
        }

        function saveVehicle() {
            const plateNumber = document.getElementById('vehiclePlateNumber').value.trim();
            const model = document.getElementById('vehicleModel').value.trim();

            if (!plateNumber || !model) {
                showToast('Plate number and make/model are required', 'danger');
                return;
            }

            const vehicleData = {
                plateNumber: plateNumber,
                model: model,
                color: document.getElementById('vehicleColor').value.trim(),
                department: document.getElementById('vehicleDepartment').value.trim(),
                year: document.getElementById('vehicleYear').value,
                type: document.getElementById('vehicleType').value,
                status: document.getElementById('vehicleStatus').value,
                driver: document.getElementById('vehicleDriver').value.trim(),
                assignedDrivers: document.getElementById('vehicleAssignedDrivers').value.trim(),
                accessStatus: document.getElementById('vehicleAccessStatus').value
            };

            // Show loading state
            showVehicleModalLoading(true, 'add');

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        loadVehicles(); // Refresh main dashboard
                        document.getElementById('addVehicleForm').reset();
                        bootstrap.Modal.getInstance(document.getElementById('vehicleManagementModal')).hide();
                        showToast('Vehicle added successfully!', 'success');
                    }
                    showVehicleModalLoading(false, 'add');
                })
                .withFailureHandler(function(error) {
                    showToast('Failed to save vehicle: ' + error, 'danger');
                    showVehicleModalLoading(false, 'add');
                })
                .saveVehicleRecord(vehicleData, currentUser.role, -1);
        }

        // QR Scanner Functions
        let qrScannerStream = null;
        let qrScannerAnimationFrame = null;
        let qrScannerActive = false;
        let qrScanCount = 0; // Track successful scans in session
        let scanSessionStartTime = null; // Track session duration

        function showQRScanner() {
            const modal = new bootstrap.Modal(document.getElementById('qrScannerModal'));
            
            // Reset modal state
            resetQRScannerModal();
            
            modal.show();
            
            // Load gates and set default gate once when modal is shown
            loadGatesForQRScanner();
            
            // Initialize scanner after modal is fully shown
            document.getElementById('qrScannerModal').addEventListener('shown.bs.modal', function() {
                initQRScanner();
            }, { once: true });
            
            // Clean up when modal is hidden
            document.getElementById('qrScannerModal').addEventListener('hidden.bs.modal', function() {
                stopQRScanner();
                resetQRScannerModal();
            }, { once: true });
        }

        function resetQRScannerModal() {
            // Reset UI elements
            document.getElementById('noScanResult').classList.remove('d-none');
            document.getElementById('scanResultData').classList.add('d-none');
            document.getElementById('transactionForm').classList.add('d-none');
            document.getElementById('cameraError').classList.add('d-none');
            
            // Reset form
            document.getElementById('qrTransactionForm').reset();
            
            // Reset status
            document.getElementById('qrScannerStatus').textContent = 'Position QR code within the frame';
            document.getElementById('qrScannerStatus').style.background = 'rgba(0, 0, 0, 0.7)';
            
            // Reset alert style
            const nextActionInfo = document.getElementById('nextActionInfo');
            nextActionInfo.className = 'alert alert-info';
            
            // Reset scan counter and start time when modal is reopened
            qrScanCount = 0;
            scanSessionStartTime = new Date();
        }

        function loadGatesForQRScanner() {
            google.script.run
                .withSuccessHandler(function(gates) {
                    const select = document.getElementById('qrGateSelect');
                    select.innerHTML = '';
                    
                    if (gates && gates.length > 1) { // Skip header row
                        for (let i = 1; i < gates.length; i++) {
                            const gate = gates[i];
                            if (gate[0]) { // Gate name exists
                                const option = document.createElement('option');
                                option.value = gate[0];
                                option.textContent = `${gate[0]} - ${gate[1] || 'No description'}`;
                                select.appendChild(option);
                            }
                        }
                        
                        // Auto-select first gate as default for continuous scanning
                        if (select.options.length > 0) {
                            select.selectedIndex = 0;
                            const defaultGate = select.options[0].textContent;
                            console.log('Default gate set:', defaultGate);
                            
                            // Show notification about the selected gate
                            const status = document.getElementById('qrScannerStatus');
                            status.textContent = `Ready to scan - Using ${defaultGate}`;
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading gates:', error);
                    // Fallback to manual selection
                    const select = document.getElementById('qrGateSelect');
                    select.innerHTML = '<option value="">Select Gate</option>';
                })
                .getGateList();
        }

        async function initQRScanner() {
            const video = document.getElementById('qrScannerVideo');
            const canvas = document.getElementById('qrScannerCanvas');
            const status = document.getElementById('qrScannerStatus');
            const cameraError = document.getElementById('cameraError');
            const scannerContainer = document.getElementById('qrScannerContainer');

            try {
                // Hide error and show scanner
                cameraError.classList.add('d-none');
                video.style.display = 'block';
                
                // Stop any existing stream
                if (qrScannerStream) {
                    stopQRScanner();
                }

                // Request camera access
                qrScannerStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'environment', // Use back camera on mobile
                        width: { ideal: 400 },
                        height: { ideal: 400 }
                    }
                });

                video.srcObject = qrScannerStream;
                await video.play();

                // Set canvas size to match video
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                qrScannerActive = true;
                status.textContent = 'Camera ready - Position QR code within frame';
                
                // Start scanning
                scanQRCode();
                
            } catch (error) {
                console.error('Camera access error:', error);
                video.style.display = 'none';
                cameraError.classList.remove('d-none');
                status.textContent = 'Camera access denied';
            }
        }

        function scanQRCode() {
            if (!qrScannerActive) return;

            const video = document.getElementById('qrScannerVideo');
            const canvas = document.getElementById('qrScannerCanvas');
            const context = canvas.getContext('2d');
            const status = document.getElementById('qrScannerStatus');

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                    status.textContent = 'QR Code detected! Processing...';
                    processQRCodeData(code.data);
                    return; // Stop scanning once we find a code
                } else {
                    status.textContent = 'Scanning for QR code...';
                }
            }

            qrScannerAnimationFrame = requestAnimationFrame(scanQRCode);
        }

        function processQRCodeData(qrData) {
            console.log('QR Code scanned:', qrData);
            
            // Assume QR code contains the plate number
            const plateNumber = qrData.trim().toUpperCase();
            
            // First, try to find vehicle in already loaded data for faster processing
            const vehicleInfo = findVehicleInLoadedData(plateNumber);
            
            if (vehicleInfo) {
                displayVehicleInfo(vehicleInfo);
                // Auto-process transaction for continuous scanning
                autoProcessTransaction(vehicleInfo);
            } else {
                // Fallback to server lookup if not found in loaded data
                google.script.run
                    .withSuccessHandler(function(serverVehicleInfo) {
                        if (serverVehicleInfo.found) {
                            displayVehicleInfo(serverVehicleInfo);
                            autoProcessTransaction(serverVehicleInfo);
                        } else {
                            showQRScanError('Vehicle not found: ' + plateNumber);
                        }
                    })
                    .withFailureHandler(function(error) {
                        showQRScanError('Error verifying vehicle: ' + error);
                    })
                    .getVehicleByPlate(plateNumber);
            }
        }

        function findVehicleInLoadedData(plateNumber) {
            // Search in the already loaded vehicle data for faster processing
            if (!vehicleData || vehicleData.length <= 1) return null;
            
            for (let i = 1; i < vehicleData.length; i++) {
                const vehicle = vehicleData[i];
                if (vehicle && vehicle[1] && vehicle[1].trim().toUpperCase() === plateNumber) {
                    // Return vehicle info in the same format as server response
                    return {
                        found: true,
                        plateNumber: vehicle[1] || '',
                        makeModel: vehicle[2] || '',
                        color: vehicle[3] || '',
                        department: vehicle[4] || '',
                        year: vehicle[5] || '',
                        type: vehicle[6] || '',
                        currentStatus: vehicle[7] || 'OUT',
                        currentDriver: vehicle[8] || '',
                        assignedDrivers: vehicle[9] || '',
                        accessStatus: vehicle[10] || 'Access'
                    };
                }
            }
            
            return null;
        }

        function autoProcessTransaction(vehicleInfo) {
            // Check for restricted access first and show alerts
            if (vehicleInfo.accessStatus === 'Banned') {
                showAccessDeniedAlert(vehicleInfo, 'BANNED', 'This vehicle is BANNED from the premises. Contact security supervisor immediately.');
                return;
            }
            
            if (vehicleInfo.accessStatus === 'No Access' && vehicleInfo.currentStatus === 'OUT') {
                showAccessDeniedAlert(vehicleInfo, 'NO ACCESS', 'This vehicle does not have access permission to enter the premises.');
                return;
            }
            
            // Auto-process transaction for continuous scanning
            setTimeout(() => {
                const gate = document.getElementById('qrGateSelect').value;
                const nextAction = vehicleInfo.currentStatus === 'IN' ? 'OUT' : 'IN';
                
                // Only auto-process if gate is selected and vehicle has access (or is going OUT)
                if (gate && (vehicleInfo.accessStatus === 'Access' || nextAction === 'OUT')) {
                    const transactionData = {
                        plateNumber: vehicleInfo.plateNumber,
                        action: nextAction,
                        gate: gate,
                        driverId: vehicleInfo.currentDriver || '',
                        remarks: 'QR Scanner auto-transaction',
                        username: currentUser.username
                    };

                    // Update status to show processing
                    const status = document.getElementById('qrScannerStatus');
                    status.textContent = `Processing ${nextAction} for ${vehicleInfo.plateNumber}...`;

                    google.script.run
                        .withSuccessHandler(function(result) {
                            if (result.success) {
                                qrScanCount++; // Increment successful scan counter
                                
                                // Calculate session performance
                                const sessionDuration = (new Date() - scanSessionStartTime) / 1000 / 60; // minutes
                                const scansPerMinute = sessionDuration > 0 ? (qrScanCount / sessionDuration).toFixed(1) : '0';
                                
                                status.textContent = `‚úì ${vehicleInfo.plateNumber} ${nextAction} (#${qrScanCount} @ ${scansPerMinute}/min) - Ready for next`;
                                status.style.background = 'rgba(40, 167, 69, 0.8)'; // Green background
                                
                                // Update local vehicle data for immediate UI refresh
                                updateLocalVehicleData(vehicleInfo.plateNumber, nextAction);
                                
                                // Refresh dashboard in background
                                loadVehicles();
                                loadTransactionLogs();
                                
                                // Quick toast notification for additional feedback
                                showToast(`${vehicleInfo.plateNumber} ${nextAction} logged successfully`, 'success');
                                
                                // Reset for next scan after a short delay and auto-continue
                                setTimeout(() => {
                                    resetForNextScan();
                                    // Auto-continue scanning without restart
                                    continuousScanning();
                                }, 1200); // Even faster reset for better throughput
                            } else {
                                showQRScanError('Transaction failed: ' + result.message);
                            }
                        })
                        .withFailureHandler(function(error) {
                            showQRScanError('Error logging transaction: ' + error);
                        })
                        .logVehicleAction(transactionData);
                } else {
                    // Manual confirmation needed for restricted access
                    const nextActionText = document.getElementById('nextActionText');
                    if (vehicleInfo.accessStatus === 'No Access') {
                        nextActionText.textContent = '‚ö†Ô∏è NO ACCESS - Manual supervisor override required';
                        nextActionText.parentElement.className = 'alert alert-warning';
                    } else {
                        nextActionText.textContent = 'Manual confirmation required - Select action below';
                    }
                    document.getElementById('transactionForm').classList.remove('d-none');
                }
            }, 1000); // Small delay to show vehicle info
        }

        function updateLocalVehicleData(plateNumber, newStatus) {
            // Update the local vehicle data for immediate UI response
            if (vehicleData && vehicleData.length > 1) {
                for (let i = 1; i < vehicleData.length; i++) {
                    if (vehicleData[i] && vehicleData[i][1] === plateNumber) {
                        vehicleData[i][7] = newStatus; // Update status
                        break;
                    }
                }
                // Refresh the vehicle display
                displayVehicles();
                updateStatistics();
            }
        }

        function resetForNextScan() {
            // Reset UI for next scan while keeping gate selection
            document.getElementById('noScanResult').classList.remove('d-none');
            document.getElementById('scanResultData').classList.add('d-none');
            document.getElementById('transactionForm').classList.add('d-none');
            
            // Reset status background but keep gate info
            const status = document.getElementById('qrScannerStatus');
            status.style.background = 'rgba(0, 0, 0, 0.7)';
            
            const gateSelect = document.getElementById('qrGateSelect');
            const selectedGate = gateSelect.options[gateSelect.selectedIndex]?.textContent || 'Gate';
            if (qrScanCount > 0) {
                status.textContent = `Ready for scan #${qrScanCount + 1} - Using ${selectedGate}`;
            } else {
                status.textContent = `Ready to scan - Using ${selectedGate}`;
            }
        }

        function continuousScanning() {
            // Enhanced continuous scanning without full restart
            if (qrScannerActive && qrScannerStream) {
                // Camera is still active, just resume QR detection
                if (!qrScannerAnimationFrame) {
                    qrScannerAnimationFrame = requestAnimationFrame(scanQRCode);
                }
                
                const status = document.getElementById('qrScannerStatus');
                const gateSelect = document.getElementById('qrGateSelect');
                const selectedGate = gateSelect.options[gateSelect.selectedIndex]?.textContent || 'Gate';
                if (qrScanCount > 0) {
                    status.textContent = `üîç Scanning for vehicle #${qrScanCount + 1} - ${selectedGate}`;
                } else {
                    status.textContent = `üîç Scanning for QR code - ${selectedGate}`;
                }
            } else {
                // Camera was stopped, need to reinitialize
                console.log('Camera stream lost, reinitializing...');
                initQRScanner();
            }
        }

        function displayVehicleInfo(vehicleInfo) {
            const status = document.getElementById('qrScannerStatus');
            const noResult = document.getElementById('noScanResult');
            const scanData = document.getElementById('scanResultData');
            const transactionForm = document.getElementById('transactionForm');

            // Update UI elements
            document.getElementById('scannedPlate').textContent = vehicleInfo.plateNumber;
            document.getElementById('scannedDriver').textContent = vehicleInfo.currentDriver || 'Not assigned';
            
            // Set access status badge
            const accessBadge = document.getElementById('scannedAccessStatus');
            accessBadge.textContent = vehicleInfo.accessStatus;
            accessBadge.className = 'ms-2 badge ' + 
                (vehicleInfo.accessStatus === 'Access' ? 'bg-success' :
                 vehicleInfo.accessStatus === 'No Access' ? 'bg-warning' : 'bg-danger');

            // Set current status badge
            const currentBadge = document.getElementById('scannedCurrentStatus');
            currentBadge.textContent = vehicleInfo.currentStatus;
            currentBadge.className = 'ms-2 badge ' + 
                (vehicleInfo.currentStatus === 'IN' ? 'bg-primary' : 'bg-secondary');

            // Determine next action and pre-select it
            const nextAction = vehicleInfo.currentStatus === 'IN' ? 'OUT' : 'IN';
            const nextActionText = document.getElementById('nextActionText');
            
            if (vehicleInfo.accessStatus === 'Access' || nextAction === 'OUT') {
                nextActionText.textContent = `Vehicle ready for ${nextAction}`;
                nextActionText.parentElement.className = 'alert alert-info';
                document.getElementById(`qrAction${nextAction}`).checked = true;
                transactionForm.classList.remove('d-none');
            } else if (vehicleInfo.accessStatus === 'Banned') {
                nextActionText.textContent = 'üö´ BANNED VEHICLE - Access strictly prohibited';
                nextActionText.parentElement.className = 'alert alert-danger';
                transactionForm.classList.add('d-none');
            } else if (vehicleInfo.accessStatus === 'No Access') {
                nextActionText.textContent = '‚ö†Ô∏è NO ACCESS - Supervisor override required';
                nextActionText.parentElement.className = 'alert alert-warning';
                // Show form but with warning
                if (nextAction === 'IN') {
                    transactionForm.classList.remove('d-none');
                    document.getElementById(`qrAction${nextAction}`).checked = true;
                } else {
                    transactionForm.classList.remove('d-none');
                    document.getElementById(`qrAction${nextAction}`).checked = true;
                }
            } else {
                nextActionText.textContent = 'Vehicle access denied - cannot enter';
                nextActionText.parentElement.className = 'alert alert-danger';
                transactionForm.classList.add('d-none');
            }

            // Show results briefly for feedback
            noResult.classList.add('d-none');
            scanData.classList.remove('d-none');
            
            status.textContent = `‚úì ${vehicleInfo.plateNumber} verified - Processing...`;
            
            // Keep scanner active for continuous scanning
        }

        function showAccessDeniedAlert(vehicleInfo, alertType, message) {
            const status = document.getElementById('qrScannerStatus');
            const noResult = document.getElementById('noScanResult');
            const scanData = document.getElementById('scanResultData');
            
            // Update vehicle info display
            document.getElementById('scannedPlate').textContent = vehicleInfo.plateNumber;
            document.getElementById('scannedDriver').textContent = vehicleInfo.currentDriver || 'Not assigned';
            
            // Set access status badge with appropriate styling
            const accessBadge = document.getElementById('scannedAccessStatus');
            accessBadge.textContent = vehicleInfo.accessStatus;
            accessBadge.className = vehicleInfo.accessStatus === 'Banned' ? 'ms-2 badge bg-danger text-white' : 'ms-2 badge bg-warning text-dark';
            
            // Set current status badge
            const currentBadge = document.getElementById('scannedCurrentStatus');
            currentBadge.textContent = vehicleInfo.currentStatus;
            currentBadge.className = 'ms-2 badge ' + (vehicleInfo.currentStatus === 'IN' ? 'bg-primary' : 'bg-secondary');
            
            // Show critical alert message
            const nextActionText = document.getElementById('nextActionText');
            nextActionText.textContent = message;
            nextActionText.parentElement.className = alertType === 'BANNED' ? 'alert alert-danger' : 'alert alert-warning';
            
            // Hide transaction form for banned vehicles
            if (alertType === 'BANNED') {
                document.getElementById('transactionForm').classList.add('d-none');
            } else {
                document.getElementById('transactionForm').classList.remove('d-none');
            }
            
            // Show vehicle info
            noResult.classList.add('d-none');
            scanData.classList.remove('d-none');
            
            // Update status with alert
            const alertIcon = alertType === 'BANNED' ? 'üö´' : '‚ö†Ô∏è';
            status.textContent = `${alertIcon} ${alertType}: ${vehicleInfo.plateNumber}`;
            status.style.background = alertType === 'BANNED' ? 'rgba(220, 53, 69, 0.9)' : 'rgba(255, 193, 7, 0.9)';
            
            // Show toast notification for additional alert
            showToast(`${alertIcon} ${alertType}: ${vehicleInfo.plateNumber} - ${message}`, alertType === 'BANNED' ? 'danger' : 'warning');
            
            // Auto-continue scanning after alert display (longer delay for restricted access)
            setTimeout(() => {
                resetForNextScan();
                continuousScanning();
            }, alertType === 'BANNED' ? 4000 : 3000); // Longer delay for banned vehicles
        }
        
        function showQRScanError(message) {
            const status = document.getElementById('qrScannerStatus');
            status.textContent = `‚ùå ${message}`;
            status.style.background = 'rgba(220, 53, 69, 0.8)'; // Red background
            
            setTimeout(() => {
                resetForNextScan();
                // Continue scanning immediately for better UX
                continuousScanning();
            }, 1500); // Faster error recovery
        }

        // pauseResumeScanner function removed - pause button no longer exists in UI

        function stopQRScanner() {
            qrScannerActive = false;
            
            if (qrScannerAnimationFrame) {
                cancelAnimationFrame(qrScannerAnimationFrame);
                qrScannerAnimationFrame = null;
            }

            if (qrScannerStream) {
                qrScannerStream.getTracks().forEach(track => track.stop());
                qrScannerStream = null;
            }

            const video = document.getElementById('qrScannerVideo');
            if (video) {
                video.srcObject = null;
            }
            
            // Reset pause button state
            const pauseBtn = document.getElementById('pauseResumeBtn');
            if (pauseBtn) {
                pauseBtn.innerHTML = '<i class="bi bi-pause-fill me-1"></i>Pause';
                pauseBtn.className = 'btn btn-warning';
            }
        }

        // Handle QR transaction form submission
        document.addEventListener('DOMContentLoaded', function() {
            const qrForm = document.getElementById('qrTransactionForm');
            if (qrForm) {
                qrForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitQRTransaction();
                });
            }
        });

        function submitQRTransaction() {
            const form = document.getElementById('qrTransactionForm');
            const plateNumber = document.getElementById('scannedPlate').textContent;
            const gate = document.getElementById('qrGateSelect').value;
            const action = document.querySelector('input[name="qrAction"]:checked')?.value;
            const driverId = document.getElementById('qrDriverId').value.trim();
            const remarks = document.getElementById('qrRemarks').value.trim();
            const accessStatus = document.getElementById('scannedAccessStatus').textContent;

            if (!gate || !action) {
                showToast('Please select gate and action', 'warning');
                return;
            }

            // Special handling for restricted access vehicles
            if (accessStatus === 'Banned') {
                if (!confirm(`‚ö†Ô∏è CRITICAL WARNING ‚ö†Ô∏è\n\nVehicle ${plateNumber} is BANNED!\n\nThis vehicle should NOT be allowed on premises under any circumstances.\n\nAre you absolutely certain you want to proceed with this transaction?\n\n(This action will be logged with your username for audit purposes)`)) {
                    return;
                }
            } else if (accessStatus === 'No Access' && action === 'IN') {
                if (!confirm(`‚ö†Ô∏è ACCESS WARNING ‚ö†Ô∏è\n\nVehicle ${plateNumber} does not have access permission.\n\nProceeding will allow entry despite restrictions.\n\nDo you have supervisor authorization to override this restriction?\n\n(This override will be logged for security review)`)) {
                    return;
                }
            }

            // Build transaction data with enhanced remarks for restricted access
            let enhancedRemarks = remarks || 'QR Scanner transaction';
            if (accessStatus === 'Banned') {
                enhancedRemarks = `üö® BANNED VEHICLE OVERRIDE - ${enhancedRemarks}`;
            } else if (accessStatus === 'No Access' && action === 'IN') {
                enhancedRemarks = `‚ö†Ô∏è NO ACCESS OVERRIDE - ${enhancedRemarks}`;
            }

            const transactionData = {
                plateNumber: plateNumber,
                action: action,
                gate: gate,
                driverId: driverId,
                remarks: enhancedRemarks,
                username: currentUser.username
            };

            // Disable form
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Processing...';

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        // Enhanced success message for restricted access
                        let successMessage = 'Transaction logged successfully!';
                        if (accessStatus === 'Banned') {
                            successMessage = 'üö® BANNED VEHICLE transaction logged - Security audit trail created';
                            showToast(successMessage, 'warning');
                        } else if (accessStatus === 'No Access' && action === 'IN') {
                            successMessage = '‚ö†Ô∏è NO ACCESS override logged - Supervisor review required';
                            showToast(successMessage, 'warning');
                        } else {
                            showToast(successMessage, 'success');
                        }
                        
                        // Close modal and refresh dashboard
                        bootstrap.Modal.getInstance(document.getElementById('qrScannerModal')).hide();
                        loadVehicles();
                        loadTransactionLogs();
                    } else {
                        showToast('Transaction failed: ' + result.message, 'danger');
                    }
                    
                    // Re-enable form
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                })
                .withFailureHandler(function(error) {
                    showToast('Error logging transaction: ' + error, 'danger');
                    
                    // Re-enable form
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                })
                .logVehicleAction(transactionData);
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Check session and initialize
            const savedSession = sessionStorage.getItem('currentUser');
            if (savedSession) {
                currentUser = JSON.parse(savedSession);
                showDashboard();
            } else {
                showLoginPage();
            }
        });

        // Transaction Logs Functions
        function loadTransactionLogs() {
            const logsBody = document.getElementById('transactionLogsBody');
            logsBody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted mb-0">Loading transaction logs...</p>
                    </td>
                </tr>
            `;

            google.script.run
                .withSuccessHandler(displayTransactionLogs)
                .withFailureHandler(function(error) {
                    console.error('Error loading transaction logs:', error);
                    logsBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center py-4 text-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Failed to load transaction logs
                            </td>
                        </tr>
                    `;
                })
                .getRecentTransactions(50);
        }

        function displayTransactionLogs(transactions) {
            const logsBody = document.getElementById('transactionLogsBody');
            const noTransactionsMessage = document.getElementById('noTransactionsMessage');
            const transactionCount = document.getElementById('transactionCount');

            if (!transactions || transactions.length === 0) {
                logsBody.innerHTML = '';
                logsBody.parentElement.style.display = 'none';
                noTransactionsMessage.classList.remove('d-none');
                transactionCount.textContent = '0';
                return;
            }

            logsBody.parentElement.style.display = '';
            noTransactionsMessage.classList.add('d-none');
            transactionCount.textContent = transactions.length;

            const rows = transactions.map(log => {
                const actionBadge = log.action === 'IN' 
                    ? '<span class="badge bg-success badge-sm">IN</span>' 
                    : '<span class="badge bg-danger badge-sm">OUT</span>';
                
                // Format timestamp to show date and time like "June 26, 13:30"
                let formattedDateTime = '-';
                if (log.timestamp) {
                    try {
                        const date = new Date(log.timestamp);
                        const options = { 
                            month: 'short', 
                            day: 'numeric',
                            hour: '2-digit', 
                            minute: '2-digit',
                            hour12: false
                        };
                        formattedDateTime = date.toLocaleDateString('en-US', options).replace(',', ', ');
                    } catch (e) {
                        formattedDateTime = log.timestamp;
                    }
                }

                return `
                    <tr>
                        <td style="padding: 8px 8px; font-size: 0.85rem;">${formattedDateTime}</td>
                        <td style="padding: 8px 8px; font-size: 0.85rem;" class="fw-bold">${log.plate || '-'}</td>
                        <td style="padding: 8px 8px; font-size: 0.85rem;">${log.gate || '-'}</td>
                        <td style="padding: 8px 8px;" class="text-center">${actionBadge}</td>
                    </tr>
                `;
            }).join('');

            logsBody.innerHTML = rows;
        }

        function refreshTransactionLogs() {
            const refreshBtn = event.target.closest('button');
            const originalContent = refreshBtn.innerHTML;
            
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Refreshing...';
            
            google.script.run
                .withSuccessHandler(function(logs) {
                    displayTransactionLogs(logs);
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = originalContent;
                    
                    // Show success feedback
                    const badge = document.getElementById('transactionCount');
                    badge.classList.add('bg-success');
                    setTimeout(() => badge.classList.remove('bg-success'), 1000);
                })
                .withFailureHandler(function(error) {
                    console.error('Error refreshing logs:', error);
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = originalContent;
                    alert('Failed to refresh transaction logs');
                })
                .getRecentTransactions(50);
        }

    </script>
</body>
</html>