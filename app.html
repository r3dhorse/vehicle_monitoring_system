<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Vehicle Monitoring System">
    <meta name="generator" content="Vehicle Monitoring System">
    <meta name="description" content="Professional Vehicle Monitoring and Management System">
    <base target="_top">
    <title>Vehicle Monitoring System</title>
    
    <!-- Preconnect to CDN for faster loading -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    
    <!-- Load CSS with media attribute for better performance -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" media="all">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" media="all">
    
    <!-- QR Code Scanner Library -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
<style>
        /* CSS Reset and Performance Optimizations */
        * {
            box-sizing: border-box;
        }
        
        /* Optimize rendering performance */
        .vehicle-card, .btn, .modal {
            will-change: transform;
        }
        
        /* Driver checkbox container styling */
        .driver-checkbox-container {
            background-color: #f8f9fa;
        }
        
        .driver-checkbox-container .form-check {
            padding: 0.25rem 0.5rem;
            margin-bottom: 0.25rem;
            transition: background-color 0.2s ease;
        }
        
        .driver-checkbox-container .form-check:hover {
            background-color: #e9ecef;
        }
        
        .driver-checkbox-container .form-check-label {
            cursor: pointer;
            width: 100%;
        }
        
        /* Gate ID badge styling */
        .gate-id-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-weight: bold;
        }
        
        /* Enhanced search input styling */
        .search-container {
            position: relative;
        }
        
        #searchInput {
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
            padding-left: 3rem;
            padding-right: 3rem;
            font-size: 1rem;
        }
        
        #searchInput:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
            outline: none;
        }
        
        #searchInput::placeholder {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            z-index: 3;
            pointer-events: none;
            font-size: 1rem;
        }
        
        .external-search-button {
            height: 38px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        
        .search-clear {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            z-index: 3;
            padding: 0.375rem;
            border-radius: 3px;
            transition: all 0.2s ease;
            opacity: 0;
            visibility: hidden;
            font-size: 1rem;
        }
        
        .search-clear:hover {
            background-color: #e9ecef;
            color: #dc3545;
        }
        
        .search-clear.show {
            opacity: 1;
            visibility: visible;
        }
        
        /* Search suggestions dropdown */
        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1050;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .search-suggestions.show {
            display: block;
        }
        
        .suggestion-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .suggestion-item:hover,
        .suggestion-item.highlighted {
            background-color: #f8f9fa;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-text {
            font-weight: 500;
        }
        
        .suggestion-type {
            font-size: 0.75rem;
            color: #6c757d;
            background: #e9ecef;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
        }
        
        .suggestion-match {
            background-color: #fff3cd;
            font-weight: bold;
        }
        
        /* Search history */
        .search-history {
            border-top: 1px solid #dee2e6;
            background-color: #f8f9fa;
        }
        
        .search-history-header {
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #6c757d;
            text-transform: uppercase;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .clear-history-btn {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 0.75rem;
            cursor: pointer;
            padding: 0;
        }
        
        .clear-history-btn:hover {
            text-decoration: underline;
        }
        
        /* Search shortcuts */
        .search-shortcuts {
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 0.75rem;
            z-index: 1001;
            display: none;
            min-width: 250px;
        }
        
        .search-shortcuts.show {
            display: block;
        }
        
        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0;
            font-size: 0.875rem;
        }
        
        .shortcut-key {
            background: #e9ecef;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.75rem;
        }
        
        /* Loading indicator in search */
        .search-loading {
            position: absolute;
            right: 2.5rem;
            top: 50%;
            transform: translateY(-50%);
            z-index: 3;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .search-loading.show {
            opacity: 1;
        }
        
        /* Search results counter */
        .search-results-counter {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        
        /* Mobile-first responsive design */
        @media (max-width: 767px) {
            .navbar-nav {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
                margin-top: 1rem;
            }
            
            .navbar-brand {
                font-size: 1rem;
            }
            
            .stats-card {
                margin-bottom: 1rem;
            }
            
            .vehicle-status-columns .col-lg-6 {
                margin-bottom: 1rem;
            }
            
            .vehicle-list {
                max-height: 400px;
            }
            
            .add-vehicle-btn {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
            }
            
            .qr-scanner-btn {
                bottom: 20px;
                left: 20px; /* Position in lower left on mobile */
                width: 50px;
                height: 50px;
            }
            
            .refresh-btn {
                bottom: 20px; /* Same level as QR scanner */
                left: 80px; /* Position to the right of QR scanner */
                width: 50px;
                height: 50px;
                right: auto; /* Override desktop positioning */
            }
            
            .login-card {
                margin: 1rem;
            }
            
            .modal-dialog {
                margin: 0.5rem;
            }
            
            .vehicle-info {
                font-size: 0.8rem;
            }
            
            .plate-number {
                font-size: 1rem;
            }
            
            /* Optimize form layouts for mobile */
            .row.mb-4 > div[class*="col-"] {
                margin-bottom: 1rem;
            }
            
            /* Touch-friendly button sizes */
            .btn {
                min-height: 44px;
                padding: 0.5rem 1rem;
            }
            
            /* Enhanced search input for mobile */
            #searchInput {
                padding-left: 1rem;
                padding-right: 4rem;
                min-height: 48px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .search-icon {
                display: none; /* Hide search icon on mobile */
            }
            
            .search-clear {
                right: 1rem;
                padding: 0.5rem;
            }
            
            .external-search-button {
                height: 44px;
                font-size: 1.1rem;
                margin-top: 0.5rem;
            }
            
            .btn-sm {
                min-height: 36px;
            }
            
            /* Responsive table in modals */
            .table-responsive {
                font-size: 0.875rem;
            }
        }
        
        /* Tablet responsive adjustments */
        @media (min-width: 768px) and (max-width: 991px) {
            .vehicle-status-columns .col-lg-6 {
                margin-bottom: 1rem;
            }
        }
        
        /* Performance optimizations */
        img, svg, video {
            max-width: 100%;
            height: auto;
        }
        
        /* Reduce animations on low-power devices */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Touch device optimizations */
        .touch-device .vehicle-card {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .touch-active {
            transform: scale(0.98);
            opacity: 0.9;
        }
        
        /* Loading state optimizations */
        .skeleton-loader {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Viewport height fix for mobile */
        .dashboard-page {
            min-height: 100vh;
            min-height: calc(var(--vh, 1vh) * 100);
        }
        
        /* Optimize modal for mobile */
        @media (max-width: 576px) {
            .modal-dialog {
                margin: 0;
                width: 100%;
                max-width: 100%;
                height: 100%;
            }
            
            .modal-content {
                height: 100%;
                border-radius: 0;
            }
            
            .modal-body {
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
        
        .login-page {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
        }
        
        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .login-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px 20px 0 0;
            padding: 2rem 1.5rem 1.5rem;
            text-align: center;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
        }
        
        /* User Management Modal close button visibility */
        /* Close button style in user management modal */
        #userManagementModal .btn-close {
            filter: invert(100%); /* More readable than just '1' */
            opacity: 1; /* Ensure full visibility */
            transition: opacity 0.2s ease, filter 0.2s ease; /* Smooth transitions */
            background-color: transparent; /* Ensures no background color issues */
            border: none; /* Removes any border styling */
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .alert { border-radius: 10px; border: none; }
        .hidden { display: none !important; }
        
        /* Prevent loading overlap during refresh */
        #loadingSpinner.hidden {
            display: none !important;
            opacity: 0;
            pointer-events: none;
        }
        
        .dashboard-page { min-height: 100vh; background: #f8f9fa; }
        .navbar-brand { font-weight: 600; }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }
        
        .stats-card .card-body {
            position: relative;
            z-index: 2;
        }
        
        .stats-card::before {
            content: "";
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            transform: rotate(45deg);
            transition: all 0.5s ease;
        }
        
        .stats-card:hover::before {
            top: -60%;
            right: -60%;
        }
        
        .stats-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 3rem;
            opacity: 0.3;
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0;
            transition: all 0.3s ease;
        }
        
        .stats-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0;
        }
        
        .stats-percentage {
            font-size: 0.8rem;
            margin-top: 0.5rem;
            opacity: 0.8;
        }
        
        .stats-progress {
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            margin-top: 0.5rem;
            overflow: hidden;
        }
        
        .stats-progress-bar {
            height: 100%;
            background: rgba(255,255,255,0.8);
            border-radius: 2px;
            transition: width 1s ease;
        }
        
        @keyframes pulse-once {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        .pulse-once {
            animation: pulse-once 0.6s ease-in-out;
        }
        
        /* Summary card styles */
        .summary-card {
            background: white;
            border: 1px solid #e3e6f0;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .summary-stats {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .summary-item {
            text-align: center;
            flex: 1;
            min-width: 100px;
        }
        
        .summary-item i {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }
        
        .summary-item .value {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }
        
        .summary-item .label {
            font-size: 0.75rem;
            color: #6c757d;
            margin: 0;
        }
        
        @media (max-width: 768px) {
            .stats-number {
                font-size: 2rem;
            }
            .stats-icon {
                font-size: 2rem;
                right: 15px;
            }
            .summary-stats {
                gap: 0.5rem;
            }
        }
        
        .vehicle-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            border: none;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid transparent;
            -webkit-tap-highlight-color: transparent;
        }
        
        .vehicle-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        @media (hover: none) {
            .vehicle-card:hover {
                transform: none;
            }
            .vehicle-card:active {
                transform: scale(0.98);
            }
        }
        
        .vehicle-card.status-in {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        
        .vehicle-card.status-out {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        
        .vehicle-card.access-banned {
            border: 3px solid #dc3545 !important;
            border-left: 4px solid #dc3545 !important;
        }
        
        .vehicle-card.access-no-access {
            border: 3px solid #fd7e14 !important;
            border-left: 4px solid #fd7e14 !important;
        }
        
        .vehicle-status-columns .card {
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .vehicle-status-columns .card-header {
            font-weight: 600;
            border-bottom: none;
        }
        
        .vehicle-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .vehicle-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .vehicle-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .vehicle-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        .vehicle-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .lazy-loading-indicator {
            padding: 20px;
            opacity: 0.7;
        }
        
        .vehicle-card {
            animation: fadeIn 0.2s ease-out;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .vehicle-info {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .no-vehicles {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .no-vehicles i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .status-in { background-color: #28a745; color: white; }
        .status-out { background-color: #dc3545; color: white; }
        
        /* Transaction Logs Table Styles */
        .transaction-logs-container {
            border-radius: 0 0 0.375rem 0.375rem;
        }
        
        .transaction-logs-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .transaction-logs-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .transaction-logs-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        .transaction-logs-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        #transactionLogsTable {
            font-size: 0.8rem;
        }
        
        #transactionLogsTable thead th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
            padding: 8px 6px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        #transactionLogsTable tbody tr {
            transition: all 0.2s ease;
        }
        
        #transactionLogsTable tbody tr:hover {
            background-color: #f1f3f5 !important;
        }
        
        #transactionLogsTable tbody td {
            padding: 6px 6px;
            vertical-align: middle;
            border-bottom: 1px solid #f1f1f1;
        }
        
        .badge-sm {
            font-size: 0.65rem;
            padding: 2px 6px;
        }
        
        /* Responsive adjustments for transaction logs */
        @media (max-width: 1199px) {
            .col-lg-4 {
                margin-bottom: 1rem;
            }
        }
        
        /* QR Scanner Styles */
        .qr-scanner-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .qr-scanner-video {
            width: 100%;
            height: auto;
            border-radius: 8px;
            background: #000;
        }
        
        .qr-scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .qr-scanner-guide {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid #28a745;
            border-radius: 12px;
            background: rgba(40, 167, 69, 0.1);
            pointer-events: none;
        }
        
        .qr-scanner-guide::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px dashed #28a745;
            border-radius: 12px;
            animation: qr-pulse 2s infinite;
        }
        
        @keyframes qr-pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        .qr-scanner-status {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            text-align: center;
            min-width: 200px;
        }
        
        .qr-scanner-canvas {
            display: none;
        }
        
        .camera-access-error {
            text-align: center;
            padding: 40px 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #dee2e6;
        }
        
        @media (max-width: 991px) {
            .transaction-logs-container {
                height: 400px !important;
            }
        }
        
        .loading-spinner {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 8000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* Spin animation for transaction buttons */
        .spin {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Mobile/Tablet specific transaction button styles */
        @media (max-width: 991px) {
            /* Enhanced transaction button feedback for mobile/tablet */
            .vehicle-action-btn:disabled {
                opacity: 0.5 !important;
                cursor: not-allowed !important;
                transform: none !important;
            }
            
            .vehicle-action-btn:disabled .spin {
                color: #6c757d !important;
                font-size: 1rem !important;
            }
            
            /* Larger touch targets for mobile */
            .vehicle-action-btn {
                min-width: 44px !important;
                min-height: 44px !important;
                padding: 8px 12px !important;
            }
            
            /* QR scanner submit button mobile styles */
            #qrTransactionForm button[type="submit"]:disabled {
                opacity: 0.6 !important;
                background-color: #6c757d !important;
                border-color: #6c757d !important;
                cursor: not-allowed !important;
            }
        }
        
        @media (max-width: 767px) {
            /* Mobile-specific transaction protection styles */
            .vehicle-action-btn {
                font-size: 0.75rem !important;
                padding: 6px 10px !important;
                min-width: 40px !important;
                min-height: 40px !important;
            }
            
            .vehicle-action-btn:disabled {
                opacity: 0.4 !important;
            }
            
            .vehicle-action-btn .spin {
                font-size: 0.9rem !important;
            }
            
            /* Enhanced visual feedback for touch devices */
            .vehicle-action-btn:active:not(:disabled) {
                transform: scale(0.95) !important;
                background-color: rgba(13, 110, 253, 0.8) !important;
            }
            
            /* Toast messages positioning for mobile during transactions */
            .toast-container {
                z-index: 9999 !important;
            }
        }
        
        .gate-selector {
            border-left: 3px solid #667eea;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        }
        
        .gate-selector:focus {
            border-left-color: #764ba2;
            box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
        }
        
        .plate-number {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #2c3e50;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 4px 8px;
            border-radius: 6px;
            border: 2px solid #dee2e6;
            display: inline-block;
        }
        
        .vehicle-actions {
            display: flex;
            gap: 4px;
        }
        
        .vehicle-plate {
            flex: 1;
        }
        
        .add-vehicle-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            z-index: 10000; /* Highest z-index to stay on top */
            transition: all 0.3s ease;
            display: none; /* Hidden by default */
        }
        
        .add-vehicle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6);
        }
        
        .qr-scanner-btn {
            position: fixed;
            bottom: 30px;
            right: 100px; /* Position to the left of add button */
            width: 60px;
            height: 60px;
            border-radius: 50%;
            box-shadow: 0 4px 20px rgba(40, 167, 69, 0.4);
            z-index: 10000; /* Highest z-index to stay on top */
            transition: all 0.3s ease;
            display: none; /* Hidden by default */
        }
        
        .qr-scanner-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(40, 167, 69, 0.6);
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 170px; /* Position to the left of QR scanner button */
            width: 60px;
            height: 60px;
            border-radius: 50%;
            box-shadow: 0 4px 20px rgba(108, 117, 125, 0.4);
            z-index: 10000; /* Highest z-index to stay on top */
            transition: all 0.3s ease;
            display: none; /* Hidden by default */
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            border: none;
            color: white;
        }
        
        .refresh-btn:hover {
            transform: scale(1.1) rotate(180deg);
            box-shadow: 0 6px 25px rgba(108, 117, 125, 0.6);
            background: linear-gradient(135deg, #495057 0%, #343a40 100%);
        }
        
        .refresh-btn:active {
            transform: scale(0.95) rotate(360deg);
        }
        
        /* Hide buttons when login page is active */
        body:has(#loginPage:not(.hidden)) .add-vehicle-btn,
        body:has(#loginPage:not(.hidden)) .qr-scanner-btn,
        body:has(#loginPage:not(.hidden)) .refresh-btn {
            display: none !important;
        }
        
        /* Fallback for browsers that don't support :has() */
        .login-active .add-vehicle-btn,
        .login-active .qr-scanner-btn,
        .login-active .refresh-btn {
            display: none !important;
        }
        
        /* Tablet view - relocate floating buttons to the left */
        @media (min-width: 768px) and (max-width: 1024px) {
            .add-vehicle-btn {
                left: 30px;
                right: auto;
            }
            
            .qr-scanner-btn {
                left: 100px;
                right: auto;
            }
            
            .refresh-btn {
                left: 170px;
                right: auto;
            }
        }
        
        /* Also apply for landscape tablets */
        @media (min-width: 768px) and (max-width: 1366px) and (orientation: landscape) {
            .add-vehicle-btn {
                left: 30px;
                right: auto;
            }
            
            .qr-scanner-btn {
                left: 100px;
                right: auto;
            }
            
            .refresh-btn {
                left: 170px;
                right: auto;
            }
        }
        
        .role-badge {
            font-size: 0.8rem;
            padding: 4px 8px;
        }
        
        .role-badge.super-admin {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }
        
        .role-badge.admin {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        
        .role-badge.security {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
        }
        
        .user-management-modal .modal-dialog {
            max-width: min(95vw, 900px);
            margin: 1rem auto;
        }
        
        .user-card {
            border-left: 4px solid transparent;
            transition: all 0.3s ease;
        }
        
        .user-card.super-admin { border-left-color: #dc3545; }
        .user-card.admin { border-left-color: #28a745; }
        .user-card.security { border-left-color: #17a2b8; }
        
        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .permissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .permission-item {
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        /* Vehicle Management Enhancements */
        .table-responsive {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .table-responsive::-webkit-scrollbar {
            width: 6px;
        }
        
        .table-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Enhanced Action Buttons Styling */
        .vehicle-row .btn-group:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
        }
        
        .vehicle-row .btn:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
        }
        
        .vehicle-row .btn:active {
            transform: scale(0.98);
        }
        
        .vehicle-row .btn-primary:hover {
            background: linear-gradient(135deg, #0056b3 0%, #004085 100%) !important;
        }
        
        .vehicle-row .btn-success:hover {
            background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%) !important;
        }
        
        .vehicle-row .btn-danger:hover {
            background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%) !important;
        }
        
        .vehicle-row .btn[disabled] {
            background: #6c757d !important;
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%) !important;
            cursor: not-allowed !important;
            transform: none !important;
        }
        
        /* Add subtle animation on row hover */
        .vehicle-row:hover {
            background-color: #f8f9fa !important;
            transition: background-color 0.2s ease;
        }
        
        /* Improve button responsiveness on mobile */
        @media (max-width: 768px) {
            .vehicle-row .btn-group {
                box-shadow: none !important;
            }
            
            .vehicle-row .btn {
                font-size: 0.75rem !important;
                padding: 4px 8px !important;
            }
            
            .vehicle-row .btn:hover {
                transform: none;
            }
            
            .vehicle-row .btn:active {
                transform: scale(0.95);
                background-color: rgba(0,0,0,0.1);
            }
        }
        
        /* Role Badge Styles */
        .role-badge {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-radius: 4px;
            padding: 4px 8px;
            border: 1px solid;
        }
        
        .badge-super-admin {
            background: linear-gradient(135deg, #dc3545 0%, #bd2130 100%);
            color: white;
            border-color: #bd2130;
            box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3);
        }
        
        .badge-admin {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border-color: #0056b3;
            box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
        }
        
        .badge-security {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
            border-color: #1e7e34;
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
        }
        
        /* Role badge hover effects */
        .role-badge:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }
        
        /* ENHANCED VEHICLE EDIT MODAL STYLES */
        
        /* One Time Pass Section - Moved to Top */
        .one-time-pass-section {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .one-time-pass-section .form-check-input:checked {
            background-color: #ff6b35;
            border-color: #ff6b35;
        }
        
        .enhanced-tooltip {
            cursor: help;
        }
        
        .loading-overlay {
            backdrop-filter: blur(2px);
        }
        
        /* Form Section Styling */
        .form-section {
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: #f8f9fa;
            border-left: 4px solid #6c757d;
        }
        
        .form-section h6 {
            color: #495057;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        /* Status Badge Enhancements */
        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        
        /* Required Field Indicator */
        .required-field::after {
            content: " *";
            color: #dc3545;
        }
        
        /* Driver Info Section */
        .driver-info {
            background-color: #e3f2fd;
            border-radius: 4px;
            padding: 8px;
            margin-top: 5px;
        }
        
        /* Enhanced Modal Styling */
        .modal-xl {
            max-width: 1200px;
        }
        
        /* Enhanced Loading Overlay */
        .enhanced-loading-overlay {
            backdrop-filter: blur(5px);
            background: rgba(255, 255, 255, 0.9) !important;
        }
        
        .enhanced-loading-overlay .pulse-loader {
            width: 3rem;
            height: 3rem;
            background-color: #0d6efd;
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        /* Form Validation Styling */
        .was-validated .form-control:invalid {
            border-color: #dc3545;
            padding-right: calc(1.5em + 0.75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath d='m5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        
        .was-validated .form-control:valid {
            border-color: #28a745;
            padding-right: calc(1.5em + 0.75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%2328a745' d='m2.3 6.73.4.36 3.7-3.73L5.84 2.9l-3 3.06L2.1 5.4l-.36.36z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(0.375em + 0.1875rem) center;
            background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
        }
        
        /* Input Group Enhancements */
        .input-group-text {
            background-color: #f8f9fa;
            border-color: #ced4da;
        }
        
        /* Enhanced Tooltips */
        .tooltip {
            font-size: 0.8rem;
        }
        
        .tooltip-inner {
            max-width: 250px;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
        }
        
        /* Modal Footer Enhancements */
        .modal-footer.bg-light {
            background-color: #f8f9fa !important;
            border-top: 1px solid #dee2e6;
        }
        
        /* Responsive Enhancements for Vehicle Edit Modal */
        @media (max-width: 1200px) {
            .modal-xl {
                max-width: 95vw;
            }
        }
        
        @media (max-width: 768px) {
            .one-time-pass-section {
                padding: 12px;
                margin-bottom: 15px;
            }
            
            .form-section {
                padding: 12px;
                margin-bottom: 12px;
            }
            
            .form-section h6 {
                font-size: 1rem;
                margin-bottom: 10px;
            }
            
            .enhanced-loading-overlay .bouncing-dots {
                color: #0d6efd;
            }
        }
        
        /* Fullscreen mode styles with immersive experience */
        .fullscreen-mode {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            transition: background 0.8s ease, opacity 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        
        /* Overlay for better content visibility */
        .fullscreen-mode::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.1);
            z-index: -1;
            animation: fadeInOverlay 0.8s ease;
        }
        
        @keyframes fadeInOverlay {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Fullscreen entrance animation */
        .fullscreen-mode .container-fluid {
            animation: slideInFromTop 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        @keyframes slideInFromTop {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .fullscreen-mode .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1050;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            height: 56px;
            transform: translateY(0);
            background: rgba(0, 0, 0, 0.9) !important;
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Glass morphism effect for navbar */
        .fullscreen-mode .navbar .navbar-brand,
        .fullscreen-mode .navbar .nav-link {
            color: rgba(255, 255, 255, 0.9) !important;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .fullscreen-mode .navbar .nav-link:hover {
            color: white !important;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
        }
        
        /* Auto-hide navbar with smooth animations */
        .fullscreen-mode .navbar.navbar-hidden {
            transform: translateY(-100%);
            opacity: 0;
        }
        
        .fullscreen-mode .navbar:hover {
            transform: translateY(0) !important;
            opacity: 1 !important;
        }
        
        /* Focus mode - hide all UI except main content */
        .fullscreen-mode.focus-mode .navbar {
            opacity: 0;
            pointer-events: none;
        }
        
        .fullscreen-mode.focus-mode .stats-row,
        .fullscreen-mode.focus-mode .quick-summary-card {
            opacity: 0.3;
            transition: opacity 0.4s ease;
        }
        
        .fullscreen-mode.focus-mode .stats-row:hover,
        .fullscreen-mode.focus-mode .quick-summary-card:hover {
            opacity: 1;
        }
        
        .fullscreen-mode .container-fluid:first-of-type {
            margin-top: 56px;
            padding: 0.5rem;
            position: relative;
        }
        
        /* Contextual toolbar for fullscreen */
        .fullscreen-toolbar {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%) translateX(50px);
            z-index: 1040;
            display: flex;
            flex-direction: column;
            gap: 10px;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            pointer-events: none; /* Prevent interference when hidden */
        }
        
        .fullscreen-mode .fullscreen-toolbar {
            opacity: 1;
            transform: translateY(-234%) translateX(0);
            pointer-events: all; /* Enable clicks when visible */
        }
        
        .fullscreen-toolbar .btn {
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
            border-radius: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }
        
        .fullscreen-toolbar .btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Visual indicators */
        .fullscreen-mode::after {
            content: 'FULLSCREEN';
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            z-index: 1100;
            opacity: 0;
            animation: showIndicator 3s ease;
            pointer-events: none;
        }
        
        @keyframes showIndicator {
            0% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
            10% { opacity: 1; transform: translateX(-50%) translateY(0); }
            90% { opacity: 1; transform: translateX(-50%) translateY(0); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
        }
        
        /* Responsive styles for fullscreen toolbar */
        @media (max-width: 768px) {
            .fullscreen-toolbar {
                right: 10px;
                pointer-events: all; /* Ensure clickability on mobile */
            }
            
            .fullscreen-toolbar .btn {
                width: 36px;
                height: 36px;
                font-size: 0.9rem;
                pointer-events: all; /* Ensure buttons are clickable */
            }
            
            /* Adjust transform for better mobile positioning */
            .fullscreen-mode .fullscreen-toolbar {
                transform: translateY(-50%) translateX(0);
            }
        }
        
        /* Loading states */
        .fullscreen-mode .loading-overlay {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }
        
        /* Enhanced transitions for all interactive elements */
        .fullscreen-mode .btn,
        .fullscreen-mode .form-control,
        .fullscreen-mode .card {
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .fullscreen-mode .stats-row {
            margin-bottom: 0.75rem; /* Reduced margin */
        }
        
        .fullscreen-mode .stats-card {
            margin-bottom: 0.5rem;
        }
        
        .fullscreen-mode .quick-summary-card {
            margin-bottom: 0.75rem; /* Reduced margin */
        }
        
        /* Enhanced stats cards for fullscreen - maintain original gradient backgrounds */
        .fullscreen-mode .stats-card {
            /* Keep original gradient backgrounds from the stats cards */
            /* background is already set inline with gradients, so don't override */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
            overflow: hidden;
            animation: slideInCard 0.6s ease;
        }
        
        @keyframes slideInCard {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .fullscreen-mode .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .fullscreen-mode .stats-card:hover::before {
            opacity: 1;
        }
        
        .fullscreen-mode .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.15);
        }
        
        .fullscreen-mode .stats-card .card-body {
            padding: 1rem 1.25rem;
            position: relative;
        }
        
        .fullscreen-mode .stats-number {
            font-size: 2rem !important; /* Slightly smaller numbers */
            margin-bottom: 0.25rem !important;
        }
        
        .fullscreen-mode .stats-label {
            font-size: 0.8rem !important; /* Smaller labels */
            margin-bottom: 0.25rem !important;
        }
        
        .fullscreen-mode .stats-percentage {
            font-size: 0.7rem !important; /* Even smaller percentage */
            margin-top: 0.25rem !important;
        }
        
        .fullscreen-mode .stats-icon {
            font-size: 2.5rem !important; /* Smaller icons */
            right: 15px !important;
        }
        
        /* Compact summary card */
        .fullscreen-mode .summary-card {
            padding: 0.75rem !important; /* Reduced padding */
            margin-bottom: 0.75rem !important;
        }
        
        .fullscreen-mode .summary-stats {
            gap: 0.75rem !important; /* Reduced gap */
        }
        
        .fullscreen-mode .summary-item .value {
            font-size: 1rem !important; /* Smaller values */
        }
        
        .fullscreen-mode .summary-item .label {
            font-size: 0.65rem !important; /* Smaller labels */
        }
        
        .fullscreen-mode .summary-item i {
            font-size: 1.25rem !important; /* Smaller icons */
        }
        
        /* Optimized main content area with smart scaling */
        .fullscreen-mode .vehicle-list {
            height: calc(100vh - 250px) !important;
            max-height: none;
            animation: expandContent 0.5s ease;
        }
        
        .fullscreen-mode .transaction-logs {
            height: calc(100vh - 250px) !important;
            max-height: none;
            animation: expandContent 0.5s ease;
        }
        
        @keyframes expandContent {
            from {
                height: calc(100vh - 320px);
                opacity: 0.8;
            }
            to {
                height: calc(100vh - 250px);
                opacity: 1;
            }
        }
        
        /* Content scaling based on screen size */
        @media (min-width: 1400px) {
            .fullscreen-mode .stats-number {
                font-size: 2.5rem !important;
            }
            
            .fullscreen-mode .stats-icon {
                font-size: 3rem !important;
            }
        }
        
        @media (max-width: 1200px) and (min-width: 992px) {
            .fullscreen-mode .stats-number {
                font-size: 1.8rem !important;
            }
            
            .fullscreen-mode .stats-icon {
                font-size: 2.2rem !important;
            }
        }
        
        .fullscreen-mode .main-content-row {
            height: calc(100vh - 210px); /* Reduced from 280px to 210px */
        }
        
        .fullscreen-mode .col-lg-8,
        .fullscreen-mode .col-lg-4 {
            height: 100%;
        }
        
        .fullscreen-mode .vehicle-list-container,
        .fullscreen-mode .transaction-logs-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .fullscreen-mode .table-responsive {
            flex: 1;
            overflow-y: auto;
        }
        
        /* Compact search and filter row */
        .fullscreen-mode .row.mb-4 {
            margin-bottom: 0.75rem !important; /* Reduced margin for search row */
        }
        
        .fullscreen-mode .form-control,
        .fullscreen-mode .form-select {
            padding: 0.375rem 0.75rem !important; /* Standard Bootstrap padding */
            font-size: 0.875rem !important; /* Slightly smaller font */
        }
        
        /* Override for search input to maintain icon spacing in fullscreen */
        .fullscreen-mode #searchInput {
            padding-left: 3rem !important; /* Account for search icon */
            padding-right: 3rem !important; /* Account for clear button */
        }
        
        .fullscreen-mode .btn {
            padding: 0.375rem 0.75rem !important; /* Compact buttons */
            font-size: 0.875rem !important;
        }
        
        /* Hide pagination in fullscreen for cleaner view */
        .fullscreen-mode #paginationRow {
            display: none !important;
        }
        
        /* Fullscreen button styles */
        #fullscreenBtn {
            transition: all 0.3s ease;
        }
        
        #fullscreenBtn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }
        
        /* Hide floating buttons in fullscreen for cleaner view */
        .fullscreen-mode .add-vehicle-btn,
        .fullscreen-mode .qr-scanner-btn {
            display: none !important;
        }
        
        /* Responsive fullscreen adjustments */
        @media (max-width: 991px) {
            .fullscreen-mode .vehicle-list,
            .fullscreen-mode .transaction-logs {
                height: calc(100vh - 280px) !important; /* Reduced from 400px */
            }
            
            .fullscreen-mode .container-fluid:first-of-type {
                margin-top: 56px; /* Keep consistent with desktop */
                padding: 0.5rem;
            }
            
            .fullscreen-mode .main-content-row {
                height: calc(100vh - 240px); /* Adjusted for tablet */
            }
            
            /* More compact stats on tablet */
            .fullscreen-mode .stats-number {
                font-size: 1.75rem !important;
            }
            
            .fullscreen-mode .stats-icon {
                font-size: 2rem !important;
            }
        }
        
        @media (max-width: 767px) {
            .fullscreen-mode .vehicle-list,
            .fullscreen-mode .transaction-logs {
                height: calc(100vh - 320px) !important; /* Reduced from 450px */
            }
            
            .fullscreen-mode .main-content-row {
                height: calc(100vh - 280px); /* Adjusted for mobile */
            }
            
            .fullscreen-mode .col-lg-4 {
                margin-top: 0.75rem; /* Reduced margin */
            }
            
            /* Even more compact on mobile */
            .fullscreen-mode .stats-card .card-body {
                padding: 0.75rem 1rem !important;
            }
            
            .fullscreen-mode .stats-number {
                font-size: 1.5rem !important;
            }
            
            .fullscreen-mode .stats-label {
                font-size: 0.75rem !important;
            }
            
            .fullscreen-mode .stats-icon {
                font-size: 1.75rem !important;
                right: 10px !important;
            }
            
            .fullscreen-mode .summary-card {
                padding: 0.5rem !important;
            }
            
            .fullscreen-mode .summary-item .value {
                font-size: 0.9rem !important;
            }
            
            .fullscreen-mode .summary-item .label {
                font-size: 0.6rem !important;
            }
            
            .fullscreen-mode .summary-item i {
                font-size: 1rem !important;
            }
        }
    </style>

    <style>
        /* Loading Screen Styles */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s ease-out;
        }
        
        .loading-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-content {
            text-align: center;
            color: white;
        }
        
        .loading-icon {
            font-size: 4rem;
            margin-bottom: 2rem;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .initial-loading-spinner {
            margin: 0 auto 2rem;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .loading-text {
            font-size: 1.5rem;
            font-weight: 300;
            margin-bottom: 0.5rem;
        }
        
        .loading-subtext {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <i class="bi bi-truck loading-icon"></i>
            <div class="initial-loading-spinner">
                <div class="bouncing-dots size-xl">
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                </div>
            </div>
            <h2 class="loading-text">Vehicle Monitoring System</h2>
            <p class="loading-subtext">Initializing...</p>
        </div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="login-page hidden">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-5">
                    <div class="login-card">
                        <div class="login-header">
                            <i class="bi bi-truck fs-1 mb-3"></i>
                            <h1 class="h3 mb-0">Vehicle Monitoring System</h1>
                            <p class="mb-0 mt-2 opacity-75">Sign in to your account</p>
                        </div>
                        
                        <div class="p-4">
                            <div id="loginMsg" class="mb-3"></div>
                            
                            <form onsubmit="event.preventDefault(); login();">
                                <div class="mb-3">
                                    <label class="form-label" for="username">
                                        <i class="bi bi-person me-2"></i>Username
                                    </label>
                                    <input type="text" class="form-control" id="username" required>
                                </div>
                                
                                <div class="mb-4">
                                    <label class="form-label" for="password">
                                        <i class="bi bi-lock me-2"></i>Password
                                    </label>
                                    <input type="password" class="form-control" id="password" required>
                                </div>
                                
                                <button type="submit" id="loginBtn" class="btn btn-primary w-100">
                                    <i class="bi bi-box-arrow-in-right me-2"></i>Sign In
                                </button>
                            </form>
                            
                            <!-- <div class="text-center mt-4">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                   
                                </small>
                            </div> -->

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="dashboard-page hidden">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <i class="bi bi-truck me-2"></i><span class="d-none d-sm-inline">Vehicle Monitoring System</span><span class="d-inline d-sm-none">VMS</span>
                </a>
                  <span class="navbar-text me-3">
                      <i class="bi bi-person-circle me-1"></i>
                      <span id="currentRole" class="badge role-badge"></span>
                      <small class="text-light ms-1"><span id="currentUsername"></span></small>
                  </span>
                  
                  <!-- User Profile Dropdown -->
                 
                  
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarContent">
                    <div class="navbar-nav ms-auto">
                    <button class="btn btn-outline-light btn-sm me-3" id="vehicleManagementBtn" style="display: none;" onclick="showVehicleManagement()">
                        <i class="bi bi-truck me-1"></i>Manage Vehicles
                    </button>
                    <button class="btn btn-outline-light btn-sm me-3" id="driverManagementBtn" style="display: none;" onclick="showDriverManagement()">
                        <i class="bi bi-person-badge me-1"></i>Manage Drivers
                    </button>
                    <button class="btn btn-outline-light btn-sm me-3" id="gateManagementBtn" style="display: none;" onclick="showGateManagement()">
                        <i class="bi bi-door-open me-1"></i>Manage Gates
                    </button>
                    <div class="dropdown me-3" id="userManagementDropdown" style="display: none;">
                        <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-people me-1"></i>Users
                        </button>
                        <ul class="dropdown-menu">
                            <li><button type="button" class="dropdown-item" onclick="showUserManagement()">
                                <i class="bi bi-person-gear me-2"></i>Manage Users
                            </button></li>
                            <li><button type="button" class="dropdown-item" onclick="showRoleSettings()">
                                <i class="bi bi-shield-check me-2"></i>Role Settings
                            </button></li>
                        </ul>
                    </div>
                    <div class="dropdown me-3" id="userProfileDropdown">
                      <button class="btn btn-outline-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                          <i class="bi bi-person-gear me-1"></i>Profile
                      </button>
                      <ul class="dropdown-menu">
                          <li><button type="button" class="dropdown-item" onclick="showChangePassword()">
                              <i class="bi bi-key me-2"></i>Change Password
                          </button></li>
                      </ul>
                    </div>
                    <button class="btn btn-outline-light btn-sm me-3" id="fullscreenBtn" onclick="toggleFullscreen()" title="Toggle Fullscreen">
                        <i class="bi bi-arrows-fullscreen" id="fullscreenIcon"></i>
                    </button>
                   
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">
                        <i class="bi bi-box-arrow-right me-1"></i>Logout
                    </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Fullscreen Toolbar -->
        <div class="fullscreen-toolbar">
            <button class="btn" id="focusModeBtn" onclick="toggleFocusMode()" title="Focus Mode (F)">
                <i class="bi bi-eye"></i>
            </button>
            <button class="btn" onclick="exitFullscreen()" title="Exit Fullscreen (ESC)">
                <i class="bi bi-fullscreen-exit"></i>
            </button>
        </div>

        <!-- Main Content -->
        <div class="container-fluid py-4">
            <!-- Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <div class="card stats-card">
                        <div class="card-body">
                            <i class="bi bi-truck stats-icon"></i>
                            <h3 class="stats-number" id="totalVehicles">0</h3>
                            <p class="stats-label">Total Vehicles</p>
                            <div class="stats-percentage" id="totalVehiclesChange">
                                <i class="bi bi-dash"></i> Registered
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card stats-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                        <div class="card-body">
                            <i class="bi bi-arrow-down-circle stats-icon"></i>
                            <h3 class="stats-number" id="vehiclesIn">0</h3>
                            <p class="stats-label">Vehicles In</p>
                            <div class="stats-percentage" id="vehiclesInPercentage">
                                <i class="bi bi-percent"></i> <span>0%</span> of total
                            </div>
                            <div class="stats-progress">
                                <div class="stats-progress-bar" id="vehiclesInProgress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card stats-card" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                        <div class="card-body">
                            <i class="bi bi-arrow-up-circle stats-icon"></i>
                            <h3 class="stats-number" id="vehiclesOut">0</h3>
                            <p class="stats-label">Vehicles Out</p>
                            <div class="stats-percentage" id="vehiclesOutPercentage">
                                <i class="bi bi-percent"></i> <span>0%</span> of total
                            </div>
                            <div class="stats-progress">
                                <div class="stats-progress-bar" id="vehiclesOutProgress" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Summary Card -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="summary-card">
                        <div class="summary-stats">
                            <div class="summary-item">
                                <i class="bi bi-clock-history text-info"></i>
                                <p class="value" id="lastUpdate">Just now</p>
                                <p class="label">Last Update</p>
                            </div>
                            <div class="summary-item">
                                <i class="bi bi-geo-alt-fill text-warning"></i>
                                <p class="value" id="activeGateDisplay">-</p>
                                <p class="label">Active Gate</p>
                            </div>
                            <div class="summary-item">
                                <i class="bi bi-arrow-left-right text-secondary"></i>
                                <p class="value" id="recentActivity">0</p>
                                <p class="label">Today's Activity</p>
                            </div>
                            <div class="summary-item">
                                <i class="bi bi-check-circle-fill text-success"></i>
                                <p class="value" id="accessCount">-</p>
                                <p class="label">Access Allowed</p>
                            </div>
                            <div class="summary-item">
                                <i class="bi bi-exclamation-triangle-fill text-warning"></i>
                                <p class="value" id="noAccessCount">-</p>
                                <p class="label">No Access</p>
                            </div>
                            <div class="summary-item">
                                <i class="bi bi-x-circle-fill text-danger"></i>
                                <p class="value" id="bannedCount">-</p>
                                <p class="label">Banned</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="row mb-4">
                <div class="col-12 col-md-3 mb-2 mb-md-0">
                    <label class="form-label mb-1 d-none d-md-block">
                        <small>
                            <i class="bi bi-search me-1"></i>Smart Search:
                            <i class="bi bi-info-circle ms-1 text-primary" 
                               data-bs-toggle="tooltip" 
                               data-bs-placement="top" 
                               title="Enhanced search with auto-suggestions, history, and keyboard shortcuts (Ctrl+K to focus)"
                               style="cursor: help;"></i>
                        </small>
                    </label>
                    <div class="search-container">
                        <i class="bi bi-search search-icon"></i>
                        <input type="text" class="form-control" id="searchInput" 
                               placeholder="Search by plate number... (Ctrl+K)" 
                               title="Search by vehicle plate number only"
                               autocomplete="off"
                               onkeyup="debounceFilter()"
                               onkeydown="handleSearchKeydown(event)">
                        <div class="search-loading">
                            <div style="color: #0d6efd;">
                                <div class="bouncing-dots size-sm">
                                    <span class="dot"></span>
                                    <span class="dot"></span>
                                    <span class="dot"></span>
                                </div>
                                <span class="visually-hidden">Searching...</span>
                            </div>
                        </div>
                        <button type="button" class="search-clear" onclick="clearSearchInput()" title="Clear search">
                            <i class="bi bi-x-circle-fill"></i>
                        </button>
                        
                        <!-- Search Suggestions Dropdown -->
                        <div class="search-suggestions" id="searchSuggestions">
                            <!-- Suggestions will be populated dynamically -->
                        </div>
                        
                        <!-- Search Shortcuts Panel -->
                        <div class="search-shortcuts" id="searchShortcuts">
                            <div class="fw-bold mb-2 text-primary">
                                <i class="bi bi-keyboard me-1"></i>Search Shortcuts
                            </div>
                            <div class="shortcut-item">
                                <span>Focus search</span>
                                <span class="shortcut-key">Ctrl + K</span>
                            </div>
                            <div class="shortcut-item">
                                <span>Clear search</span>
                                <span class="shortcut-key">Escape</span>
                            </div>
                            <div class="shortcut-item">
                                <span>Partial plate search</span>
                                <span class="shortcut-key">ABC</span>
                            </div>
                            <div class="shortcut-item">
                                <span>Exact plate match</span>
                                <span class="shortcut-key">"ABC-123"</span>
                            </div>
                            <div class="shortcut-item">
                                <span>Case insensitive</span>
                                <span class="shortcut-key">abc-123</span>
                            </div>
                        </div>
                    </div>
                    <div class="search-results-counter" id="searchResultsCounter"></div>
                </div>
                <div class="col-12 col-md-1 mb-2 mb-md-0">
                    <label class="form-label mb-1 d-none d-md-block">
                        <small>&nbsp;</small>
                    </label>
                    <button type="button" class="btn btn-primary w-100 external-search-button" onclick="triggerManualSearch()" title="Search">
                        <i class="bi bi-search me-1"></i><span class="d-md-none">Search</span>
                    </button>
                </div>
                <div class="col-6 col-md-2 mb-2 mb-md-0">
                    <label class="form-label mb-1 d-none d-md-block">
                        <small><i class="bi bi-geo-alt me-1"></i>Gate:</small>
                    </label>
                    <div class="input-group">
                        <select class="form-select gate-selector" id="gateSelector">
                            <option value="">Loading...</option>
                        </select>
                        <button class="btn btn-outline-secondary" type="button" onclick="refreshGateSelector()" title="Refresh gates">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Pagination Controls -->
            <div class="row mb-3" id="paginationRow" style="display: none;">
                <div class="col-12">
                    <nav aria-label="Vehicle list pagination">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="pagination-info">
                                <small class="text-muted" id="paginationInfo">Showing 1-50 of 1500 vehicles</small>
                            </div>
                            <ul class="pagination pagination-sm mb-0">
                                <li class="page-item" id="prevPageItem">
                                    <button class="page-link" onclick="changePage('prev')" aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </button>
                                </li>
                                <li class="page-item active" id="currentPageItem">
                                    <span class="page-link" id="currentPageNumber">1</span>
                                </li>
                                <li class="page-item" id="nextPageItem">
                                    <button class="page-link" onclick="changePage('next')" aria-label="Next">
                                        <span aria-hidden="true">&raquo;</span>
                                    </button>
                                </li>
                            </ul>
                            <div class="page-size-selector">
                                <small class="text-muted me-2">Show:</small>
                                <select class="form-select form-select-sm d-inline-block w-auto" id="pageSizeSelector" onchange="changePageSize()">
                                    <option value="25">25</option>
                                    <option value="50" selected>50</option>
                                    <option value="100">100</option>
                                    <option value="200">200</option>
                                </select>
                            </div>
                        </div>
                    </nav>
                </div>
            </div>

            <!-- Vehicle Table and Transaction Logs -->
            <div class="row">
                <!-- Vehicles Table -->
                <div class="col-lg-8">
                    <div class="card h-100">
                        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-car-front me-2"></i>
                                Vehicle List
                                <span class="badge bg-light text-primary ms-2" id="totalVehiclesBadge">0</span>
                            </h5>
                            <div class="d-flex gap-2">
                                <span class="badge bg-success d-flex align-items-center">
                                    <i class="bi bi-arrow-down-circle me-1"></i>
                                    IN: <span id="vehiclesInBadge" class="ms-1">0</span>
                                </span>
                                <span class="badge bg-danger d-flex align-items-center">
                                    <i class="bi bi-arrow-up-circle me-1"></i>
                                    OUT: <span id="vehiclesOutBadge" class="ms-1">0</span>
                                </span>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="vehicle-logs-container" style="height: 600px; overflow-y: auto;">
                                <table class="table table-sm table-hover mb-0" id="vehiclesTable">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th style="width: 60px; font-size: 0.85rem;">ID</th>
                                            <th style="width: 90px; font-size: 0.85rem;">Plate #</th>
                                            <th style="width: 110px; font-size: 0.85rem;">Make/Model</th>
                                            <th style="width: 80px; font-size: 0.85rem;" class="d-none d-md-table-cell">Department</th>
                                            <th style="width: 80px; font-size: 0.85rem;" class="d-none d-lg-table-cell">Driver</th>
                                            <th style="width: 60px; font-size: 0.85rem;" class="text-center">Status</th>
                                            <th style="width: 70px; font-size: 0.85rem;" class="d-none d-xl-table-cell">Access</th>
                                            <th style="width: 50px; font-size: 0.85rem;" class="d-none d-xl-table-cell text-center">OTP</th>
                                            <th style="width: 60px; font-size: 0.85rem;" class="text-center">Actions</th>
                                            <th style="width: 75px; font-size: 0.85rem;" class="text-center">Transaction</th>
                                        </tr>
                                    </thead>
                                    <tbody id="vehiclesTableBody">
                                        <tr>
                                            <td colspan="10" class="text-center py-4">
                                                <div style="color: #0d6efd;">
                                                    <div class="bouncing-dots size-lg">
                                                        <span class="dot"></span>
                                                        <span class="dot"></span>
                                                        <span class="dot"></span>
                                                    </div>
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p class="mt-2 text-muted">Loading vehicles...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="noVehiclesMessage" class="text-center py-4 d-none">
                                <i class="bi bi-car-front text-muted" style="font-size: 3rem;"></i>
                                <p class="text-muted mt-2 mb-0">No vehicles found</p>
                                <small class="text-muted">Try adjusting your search criteria</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transaction Logs Column -->
                <div class="col-lg-4">
                    <div class="card h-100">
                        <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="bi bi-clock-history me-2"></i>
                                Recent Transactions
                                <span class="badge bg-light text-secondary ms-2" id="transactionCount">50</span>
                            </h6>
                            <button class="btn btn-sm btn-light" onclick="refreshTransactionLogs(); refreshDashboard()" title="Refresh logs">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="transaction-logs-container" style="height: 600px; overflow-y: auto;">
                                <table class="table table-sm table-hover mb-0" id="transactionLogsTable">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th style="width: 80px; font-size: 0.85rem; padding: 8px 8px;">Timestamp</th>
                                            <th style="width: 70px; font-size: 0.85rem; padding: 8px 8px;">Plate</th>
                                            <th style="width: 80px; font-size: 0.85rem; padding: 8px 8px;">Driver</th>
                                            <th style="width: 60px; font-size: 0.85rem; padding: 8px 8px;">Gate</th>
                                            <th style="width: 50px; font-size: 0.85rem; padding: 8px 8px;" class="text-center">Transaction</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactionLogsBody">
                                        <tr>
                                            <td colspan="5" class="text-center py-3">
                                                <div style="color: #6c757d;">
                                                    <div class="bouncing-dots">
                                                        <span class="dot"></span>
                                                        <span class="dot"></span>
                                                        <span class="dot"></span>
                                                    </div>
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p class="mt-2 text-muted mb-0 small">Loading logs...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div id="noTransactionsMessage" class="text-center py-3 d-none">
                                <i class="bi bi-inbox text-muted" style="font-size: 2rem;"></i>
                                <p class="text-muted mt-2 mb-0 small">No transactions found</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner hidden">
        <div style="color: #0d6efd;">
            <div class="bouncing-dots size-xl">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- QR Scanner Button -->
    <button class="btn btn-success qr-scanner-btn" onclick="showQRScanner()" title="QR Code Scanner" id="qrScannerBtn">
        <i class="bi bi-qr-code fs-4"></i>
    </button>
    
    <!-- Refresh Button -->
    <button class="refresh-btn" onclick="refreshPage()" title="Refresh Page" id="refreshBtn">
        <i class="bi bi-arrow-clockwise fs-4"></i>
    </button>
    
    <!-- Add Vehicle Button -->
    <button class="btn btn-primary add-vehicle-btn" onclick="showVehicleManagement()" title="Manage Vehicles" id="addVehicleBtn">
        <i class="bi bi-plus-lg fs-4"></i>
    </button>

    



    <!-- Edit Vehicle Modal -->
    <div class="modal fade" id="editVehicleModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil-square me-2"></i>Edit Vehicle Information
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Enhanced Loading Overlay -->
                    <div id="editVehicleLoading" class="d-none position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-white bg-opacity-90 loading-overlay" style="z-index: 1050;">
                        <div class="text-center">
                            <div style="color: #ffc107;">
                                <div class="bouncing-dots size-xl">
                                    <span class="dot"></span>
                                    <span class="dot"></span>
                                    <span class="dot"></span>
                                </div>
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-3 text-muted fw-medium">Saving changes...</div>
                            <div class="mt-1 text-muted small">Please wait while we update the vehicle information</div>
                        </div>
                    </div>

                    <form id="editVehicleForm">
                        <input type="hidden" id="editVehicleIndex">
                        
                        <!-- One Time Pass Section - Moved to Top -->
                        <div class="one-time-pass-section">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <div class="form-check form-switch me-3">
                                        <input class="form-check-input" type="checkbox" id="editOneTimePass" role="switch">
                                        <label class="form-check-label fw-bold" for="editOneTimePass">
                                            <i class="bi bi-key-fill text-warning me-2"></i>One Time Pass
                                        </label>
                                    </div>
                                    <i class="bi bi-info-circle-fill text-muted enhanced-tooltip" data-bs-toggle="tooltip" 
                                       data-bs-placement="right"
                                       title="When enabled, allows a restricted vehicle one-time access. Will automatically disable after successful entry."></i>
                                </div>
                                <span class="badge bg-warning text-dark status-badge" id="oneTimePassStatus">Disabled</span>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                    This setting provides temporary access and will reset automatically after use.
                                </small>
                            </div>
                        </div>

                        <!-- Basic Vehicle Information -->
                        <div class="form-section">
                            <h6><i class="bi bi-car-front me-2"></i>Basic Vehicle Information</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label required-field">Plate Number</label>
                                        <input type="text" class="form-control" id="editPlateNumber" required 
                                               placeholder="Enter plate number">
                                        <div class="invalid-feedback">
                                            Please provide a valid plate number.
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label required-field">Make/Model</label>
                                        <input type="text" class="form-control" id="editModel" required 
                                               placeholder="e.g., Toyota Camry">
                                        <div class="invalid-feedback">
                                            Please provide the vehicle make and model.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Color</label>
                                        <input type="text" class="form-control" id="editColor" 
                                               placeholder="e.g., Red, Blue">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Year</label>
                                        <input type="number" class="form-control" id="editYear" 
                                               min="1900" max="2030" placeholder="YYYY">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Vehicle Type</label>
                                        <select class="form-select" id="editType">
                                            <option value="">Select type...</option>
                                            <option value="Car">Car</option>
                                            <option value="Truck">Truck</option>
                                            <option value="Van">Van</option>
                                            <option value="Motorcycle">Motorcycle</option>
                                            <option value="Bus">Bus</option>
                                            <option value="SUV">SUV</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Organization Information -->
                        <div class="form-section">
                            <h6><i class="bi bi-building me-2"></i>Organization Information</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Department/Company</label>
                                        <input type="text" class="form-control" id="editDepartment" 
                                               placeholder="Enter department or company name">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">MV File Number</label>
                                        <div class="input-group">
                                            <span class="input-group-text"><i class="bi bi-file-earmark-text"></i></span>
                                            <input type="text" class="form-control" id="editMVFile" 
                                                   placeholder="Motor Vehicle file number or reference">
                                        </div>
                                        <div class="form-text">
                                            <i class="bi bi-info-circle me-1"></i>Optional: Internal file reference number
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Driver Assignment -->
                        <div class="form-section">
                            <h6><i class="bi bi-person-check me-2"></i>Driver Assignment</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Current Driver</label>
                                        <select class="form-select" id="editDriver">
                                            <option value="">Select a driver...</option>
                                            <!-- Options will be loaded dynamically -->
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Authorized Drivers</label>
                                        <div class="driver-checkbox-container border rounded p-3" style="max-height: 150px; overflow-y: auto;" id="editAssignedDriversContainer">
                                            <div class="text-muted text-center">
                                                <i class="bi bi-hourglass-split"></i> Loading drivers...
                                            </div>
                                        </div>
                                        <div class="form-text">
                                            <i class="bi bi-check2-square me-1"></i>Select drivers authorized to operate this vehicle
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Access Control -->
                        <div class="form-section">
                            <h6><i class="bi bi-shield-check me-2"></i>Access Control & Status</h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Access Status</label>
                                        <select class="form-select" id="editAccessStatus">
                                            <option value="Access">
                                                <i class="bi bi-check-circle"></i> Full Access
                                            </option>
                                            <option value="No Access">
                                                <i class="bi bi-x-circle"></i> No Access
                                            </option>
                                            <option value="Banned">
                                                <i class="bi bi-ban"></i> Banned
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Current Status</label>
                                        <select class="form-select" id="editStatus">
                                            <option value="OUT">
                                                <i class="bi bi-arrow-right-circle"></i> Checked Out
                                            </option>
                                            <option value="IN">
                                                <i class="bi bi-arrow-left-circle"></i> Checked In
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Last Updated</label>
                                        <input type="text" class="form-control" id="editLastUpdated" readonly 
                                               placeholder="System will update automatically">
                                        <div class="form-text">
                                            <i class="bi bi-clock me-1"></i>Automatically updated on save
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gate Access Control Section -->
                        <div class="form-section border-top pt-3 mt-3">
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-door-open me-2"></i>Gate Access Control
                                <small class="text-muted ms-2">(Admin/Super Admin Only)</small>
                            </h6>
                            <div class="row">
                                <div class="col-12">
                                    <label class="form-label fw-semibold">Allowed Gates</label>
                                    <div class="gate-checkbox-container border rounded p-3 bg-light" 
                                         style="max-height: 150px; overflow-y: auto;" 
                                         id="editAllowedGatesContainer">
                                        <div class="text-center py-2">
                                            <div style="color: #0d6efd;">
                                                <div class="bouncing-dots size-sm">
                                                    <span class="dot"></span>
                                                    <span class="dot"></span>
                                                    <span class="dot"></span>
                                                </div>
                                            </div>
                                            <small class="text-muted">Loading gates...</small>
                                        </div>
                                    </div>
                                    <div class="form-text mt-2">
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-info-circle text-primary me-2"></i>
                                            <span>Leave empty to allow access to all gates. Select specific gates to restrict access.</span>
                                        </div>
                                        <div class="d-flex align-items-center mt-1">
                                            <i class="bi bi-shield-check text-success me-2"></i>
                                            <span>Changes take effect immediately upon saving.</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </form>
                </div>
                <div class="modal-footer bg-light">
                    <div class="d-flex justify-content-between w-100 align-items-center">
                        <div class="text-muted small">
                            <i class="bi bi-info-circle me-1"></i>
                            All changes will be logged for audit purposes
                        </div>
                        <div>
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">
                                <i class="bi bi-x-lg me-2"></i>Cancel
                            </button>
                            <button type="button" class="btn btn-warning" id="saveVehicleEditBtn" onclick="saveVehicleEdit()">
                                <i class="bi bi-check-lg me-2"></i>Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

   

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Enhanced functionality
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // One Time Pass status update
            const oneTimePassCheckbox = document.getElementById('editOneTimePass');
            const oneTimePassStatus = document.getElementById('oneTimePassStatus');
            
            if (oneTimePassCheckbox && oneTimePassStatus) {
                oneTimePassCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        oneTimePassStatus.textContent = 'Enabled';
                        oneTimePassStatus.className = 'badge bg-success status-badge';
                    } else {
                        oneTimePassStatus.textContent = 'Disabled';
                        oneTimePassStatus.className = 'badge bg-warning text-dark status-badge';
                    }
                });
            }

            // Form validation
            const form = document.getElementById('editVehicleForm');
            if (form) {
                form.addEventListener('submit', function(event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                });
            }

            // Auto-update last updated field
            const lastUpdatedField = document.getElementById('editLastUpdated');
            if (lastUpdatedField) {
                const now = new Date();
                lastUpdatedField.value = now.toLocaleString();
            }
        });

        // Placeholder for saveVehicleEdit function
        function saveVehicleEdit() {
            // Show loading overlay
            const loadingOverlay = document.getElementById('editVehicleLoading');
            if (loadingOverlay) {
                loadingOverlay.classList.remove('d-none');
            }

            // Simulate save operation
            setTimeout(function() {
                loadingOverlay.classList.add('d-none');
                alert('Vehicle information saved successfully!');
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editVehicleModal'));
                modal.hide();
            }, 2000);
        }
    </script>


    <!-- Enhanced User Management Modal -->
    <div class="modal fade user-management-modal" id="userManagementModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h4 class="modal-title fw-bold">
                        <i class="bi bi-people-fill me-3"></i>User Management Dashboard
                    </h4>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <!-- Header with Search and Add Button -->
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center gap-3">
                            <h5 class="mb-0 text-primary fw-bold">
                                <i class="bi bi-list-ul me-2"></i>
                                User Directory
                                <span class="badge bg-primary ms-2" id="totalUsersCount">0</span>
                            </h5>
                        </div>
                        <div class="d-flex gap-2">
                            <div class="input-group" style="width: 300px;">
                                <span class="input-group-text bg-light border-end-0">
                                    <i class="bi bi-search text-muted"></i>
                                </span>
                                <input type="text" class="form-control border-start-0" id="userSearchInput" 
                                       placeholder="Search users..." onkeyup="filterUsers()">
                            </div>
                            <button class="btn btn-primary px-4" onclick="showAddUserForm()">
                                <i class="bi bi-plus-circle me-2"></i>Add User
                            </button>
                            <button class="btn btn-outline-secondary" onclick="loadUsers()" title="Refresh">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quick Add Form (Initially Hidden) -->
                    <div id="userForm" class="mb-4" style="display: none;">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-light border-0">
                                <h6 class="mb-0 text-primary fw-bold" id="userFormTitle">✨ Add New User</h6>
                            </div>
                            <div class="card-body">
                                <form id="addEditUserForm">
                                    <input type="hidden" id="editUserIndex" value="-1">
                                    
                                    <div class="row g-3">
                                        <div class="col-md-3">
                                            <label class="form-label fw-semibold">Username *</label>
                                            <input type="text" class="form-control" id="userUsername" required 
                                                   placeholder="john_doe">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-semibold">Full Name *</label>
                                            <input type="text" class="form-control" id="userFullName" required 
                                                   placeholder="John Doe">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-semibold">Email *</label>
                                            <input type="email" class="form-control" id="userEmail" required 
                                                   placeholder="john@company.com">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label fw-semibold">Role *</label>
                                            <select class="form-select" id="userRole" required>
                                                <option value="security">Security</option>
                                                <option value="admin">Admin</option>
                                                <option value="super-admin">Super Admin</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-semibold">
                                                Password *
                                                <small class="text-muted" id="passwordRequiredLabel">(Min 6 chars)</small>
                                                <small class="text-muted d-none" id="passwordOptionalLabel">(Leave blank to keep current)</small>
                                            </label>
                                            <div class="input-group">
                                                <input type="password" class="form-control" id="userPassword" 
                                                       placeholder="Enter password" minlength="6">
                                                <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility()">
                                                    <i class="bi bi-eye" id="passwordToggleIcon"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-semibold">Confirm Password *</label>
                                            <input type="password" class="form-control" id="userPasswordConfirm" 
                                                   placeholder="Confirm password" minlength="6" oninput="validatePasswords()">
                                            <div class="invalid-feedback" id="passwordMismatchError">
                                                Passwords do not match
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label fw-semibold">Status *</label>
                                            <select class="form-select" id="userStatus" required>
                                                <option value="active">✅ Active</option>
                                                <option value="inactive">⏸️ Inactive</option>
                                                <option value="suspended">🚫 Suspended</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="d-flex gap-2 mt-4">
                                        <button type="button" class="btn btn-primary px-4" onclick="saveUser()">
                                            <i class="bi bi-check-circle me-2"></i>Save User
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary px-4" onclick="cancelUserForm()">
                                            <i class="bi bi-x-circle me-2"></i>Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Modern User Table -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                <table class="table table-hover mb-0" id="usersDataTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="px-4 py-3 border-0">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-person-circle me-2 text-primary"></i>
                                                    <span class="fw-bold">User</span>
                                                </div>
                                            </th>
                                            <th class="px-4 py-3 border-0">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-shield-check me-2 text-success"></i>
                                                    <span class="fw-bold">Role</span>
                                                </div>
                                            </th>
                                            <th class="px-4 py-3 border-0">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-envelope me-2 text-info"></i>
                                                    <span class="fw-bold">Contact</span>
                                                </div>
                                            </th>
                                            <th class="px-4 py-3 border-0">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-circle-fill me-2 text-warning"></i>
                                                    <span class="fw-bold">Status</span>
                                                </div>
                                            </th>
                                            <th class="px-4 py-3 border-0">
                                                <div class="d-flex align-items-center">
                                                    <i class="bi bi-calendar3 me-2 text-secondary"></i>
                                                    <span class="fw-bold">Created</span>
                                                </div>
                                            </th>
                                            <th class="px-4 py-3 border-0 text-center">
                                                <div class="d-flex align-items-center justify-content-center">
                                                    <i class="bi bi-gear me-2 text-dark"></i>
                                                    <span class="fw-bold">Actions</span>
                                                </div>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="userTableBody">
                                        <!-- Dynamic content will be inserted here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loading/Empty State -->
                    <div id="userListContainer" class="d-none">
                        <div class="text-center py-5">
                            <div style="color: #0d6efd;">
                                <div class="bouncing-dots size-xl">
                                    <span class="dot"></span>
                                    <span class="dot"></span>
                                    <span class="dot"></span>
                                </div>
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3 text-muted">Loading users...</p>
                        </div>
                    </div>
                    
                    <!-- No Users State -->
                    <div id="noUsersState" class="text-center py-5 d-none">
                        <div class="mb-4">
                            <i class="bi bi-people text-muted" style="font-size: 4rem;"></i>
                        </div>
                        <h5 class="text-muted">No Users Found</h5>
                        <p class="text-muted mb-4">Get started by adding your first user to the system.</p>
                        <button class="btn btn-primary" onclick="showAddUserForm()">
                            <i class="bi bi-plus-circle me-2"></i>Add First User
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg me-2"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Role Settings Modal -->
    <div class="modal fade" id="roleSettingsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="bi bi-shield-check me-2"></i>Role Settings & Permissions
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-12 mb-4">
                            <h6>Role Hierarchy & Permissions</h6>
                            <div class="permissions-grid">
                                <div class="permission-item">
                                    <div class="role-badge super-admin mb-2">Super Admin</div>
                                    <small>
                                        • Full system access<br>
                                        • Manage all users<br>
                                        • Manage gates / access points<br>
                                    </small>
                                </div>
                                <div class="permission-item">
                                    <div class="role-badge admin mb-2">Admin</div>
                                    <small>
                                        • Manage vehicles<br>
                                    </small>
                                </div>
                                <div class="permission-item">
                                    <div class="role-badge security mb-2">Security</div>
                                    <small>
                                        • Gate operations<br>
                                        • QR code scanning
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gate Management Modal -->
    <div class="modal fade" id="gateManagementModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-door-open me-2"></i>Gate Management
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">Manage Gates</h6>
                        <button class="btn btn-primary btn-sm" onclick="showAddGateForm()">
                            <i class="bi bi-plus-lg me-1"></i>Add Gate
                        </button>
                    </div>
                    
                    <!-- Add/Edit Form -->
                    <div id="gateForm" class="mb-3" style="display: none;">
                        <div class="card">
                            <div class="card-body">
                                <h6 id="gateFormTitle">Add New Gate</h6>
                                <form id="addEditGateForm">
                                    <input type="hidden" id="editGateIndex" value="-1">
                                    <div class="mb-3">
                                        <label for="gateName" class="form-label">Gate Name *</label>
                                        <input type="text" class="form-control" id="gateName" required 
                                               placeholder="e.g., Main Gate">
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-primary" onclick="saveGate()">
                                            <i class="bi bi-check-lg me-1"></i>Save
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="cancelGateForm()">
                                            Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Gate List -->
                    <div id="gateListContainer">
                        <div class="text-center py-3">
                            <div style="color: #0d6efd;">
                                <div class="bouncing-dots size-lg">
                                    <span class="dot"></span>
                                    <span class="dot"></span>
                                    <span class="dot"></span>
                                </div>
                            </div>
                            <p class="mt-2 text-muted">Loading gates...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vehicle Management Modal -->
    <div class="modal fade" id="vehicleManagementModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-truck me-2"></i>Vehicle Management
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Loading Overlay -->
                    <div id="addVehicleLoading" class="d-none position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-white bg-opacity-75" style="z-index: 1050;">
                        <div class="text-center">
                            <div style="color: #0d6efd;">
                                <div class="bouncing-dots size-xl">
                                    <span class="dot"></span>
                                    <span class="dot"></span>
                                    <span class="dot"></span>
                                </div>
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-2 text-muted">Adding vehicle...</div>
                        </div>
                    </div>
                    
                    <h6 class="mb-3">Add New Vehicle</h6>
                    
                    <!-- One Time Pass Toggle - Moved to Top -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card bg-light border-warning">
                                <div class="card-body py-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="vehicleOneTimePass" role="switch">
                                        <label class="form-check-label fw-semibold" for="vehicleOneTimePass">
                                            <i class="bi bi-clock-history text-warning me-2"></i>One Time Pass
                                            <i class="bi bi-info-circle-fill text-muted ms-2" data-bs-toggle="tooltip" 
                                               title="When enabled, allows a restricted vehicle one-time access. Will automatically disable after successful entry."></i>
                                        </label>
                                    </div>
                                    <small class="text-muted">Enable for temporary vehicle access that expires after one entry</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add Vehicle Form -->
                    <form id="addVehicleForm">
                        <!-- Basic Information -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vehiclePlateNumber" class="form-label">Plate Number *</label>
                                    <input type="text" class="form-control" id="vehiclePlateNumber" required 
                                           placeholder="e.g., ABC-123">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vehicleModel" class="form-label">Make/Model *</label>
                                    <input type="text" class="form-control" id="vehicleModel" required 
                                           placeholder="e.g., Toyota Camry">
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vehicleColor" class="form-label">Color</label>
                                    <input type="text" class="form-control" id="vehicleColor" 
                                           placeholder="e.g., White">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vehicleDepartment" class="form-label">Department/Company</label>
                                    <input type="text" class="form-control" id="vehicleDepartment" 
                                           placeholder="e.g., IT Department">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Vehicle Details -->
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="vehicleYear" class="form-label">Year</label>
                                    <input type="number" class="form-control" id="vehicleYear" 
                                           placeholder="2023" min="1900" max="2030">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="vehicleType" class="form-label">Type</label>
                                    <select class="form-select" id="vehicleType" onchange="toggleMVFileField()">
                                        <option value="Car">Car</option>
                                        <option value="Truck">Truck</option>
                                        <option value="Van">Van</option>
                                        <option value="SUV">SUV</option>
                                        <option value="Motorcycle">Motorcycle</option>
                                        <option value="Bus">Bus</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="vehicleStatus" class="form-label">Status</label>
                                    <select class="form-select" id="vehicleStatus">
                                        <option value="OUT">OUT</option>
                                        <option value="IN">IN</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- MV File Field - Only for Motorcycles -->
                        <div class="row" id="mvFileRow" style="display: none;">
                            <div class="col-12">
                                <div class="mb-3">
                                    <label for="vehicleMVFile" class="form-label">
                                        <i class="bi bi-file-earmark-text me-1"></i>MV File
                                        <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="vehicleMVFile" 
                                           placeholder="Motor Vehicle file number or reference">
                                    <small class="text-muted">Required for motorcycle registration</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Driver and Access Information -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vehicleDriver" class="form-label">Current Driver</label>
                                    <input type="text" class="form-control" id="vehicleDriver" 
                                           placeholder="Driver name or ID">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vehicleAccessStatus" class="form-label">Access Status</label>
                                    <select class="form-select" id="vehicleAccessStatus">
                                        <option value="Access">Full Access</option>
                                        <option value="No Access">No Access</option>
                                        <option value="Banned">Banned</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="vehicleAssignedDrivers" class="form-label">Assigned Drivers</label>
                            <div class="driver-checkbox-container border rounded p-3" style="max-height: 150px; overflow-y: auto;" id="vehicleAssignedDriversContainer">
                                <div class="text-muted text-center">
                                    <i class="bi bi-hourglass-split"></i> Loading drivers...
                                </div>
                            </div>
                            <small class="text-muted"><i class="bi bi-check2-square me-1"></i>Select drivers authorized to operate this vehicle</small>
                        </div>

                        <!-- Gate Access Control -->
                        <div class="mb-3">
                            <label for="vehicleAllowedGates" class="form-label">
                                <i class="bi bi-door-open me-2"></i>Allowed Gates
                                <span class="badge bg-info ms-2">Optional</span>
                            </label>
                            <div class="gate-checkbox-container border rounded p-3 bg-light" 
                                 style="max-height: 150px; overflow-y: auto;" 
                                 id="vehicleAllowedGatesContainer">
                                <div class="text-center py-2">
                                    <div style="color: #0d6efd;">
                                        <div class="bouncing-dots size-sm">
                                            <span class="dot"></span>
                                            <span class="dot"></span>
                                            <span class="dot"></span>
                                        </div>
                                    </div>
                                    <small class="text-muted">Loading gates...</small>
                                </div>
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-shield-check me-1"></i>Leave empty to allow access to all gates, or select specific gates to restrict access
                            </small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveVehicle()">
                        <i class="bi bi-check-lg me-2"></i>Add Vehicle
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Function to toggle MV File field based on vehicle type
        function toggleMVFileField() {
            const vehicleType = document.getElementById('vehicleType').value;
            const mvFileRow = document.getElementById('mvFileRow');
            const mvFileInput = document.getElementById('vehicleMVFile');
            
            if (vehicleType === 'Motorcycle') {
                mvFileRow.style.display = 'block';
                mvFileInput.required = true;
            } else {
                mvFileRow.style.display = 'none';
                mvFileInput.required = false;
                mvFileInput.value = ''; // Clear the field when hidden
            }
        }
        
        // Initialize tooltips
        document.addEventListener('DOMContentLoaded', function() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            });
        });
        
        // Sample save function
        function saveVehicle() {
            const form = document.getElementById('addVehicleForm');
            const loading = document.getElementById('addVehicleLoading');
            
            if (form.checkValidity()) {
                // Show loading
                loading.classList.remove('d-none');
                
                // Simulate save operation
                setTimeout(() => {
                    loading.classList.add('d-none');
                    alert('Vehicle saved successfully!');
                    // Close modal and reset form
                    bootstrap.Modal.getInstance(document.getElementById('vehicleManagementModal')).hide();
                    form.reset();
                    toggleMVFileField(); // Reset MV file field visibility
                }, 2000);
            } else {
                form.reportValidity();
            }
        }
        
        // Reset form when modal is closed
        document.getElementById('vehicleManagementModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('addVehicleForm').reset();
            toggleMVFileField();
        });
    </script>

    <!-- QR Scanner Modal -->
    <div class="modal fade" id="qrScannerModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-qr-code me-2"></i>QR Code Scanner
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" onclick="stopQRScanner()"></button>
                </div>
                <div class="modal-body">
                    <!-- Gates and Camera Selection -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0"><i class="bi bi-door-open me-1"></i>Gate:</label>
                                <select class="form-select" id="qrGateSelect" style="flex: 1;">
                                    <option value="">Loading gates...</option>
                                </select>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="loadGatesForQRScanner()" title="Refresh gates">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-center gap-2">
                                <label class="form-label mb-0"><i class="bi bi-camera me-1"></i></label>
                                <select class="form-select" id="cameraSelect" onchange="switchCamera()">
                                    <option value="environment">Back Camera</option>
                                    <option value="user">Front Camera</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-3">Camera Scanner</h6>
                            <div class="qr-scanner-container" id="qrScannerContainer">
                                <video id="qrScannerVideo" class="qr-scanner-video" autoplay playsinline></video>
                                <canvas id="qrScannerCanvas" class="qr-scanner-canvas"></canvas>
                                <div class="qr-scanner-overlay">
                                    <div class="qr-scanner-guide"></div>
                                    <div class="qr-scanner-status" id="qrScannerStatus">
                                        Position QR code within the frame
                                    </div>
                                </div>
                                <div class="camera-access-error d-none" id="cameraError">
                                    <i class="bi bi-camera-video-off fs-1 text-muted mb-3"></i>
                                    <h6>Camera Access Required</h6>
                                    <p class="text-muted">Please allow camera access to scan QR codes.<br>Refresh the page and try again.</p>
                                    <button class="btn btn-primary btn-sm" onclick="initQRScanner()">
                                        <i class="bi bi-camera me-1"></i>Request Camera Access
                                    </button>
                                </div>
                            </div>
                             <div class="mt-3 text-center">
                                  <button type="button" class="btn btn-success" onclick="initQRScanner(); loadVehicles();" id="restartScannerBtn">
                                     Start Scanning <i class="bi bi-qr-code-scan"></i>
                                  </button>
                              </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="mb-3">Scan Result</h6>
                            <div class="scan-result-container" id="scanResultContainer">
                                <div class="text-center text-muted py-4" id="noScanResult">
                                    <i class="bi bi-qr-code-scan fs-1 mb-3"></i>
                                    <p>No activity detected. Awaiting transactions..."</p>
                                </div>
                                <div class="d-none" id="scanResultData">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="bi bi-truck me-2"></i>Vehicle Information
                                            </h6>
                                            <div class="mb-3">
                                                <strong>Plate Number:</strong>
                                                <span class="ms-2 badge bg-primary" id="scannedPlate">-</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Access Status:</strong>
                                                <span class="ms-2 badge" id="scannedAccessStatus">-</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Current Status:</strong>
                                                <span class="ms-2 badge" id="scannedCurrentStatus">-</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Driver:</strong>
                                                <span class="ms-2" id="scannedDriver">-</span>
                                            </div>
                                            <div class="mb-3">
                                                <strong>Department/Company:</strong>
                                                <span class="ms-2" id="scannedDepartment">-</span>
                                            </div>
                                            <div class="alert alert-info" id="nextActionInfo">
                                                <i class="bi bi-info-circle me-2"></i>
                                                <span id="nextActionText">Select a gate to log transaction</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Transaction Form -->
                            <div class="d-none" id="transactionForm">
                                <div class="card mt-3">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="bi bi-door-open me-2"></i>Log Transaction
                                        </h6>
                                        <form id="qrTransactionForm">
                                            <div class="mb-3">
                                                <label class="form-label">Action</label>
                                                    <div class="btn-group w-100" role="group">
                                                    <input type="radio" class="btn-check" name="qrAction" id="qrActionIN" value="IN" disabled>
                                                    <label class="btn btn-outline-success" for="qrActionIN">
                                                        <i class="bi bi-arrow-left me-1"></i>Vehicle IN
                                                    </label>
                                                    <input type="radio" class="btn-check" name="qrAction" id="qrActionOUT" value="OUT" disabled>
                                                    <label class="btn btn-outline-danger" for="qrActionOUT">
                                                        <i class="bi bi-arrow-right me-1"></i>Vehicle OUT
                                                  </label>
                                              </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- <div class="modal-footer">
                    <button type="button" class="btn btn-success" onclick="initQRScanner()" id="restartScannerBtn">
                       Next Vehicle <i class="bi-car-front-fill"></i> 
                    </button>
                </div> -->
            </div>
        </div>
    </div>

    <!-- Password Change Modal -->
    <div class="modal fade" id="passwordChangeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-key-fill me-2"></i>Change Password
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="passwordChangeForm" onsubmit="event.preventDefault(); submitPasswordChange();">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">
                                <i class="bi bi-lock me-1"></i>Current Password
                            </label>
                            <input type="password" class="form-control" id="currentPassword" required>
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">
                                <i class="bi bi-key me-1"></i>New Password
                            </label>
                            <input type="password" class="form-control" id="newPassword" required>
                            <div class="form-text">Password must be at least 6 characters long.</div>
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">
                                <i class="bi bi-check-circle me-1"></i>Confirm Password
                            </label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                            <div class="invalid-feedback"></div>
                        </div>
                        
                        <div class="alert alert-info" role="alert">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Password Requirements:</strong>
                            <ul class="mb-0 mt-2">
                                <li>At least 6 characters long</li>
                                <li>Must be different from your current password</li>
                                <li>New password and confirmation must match</li>
                            </ul>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-1"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-primary" id="changePasswordBtn" onclick="submitPasswordChange()">
                        <i class="bi bi-check-circle me-1"></i>Change Password
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Driver Management Modal -->
    <div class="modal fade" id="driverManagementModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-person-badge me-2"></i>Driver Management
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h6 class="mb-0">Manage Drivers</h6>
                        <button class="btn btn-primary" id="addNewDriverBtn" onclick="showAddDriverForm()">
                            <i class="bi bi-plus-circle me-2"></i>Add New Driver
                        </button>
                    </div>
                    
                    <!-- Add/Edit Driver Form -->
                    <div id="driverForm" class="mb-4" style="display: none;">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0" id="driverFormTitle">Add New Driver</h6>
                            </div>
                            <div class="card-body">
                                <form id="addEditDriverForm">
                                    <input type="hidden" id="editDriverId" value="">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="driverName" class="form-label">Name *</label>
                                                <input type="text" class="form-control" id="driverName" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="driverLicenseNumber" class="form-label">License Number *</label>
                                                <input type="text" class="form-control" id="driverLicenseNumber" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="driverPhone" class="form-label">Phone</label>
                                                <input type="tel" class="form-control" id="driverPhone">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="driverStatus" class="form-label">Status *</label>
                                                <select class="form-select" id="driverStatus" required>
                                                    <option value="Active">Active</option>
                                                    <option value="Inactive">Inactive</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-primary" onclick="saveDriver()">
                                            <i class="bi bi-check-lg me-2"></i>Save Driver
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="cancelDriverForm()">
                                            Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Driver List -->
                    <div class="card">
                        <div class="card-body p-0">
                            <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>License Number</th>
                                            <th>Phone</th>
                                            <th>Status</th>
                                            <th class="text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="driverTableBody">
                                        <tr>
                                            <td colspan="6" class="text-center py-4">
                                                <div style="color: #0d6efd;">
                                                    <div class="bouncing-dots size-lg">
                                                        <span class="dot"></span>
                                                        <span class="dot"></span>
                                                        <span class="dot"></span>
                                                    </div>
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p class="mt-2 text-muted">Loading drivers...</p>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg me-2"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

    <!-- Load scripts with defer for better performance -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
    <script>
        let currentUser = null;
        let vehicleData = [];
        let allVehicles = [];
        let userPermissions = null; // Store user permissions from backend
        let isTransactionInProgress = false; // Prevent multiple simultaneous transactions
        let currentTransactionIndex = -1; // Track which vehicle is being processed
        
        // Session management functions
        function saveSession() {
            if (currentUser) {
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                console.log('Session saved for user:', currentUser.username);
            }
        }
        
        function clearSession() {
            sessionStorage.removeItem('currentUser');
            sessionStorage.removeItem('selectedGate');
            console.log('Session cleared');
        }

        // Track last transaction time to prevent rapid double-taps on mobile
        let lastTransactionTime = 0;
        const MOBILE_DEBOUNCE_TIME = 300; // 300ms debounce for mobile
        
        // Transaction management functions to prevent multiple clicks
        function setTransactionInProgress(inProgress, vehicleIndex = -1) {
            isTransactionInProgress = inProgress;
            currentTransactionIndex = inProgress ? vehicleIndex : -1;
            
            // Detect if we're on mobile/tablet for enhanced feedback
            const isMobile = window.innerWidth <= 767;
            const isTablet = window.innerWidth <= 991 && window.innerWidth > 767;
            
            // Disable/enable all transaction buttons (vehicle list buttons)
            const transactionButtons = document.querySelectorAll('.vehicle-action-btn, [onclick*="toggleVehicleStatus"]');
            transactionButtons.forEach(button => {
                if (inProgress) {
                    button.disabled = true;
                    
                    // Enhanced mobile/tablet styling
                    if (isMobile) {
                        button.style.opacity = '0.4';
                        button.style.transform = 'none';
                        button.style.backgroundColor = '#e9ecef';
                        button.style.borderColor = '#dee2e6';
                    } else if (isTablet) {
                        button.style.opacity = '0.5';
                        button.style.transform = 'none';
                    } else {
                        button.style.opacity = '0.6';
                    }
                    
                    button.style.cursor = 'not-allowed';
                    button.style.pointerEvents = 'none'; // Prevent touch events on mobile
                    
                    // Add loading indicator to the specific button for current transaction
                    if (vehicleIndex >= 0 && button.getAttribute('onclick') && 
                        button.getAttribute('onclick').includes(`toggleVehicleStatus(${vehicleIndex})`)) {
                        const originalText = button.innerHTML;
                        const spinnerSize = isMobile ? '0.9rem' : '1rem';
                        button.innerHTML = `<i class="bi bi-arrow-clockwise spin" style="font-size: ${spinnerSize}"></i>`;
                        button.setAttribute('data-original-text', originalText);
                        button.title = 'Processing transaction...';
                        
                        // Add haptic feedback for mobile devices
                        if (isMobile && 'vibrate' in navigator) {
                            navigator.vibrate(50); // Brief vibration
                        }
                    }
                } else {
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.style.cursor = 'pointer';
                    button.style.pointerEvents = 'auto';
                    button.style.backgroundColor = '';
                    button.style.borderColor = '';
                    button.style.transform = '';
                    
                    // Restore original button text and title
                    const originalText = button.getAttribute('data-original-text');
                    if (originalText) {
                        button.innerHTML = originalText;
                        button.removeAttribute('data-original-text');
                        // Restore original title
                        const vehicle = vehicleData[vehicleIndex];
                        if (vehicle) {
                            const status = vehicle[7] || 'OUT';
                            const accessStatus = vehicle[10] || 'Access';
                            const oneTimePass = vehicle[11] || 'No';
                            button.title = (accessStatus === 'Banned') ? 'Vehicle is banned - check-in disabled' : 
                                          (accessStatus === 'No Access' && oneTimePass !== 'Yes' && status === 'OUT') ? 'No Access - requires active one-time pass' : 
                                          (status === 'IN' ? 'Check out this vehicle' : 'Check in this vehicle');
                        }
                    }
                }
            });
            
            // Also disable QR scanner submit button if it exists
            const qrSubmitBtn = document.querySelector('#qrTransactionForm button[type="submit"]');
            if (qrSubmitBtn) {
                qrSubmitBtn.disabled = inProgress;
                qrSubmitBtn.style.opacity = inProgress ? (isMobile ? '0.4' : '0.6') : '1';
                qrSubmitBtn.style.pointerEvents = inProgress ? 'none' : 'auto';
            }
            
            // Show visual feedback for longer operations on mobile
            if (inProgress && (isMobile || isTablet)) {
                showToast('Processing transaction...', 'info', 2000);
            }
            
            console.log('Transaction in progress:', inProgress, 'for vehicle index:', vehicleIndex, 'Device:', isMobile ? 'Mobile' : isTablet ? 'Tablet' : 'Desktop');
        }
        
        function restoreSession() {
            try {
                const storedUser = sessionStorage.getItem('currentUser');
                if (storedUser) {
                    currentUser = JSON.parse(storedUser);
                    console.log('Session restored for user:', currentUser.username, 'with role:', currentUser.role);
                    return true;
                }
            } catch (error) {
                console.error('Error restoring session:', error);
                clearSession();
            }
            return false;
        }
        
        // Table optimization configuration
        const DISPLAY_BATCH_SIZE = 100; // Load vehicles in batches for large datasets
        let filterTimeout = null;
        
        // Enhanced search configuration
        let searchHistory = JSON.parse(localStorage.getItem('vms_search_history') || '[]');
        let searchSuggestions = [];
        let currentSearchQuery = '';
        let searchCache = new Map();
        let highlightedSuggestionIndex = -1;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Application starting...');
            
            // Initialize Bootstrap tooltips
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
            
            // Check for existing session first
            checkExistingSession();
            
            // Preload critical resources
            preloadResources();
        });
        
        function checkExistingSession() {
            const loadingScreen = document.getElementById('loadingScreen');
            const loadingSubtext = loadingScreen.querySelector('.loading-subtext');
            
            // Try to restore session using the new function
            if (restoreSession()) {
                console.log('User session restored, fetching permissions and showing dashboard');
                loadingSubtext.textContent = 'Restoring session...';
                
                // Fetch permissions for the restored session
                fetchUserPermissions()
                    .then(() => {
                        loadingSubtext.textContent = 'Loading dashboard...';
                        setTimeout(() => {
                            hideLoadingScreen();
                            showDashboard();
                        }, 500);
                    })
                    .catch((error) => {
                        console.error('Failed to load permissions for restored session:', error);
                        // Still show dashboard but warn user
                        loadingSubtext.textContent = 'Loading dashboard...';
                        setTimeout(() => {
                            hideLoadingScreen();
                            showMessage('Session restored but failed to load permissions. Please refresh the page.', 'warning');
                            showDashboard();
                        }, 500);
                    });
            } else {
                console.log('No valid session found, showing login page');
                loadingSubtext.textContent = 'Please sign in...';
                setTimeout(() => {
                    hideLoadingScreen();
                    showLoginPage();
                }, 1000);
            }
        }
        
        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loadingScreen');
            loadingScreen.classList.add('fade-out');
            setTimeout(() => {
                loadingScreen.style.display = 'none';
            }, 500);
        }

        // Duplicate functions removed - using the ones defined earlier

        function preloadResources() {
            // Preload images and icons that will be used
            const imagesToPreload = [
                'bi-truck', 'bi-arrow-down-circle', 'bi-arrow-up-circle',
                'bi-person-fill', 'bi-people-fill', 'bi-building'
            ];
            
            // Create a hidden div to trigger icon font loading
            const preloadDiv = document.createElement('div');
            preloadDiv.style.position = 'absolute';
            preloadDiv.style.left = '-9999px';
            preloadDiv.style.visibility = 'hidden';
            
            imagesToPreload.forEach(icon => {
                const i = document.createElement('i');
                i.className = `bi ${icon}`;
                preloadDiv.appendChild(i);
            });
            
            document.body.appendChild(preloadDiv);
            
            // Remove after a short delay
            setTimeout(() => preloadDiv.remove(), 100);
        }

        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('dashboardPage').classList.add('hidden');
            document.body.classList.add('login-active');
        }

        function showDashboard() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('dashboardPage').classList.remove('hidden');
            document.body.classList.remove('login-active');
            
            // Update user role display
            const usernameElement = document.getElementById('currentUsername');
            usernameElement.textContent = currentUser.username;
            
            // Update role badge using the dedicated function
            updateRoleBadge(currentUser.role);
            
            // Show/hide features based on role permissions (only if permissions are loaded)
            if (userPermissions) {
                updateUIBasedOnRole();
            } else {
                console.warn('Permissions not loaded yet when showing dashboard');
            }
            
            loadVehicles();
            loadDrivers(); // Load drivers for vehicle assignment dropdowns
            initializeDriverDropdownListeners(); // Add event listeners for driver dropdowns
            loadActiveGates();
            loadTransactionLogs();
            loadDatabaseStatistics(); // Load database statistics separately
            
            
            // Optimize for mobile
            optimizeForMobile();
            
            // Initialize filter UI
            initializeFilterUI();
            
            // Initialize enhanced search functionality
            initializeSearch();
        }

        function updateUIBasedOnRole() {
            if (!userPermissions) {
                console.warn('User permissions not loaded, cannot update UI');
                return;
            }
            
            const role = currentUser.role;
            console.log('Updating UI for role:', role);
            
            // Show/hide add vehicle button
            const addVehicleBtn = document.getElementById('addVehicleBtn');
            if (hasPermission('vehicles', 'create')) {
                addVehicleBtn.style.display = 'block';
            } else {
                addVehicleBtn.style.display = 'none';
            }
            
            // Show/hide QR scanner button  
            const qrScannerBtn = document.getElementById('qrScannerBtn');
            if (hasPermission('gates', 'transactions')) {
                qrScannerBtn.style.display = 'block';
            } else {
                qrScannerBtn.style.display = 'none';
            }
            
            // Show refresh button for all authenticated users
            const refreshBtn = document.getElementById('refreshBtn');
            if (refreshBtn) {
                refreshBtn.style.display = 'block';
            }
            
            // Show/hide user management dropdown (only super-admin)
            const userManagementDropdown = document.getElementById('userManagementDropdown');
            if (hasPermission('users', 'read') && role === 'super-admin') {
                userManagementDropdown.style.display = 'block';
            } else {
                userManagementDropdown.style.display = 'none';
            }
            
            // Show/hide vehicle management button (hide for security role)
            const vehicleManagementBtn = document.getElementById('vehicleManagementBtn');
            if ((hasPermission('vehicles', 'read') || hasPermission('vehicles', 'create')) && role !== 'security') {
                vehicleManagementBtn.style.display = 'inline-block';
            } else {
                vehicleManagementBtn.style.display = 'none';
            }
            
            // Show/hide driver management button (admin and super-admin only)
            const driverManagementBtn = document.getElementById('driverManagementBtn');
            if ((role === 'admin' || role === 'super-admin')) {
                driverManagementBtn.style.display = 'inline-block';
            } else {
                driverManagementBtn.style.display = 'none';
            }
            
            // Show/hide gate management button (only super-admin)
            const gateManagementBtn = document.getElementById('gateManagementBtn');
            if ((hasPermission('gates', 'read') || hasPermission('gates', 'create')) && role === 'super-admin') {
                gateManagementBtn.style.display = 'inline-block';
            } else {
                gateManagementBtn.style.display = 'none';
            }
            
            // Hide user profile dropdown for super-admin (they can edit passwords in User Management)
            const userProfileDropdown = document.getElementById('userProfileDropdown');
            if (role === 'super-admin') {
                userProfileDropdown.style.display = 'none';
            } else {
                userProfileDropdown.style.display = 'block';
            }
            
            // Update role badge with appropriate styling
            updateRoleBadge(role);
        }

        function updateRoleBadge(role) {
            const roleElement = document.getElementById('currentRole');
            if (roleElement) {
                // Remove existing role classes
                roleElement.classList.remove('badge-super-admin', 'badge-admin', 'badge-security');
                
                // Add appropriate class and text
                switch(role) {
                    case 'super-admin':
                        roleElement.classList.add('badge-super-admin');
                        roleElement.textContent = 'Super Admin';
                        break;
                    case 'admin':
                        roleElement.classList.add('badge-admin');
                        roleElement.textContent = 'Admin';
                        break;
                    case 'security':
                        roleElement.classList.add('badge-security');
                        roleElement.textContent = 'Security';
                        break;
                    default:
                        roleElement.textContent = role;
                }
            }
        }

        /**
         * Fetch user permissions from backend
         */
        function fetchUserPermissions() {
            if (!currentUser || !currentUser.role) {
                console.warn('No current user or role available');
                return Promise.resolve(false);
            }
            
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result && result.success) {
                            userPermissions = result.permissions;
                            console.log('User permissions loaded:', userPermissions);
                            resolve(true);
                        } else {
                            console.error('Failed to load permissions:', result.error);
                            reject(result.error || 'Failed to load permissions');
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error fetching permissions:', error);
                        reject(error);
                    })
                    .getPermissionsForFrontend(currentUser.role);
            });
        }

        /**
         * Check if user has specific permission based on backend permission system
         * @param {string} resource - Resource type (users, vehicles, gates, system)
         * @param {string} action - Action type (create, read, update, delete, etc.)
         * @returns {boolean} - Whether permission is granted
         */
        function hasPermission(resource, action) {
            if (!userPermissions || !currentUser) {
                console.warn('User permissions not loaded or no current user');
                return false;
            }
            
            const resourcePerms = userPermissions[resource];
            if (!resourcePerms) {
                console.warn(`Resource '${resource}' not found in permissions`);
                return false;
            }
            
            return resourcePerms[action] === true;
        }

        /**
         * Legacy permission check function for backward compatibility
         * Maps old permission strings to new resource/action format
         */
        function hasLegacyPermission(permission) {
            const permissionMap = {
                'manage_users': () => hasPermission('users', 'create') || hasPermission('users', 'update'),
                'manage_users_limited': () => hasPermission('users', 'create') || hasPermission('users', 'update'),
                'manage_vehicles': () => hasPermission('vehicles', 'create') || hasPermission('vehicles', 'update'),
                'manage_drivers': () => hasPermission('vehicles', 'updateDriver'),
                'manage_gates': () => hasPermission('gates', 'create') || hasPermission('gates', 'update'),
                'view_all': () => hasPermission('vehicles', 'read') || hasPermission('users', 'read'),
                'system_config': () => hasPermission('system', 'exportLogs') || hasPermission('system', 'clearData'),
                'scan_vehicles': () => hasPermission('gates', 'transactions'),
                'vehicle_operations': () => hasPermission('vehicles', 'updateDriver'),
                'gate_operations': () => hasPermission('gates', 'transactions'),
                'view_assigned': () => hasPermission('vehicles', 'read'),
                'full_system_access': () => currentUser.role === 'super-admin'
            };
            
            const checkFunction = permissionMap[permission];
            return checkFunction ? checkFunction() : false;
        }

        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            
            if (!username || !password) {
                showMessage('Please enter both username and password', 'danger');
                return;
            }

            loginBtn.innerHTML = '<span class="me-2" style="color: white;"><span class="bouncing-dots size-sm"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></span>Signing in...';
            loginBtn.disabled = true;

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        currentUser = { username: username, role: result.role };
                        saveSession(); // Save session to prevent logout on refresh
                        showMessage('Login successful!', 'success');
                        
                        // Show loading screen for smooth transition
                        const loadingScreen = document.getElementById('loadingScreen');
                        const loadingSubtext = loadingScreen.querySelector('.loading-subtext');
                        loadingScreen.style.display = 'flex';
                        loadingScreen.classList.remove('fade-out');
                        loadingSubtext.textContent = 'Loading your dashboard...';
                        
                        // Fetch user permissions after successful login
                        fetchUserPermissions()
                            .then(() => {
                                setTimeout(() => {
                                    hideLoadingScreen();
                                    showDashboard();
                                }, 1000);
                            })
                            .catch((error) => {
                                console.error('Failed to load permissions:', error);
                                showMessage('Login successful but failed to load permissions. Some features may not work correctly.', 'warning');
                                setTimeout(() => {
                                    hideLoadingScreen();
                                    showDashboard();
                                }, 1000);
                            });
                    } else {
                        // Show specific error message if provided (for account status issues)
                        const errorMessage = result.message || 'Invalid username or password';
                        showMessage(errorMessage, 'danger');
                        resetLoginForm();
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Login error:', error);
                    showMessage('Login failed. Please try again.', 'danger');
                    resetLoginForm();
                })
                .loginUser(username, password);
        }

        function resetLoginForm() {
            const loginBtn = document.getElementById('loginBtn');
            loginBtn.innerHTML = '<i class="bi bi-box-arrow-in-right me-2"></i>Sign In';
            loginBtn.disabled = false;
            document.getElementById('password').value = '';
        }

        function loadDatabaseStatistics() {
            // Load database statistics directly from the database
            google.script.run
                .withSuccessHandler(function(stats) {
                    if (stats && !stats.error) {
                        console.log('Database statistics loaded:', stats);
                        
                        // Update the main statistics cards with database data
                        animateNumber('totalVehicles', stats.totalRegistered || 0);
                        animateNumber('vehiclesIn', stats.totalIn || 0);
                        animateNumber('vehiclesOut', stats.totalOut || 0);
                        
                        // Update access status counts from database data
                        animateNumber('accessCount', stats.accessCount || 0);
                        animateNumber('noAccessCount', stats.noAccessCount || 0);
                        animateNumber('bannedCount', stats.bannedCount || 0);
                        
                        // Update percentages and progress bars
                        updatePercentages(stats.totalRegistered || 0, stats.totalIn || 0, stats.totalOut || 0);
                        
                        // Update summary stats
                        updateSummaryStats(stats.totalIn || 0);
                        
                        // Add pulse effect on update
                        addPulseEffect();
                        
                        console.log(`%c✅ Database Statistics Loaded`, 'color: #28a745; font-weight: bold;', 
                                   `Total: ${stats.totalRegistered}, IN: ${stats.totalIn}, OUT: ${stats.totalOut}, Access: ${stats.accessCount}, No Access: ${stats.noAccessCount}, Banned: ${stats.bannedCount}`);
                    } else {
                        console.error('Error loading database statistics:', stats.error);
                        showToast('Failed to load database statistics', 'warning');
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading database statistics:', error);
                    showToast('Failed to load database statistics: ' + error, 'danger');
                })
                .getDatabaseStatistics();
        }

        function refreshDashboard() {
            // Clear filter fields (except gate selector)
            document.getElementById('searchInput').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterAccessStatus').value = '';
            
            // Refresh all dashboard data
            loadVehicles();
            loadDatabaseStatistics(); 
            loadTransactionLogs();
            showToast('Dashboard refreshed', 'success');
        }

        // Driver management functions
        let availableDrivers = [];

        function loadDrivers() {
            google.script.run
                .withSuccessHandler(function(drivers) {
                    availableDrivers = drivers || [];
                    populateDriverDropdowns();
                })
                .withFailureHandler(function(error) {
                    console.error('Failed to load drivers:', error);
                    availableDrivers = [];
                    populateDriverDropdowns();
                })
                .getDriverList();
        }

        function populateDriverDropdowns() {
            const addDriverContainer = document.getElementById('vehicleAssignedDriversContainer');
            const editDriverContainer = document.getElementById('editAssignedDriversContainer');
            
            // Preserve current driver selection before clearing
            const currentDriverSelect = document.getElementById('editDriver');
            const currentDriverValue = currentDriverSelect ? currentDriverSelect.value : '';
            
            // Clear existing content
            addDriverContainer.innerHTML = '';
            editDriverContainer.innerHTML = '';
            
            if (availableDrivers.length === 0) {
                const noDriversMessage = '<div class="text-muted">No active drivers found</div>';
                addDriverContainer.innerHTML = noDriversMessage;
                editDriverContainer.innerHTML = noDriversMessage;
                return;
            }
            
            // Populate add vehicle checkboxes
            availableDrivers.forEach(driver => {
                const addCheckboxDiv = document.createElement('div');
                addCheckboxDiv.className = 'form-check';
                addCheckboxDiv.innerHTML = `
                    <input class="form-check-input add-driver-checkbox" type="checkbox" 
                           value="${driver.id}" id="addDriver_${driver.id}">
                    <label class="form-check-label" for="addDriver_${driver.id}">
                        ${driver.name} <small class="text-muted">(ID: ${driver.id}${driver.licenseNumber ? ' - ' + driver.licenseNumber : ''})</small>
                    </label>
                `;
                addDriverContainer.appendChild(addCheckboxDiv);
            });
            
            // Populate edit vehicle checkboxes
            availableDrivers.forEach(driver => {
                const editCheckboxDiv = document.createElement('div');
                editCheckboxDiv.className = 'form-check';
                editCheckboxDiv.innerHTML = `
                    <input class="form-check-input edit-driver-checkbox" type="checkbox" 
                           value="${driver.id}" id="editDriver_${driver.id}">
                    <label class="form-check-label" for="editDriver_${driver.id}">
                        ${driver.name} <small class="text-muted">${driver.licenseNumber ? ' - ' + driver.licenseNumber : ''}</small>
                    </label>
                `;
                editDriverContainer.appendChild(editCheckboxDiv);
            });
            
            // Apply security role restrictions after checkboxes are populated
            setTimeout(() => {
                applySecurityRoleRestrictions();
                // Restore current driver value if it was set before
                if (currentDriverValue && currentDriverSelect) {
                    // Trigger update to rebuild the dropdown with preserved value
                    updateCurrentDriverDropdown();
                    // Set the value after dropdown is updated
                    setTimeout(() => {
                        currentDriverSelect.value = currentDriverValue;
                    }, 50);
                }
            }, 100);
        }

        function getSelectedDriverIds(selectElement) {
            const selectedOptions = Array.from(selectElement.selectedOptions);
            return selectedOptions.map(option => option.value).filter(value => value !== '');
        }

        function getSelectedDriverCheckboxIds() {
            const checkboxes = document.querySelectorAll('.edit-driver-checkbox:checked');
            return Array.from(checkboxes).map(checkbox => checkbox.value);
        }

        function getSelectedAddDriverCheckboxIds() {
            const checkboxes = document.querySelectorAll('.add-driver-checkbox:checked');
            return Array.from(checkboxes).map(checkbox => checkbox.value);
        }

        // Gate selection functions (similar to driver functions)
        function getSelectedGateCheckboxIds() {
            const checkboxes = document.querySelectorAll('.edit-gate-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(checkbox => checkbox.value);
            console.log('getSelectedGateCheckboxIds - Found checkboxes:', checkboxes.length);
            console.log('getSelectedGateCheckboxIds - Selected IDs:', selectedIds);
            return selectedIds;
        }

        function getSelectedAddGateCheckboxIds() {
            const checkboxes = document.querySelectorAll('.add-gate-checkbox:checked');
            return Array.from(checkboxes).map(checkbox => checkbox.value);
        }

        // Load gates for vehicle modals - refactored to use IDs as identifiers
        function loadGatesForModal(containerId, checkboxClass, selectedGates = []) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Show loading
            container.innerHTML = `
                <div class="text-center py-2">
                    <div style="color: #0d6efd;">
                        <div class="bouncing-dots size-sm">
                            <span class="dot"></span>
                            <span class="dot"></span>
                            <span class="dot"></span>
                        </div>
                    </div>
                    <small class="text-muted">Loading gates...</small>
                </div>
            `;

            google.script.run
                .withSuccessHandler(function(gates) {
                    let html = '';
                    
                    if (gates && gates.length > 0) {
                        // Convert selectedGates to array of IDs with proper type checking
                        let selectedArray = [];
                        if (Array.isArray(selectedGates)) {
                            selectedArray = selectedGates;
                        } else if (selectedGates && typeof selectedGates === 'string' && selectedGates.trim() !== '') {
                            selectedArray = selectedGates.split(',').map(g => g.trim());
                        } else if (selectedGates && typeof selectedGates === 'number') {
                            selectedArray = [selectedGates.toString()];
                        }
                        
                        console.log('loadGatesForModal - selectedGates input:', selectedGates);
                        console.log('loadGatesForModal - selectedGates type:', typeof selectedGates);
                        console.log('loadGatesForModal - selectedArray:', selectedArray);

                        // Handle both array format (from getGateList) and object format (from getSimpleGateList)
                        gates.forEach(gate => {
                            let gateName, gateId;
                            
                            if (Array.isArray(gate)) {
                                // Array format: [ID, Gate Name]
                                gateId = gate[0];
                                gateName = gate[1];
                            } else {
                                // Object format: {gateId, gateName}
                                gateId = gate.gateId;
                                gateName = gate.gateName;
                            }
                            
                            // Skip header row
                            if (gateName === "Gate Name" || gateName === "GateName") return;
                            
                            // Check if this gate ID is selected (backward compatibility: also check gate name)
                            const isChecked = selectedArray.includes(gateId?.toString()) || selectedArray.includes(gateName);
                            const cleanId = (gateId || gateName).toString().replace(/[^a-zA-Z0-9]/g, '');
                            
                            console.log(`loadGatesForModal - Gate ${gateId}(${gateName}): selected=${isChecked}, selectedArray contains ID=${selectedArray.includes(gateId?.toString())}, contains name=${selectedArray.includes(gateName)}`);
                            
                            html += `
                                <div class="form-check">
                                    <input class="form-check-input ${checkboxClass}" type="checkbox" 
                                           value="${gateId}" data-gate-name="${gateName}" id="${checkboxClass}_${cleanId}" ${isChecked ? 'checked' : ''}>
                                    <label class="form-check-label" for="${checkboxClass}_${cleanId}">
                                        <i class="bi bi-door-${isChecked ? 'open' : 'closed'} me-2"></i>
                                        <span class="gate-id-badge badge bg-secondary me-1">${gateId}</span>
                                        ${gateName}
                                    </label>
                                </div>
                            `;
                        });

                        if (html === '') {
                            html = '<div class="text-muted text-center py-2"><i class="bi bi-door-closed me-2"></i>No gates available</div>';
                        }
                    } else {
                        html = '<div class="text-muted text-center py-2"><i class="bi bi-door-closed me-2"></i>No gates configured</div>';
                    }
                    
                    container.innerHTML = html;

                    // Add event listeners to update icons
                    container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                        checkbox.addEventListener('change', function() {
                            const label = this.nextElementSibling;
                            const icon = label.querySelector('i');
                            if (this.checked) {
                                icon.className = 'bi bi-door-open me-2';
                            } else {
                                icon.className = 'bi bi-door-closed me-2';
                            }
                        });
                    });
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading gates:', error);
                    container.innerHTML = '<div class="text-danger text-center py-2"><i class="bi bi-exclamation-triangle me-2"></i>Error loading gates</div>';
                })
                .getSimpleGateList(); // Use getSimpleGateList for consistent object format
        }

        function setSelectedDriverIds(selectElement, driverIdsString) {
            if (!driverIdsString || typeof driverIdsString !== 'string') {
                return;
            }
            
            const driverIds = driverIdsString.split(',').map(id => id.trim()).filter(id => id);
            Array.from(selectElement.options).forEach(option => {
                option.selected = driverIds.includes(option.value);
            });
        }

        function getDriverNameById(driverId) {
            if (!driverId || driverId === 'Unassigned') {
                return 'Unassigned';
            }
            
            const driver = availableDrivers.find(d => String(d.id) === String(driverId));
            return driver ? driver.name : `${driverId}`;
        }

        function setSelectedDriverCheckboxes(driverIdsString) {
            if (!driverIdsString || typeof driverIdsString !== 'string') {
                // Uncheck all checkboxes if no drivers assigned or invalid type
                document.querySelectorAll('.edit-driver-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
                return;
            }
            
            const driverIds = driverIdsString.split(',').map(id => id.trim()).filter(id => id);
            document.querySelectorAll('.edit-driver-checkbox').forEach(checkbox => {
                const shouldBeChecked = driverIds.includes(String(checkbox.value));
                checkbox.checked = shouldBeChecked;
            });
        }

        // Add event listeners for driver dropdowns after DOM content loaded
        function initializeDriverDropdownListeners() {
            // Add event listener to edit driver checkboxes container using event delegation
            const editDriverContainer = document.getElementById('editAssignedDriversContainer');
            if (editDriverContainer) {
                editDriverContainer.addEventListener('change', function(e) {
                    if (e.target.classList.contains('edit-driver-checkbox')) {
                        updateCurrentDriverDropdown();
                    }
                });
            }
        }

        function loadVehicles(searchCriteria = {}) {
            showLoading(true);
            const startTime = performance.now();
            
            // Default search criteria for initial load
            const defaultCriteria = {
                searchTerm: '',
                statusFilter: '',
                accessStatusFilter: '',
                departmentFilter: '',
                pageSize: 50,
                pageOffset: 0,
                ...searchCriteria
            };
            
            // If this is a plate-only search and we have full data loaded, skip backend call
            if (defaultCriteria.plateNumberOnly && vehicleData && vehicleData.length > 1) {
                console.log('Using client-side filtering instead of backend call');
                showLoading(false);
                return Promise.resolve();
            }
            
            console.log('Loading vehicles with criteria:', defaultCriteria);
            
            // Load vehicles and get total count for pagination
            return Promise.all([
                new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .getVehicleList(defaultCriteria);
                }),
                new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .getVehicleCount(defaultCriteria);
                })
            ]).then(([vehicles, totalCount]) => {
                const loadTime = performance.now() - startTime;
                console.log(`Vehicles loaded: ${vehicles.length} in ${loadTime.toFixed(2)}ms`);
                
                allVehicles = vehicles || [];
                
                // Debug: Check data structure
                if (allVehicles.length > 1) {
                    console.log('First vehicle column count:', allVehicles[1]?.length);
                    console.log('First vehicle data:', allVehicles[1]);
                    console.log('Sample allowed gates (index 13):', allVehicles[1]?.[13]);
                }
                
                vehicleData = allVehicles;
                
                // Display vehicles and update pagination
                displayVehicles();
                updateStatistics();
                updatePaginationControls(vehicles.length - 1, totalCount); // Subtract header row
                
                // Update search suggestions with new data
                updateSearchSuggestions();
                
                showLoading(false);
                
                // Enhanced performance monitoring with actionable insights
                if (loadTime > 5000) {
                    console.warn('%c⚠️ Performance Alert', 'color: #ffc107; font-weight: bold;',
                        `\n📈 Load Time: ${(loadTime / 1000).toFixed(2)}s (Target: <3s)`
                        + '\n🔧 Recommendations:'
                        + '\n   • Search terms help reduce dataset size'
                        + '\n   • Use filters to narrow results'
                        + '\n   • Check network connection stability'
                        + '\n   • Contact administrator if issue persists'
                        + '\n💡 Current system uses server-side search for better performance');
                    
                    // Show user-friendly notification for very slow loads
                    if (loadTime > 5000) {
                        showToast('Large dataset detected. Try using search filters for faster results.', 'info');
                    }
                } else {
                    console.log(`%c✅ Performance Good`, 'color: #28a745; font-weight: bold;', `Load time: ${(loadTime / 1000).toFixed(2)}s`);
                }
            }).catch((error) => {
                console.error('Error loading vehicles:', error);
                showToast('Failed to load vehicles: ' + error, 'danger');
                showLoading(false);
                
                // Show retry option for network errors
                if (error.toString().includes('NetworkError')) {
                    setTimeout(() => {
                        if (confirm('Network error detected. Would you like to retry?')) {
                            loadVehicles(searchCriteria);
                        }
                    }, 1000);
                }
            });
        }

        function displayVehicles() {
            const vehiclesTableBody = document.getElementById('vehiclesTableBody');
            const noVehiclesMessage = document.getElementById('noVehiclesMessage');
            
            if (!vehiclesTableBody) {
                console.error('Vehicles table body not found');
                return;
            }

            // Clear existing content
            vehiclesTableBody.innerHTML = '';
            
            if (vehicleData.length <= 1) {
                // Show no vehicles message
                vehiclesTableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-4">
                            <i class="bi bi-car-front text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-2 mb-0">No vehicles found</p>
                            <small class="text-muted">Try adjusting your search criteria</small>
                        </td>
                    </tr>
                `;
                
                // Update badge counts
                document.getElementById('vehiclesInBadge').textContent = '0';
                document.getElementById('vehiclesOutBadge').textContent = '0';
                document.getElementById('totalVehiclesBadge').textContent = '0';
                return;
            }

            // Count vehicles by status
            let vehiclesInCount = 0;
            let vehiclesOutCount = 0;
            
            // Build table rows
            for (let i = 1; i < vehicleData.length; i++) {
                const vehicle = vehicleData[i];
                if (!vehicle || vehicle.length < 11) continue;

                const vehicleId = vehicle[0] || '';
                const plateNumber = vehicle[1] || '';
                const model = vehicle[2] || '';
                const color = vehicle[3] || '';
                const department = vehicle[4] || '';
                const year = vehicle[5] || '';
                const type = vehicle[6] || '';
                const status = vehicle[7] || 'OUT';
                const currentDriver = vehicle[8] || 'Unassigned';
                const assignedDrivers = vehicle[9] || '';
                const accessStatus = vehicle[10] || 'Access';
                const oneTimePass = vehicle[11] || 'No';

                // Count by status
                if (status === 'IN') {
                    vehiclesInCount++;
                } else {
                    vehiclesOutCount++;
                }

                // Create table row
                const row = createVehicleTableRow(
                    vehicleId, plateNumber, model, color, department, year, type, 
                    status, currentDriver, assignedDrivers, accessStatus, oneTimePass, i
                );
                
                vehiclesTableBody.appendChild(row);
            }

            // Update badge counts
            document.getElementById('vehiclesInBadge').textContent = vehiclesInCount;
            document.getElementById('vehiclesOutBadge').textContent = vehiclesOutCount;
            document.getElementById('totalVehiclesBadge').textContent = vehicleData.length - 1;
            
            // Optimize table performance for large datasets
            optimizeTablePerformance();
        }

        function createVehicleTableRow(vehicleId, plateNumber, model, color, department, year, type, status, currentDriver, assignedDrivers, accessStatus, oneTimePass, index) {
            const row = document.createElement('tr');
            row.className = `vehicle-row ${status === 'IN' ? 'table-success' : 'table-light'}`;
            
            // Determine access status styling
            let accessTextClass = 'text-success';
            if (accessStatus === 'No Access') accessTextClass = 'text-warning';
            if (accessStatus === 'Banned') accessTextClass = 'text-danger';
            
            // Display 'Full Access' instead of 'Access' for better clarity
            const displayAccessStatus = accessStatus === 'Access' ? 'Full Access' : accessStatus;
            
            // Determine status text
            const statusText = status === 'IN' 
                ? '<small class="text-success">IN</small>'
                : '<small class="text-danger">OUT</small>';
            
            // Check if edit button should be enabled for security role
            const canEditVehicle = () => {
                // Super admin and admin can always edit
                if (hasPermission('vehicles', 'update')) {
                    return true;
                }
                // Security role can only edit if Access status is 'Access' OR one-time pass is active
                if (hasPermission('vehicles', 'updateDriver')) {
                    return accessStatus === 'Access' || oneTimePass === 'Yes';
                }
                return false;
            };
            
            const editButtonEnabled = canEditVehicle();
            
            // Determine button text and icon based on user role
            const getButtonConfig = () => {
                if (hasPermission('vehicles', 'update')) {
                    return { text: 'Edit', icon: 'bi-pencil-square' }; // Super admin and admin see 'Edit'
                } else if (hasPermission('vehicles', 'updateDriver')) {
                    return { text: 'Change Driver', icon: 'bi-person-gear' }; // Security role sees 'Change Driver'
                }
                return { text: 'Edit', icon: 'bi-pencil-square' }; // Fallback
            };
            
            const buttonConfig = getButtonConfig();
            
            // Create modern action buttons following UI/UX best practices
            const detailsButton = `
                <button class="btn btn-outline-primary btn-sm vehicle-action-btn" 
                        onclick="editVehicle(${index})" 
                        title="${editButtonEnabled ? (buttonConfig.text + ' vehicle information and details') : 'Edit disabled - Full Access required or one-time pass needed'}"
                        aria-label="${buttonConfig.text} vehicle ${plateNumber}"
                        data-bs-toggle="tooltip"
                        ${!editButtonEnabled ? 'disabled aria-disabled="true"' : ''}
                        style="
                            padding: 8px 12px; 
                            font-size: 0.9rem; 
                            font-weight: 600;
                            border-radius: 8px; 
                            border: 2px solid #007bff;
                            color: #007bff;
                            background: white;
                            transition: all 0.15s ease-in-out; 
                            box-shadow: 0 1px 3px rgba(0, 123, 255, 0.1);
                            min-height: 36px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            position: relative;
                            overflow: hidden;
                            width: 100%;
                            ${!editButtonEnabled ? 'opacity: 0.5; cursor: not-allowed; filter: grayscale(1);' : ''}
                        "
                        ${editButtonEnabled ? `
                            onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(0, 123, 255, 0.25)'; this.style.background='#007bff'; this.style.color='white';"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px rgba(0, 123, 255, 0.1)'; this.style.background='white'; this.style.color='#007bff';"
                            onfocus="this.style.boxShadow='0 0 0 3px rgba(0, 123, 255, 0.25)';"
                            onblur="this.style.boxShadow='0 1px 3px rgba(0, 123, 255, 0.1)';"` : ''}>
                    <i class="bi ${buttonConfig.icon} me-1" aria-hidden="true"></i>
                    <span>${buttonConfig.text}</span>
                </button>
            `;

            const transactionButton = `
                <button class="btn ${status === 'IN' ? 'btn-outline-danger' : 'btn-outline-success'} btn-sm vehicle-action-btn" 
                        onclick="toggleVehicleStatus(${index})" 
                        title="${(accessStatus === 'Banned') ? 'Vehicle is banned - check-in disabled' : 
                               (accessStatus === 'No Access' && oneTimePass !== 'Yes' && status === 'OUT') ? 'No Access - requires active one-time pass' : 
                               (status === 'IN' ? 'Check out this vehicle' : 'Check in this vehicle')}"
                        aria-label="${status === 'IN' ? 'Check out' : 'Check in'} vehicle ${plateNumber}"
                        data-bs-toggle="tooltip"
                        ${(accessStatus === 'Banned' || (accessStatus === 'No Access' && oneTimePass !== 'Yes' && status === 'OUT')) ? 'disabled aria-disabled="true"' : ''}
                        style="
                            padding: 8px 12px; 
                            font-size: 0.9rem; 
                            font-weight: 600;
                            border-radius: 8px; 
                            border: 2px solid ${status === 'IN' ? '#dc3545' : '#28a745'};
                            color: ${status === 'IN' ? '#dc3545' : '#28a745'};
                            background: white;
                            transition: all 0.15s ease-in-out; 
                            box-shadow: 0 1px 3px ${status === 'IN' ? 'rgba(220, 53, 69, 0.1)' : 'rgba(40, 167, 69, 0.1)'};
                            min-width: 64px; 
                            min-height: 36px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            position: relative;
                            overflow: hidden;
                            width: 100%;
                            ${(accessStatus === 'Banned' || (accessStatus === 'No Access' && oneTimePass !== 'Yes' && status === 'OUT')) ? 'opacity: 0.5; cursor: not-allowed; filter: grayscale(1);' : ''}
                        "
                        ${!(accessStatus === 'Banned' || (accessStatus === 'No Access' && oneTimePass !== 'Yes' && status === 'OUT')) ? `
                            onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px ${status === 'IN' ? 'rgba(220, 53, 69, 0.25)' : 'rgba(40, 167, 69, 0.25)'}'; this.style.background='${status === 'IN' ? '#dc3545' : '#28a745'}'; this.style.color='white';"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 1px 3px ${status === 'IN' ? 'rgba(220, 53, 69, 0.1)' : 'rgba(40, 167, 69, 0.1)'}'; this.style.background='white'; this.style.color='${status === 'IN' ? '#dc3545' : '#28a745'}';"
                            onfocus="this.style.boxShadow='0 0 0 3px ${status === 'IN' ? 'rgba(220, 53, 69, 0.25)' : 'rgba(40, 167, 69, 0.25)'}';"
                            onblur="this.style.boxShadow='0 1px 3px ${status === 'IN' ? 'rgba(220, 53, 69, 0.1)' : 'rgba(40, 167, 69, 0.1)'}';"
                        ` : ''}>
                    <i class="bi bi-${status === 'IN' ? 'box-arrow-right' : 'box-arrow-in-left'} me-1" aria-hidden="true"></i>
                    <span class="action-text">${status === 'IN' ? 'OUT' : 'IN'}</span>
                    <div class="loading-spinner d-none" style="
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        width: 16px;
                        height: 16px;
                    ">
                        <div style="color: #0d6efd;">
                            <div class="bouncing-dots size-sm">
                                <span class="dot"></span>
                                <span class="dot"></span>
                                <span class="dot"></span>
                            </div>
                            <span class="visually-hidden">Processing...</span>
                        </div>
                    </div>
                </button>
            `;
            
            row.innerHTML = `
                <td style="padding: 8px 8px; font-size: 0.8rem;" class="text-muted">${vehicleId}</td>
                <td style="padding: 8px 8px; font-size: 0.9rem;" class="fw-bold text-primary">${plateNumber}</td>
                <td style="padding: 8px 8px; font-size: 0.85rem;">
                    <div class="fw-semibold">${model}</div>
                    <small class="text-muted">${year} ${color}</small>
                </td>
                <td style="padding: 8px 8px; font-size: 0.85rem;" class="d-none d-md-table-cell">
                    <small>${department}</small>
                </td>
                <td style="padding: 8px 8px; font-size: 0.85rem;" class="d-none d-lg-table-cell">
                    <small>${getDriverNameById(currentDriver)}</small>
                </td>
                <td style="padding: 8px 8px; font-size: 0.85rem;" class="text-center">${statusText}</td>
                <td style="padding: 8px 8px; font-size: 0.85rem;" class="d-none d-xl-table-cell">
                    <small class="${accessTextClass}">${displayAccessStatus}</small>
                </td>
                <td style="padding: 8px 8px; font-size: 0.85rem;" class="d-none d-xl-table-cell text-center">
                    ${oneTimePass === 'Yes' ? 
                        '<span class="badge bg-info text-white" title="One Time Pass Enabled"><i class="bi bi-key-fill"></i></span>' : 
                        '<span class="text-muted">-</span>'}
                </td>
                <td style="padding: 8px 8px;" class="text-center">${detailsButton}</td>
                <td style="padding: 8px 8px;" class="text-center">${transactionButton}</td>
            `;
            
            return row;
        }

        function createVehicleListItem(plateNumber, model, status, driver, index) {
            const item = document.createElement('div');
            
            // Get vehicle details for enhanced display
            const vehicle = vehicleData[index];
            const color = vehicle[3] || 'Unknown';
            const department = vehicle[4] || 'Unknown';
            const year = vehicle[5] || '';
            const type = vehicle[6] || 'Car';
            const assignedDrivers = vehicle[9] || '';
            const accessStatus = vehicle[10] || 'Access';
            
            // Build CSS classes including access status
            let cssClasses = `card vehicle-card status-${status.toLowerCase()}`;
            if (accessStatus === 'Banned') {
                cssClasses += ' access-banned';
            } else if (accessStatus === 'No Access') {
                cssClasses += ' access-no-access';
            }
            
            item.className = cssClasses;

            // Get appropriate icon for vehicle type
            let typeIcon = 'bi-truck';
            let typeColor = 'text-secondary';
            switch(type.toLowerCase()) {
                case 'car':
                    typeIcon = 'bi-car-front-fill';
                    typeColor = 'text-primary';
                    break;
                case 'truck':
                    typeIcon = 'bi-truck';
                    typeColor = 'text-danger';
                    break;
                case 'van':
                    typeIcon = 'bi-minecart';
                    typeColor = 'text-info';
                    break;
                case 'suv':
                    typeIcon = 'bi-car-front';
                    typeColor = 'text-success';
                    break;
                case 'motorcycle':
                    typeIcon = 'bi-bicycle';
                    typeColor = 'text-warning';
                    break;
                case 'bus':
                    typeIcon = 'bi-bus-front-fill';
                    typeColor = 'text-purple';
                    break;
                default:
                    typeIcon = 'bi-truck';
                    typeColor = 'text-secondary';
            }

            // Format assigned drivers display
            let assignedDriversDisplay = '';
            if (assignedDrivers && assignedDrivers.trim()) {
                const drivers = assignedDrivers.split(',').map(d => d.trim()).filter(d => d);
                if (drivers.length > 0) {
                    if (drivers.length === 1) {
                        assignedDriversDisplay = drivers[0];
                    } else if (drivers.length <= 3) {
                        assignedDriversDisplay = drivers.join(', ');
                    } else {
                        assignedDriversDisplay = `${drivers.slice(0, 2).join(', ')} +${drivers.length - 2} more`;
                    }
                }
            }


            item.innerHTML = `
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="vehicle-plate">
                            <h5 class="plate-number mb-1">${plateNumber}</h5>
                            <small class="text-muted">${year} ${color}</small>
                        </div>
                        <div class="vehicle-actions">
                            <button class="btn btn-sm btn-outline-secondary me-1" 
                                    onclick="showVehicleDetails(${index})" title="View Details">
                                <i class="bi bi-info-circle"></i>
                            </button>
                            <button class="btn btn-sm ${status === 'IN' ? 'btn-outline-danger' : 'btn-outline-success'}" 
                                    onclick="toggleVehicleStatus(${index})" title="${(accessStatus === 'Banned') ? 'Vehicle is banned - check-in disabled' : 
                                           (accessStatus === 'No Access' && oneTimePass !== 'Yes' && status === 'OUT') ? 'No Access - requires active one-time pass' : 
                                           (status === 'IN' ? 'Check Out' : 'Check In')}"
                                    ${(accessStatus === 'Banned' || (accessStatus === 'No Access' && oneTimePass !== 'Yes' && status === 'OUT')) ? 'disabled' : ''}>
                                <i class="bi ${status === 'IN' ? 'bi-box-arrow-right' : 'bi-box-arrow-in-left'}"></i>
                            </button>
                        </div>
                    </div>
                    <div class="vehicle-info">
                        <div class="mb-1">
                            <i class="bi ${typeIcon} me-2 ${typeColor}"></i>
                            <small class="fw-medium">${type} - ${model}</small>
                        </div>
                        <div class="mb-1">
                            <i class="bi bi-person-fill me-2 text-success"></i>
                            <small><strong>Current:</strong> ${driver}</small>
                        </div>
                        ${assignedDriversDisplay ? `
                        <div class="mb-1">
                            <i class="bi bi-people-fill me-2 text-info"></i>
                            <small><strong>Assigned:</strong> ${assignedDriversDisplay}</small>
                        </div>
                        ` : ''}
                        <div>
                            <i class="bi bi-building me-2 text-warning"></i>
                            <small>${department}</small>
                        </div>
                    </div>
                </div>
            `;

            return item;
        }

        // Keep the old function for compatibility
        function createVehicleCard(plateNumber, model, status, driver, index) {
            return createVehicleListItem(plateNumber, model, status, driver, index);
        }

        function toggleVehicleStatus(index) {
            // Prevent multiple clicks by checking if transaction is already in progress
            if (isTransactionInProgress) {
                console.log('Transaction already in progress, ignoring click');
                return;
            }
            
            // Mobile debouncing to prevent double-taps
            const currentTime = Date.now();
            const isMobile = window.innerWidth <= 767;
            if (isMobile && (currentTime - lastTransactionTime) < MOBILE_DEBOUNCE_TIME) {
                console.log('Mobile double-tap detected, ignoring click');
                return;
            }
            lastTransactionTime = currentTime;

            // Add error handling for vehicle data
            if (!vehicleData || vehicleData.length === 0) {
                showToast('No vehicle data available', 'warning');
                return;
            }
            
            if (index < 0 || index >= vehicleData.length) {
                showToast('Invalid vehicle index', 'danger');
                return;
            }
            
            const vehicle = vehicleData[index];
            if (!vehicle) {
                showToast('Vehicle data not found', 'danger');
                console.error('Vehicle not found at index:', index, 'vehicleData length:', vehicleData.length);
                return;
            }
            
            console.log('Toggling status for vehicle:', vehicle[0], 'at index:', index);
            
            // Set transaction in progress and disable all transaction buttons
            setTransactionInProgress(true, index);
            
            // Validate gate selection first
            if (!validateGateSelection()) {
                setTransactionInProgress(false);
                return;
            }
            
            const currentStatus = vehicle[7] || 'OUT'; // Status is at index 7
            const newStatus = currentStatus === 'IN' ? 'OUT' : 'IN';
            const accessStatus = vehicle[10] || 'Access'; // Access status is at index 10
            const oneTimePass = vehicle[11] || 'No'; // One-time pass is at index 11
            
            // Get the selected gate using our helper function
            const selectedGate = getCurrentGate();
            const gate = selectedGate.id;

            // First, validate gate access restrictions for this vehicle
            showLoading(true);
            google.script.run
                .withSuccessHandler(function(gateValidation) {
                    showLoading(false);
                    
                    if (!gateValidation.allowed) {
                        // Show detailed denial notification with reason
                        let message = `🚫This Vehicle not authorized for this gate.`;
                        showToast(message, 'danger', 8000); // Show for 8 seconds
                        setTransactionInProgress(false); // Re-enable buttons
                        return;
                    }
                    
                    // Gate validation passed, continue with standard access checks
                    proceedWithStatusChange();
                })
                .withFailureHandler(function(error) {
                    showLoading(false);
                    console.error('Gate validation error:', error);
                    showToast('Error validating gate access: ' + error.toString(), 'danger');
                    setTransactionInProgress(false); // Re-enable buttons on error
                })
                .validateVehicleGateAccess(vehicle[0], vehicle[1], gate);
            
            // Move the rest of the logic to a separate function
            function proceedWithStatusChange() {
                // Check access permissions for check-in attempts
                if (newStatus === 'IN' && accessStatus === 'No Access' && oneTimePass !== 'Yes') {
                    showToast('Vehicle access denied. No Access vehicles require an active one-time pass to check in.', 'warning');
                    setTransactionInProgress(false); // Re-enable buttons
                    return;
                }
                
                if (accessStatus === 'Banned') {
                    showToast('Vehicle access denied. This vehicle is banned from entry.', 'danger');
                    setTransactionInProgress(false); // Re-enable buttons
                    return;
                }

                const logData = {
                    plateNumber: vehicle[1], // Plate number is at index 1, not 0 (which is ID)
                    driverId: vehicle[8] || 'Unknown', // Current driver is at index 8
                    action: newStatus,
                    gate: gate,
                    remarks: '',
                    username: currentUser.username // Add the current user's username
                };

                showLoading(true);
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result && result.success) {
                            vehicleData[index][7] = newStatus;
                            
                            // Update one-time pass status if it was disabled
                            if (result.oneTimePassUsed) {
                                vehicleData[index][11] = 'No'; // Disable one-time pass in local data
                            }
                            
                            displayVehicles();
                            updateStatistics();
                            
                            // Show appropriate message based on whether one-time pass was used
                            let message = `Vehicle ${newStatus === 'IN' ? 'checked in' : 'checked out'} at ${selectedGate.name}!`;
                            if (result.oneTimePassUsed) {
                                message += ' One-time pass has been disabled.';
                            }
                            showToast(message, 'success');
                            
                            // Refresh statistics to get accurate count from database
                            loadDatabaseStatistics();
                            
                        }
                        showLoading(false);
                        setTransactionInProgress(false); // Re-enable buttons after successful transaction
                    })
                    .withFailureHandler(function(error) {
                        showToast('Failed to update vehicle status: ' + error, 'danger');
                        showLoading(false);
                        setTransactionInProgress(false); // Re-enable buttons after failed transaction
                    })
                    .logVehicleAction(logData);
            }
        }

        // Enhanced search functionality
        function initializeSearch() {
            const searchInput = document.getElementById('searchInput');
            if (!searchInput) return;
            
            // Add event listeners for enhanced search
            searchInput.addEventListener('input', handleSearchInput);
            searchInput.addEventListener('keydown', handleSearchKeydown);
            searchInput.addEventListener('focus', handleSearchFocus);
            searchInput.addEventListener('blur', handleSearchBlur);
            
            // Initialize search suggestions from loaded vehicle data
            updateSearchSuggestions();
            
            // Set up keyboard shortcuts
            setupSearchKeyboardShortcuts();
        }
        
        function handleSearchInput(event) {
            // Now just handles UI updates, actual search triggered by button click
            handleSearchInputUI(event);
        }
        
        function handleSearchKeydown(event) {
            const suggestions = document.querySelectorAll('.suggestion-item:not(.search-history .suggestion-item)');
            
            switch (event.key) {
                case 'ArrowDown':
                    event.preventDefault();
                    highlightedSuggestionIndex = Math.min(highlightedSuggestionIndex + 1, suggestions.length - 1);
                    updateSuggestionHighlight(suggestions);
                    break;
                    
                case 'ArrowUp':
                    event.preventDefault();
                    highlightedSuggestionIndex = Math.max(highlightedSuggestionIndex - 1, -1);
                    updateSuggestionHighlight(suggestions);
                    break;
                    
                case 'Enter':
                    event.preventDefault();
                    if (highlightedSuggestionIndex >= 0 && suggestions[highlightedSuggestionIndex]) {
                        selectSuggestion(suggestions[highlightedSuggestionIndex]);
                    } else {
                        // Use the same protected search mechanism as the button
                        triggerManualSearch();
                        hideSearchSuggestions();
                    }
                    break;
                    
                case 'Escape':
                    event.target.value = '';
                    clearSearchInput();
                    event.target.blur();
                    break;
                    
                case 'Tab':
                    if (highlightedSuggestionIndex >= 0 && suggestions[highlightedSuggestionIndex]) {
                        event.preventDefault();
                        selectSuggestion(suggestions[highlightedSuggestionIndex]);
                    }
                    break;
            }
        }
        
        function handleSearchFocus() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (searchTerm.length >= 1) {
                showSearchSuggestions(searchTerm);
            } else if (searchHistory.length > 0) {
                showSearchHistory();
            }
        }
        
        function handleSearchBlur(event) {
            // Delay hiding suggestions to allow for clicking
            setTimeout(() => {
                if (!event.relatedTarget || !event.relatedTarget.closest('.search-suggestions')) {
                    hideSearchSuggestions();
                    hideSearchShortcuts();
                }
            }, 150);
        }
        
        function performEnhancedSearch(searchTerm) {
            // Parse simple plate number search
            const parsedQuery = parseAdvancedSearchQuery(searchTerm);
            const plateSearchTerm = parsedQuery.mainQuery.toLowerCase();
            
            // Show loading
            showSearchLoading(true);
            
            // Add to search history if it's a meaningful search
            if (searchTerm.length > 2) {
                addToSearchHistory(searchTerm);
            }
            
            // If we have vehicle data loaded, filter client-side for better performance
            if (vehicleData && vehicleData.length > 1 && plateSearchTerm.length > 0) {
                performClientSidePlateFilter(plateSearchTerm, parsedQuery.exactMatch);
                showSearchLoading(false);
                updateSearchResultsCounter(searchTerm);
                hideSearchSuggestions();
                return Promise.resolve(); // Return resolved promise for consistency
            }
            
            // Fallback to server-side search if no data loaded or empty search
            const searchCriteria = {
                searchTerm: parsedQuery.mainQuery,
                exactMatch: parsedQuery.exactMatch || false,
                plateNumberOnly: true,
                pageSize: 50,
                pageOffset: 0
            };
            
            // Check cache first
            const cacheKey = JSON.stringify(searchCriteria);
            if (searchCache.has(cacheKey)) {
                const cachedResult = searchCache.get(cacheKey);
                displaySearchResults(cachedResult, searchTerm);
                showSearchLoading(false);
                return;
            }
            
            // Perform server-side search only when necessary
            return loadVehicles(searchCriteria).then(() => {
                showSearchLoading(false);
                updateSearchResultsCounter(searchTerm);
                hideSearchSuggestions();
            }).catch(() => {
                showSearchLoading(false);
                showToast('Search failed. Please try again.', 'danger');
            });
        }
        
        function performClientSidePlateFilter(searchTerm, exactMatch = false) {
            if (!vehicleData || vehicleData.length <= 1) {
                return;
            }
            
            // Filter vehicles by plate number (column B - index 1)
            const filteredVehicles = [vehicleData[0]]; // Keep header row
            
            for (let i = 1; i < vehicleData.length; i++) {
                const vehicle = vehicleData[i];
                if (!vehicle || !vehicle[1]) continue;
                
                const plateNumber = vehicle[1].toLowerCase();
                
                if (exactMatch) {
                    // Exact match search
                    if (plateNumber === searchTerm) {
                        filteredVehicles.push(vehicle);
                    }
                } else {
                    // Partial match search
                    if (plateNumber.includes(searchTerm)) {
                        filteredVehicles.push(vehicle);
                    }
                }
            }
            
            // Store original data if not already stored
            if (!window.originalVehicleData) {
                window.originalVehicleData = vehicleData;
            }
            
            // Update vehicleData with filtered results
            vehicleData = filteredVehicles;
            
            // Update display with filtered data
            displayVehicles();
            
            // Update statistics for filtered view
            updateStatistics();
            
            console.log(`Client-side plate filter: ${filteredVehicles.length - 1} vehicles found for "${searchTerm}"`);
        }
        
        function clearClientSideFilter() {
            // Restore original data if it exists
            if (window.originalVehicleData) {
                vehicleData = window.originalVehicleData;
                window.originalVehicleData = null;
                displayVehicles();
                updateStatistics();
            }
        }
        
        function parseAdvancedSearchQuery(query) {
            const result = {
                mainQuery: query,
                exactMatch: false
            };
            
            // Check for exact match (quoted strings) - Only for plate numbers
            const exactMatchRegex = /"([^"]+)"/g;
            const exactMatches = [];
            let match;
            while ((match = exactMatchRegex.exec(query)) !== null) {
                exactMatches.push(match[1]);
                result.exactMatch = true;
            }
            
            if (exactMatches.length > 0) {
                result.mainQuery = exactMatches.join(' ');
                return result;
            }
            
            // No advanced syntax parsing - only plate number search
            return result;
        }
        
        function showSearchSuggestions(searchTerm) {
            const suggestions = generateSearchSuggestions(searchTerm);
            const container = document.getElementById('searchSuggestions');
            
            if (suggestions.length === 0) {
                hideSearchSuggestions();
                return;
            }
            
            let html = '';
            
            // Add main suggestions
            suggestions.forEach((suggestion, index) => {
                const highlightedText = highlightSearchMatch(suggestion.text, searchTerm);
                html += `
                    <div class="suggestion-item" data-suggestion="${suggestion.text}" data-type="${suggestion.type}">
                        <span class="suggestion-text">${highlightedText}</span>
                        <span class="suggestion-type">${suggestion.type}</span>
                    </div>
                `;
            });
            
            // Add search history if query is empty or short
            if (searchTerm.length <= 2 && searchHistory.length > 0) {
                html += `
                    <div class="search-history">
                        <div class="search-history-header">
                            <span>Recent Searches</span>
                            <button type="button" class="clear-history-btn" onclick="clearSearchHistory()">Clear</button>
                        </div>
                `;
                
                searchHistory.slice(0, 5).forEach(historyItem => {
                    html += `
                        <div class="suggestion-item" data-suggestion="${historyItem}">
                            <span class="suggestion-text">
                                <i class="bi bi-clock-history me-2 text-muted"></i>${historyItem}
                            </span>
                            <span class="suggestion-type">history</span>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            container.innerHTML = html;
            container.classList.add('show');
            
            // Add click listeners to suggestions
            container.querySelectorAll('.suggestion-item').forEach(item => {
                item.addEventListener('click', () => selectSuggestion(item));
            });
            
            highlightedSuggestionIndex = -1;
        }
        
        function generateSearchSuggestions(searchTerm) {
            if (!vehicleData || vehicleData.length <= 1) return [];
            
            const suggestions = new Set();
            const term = searchTerm.toLowerCase();
            const maxSuggestions = 8;
            
            // Generate suggestions from loaded vehicle data - PLATE NUMBERS ONLY (Column B)
            for (let i = 1; i < vehicleData.length && suggestions.size < maxSuggestions; i++) {
                const vehicle = vehicleData[i];
                if (!vehicle) continue;
                
                const plateNumber = vehicle[1] || ''; // Column B - Plate Number only
                
                // Plate number suggestions only
                if (plateNumber.toLowerCase().includes(term)) {
                    suggestions.add({ text: plateNumber, type: 'plate' });
                }
            }
            
            return Array.from(suggestions).slice(0, maxSuggestions);
        }
        
        function highlightSearchMatch(text, searchTerm) {
            if (!searchTerm) return text;
            
            const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<span class="suggestion-match">$1</span>');
        }
        
        function selectSuggestion(suggestionElement) {
            const suggestionText = suggestionElement.getAttribute('data-suggestion');
            
            // Only populate the search input, don't trigger search
            document.getElementById('searchInput').value = suggestionText;
            
            // Hide suggestions after selection
            hideSearchSuggestions();
            
            // Update UI elements (show clear button, etc.)
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                handleSearchInputUI({ target: searchInput });
            }
            
            // Focus back on the search input for user convenience
            searchInput.focus();
        }
        
        function updateSuggestionHighlight(suggestions) {
            suggestions.forEach((suggestion, index) => {
                if (index === highlightedSuggestionIndex) {
                    suggestion.classList.add('highlighted');
                } else {
                    suggestion.classList.remove('highlighted');
                }
            });
        }
        
        function hideSearchSuggestions() {
            const container = document.getElementById('searchSuggestions');
            container.classList.remove('show');
            highlightedSuggestionIndex = -1;
        }
        
        function showSearchHistory() {
            if (searchHistory.length === 0) return;
            
            const container = document.getElementById('searchSuggestions');
            let html = `
                <div class="search-history">
                    <div class="search-history-header">
                        <span>Recent Searches</span>
                        <button type="button" class="clear-history-btn" onclick="clearSearchHistory()">Clear</button>
                    </div>
            `;
            
            searchHistory.slice(0, 8).forEach(historyItem => {
                html += `
                    <div class="suggestion-item" data-suggestion="${historyItem}">
                        <span class="suggestion-text">
                            <i class="bi bi-clock-history me-2 text-muted"></i>${historyItem}
                        </span>
                        <span class="suggestion-type">recent</span>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
            container.classList.add('show');
            
            // Add click listeners
            container.querySelectorAll('.suggestion-item').forEach(item => {
                item.addEventListener('click', () => selectSuggestion(item));
            });
        }
        
        function addToSearchHistory(searchTerm) {
            if (!searchTerm || searchTerm.length < 2) return;
            
            // Remove if already exists
            searchHistory = searchHistory.filter(item => item !== searchTerm);
            
            // Add to beginning
            searchHistory.unshift(searchTerm);
            
            // Keep only last 20 items
            searchHistory = searchHistory.slice(0, 20);
            
            // Save to localStorage
            localStorage.setItem('vms_search_history', JSON.stringify(searchHistory));
        }
        
        function clearSearchHistory() {
            searchHistory = [];
            localStorage.removeItem('vms_search_history');
            hideSearchSuggestions();
            showToast('Search history cleared', 'info');
        }
        
        function clearSearchInput() {
            const searchInput = document.getElementById('searchInput');
            searchInput.value = '';
            searchInput.focus();
            
            const clearButton = document.querySelector('.search-clear');
            clearButton.classList.remove('show');
            
            hideSearchSuggestions();
            updateSearchResultsCounter('');
            
            // Clear client-side filter first, fallback to server if needed
            if (window.originalVehicleData) {
                clearClientSideFilter();
            } else {
                // Only hit server if we don't have original data
                loadVehicles();
            }
        }
        
        function showSearchLoading(show) {
            const loadingElement = document.querySelector('.search-loading');
            if (show) {
                loadingElement.classList.add('show');
            } else {
                loadingElement.classList.remove('show');
            }
        }
        
        function updateSearchResultsCounter(searchTerm) {
            const counter = document.getElementById('searchResultsCounter');
            const totalVehicles = document.getElementById('totalVehiclesBadge').textContent || '0';
            
            if (searchTerm) {
                counter.textContent = `Showing ${totalVehicles} results for "${searchTerm}"`;
                counter.style.color = '#0d6efd';
            } else {
                counter.textContent = `Showing all ${totalVehicles} vehicles`;
                counter.style.color = '#6c757d';
            }
        }
        
        function setupSearchKeyboardShortcuts() {
            document.addEventListener('keydown', (event) => {
                // Ctrl+K or Cmd+K to focus search
                if ((event.ctrlKey || event.metaKey) && event.key === 'k') {
                    event.preventDefault();
                    const searchInput = document.getElementById('searchInput');
                    searchInput.focus();
                    searchInput.select();
                }
                
                // Alt+C to clear search
                if (event.altKey && event.key === 'c') {
                    event.preventDefault();
                    clearSearchInput();
                }
            });
        }
        
        function toggleSearchShortcuts() {
            const shortcuts = document.getElementById('searchShortcuts');
            shortcuts.classList.toggle('show');
            
            // Hide suggestions when showing shortcuts
            if (shortcuts.classList.contains('show')) {
                hideSearchSuggestions();
            }
        }
        
        function hideSearchShortcuts() {
            const shortcuts = document.getElementById('searchShortcuts');
            shortcuts.classList.remove('show');
        }
        
        function updateSearchSuggestions() {
            // Update suggestions cache when vehicle data changes
            if (vehicleData && vehicleData.length > 1) {
                searchSuggestions = [];
                
                // Extract unique values for suggestions
                const plateNumbers = new Set();
                const makeModels = new Set();
                const departments = new Set();
                const drivers = new Set();
                const vehicleTypes = new Set();
                
                for (let i = 1; i < vehicleData.length; i++) {
                    const vehicle = vehicleData[i];
                    if (!vehicle) continue;
                    
                    if (vehicle[1]) plateNumbers.add(vehicle[1]);
                    if (vehicle[2]) makeModels.add(vehicle[2]);
                    if (vehicle[4]) departments.add(vehicle[4]);
                    if (vehicle[8]) drivers.add(vehicle[8]);
                    if (vehicle[6]) vehicleTypes.add(vehicle[6]);
                }
                
                // Store for fast access
                searchSuggestions = {
                    plates: Array.from(plateNumbers),
                    models: Array.from(makeModels),
                    departments: Array.from(departments),
                    drivers: Array.from(drivers),
                    types: Array.from(vehicleTypes)
                };
            }
        }
        
        // Manual search trigger function for search button with click protection
        let isSearchInProgress = false;
        
        function triggerManualSearch() {
            // Prevent multiple concurrent searches
            if (isSearchInProgress) {
                console.log('Search already in progress, ignoring click');
                return;
            }
            
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.querySelector('.external-search-button');
            
            if (searchInput) {
                const searchTerm = searchInput.value.trim();
                if (searchTerm.length > 0) {
                    console.log('Manual search triggered for:', searchTerm);
                    
                    // Set search in progress and disable button
                    isSearchInProgress = true;
                    if (searchButton) {
                        searchButton.disabled = true;
                        searchButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>Searching...';
                    }
                    
                    // Perform search
                    performEnhancedSearch(searchTerm).finally(() => {
                        // Re-enable button after search completes
                        isSearchInProgress = false;
                        if (searchButton) {
                            searchButton.disabled = false;
                            searchButton.innerHTML = '<i class="bi bi-search me-1"></i><span class="d-md-none">Search</span>';
                        }
                    });
                } else {
                    // If empty, clear the search
                    clearSearchInput();
                }
            }
        }
        
        // Modified to only handle UI updates, NO auto-search behavior
        function handleSearchInputUI(event) {
            const searchTerm = event.target.value.trim();
            currentSearchQuery = searchTerm;
            
            // Show/hide clear button
            const clearButton = document.querySelector('.search-clear');
            if (searchTerm.length > 0) {
                clearButton.classList.add('show');
            } else {
                clearButton.classList.remove('show');
                // Only clear search results when input is completely empty
                if (searchTerm.length === 0) {
                    performEnhancedSearch(searchTerm);
                }
            }
            
            // Update suggestions if search term is long enough (but don't trigger search)
            if (searchTerm.length >= 1) {
                showSearchSuggestions(searchTerm);
            } else {
                hideSearchSuggestions();
            }
        }
        
        // Legacy function for compatibility - now only handles UI updates
        function debounceFilter() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                handleSearchInputUI({ target: searchInput });
            }
        }

        // Legacy function for compatibility - now calls enhanced search
        function filterVehicles() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            performEnhancedSearch(searchTerm);
        }

        function clearFilters() {
            // Clear all filter inputs
            const searchInput = document.getElementById('searchInput');
            const filterStatus = document.getElementById('filterStatus');
            const filterAccessStatus = document.getElementById('filterAccessStatus');
            
            if (searchInput) searchInput.value = '';
            if (filterStatus) filterStatus.value = '';
            if (filterAccessStatus) filterAccessStatus.value = '';
            
            // Reset to default search criteria (load all vehicles)
            loadVehicles();
            
            // Show feedback
            showToast('Filters cleared - showing all vehicles', 'info');
        }

        function showFilterFeedback(searchTerm, filterStatus, filterAccessStatus) {
            // Update clear button visibility
            const clearBtn = document.querySelector('button[onclick="clearFilters()"]');
            if (clearBtn) {
                if (searchTerm || filterStatus || filterAccessStatus) {
                    clearBtn.style.opacity = '1';
                    clearBtn.disabled = false;
                } else {
                    clearBtn.style.opacity = '0.5';
                    clearBtn.disabled = true;
                }
            }
        }

        function initializeFilterUI() {
            // Initialize clear button state
            const clearBtn = document.querySelector('button[onclick="clearFilters()"]');
            if (clearBtn) {
                clearBtn.style.opacity = '0.5';
                clearBtn.disabled = true;
            }
        }

        // Pagination functionality
        let currentPage = 1;
        let pageSize = 50;
        let totalVehicles = 0;

        function changePage(direction) {
            const totalPages = Math.ceil(totalVehicles / pageSize);
            
            if (direction === 'prev' && currentPage > 1) {
                currentPage--;
            } else if (direction === 'next' && currentPage < totalPages) {
                currentPage++;
            }
            
            // Load vehicles for the new page
            const searchInput = document.getElementById('searchInput');
            const filterStatusElement = document.getElementById('filterStatus');
            const filterAccessStatusElement = document.getElementById('filterAccessStatus');
            
            const searchTerm = searchInput ? searchInput.value.trim() : '';
            const filterStatus = filterStatusElement ? filterStatusElement.value : '';
            const filterAccessStatus = filterAccessStatusElement ? filterAccessStatusElement.value : '';
            
            const searchCriteria = {
                searchTerm: searchTerm,
                statusFilter: filterStatus,
                accessStatusFilter: filterAccessStatus,
                departmentFilter: '',
                pageSize: pageSize,
                pageOffset: (currentPage - 1) * pageSize
            };
            
            loadVehicles(searchCriteria);
        }

        function changePageSize() {
            const newPageSize = parseInt(document.getElementById('pageSizeSelector').value);
            pageSize = newPageSize;
            currentPage = 1; // Reset to first page when changing page size
            
            // Reload vehicles with new page size
            const searchInput = document.getElementById('searchInput');
            const filterStatusElement = document.getElementById('filterStatus');
            const filterAccessStatusElement = document.getElementById('filterAccessStatus');
            
            const searchTerm = searchInput ? searchInput.value.trim() : '';
            const filterStatus = filterStatusElement ? filterStatusElement.value : '';
            const filterAccessStatus = filterAccessStatusElement ? filterAccessStatusElement.value : '';
            
            const searchCriteria = {
                searchTerm: searchTerm,
                statusFilter: filterStatus,
                accessStatusFilter: filterAccessStatus,
                departmentFilter: '',
                pageSize: pageSize,
                pageOffset: 0
            };
            
            loadVehicles(searchCriteria);
        }

        function updatePaginationControls(vehicleCount, totalCount) {
            const paginationRow = document.getElementById('paginationRow');
            const paginationInfo = document.getElementById('paginationInfo');
            const prevPageItem = document.getElementById('prevPageItem');
            const nextPageItem = document.getElementById('nextPageItem');
            const currentPageNumber = document.getElementById('currentPageNumber');
            
            totalVehicles = totalCount;
            const totalPages = Math.ceil(totalCount / pageSize);
            const startIndex = (currentPage - 1) * pageSize + 1;
            const endIndex = Math.min(currentPage * pageSize, totalCount);
            
            // Show pagination controls if there are more vehicles than page size
            if (totalCount > pageSize) {
                paginationRow.style.display = 'block';
                
                // Update pagination info
                paginationInfo.textContent = `Showing ${startIndex}-${endIndex} of ${totalCount} vehicles`;
                
                // Update current page number
                currentPageNumber.textContent = currentPage;
                
                // Update previous button state
                if (currentPage <= 1) {
                    prevPageItem.classList.add('disabled');
                } else {
                    prevPageItem.classList.remove('disabled');
                }
                
                // Update next button state
                if (currentPage >= totalPages) {
                    nextPageItem.classList.add('disabled');
                } else {
                    nextPageItem.classList.remove('disabled');
                }
            } else {
                paginationRow.style.display = 'none';
            }
        }

        function updateStatistics() {
            // This function is now simplified - all statistics come from database via loadDatabaseStatistics()
            // This function is kept for compatibility and any future enhancements that might need table-based calculations
            
            console.log('updateStatistics called - all stats now loaded from database via loadDatabaseStatistics()');
            
            // No longer needed since all statistics are fetched directly from database
            // Access status counts, vehicle totals, IN/OUT counts all come from getDatabaseStatistics()
        }

        function animateNumber(elementId, targetNumber) {
            const element = document.getElementById(elementId);
            const currentText = element.textContent.trim();
            
            // Handle loading state (when value is "-")
            if (currentText === "-" || currentText === "") {
                element.textContent = targetNumber;
                // Add a subtle scale effect when complete
                element.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    element.style.transform = 'scale(1)';
                }, 200);
                return;
            }
            
            const currentNumber = parseInt(currentText) || 0;
            const increment = targetNumber > currentNumber ? 1 : -1;
            const steps = Math.abs(targetNumber - currentNumber);
            const duration = Math.min(1000, steps * 50); // Max 1 second animation
            const stepDuration = duration / steps;

            if (steps === 0) return;

            let current = currentNumber;
            const timer = setInterval(() => {
                current += increment;
                element.textContent = current;
                
                if (current === targetNumber) {
                    clearInterval(timer);
                    // Add a subtle scale effect when complete
                    element.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        element.style.transform = 'scale(1)';
                    }, 200);
                }
            }, stepDuration);
        }

        function updatePercentages(total, vehiclesIn, vehiclesOut) {
            if (total === 0) {
                document.querySelector('#vehiclesInPercentage span').textContent = '0%';
                document.querySelector('#vehiclesOutPercentage span').textContent = '0%';
                document.getElementById('vehiclesInProgress').style.width = '0%';
                document.getElementById('vehiclesOutProgress').style.width = '0%';
                return;
            }

            const inPercentage = Math.round((vehiclesIn / total) * 100);
            const outPercentage = Math.round((vehiclesOut / total) * 100);

            // Update percentage text
            document.querySelector('#vehiclesInPercentage span').textContent = inPercentage + '%';
            document.querySelector('#vehiclesOutPercentage span').textContent = outPercentage + '%';

            // Animate progress bars
            setTimeout(() => {
                document.getElementById('vehiclesInProgress').style.width = inPercentage + '%';
                document.getElementById('vehiclesOutProgress').style.width = outPercentage + '%';
            }, 100);
        }

        function addPulseEffect() {
            const cards = document.querySelectorAll('.stats-card');
            cards.forEach(card => {
                card.classList.add('pulse-once');
                setTimeout(() => {
                    card.classList.remove('pulse-once');
                }, 600);
            });
        }

        function updateSummaryStats(vehiclesIn, totalRegistered = null) {
            // Update last update time
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('lastUpdate').textContent = timeString;
            
            // Update active gate display
            const currentGate = getCurrentGate();
            if (currentGate) {
                document.getElementById('activeGateDisplay').textContent = currentGate.name;
            }
            
            // Update today's activity from InOutLogs
            updateTodayActivity();
        }

        // Function to update today's activity count from backend
        function updateTodayActivity() {
            try {
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result && result.success) {
                            document.getElementById('recentActivity').textContent = result.count;
                        } else {
                            console.error('Error getting today activity:', result?.error);
                            document.getElementById('recentActivity').textContent = '0';
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Failed to get today activity:', error);
                        document.getElementById('recentActivity').textContent = '0';
                    })
                    .getTodayActivityCount();
            } catch (error) {
                console.error('Error calling getTodayActivityCount:', error);
                document.getElementById('recentActivity').textContent = '0';
            }
        }

        function logout() {
            currentUser = null;
            clearSession(); // Clear stored session data
            
            // Immediately hide buttons
            document.getElementById('addVehicleBtn').style.display = 'none';
            document.getElementById('qrScannerBtn').style.display = 'none';
            document.getElementById('refreshBtn').style.display = 'none';
            
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginMsg').innerHTML = '';
            showLoginPage();
            showToast('You have been logged out successfully', 'info');
        }

        // Fullscreen functionality with browser compatibility check
        function isFullscreenSupported() {
            return document.fullscreenEnabled || 
                   document.mozFullScreenEnabled || 
                   document.webkitFullscreenEnabled || 
                   document.msFullscreenEnabled;
        }

        function toggleFullscreen() {
            if (!isFullscreenSupported()) {
                showToast('Fullscreen mode is not supported in your browser', 'warning');
                return;
            }

            if (!document.fullscreenElement && !document.mozFullScreenElement && 
                !document.webkitFullscreenElement && !document.msFullscreenElement) {
                enterFullscreen();
            } else {
                exitFullscreen();
            }
        }

        function enterFullscreen() {
            const elem = document.documentElement;
            try {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen().catch(err => {
                        console.error('Error entering fullscreen:', err);
                        showToast('Failed to enter fullscreen mode', 'error');
                    });
                } else if (elem.mozRequestFullScreen) { // Firefox
                    elem.mozRequestFullScreen();
                } else if (elem.webkitRequestFullscreen) { // Chrome, Safari, Opera
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) { // IE/Edge
                    elem.msRequestFullscreen();
                }
            } catch (error) {
                console.error('Fullscreen error:', error);
                showToast('Failed to enter fullscreen mode', 'error');
            }
        }

        function exitFullscreen() {
            try {
                if (document.exitFullscreen) {
                    document.exitFullscreen().catch(err => {
                        console.error('Error exiting fullscreen:', err);
                    });
                } else if (document.mozCancelFullScreen) { // Firefox
                    document.mozCancelFullScreen();
                } else if (document.webkitExitFullscreen) { // Chrome, Safari, Opera
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) { // IE/Edge
                    document.msExitFullscreen();
                }
            } catch (error) {
                console.error('Fullscreen exit error:', error);
            }
        }

        // Listen for fullscreen changes to update icon
        function handleFullscreenChange() {
            const fullscreenIcon = document.getElementById('fullscreenIcon');
            const dashboardPage = document.getElementById('dashboardPage');
            
            if (document.fullscreenElement) {
                fullscreenIcon.className = 'bi bi-fullscreen-exit';
                dashboardPage.classList.add('fullscreen-mode');
                optimizeFullscreenLayout();
            } else {
                fullscreenIcon.className = 'bi bi-arrows-fullscreen';
                dashboardPage.classList.remove('fullscreen-mode');
            }
        }

        // Add event listeners for fullscreen changes
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange); // Firefox
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange); // Chrome, Safari, Opera
        document.addEventListener('msfullscreenchange', handleFullscreenChange); // IE/Edge

        // Enhanced keyboard shortcuts for fullscreen
        document.addEventListener('keydown', function(event) {
            // Only process shortcuts in fullscreen mode (except for Ctrl+F to enter)
            const inFullscreen = !!document.fullscreenElement;
            
            // Ctrl+F to toggle fullscreen
            if (event.key === 'f' && event.ctrlKey && !event.shiftKey && !event.altKey) {
                event.preventDefault();
                toggleFullscreen();
                return;
            }
            
            // Only process other shortcuts in fullscreen mode
            if (!inFullscreen) return;
            
            // Prevent default for all our custom shortcuts
            if (!event.ctrlKey && !event.altKey && !event.metaKey) {
                switch (event.key.toLowerCase()) {
                    case 'f':
                        event.preventDefault();
                        toggleFocusMode();
                        break;
                    case 'z':
                        event.preventDefault();
                        toggleZenMode();
                        break;
                    case 'r':
                        event.preventDefault();
                        refreshData();
                        break;
                    case 'h':
                        event.preventDefault();
                        showFullscreenHelp();
                        break;
                    case 'escape':
                        event.preventDefault();
                        exitFullscreen();
                        break;
                }
            }
        });

        // Enhance fullscreen experience by adjusting layout
        function optimizeFullscreenLayout() {
            const dashboardPage = document.getElementById('dashboardPage');
            if (document.fullscreenElement && dashboardPage) {
                // Temporarily hide elements during transition for smoother experience
                dashboardPage.style.transition = 'all 0.3s ease';
                
                // Set up auto-hide navbar functionality
                setupAutoHideNavbar();
                
                // Force layout recalculation after a brief delay
                setTimeout(() => {
                    window.dispatchEvent(new Event('resize'));
                }, 100);
            } else {
                // Clean up when exiting fullscreen
                cleanupFullscreenModes();
            }
        }

        function cleanupFullscreenModes() {
            cleanupAutoHideNavbar();
            
            // Reset focus mode
            if (focusModeActive) {
                const dashboardPage = document.getElementById('dashboardPage');
                dashboardPage.classList.remove('focus-mode');
                focusModeActive = false;
            }
            
            // Reset zen mode
            if (zenModeActive) {
                const statsRow = document.querySelector('.stats-row');
                const summaryCard = document.querySelector('.quick-summary-card');
                const mainContentRow = document.querySelector('.main-content-row');
                
                if (statsRow) statsRow.style.display = '';
                if (summaryCard) summaryCard.style.display = '';
                if (mainContentRow) mainContentRow.style.height = '';
                
                zenModeActive = false;
            }
        }

        // Auto-hide navbar functionality for fullscreen mode
        let scrollTimeout;
        let lastScrollY = 0;
        let navbarHideTimeout;

        function setupAutoHideNavbar() {
            if (!document.fullscreenElement) return;
            
            const navbar = document.querySelector('.navbar');
            const vehicleList = document.querySelector('.vehicle-logs-container');
            const transactionLogs = document.querySelector('.transaction-logs-container');
            
            function handleScroll() {
                clearTimeout(scrollTimeout);
                clearTimeout(navbarHideTimeout);
                
                const currentScrollY = this.scrollTop || window.pageYOffset;
                
                // Show navbar immediately when scrolling up or at top
                if (currentScrollY < lastScrollY || currentScrollY <= 10) {
                    navbar.classList.remove('navbar-hidden');
                } else if (currentScrollY > lastScrollY && currentScrollY > 100) {
                    // Hide navbar when scrolling down after some distance
                    navbarHideTimeout = setTimeout(() => {
                        navbar.classList.add('navbar-hidden');
                    }, 150); // Small delay to prevent flicker
                }
                
                lastScrollY = currentScrollY;
                
                // Auto-show navbar after inactivity
                scrollTimeout = setTimeout(() => {
                    navbar.classList.remove('navbar-hidden');
                }, 3000); // Show after 3 seconds of no scrolling
            }
            
            // Add scroll listeners to both main content areas
            if (vehicleList) {
                vehicleList.addEventListener('scroll', handleScroll, { passive: true });
            }
            if (transactionLogs) {
                transactionLogs.addEventListener('scroll', handleScroll, { passive: true });
            }
            
            // Also listen to main window scroll as fallback
            window.addEventListener('scroll', handleScroll, { passive: true });
            
            // Show navbar on mouse move to top
            document.addEventListener('mousemove', function(e) {
                if (e.clientY <= 60) { // Mouse near top of screen
                    navbar.classList.remove('navbar-hidden');
                }
            });
            
            // Touch gesture support for mobile
            let touchStartY = 0;
            let touchStartTime = 0;
            
            document.addEventListener('touchstart', function(e) {
                touchStartY = e.touches[0].clientY;
                touchStartTime = Date.now();
            }, { passive: true });
            
            document.addEventListener('touchend', function(e) {
                const touchEndY = e.changedTouches[0].clientY;
                const touchDuration = Date.now() - touchStartTime;
                const swipeDistance = touchEndY - touchStartY;
                
                // Detect swipe down from top to show navbar
                if (touchStartY <= 100 && swipeDistance > 50 && touchDuration < 500) {
                    navbar.classList.remove('navbar-hidden');
                }
                
                // Detect swipe up to hide navbar
                if (swipeDistance < -50 && touchDuration < 500) {
                    navbar.classList.add('navbar-hidden');
                }
            }, { passive: true });
            
            // Auto-hide after initial delay in fullscreen
            navbarHideTimeout = setTimeout(() => {
                navbar.classList.add('navbar-hidden');
            }, 5000); // Hide after 5 seconds
        }

        function cleanupAutoHideNavbar() {
            const navbar = document.querySelector('.navbar');
            if (navbar) {
                navbar.classList.remove('navbar-hidden');
            }
            
            clearTimeout(scrollTimeout);
            clearTimeout(navbarHideTimeout);
            
            // Remove event listeners if needed (though they're passive and will be cleaned up)
            lastScrollY = 0;
        }

        // Advanced fullscreen features
        let focusModeActive = false;
        let zenModeActive = false;

        function toggleFocusMode() {
            if (!document.fullscreenElement) return;
            
            const dashboardPage = document.getElementById('dashboardPage');
            const focusBtn = document.getElementById('focusModeBtn');
            
            focusModeActive = !focusModeActive;
            
            if (focusModeActive) {
                dashboardPage.classList.add('focus-mode');
                focusBtn.style.background = 'rgba(255, 255, 255, 0.3)';
                focusBtn.title = 'Exit Focus Mode (F)';
                showToast('Focus Mode: Stats dimmed, content highlighted', 'info');
            } else {
                dashboardPage.classList.remove('focus-mode');
                focusBtn.style.background = 'rgba(0, 0, 0, 0.7)';
                focusBtn.title = 'Focus Mode (F)';
                showToast('Focus Mode disabled', 'info');
            }
        }

        function toggleZenMode() {
            if (!document.fullscreenElement) return;
            
            const dashboardPage = document.getElementById('dashboardPage');
            const zenBtn = document.getElementById('zenModeBtn');
            const statsRow = document.querySelector('.stats-row');
            const summaryCard = document.querySelector('.quick-summary-card');
            
            zenModeActive = !zenModeActive;
            
            if (zenModeActive) {
                // Hide stats and summary in zen mode
                if (statsRow) statsRow.style.display = 'none';
                if (summaryCard) summaryCard.style.display = 'none';
                
                zenBtn.style.background = 'rgba(255, 255, 255, 0.3)';
                zenBtn.querySelector('i').className = 'bi bi-sun';
                zenBtn.title = 'Exit Zen Mode (Z)';
                showToast('Zen Mode: Minimal UI, maximum focus', 'info');
                
                // Adjust main content to use full space
                const mainContentRow = document.querySelector('.main-content-row');
                if (mainContentRow) {
                    mainContentRow.style.height = 'calc(100vh - 120px)';
                }
            } else {
                // Show stats and summary
                if (statsRow) statsRow.style.display = '';
                if (summaryCard) summaryCard.style.display = '';
                
                zenBtn.style.background = 'rgba(0, 0, 0, 0.7)';
                zenBtn.querySelector('i').className = 'bi bi-moon';
                zenBtn.title = 'Zen Mode (Z)';
                showToast('Zen Mode disabled', 'info');
                
                // Reset main content height
                const mainContentRow = document.querySelector('.main-content-row');
                if (mainContentRow) {
                    mainContentRow.style.height = '';
                }
            }
        }

        function refreshData() {
            if (document.fullscreenElement) {
                showToast('Refreshing data...', 'info');
                
                // Add visual feedback
                const refreshBtn = document.getElementById('refreshBtn');
                const icon = refreshBtn.querySelector('i');
                icon.style.animation = 'spin 1s linear infinite';
                
                // Instead of reloading the page, refresh just the dashboard data
                // This preserves the fullscreen state and avoids the black screen issue
                Promise.all([
                    new Promise(resolve => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(resolve)
                            .getVehicleList({
                                searchTerm: document.getElementById('searchInput') ? document.getElementById('searchInput').value.trim() : '',
                                statusFilter: document.getElementById('filterStatus') ? document.getElementById('filterStatus').value : '',
                                accessStatusFilter: document.getElementById('filterAccessStatus') ? document.getElementById('filterAccessStatus').value : '',
                                departmentFilter: '',
                                pageSize: 50,
                                pageOffset: 0
                            });
                    }),
                    new Promise(resolve => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(resolve)
                            .getDatabaseStatistics();
                    }),
                    new Promise(resolve => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(resolve)
                            .getRecentTransactions(50);
                    })
                ]).then(([vehicles, stats, transactions]) => {
                    // Update vehicle data
                    if (vehicles && !vehicles.error) {
                        allVehicles = vehicles;
                        vehicleData = allVehicles;
                        displayVehicles();
                    }
                    
                    // Update statistics
                    if (stats && !stats.error) {
                        animateNumber('totalVehicles', stats.totalRegistered || 0);
                        animateNumber('vehiclesIn', stats.totalIn || 0);
                        animateNumber('vehiclesOut', stats.totalOut || 0);
                        animateNumber('accessCount', stats.accessCount || 0);
                        animateNumber('noAccessCount', stats.noAccessCount || 0);
                        animateNumber('bannedCount', stats.bannedCount || 0);
                        updatePercentages(stats.totalRegistered || 0, stats.totalIn || 0, stats.totalOut || 0);
                        updateSummaryStats(stats.totalIn || 0);
                        addPulseEffect();
                    }
                    
                    // Update transaction logs
                    if (transactions) {
                        displayTransactionLogs(transactions);
                    }
                    
                    // Reset button animation
                    icon.style.animation = '';
                    showToast('Dashboard refreshed successfully!', 'success');
                }).catch(error => {
                    console.error('Error refreshing data:', error);
                    icon.style.animation = '';
                    showToast('Error refreshing data', 'danger');
                });
            }
        }

        function showFullscreenHelp() {
            const helpContent = `
                <div class="text-start">
                    <h6 class="mb-3"><i class="bi bi-keyboard me-2"></i>Fullscreen Keyboard Shortcuts</h6>
                    <div class="row">
                        <div class="col-6">
                            <p class="mb-2"><kbd>Ctrl+F</kbd> - Toggle Fullscreen</p>
                            <p class="mb-2"><kbd>F</kbd> - Focus Mode</p>
                            <p class="mb-2"><kbd>Z</kbd> - Zen Mode</p>
                        </div>
                        <div class="col-6">
                            <p class="mb-2"><kbd>R</kbd> - Refresh Data</p>
                            <p class="mb-2"><kbd>H</kbd> - Show This Help</p>
                            <p class="mb-2"><kbd>ESC</kbd> - Exit Fullscreen</p>
                        </div>
                    </div>
                    <hr class="my-3">
                    <div class="small text-muted">
                        <p class="mb-1"><strong>Focus Mode:</strong> Dims stats, highlights main content</p>
                        <p class="mb-1"><strong>Zen Mode:</strong> Minimal UI for maximum focus</p>
                        <p class="mb-0"><strong>Auto-hide:</strong> Navbar hides on scroll, shows on mouse hover at top</p>
                    </div>
                </div>
            `;
            
            // Create and show modal
            const helpModal = document.createElement('div');
            helpModal.className = 'modal fade';
            helpModal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Fullscreen Help</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            ${helpContent}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(helpModal);
            const modal = new bootstrap.Modal(helpModal);
            modal.show();
            
            // Remove modal from DOM when hidden
            helpModal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(helpModal);
            });
        }

        // CSS for three bouncing dots animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes bounce {
                0%, 80%, 100% { 
                    transform: scale(0.8);
                    opacity: 0.7;
                }
                40% { 
                    transform: scale(1.2);
                    opacity: 1;
                }
            }
            
            .bouncing-dots {
                display: inline-flex;
                align-items: center;
                gap: 4px;
            }
            
            .bouncing-dots .dot {
                width: 8px;
                height: 8px;
                background-color: currentColor;
                border-radius: 50%;
                animation: bounce 1.4s ease-in-out infinite both;
            }
            
            .bouncing-dots .dot:nth-child(1) { animation-delay: -0.32s; }
            .bouncing-dots .dot:nth-child(2) { animation-delay: -0.16s; }
            .bouncing-dots .dot:nth-child(3) { animation-delay: 0s; }
            
            /* Size variations */
            .bouncing-dots.size-sm .dot {
                width: 6px;
                height: 6px;
            }
            
            .bouncing-dots.size-lg .dot {
                width: 12px;
                height: 12px;
            }
            
            .bouncing-dots.size-xl .dot {
                width: 16px;
                height: 16px;
            }
        `;
        document.head.appendChild(style);

        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            if (show) {
                spinner.classList.remove('hidden');
            } else {
                spinner.classList.add('hidden');
            }
        }

        function showVehicleModalLoading(show, modalType) {
            const loadingOverlayId = modalType === 'add' ? 'addVehicleLoading' : 'editVehicleLoading';
            const modalId = modalType === 'add' ? 'vehicleManagementModal' : 'editVehicleModal';
            
            const loadingOverlay = document.getElementById(loadingOverlayId);
            const modal = document.getElementById(modalId);
            
            if (show) {
                // Show loading overlay
                loadingOverlay.classList.remove('d-none');
                loadingOverlay.classList.add('d-flex');
                
                // Disable all buttons and form elements in the modal EXCEPT Cancel and X buttons
                const buttons = modal.querySelectorAll('button:not([data-bs-dismiss="modal"])');
                const inputs = modal.querySelectorAll('input, select, textarea');
                
                buttons.forEach(btn => {
                    if (!btn.hasAttribute('data-bs-dismiss')) {
                        btn.setAttribute('data-original-disabled', btn.disabled);
                        btn.disabled = true;
                    }
                });
                
                inputs.forEach(input => {
                    input.setAttribute('data-original-disabled', input.disabled);
                    input.disabled = true;
                });
            } else {
                // Hide loading overlay
                loadingOverlay.classList.add('d-none');
                loadingOverlay.classList.remove('d-flex');
                
                // Re-enable all buttons and form elements
                const buttons = modal.querySelectorAll('button:not([data-bs-dismiss="modal"])');
                const inputs = modal.querySelectorAll('input, select, textarea');
                
                buttons.forEach(btn => {
                    if (!btn.hasAttribute('data-bs-dismiss')) {
                        const wasOriginallyDisabled = btn.getAttribute('data-original-disabled') === 'true';
                        btn.disabled = wasOriginallyDisabled;
                        btn.removeAttribute('data-original-disabled');
                    }
                });
                
                inputs.forEach(input => {
                    const wasOriginallyDisabled = input.getAttribute('data-original-disabled') === 'true';
                    input.disabled = wasOriginallyDisabled;
                    input.removeAttribute('data-original-disabled');
                });
            }
        }

        function showMessage(message, type) {
            const loginMsg = document.getElementById('loginMsg');
            const icons = {
                success: 'bi-check-circle-fill',
                danger: 'bi-exclamation-triangle-fill'
            };

            loginMsg.className = `alert alert-${type} mb-3 d-flex align-items-center`;
            loginMsg.innerHTML = `
                <i class="bi ${icons[type]} me-2"></i>
                <div>${message}</div>
            `;
        }

        function showToast(message, type) {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            toastContainer.innerHTML += toastHtml;
            const toast = new bootstrap.Toast(document.getElementById(toastId));
            toast.show();
            
            setTimeout(() => {
                const toastElement = document.getElementById(toastId);
                if (toastElement) {
                    toastElement.remove();
                }
            }, 5000);
        }



        function updateCurrentDriverDropdown() {
            const currentDriverSelect = document.getElementById('editDriver');
            const currentValue = currentDriverSelect.value; // Save current selection
            
            // Get the authorized drivers from the vehicle data directly
            const vehicleIndex = parseInt(document.getElementById('editVehicleIndex').value);
            const vehicle = vehicleData[vehicleIndex];
            const authorizedDriversString = vehicle[9] || ''; // Authorized drivers at index 9
            
            // Use all drivers including inactive ones if available
            const driversToUse = window.tempAllDriversForEdit || availableDrivers;
            
            console.log('updateCurrentDriverDropdown - currentValue preserved:', currentValue);
            console.log('updateCurrentDriverDropdown - authorizedDriversString:', authorizedDriversString);
            console.log('updateCurrentDriverDropdown - driversToUse:', driversToUse);
            
            // Clear existing options
            currentDriverSelect.innerHTML = '<option value="">Select a driver...</option>';
            
            if (authorizedDriversString && typeof authorizedDriversString === 'string') {
                const authorizedDriverIds = authorizedDriversString.split(',').map(id => id.trim()).filter(id => id);
                console.log('updateCurrentDriverDropdown - authorizedDriverIds:', authorizedDriverIds);
                
                // Add each authorized driver as an option
                authorizedDriverIds.forEach(driverId => {
                    const driver = driversToUse.find(d => String(d.id) === String(driverId));
                    if (driver) {
                        const option = document.createElement('option');
                        option.value = driver.id;
                        // Show driver status if inactive
                        const statusText = driver.status && driver.status !== 'Active' ? ` [${driver.status}]` : '';
                        option.textContent = `${driver.name}${statusText}`;
                        if (driver.status && driver.status !== 'Active') {
                            option.style.color = '#6c757d'; // Gray color for inactive
                        }
                        currentDriverSelect.appendChild(option);
                    } else {
                        // Add the driver ID even if not found in available drivers
                        // This handles cases where driver might be deleted
                        console.warn('Driver not found in driver list, adding ID only:', driverId);
                        const option = document.createElement('option');
                        option.value = driverId;
                        option.textContent = `${driverId} (Not Found)`;
                        option.style.color = '#dc3545'; // Red color for not found
                        currentDriverSelect.appendChild(option);
                    }
                });
                
                // Restore previous selection if it's still in the list
                if (currentValue) {
                    // Try to restore the value even if it's not in the authorized list
                    // This handles the case where the selection was made before the list was updated
                    currentDriverSelect.value = currentValue;
                    
                    // If the value couldn't be set (not in the list), log it
                    if (currentDriverSelect.value !== currentValue) {
                        console.log('updateCurrentDriverDropdown - Previous driver not in authorized list:', currentValue);
                    } else {
                        console.log('updateCurrentDriverDropdown - Successfully restored driver:', currentValue);
                    }
                }
            } else {
                console.log('No authorized drivers for this vehicle');
            }
        }

        function editVehicle(index) {
            if (!hasPermission('vehicles', 'update') && !hasPermission('vehicles', 'updateDriver')) {
                showToast('Access denied: Insufficient permissions to edit vehicles', 'danger');
                return;
            }
            
            const vehicle = vehicleData[index];
            
            // Debug: Log the vehicle data being edited
            console.log('Editing vehicle at index:', index);
            console.log('Vehicle data for edit:', vehicle);
            console.log('Current driver (index 8):', vehicle[8]);
            console.log('Assigned drivers (index 9):', vehicle[9]);
            console.log('Allowed gates (index 13):', vehicle[13]);
            
            // Populate edit form with correct indices
            document.getElementById('editVehicleIndex').value = index;
            document.getElementById('editPlateNumber').value = vehicle[1] || ''; // Plate number is at index 1
            document.getElementById('editModel').value = vehicle[2] || '';      // Make/Model is at index 2
            document.getElementById('editColor').value = vehicle[3] || '';      // Color is at index 3
            document.getElementById('editDepartment').value = vehicle[4] || ''; // Department is at index 4
            document.getElementById('editYear').value = vehicle[5] || '';       // Year is at index 5
            document.getElementById('editType').value = vehicle[6] || 'Car';    // Type is at index 6
            document.getElementById('editStatus').value = vehicle[7] || 'OUT';  // Status is at index 7
            // Note: setSelectedDriverCheckboxes will be called after drivers are loaded
            document.getElementById('editAccessStatus').value = vehicle[10] || 'Access'; // Access status is at index 10
            console.log('One Time Pass value (index 11):', vehicle[11]);
            document.getElementById('editOneTimePass').checked = vehicle[11] === 'Yes'; // One Time Pass is at index 11
            document.getElementById('editMVFile').value = vehicle[12] || '';    // MV File is at index 12
            
            // Apply role-based field restrictions for security users
            applySecurityRoleRestrictions();
            
            // Store current vehicle data for reference during async operations
            window.currentEditVehicle = vehicle;
            
            // Load all drivers including inactive ones for edit modal
            google.script.run
                .withSuccessHandler(function(allDrivers) {
                    console.log('Loaded drivers for edit modal:', allDrivers?.length || 0);
                    
                    // Store all drivers for current driver dropdown
                    const allDriversForEdit = allDrivers || [];
                    
                    // Update the updateCurrentDriverDropdown to use allDriversForEdit
                    window.tempAllDriversForEdit = allDriversForEdit;
                    
                    // Still populate checkboxes with only active drivers
                    populateDriverDropdowns(); // This uses availableDrivers (active only)
                    
                    // Wait for checkboxes to be rendered before setting selected ones
                    setTimeout(() => {
                        const currentVehicle = window.currentEditVehicle;
                        console.log('Setting driver checkboxes:', currentVehicle[9]);
                        console.log('Setting current driver:', currentVehicle[8]);
                        
                        setSelectedDriverCheckboxes(currentVehicle[9] || ''); // Re-set the checkboxes
                        updateCurrentDriverDropdown();
                        document.getElementById('editDriver').value = currentVehicle[8] || '';     // Current driver is at index 8
                        
                        // Verify the values were set
                        console.log('Current driver dropdown value after setting:', document.getElementById('editDriver').value);
                    }, 100);
                })
                .withFailureHandler(function(error) {
                    console.error('Failed to load all drivers for edit:', error);
                    showToast('Failed to load drivers', 'danger');
                    
                    // Still try to set current driver even if driver loading fails
                    setTimeout(() => {
                        document.getElementById('editDriver').value = vehicle[8] || '';
                    }, 100);
                })
                .getAllDriversIncludingInactive();
            
            // Load gates for gate restriction modal
            console.log('Loading gates for edit modal with selected gates:', vehicle[13] || '');
            loadGatesForModal('editAllowedGatesContainer', 'edit-gate-checkbox', vehicle[13] || '');
            
            // Event listener for assigned drivers is already handled by initializeDriverDropdownListeners
            // using event delegation on the container
            
            // Restrict users who can only update driver to current driver field only
            if (hasPermission('vehicles', 'updateDriver') && !hasPermission('vehicles', 'update')) {
                // Disable all fields except current driver
                const fieldsToDisable = [
                    'editPlateNumber', 'editModel', 'editColor', 'editDepartment', 
                    'editYear', 'editType', 'editStatus', 'editAccessStatus'
                ];
                
                fieldsToDisable.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.disabled = true;
                        field.style.backgroundColor = '#f8f9fa';
                        field.style.opacity = '0.6';
                    }
                });
                
                // Disable all driver checkboxes
                document.querySelectorAll('.edit-driver-checkbox').forEach(checkbox => {
                    checkbox.disabled = true;
                    checkbox.parentElement.style.opacity = '0.6';
                });
                
                // Disable One Time Pass toggle for security role
                const oneTimePassToggle = document.getElementById('editOneTimePass');
                if (oneTimePassToggle) {
                    oneTimePassToggle.disabled = true;
                    oneTimePassToggle.parentElement.style.opacity = '0.6';
                    oneTimePassToggle.parentElement.title = 'One Time Pass control is read-only for security role';
                }
                
                // Ensure current driver field is enabled and highlighted
                const driverField = document.getElementById('editDriver');
                if (driverField) {
                    driverField.disabled = false;
                    driverField.style.backgroundColor = '#f8f9ff';
                    driverField.style.opacity = '';
                    driverField.style.borderColor = '#007bff';
                    driverField.style.borderWidth = '2px';
                    driverField.style.boxShadow = '0 0 0 0.25rem rgba(13, 110, 253, 0.25)';
                    
                    // Add a visual label for security users
                    const driverFieldContainer = driverField.closest('.col-md-6');
                    if (driverFieldContainer) {
                        const existingLabel = driverFieldContainer.querySelector('.security-driver-label');
                        if (!existingLabel) {
                            const securityLabel = document.createElement('div');
                            securityLabel.className = 'security-driver-label badge bg-primary-subtle text-primary mb-2';
                            securityLabel.innerHTML = '<i class="bi bi-person-check me-1"></i>Editable Field';
                            driverFieldContainer.insertBefore(securityLabel, driverField.parentElement);
                        }
                    }
                    
                    setTimeout(() => driverField.focus(), 100);
                }
                
                // Update modal title for Security users
                const modalTitle = document.querySelector('#editVehicleModal .modal-title');
                if (modalTitle) {
                    modalTitle.innerHTML = '<i class="bi bi-person-gear me-2"></i>Change Current Driver - ' + vehicle[1];
                }
                
                // Show driver change warning and update save button
                const warningElement = document.getElementById('driverChangeWarning');
                if (warningElement) {
                    const currentStatus = vehicle[7];
                    const nextStatus = currentStatus === 'IN' ? 'OUT' : 'IN';
                    const currentDriver = vehicle[8] || 'Unassigned';
                    
                    warningElement.innerHTML = '<i class="bi bi-info-circle me-1"></i>' +
                        '<strong>Driver Change for ' + vehicle[1] + '</strong><br>' +
                        '<small class="text-muted">Current: ' + currentDriver + ' | Status: ' + currentStatus + '</small><br>' +
                        '<small>This driver change will be recorded in the next ' + nextStatus + ' transaction.</small>';
                    warningElement.parentElement.style.display = 'block';
                }
                
                // Update save button text
                const saveBtn = document.getElementById('saveVehicleEditBtn');
                if (saveBtn) {
                    saveBtn.innerHTML = '<i class="bi bi-person-check me-2"></i>Save & Record Transaction';
                    saveBtn.className = 'btn btn-primary';
                }
            } else {
                // Reset all fields for admin, supervisor, and super-admin users
                const allFields = [
                    'editPlateNumber', 'editModel', 'editColor', 'editDepartment', 
                    'editYear', 'editType', 'editStatus', 'editAccessStatus', 'editDriver'
                ];
                
                allFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.disabled = false;
                        field.style.backgroundColor = '';
                        field.style.opacity = '';
                        field.style.borderColor = '';
                        field.style.borderWidth = '';
                        field.style.boxShadow = '';
                    }
                });
                
                // Enable all driver checkboxes
                document.querySelectorAll('.edit-driver-checkbox').forEach(checkbox => {
                    checkbox.disabled = false;
                    checkbox.parentElement.style.opacity = '';
                });
                
                // Enable all gate checkboxes
                const allowedGatesContainer = document.getElementById('editAllowedGatesContainer');
                if (allowedGatesContainer) {
                    const gateCheckboxes = allowedGatesContainer.querySelectorAll('input[type="checkbox"]');
                    gateCheckboxes.forEach(checkbox => {
                        checkbox.disabled = false;
                        checkbox.style.cursor = '';
                    });
                    allowedGatesContainer.style.backgroundColor = '';
                    allowedGatesContainer.style.border = '';
                    allowedGatesContainer.title = '';
                    
                    // Reset section header
                    const gateSection = allowedGatesContainer.closest('.form-section');
                    if (gateSection) {
                        const gateSectionHeader = gateSection.querySelector('h6');
                        if (gateSectionHeader) {
                            gateSectionHeader.innerHTML = '<i class="bi bi-door-open me-2"></i>Gate Access Control <small class="text-muted ms-2">(Admin/Super Admin Only)</small>';
                        }
                    }
                }
                
                // Enable One Time Pass toggle for admin/super-admin roles
                const oneTimePassToggle = document.getElementById('editOneTimePass');
                if (oneTimePassToggle) {
                    oneTimePassToggle.disabled = false;
                    oneTimePassToggle.parentElement.style.opacity = '';
                    oneTimePassToggle.parentElement.title = '';
                }
                
                // Remove security driver label if exists
                const securityDriverLabel = document.querySelector('.security-driver-label');
                if (securityDriverLabel) {
                    securityDriverLabel.remove();
                }
                
                // Reset modal title for privileged users
                const modalTitle = document.querySelector('#editVehicleModal .modal-title');
                if (modalTitle) {
                    modalTitle.innerHTML = '<i class="bi bi-pencil-square me-2"></i>Edit Vehicle';
                }
                
                // Hide driver change warning for admin users
                const warningElement = document.getElementById('driverChangeWarning');
                if (warningElement && warningElement.parentElement) {
                    warningElement.parentElement.style.display = 'none';
                }
                
                // Reset save button text
                const saveBtn = document.getElementById('saveVehicleEditBtn');
                if (saveBtn) {
                    saveBtn.innerHTML = '<i class="bi bi-check-lg me-2"></i>Save Changes';
                }
            }
            
            // Show edit modal
            const modal = new bootstrap.Modal(document.getElementById('editVehicleModal'));
            modal.show();
        }

        function saveVehicleEdit() {
            const index = parseInt(document.getElementById('editVehicleIndex').value);
            
            // Handle users with driver-only permissions - only update current driver
            if (hasPermission('vehicles', 'updateDriver') && !hasPermission('vehicles', 'update')) {
                const newDriverId = document.getElementById('editDriver').value || '';
                const newDriverValue = getDriverNameById(newDriverId);
                
                // Create updated vehicle data with only driver field changed
                const currentVehicle = vehicleData[index]; // Use vehicleData instead of allVehicles
                const oldDriverId = currentVehicle[8] || ''; // Get current driver ID
                const oldDriverValue = getDriverNameById(oldDriverId); // Convert ID to name
                const updatedVehicleData = [...currentVehicle]; // Copy existing data
                updatedVehicleData[8] = newDriverValue; // Update only current driver field
                
                // Check if we need to log a transaction (driver changed)
                const shouldLogTransaction = oldDriverValue !== newDriverValue && newDriverValue !== '';
                const vehicleStatus = currentVehicle[7] || 'OUT'; // Get current status
                const plateNumber = currentVehicle[1]; // Get plate number
                
                showVehicleModalLoading(true, 'edit');
                
                // Function to log the transaction
                const logDriverChangeTransaction = function() {
                    if (!shouldLogTransaction) {
                        return Promise.resolve();
                    }
                    
                    // Get current gate
                    const currentGate = getCurrentGate();
                    if (!currentGate) {
                        showToast('Please select a gate before changing driver', 'warning');
                        return Promise.reject('No gate selected');
                    }
                    
                    // Determine the action based on current status
                    const action = vehicleStatus === 'IN' ? 'OUT' : 'IN';
                    
                    const transactionData = {
                        plateNumber: plateNumber,
                        action: action,
                        gate: currentGate.id,
                        driverId: newDriverValue,
                        remarks: `Driver change: ${oldDriverValue || 'Unassigned'} → ${newDriverValue}`,
                        username: currentUser.username
                    };
                    
                    return new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .logVehicleAction(transactionData);
                    });
                };
                
                google.script.run
                    .withSuccessHandler(function(success) {
                        if (success) {
                            console.log('Driver update successful, updating local data and refreshing...');
                            
                            // Update local data immediately
                            vehicleData[index] = updatedVehicleData;
                            
                            // Log the transaction if driver changed
                            if (shouldLogTransaction) {
                                logDriverChangeTransaction()
                                    .then(function(result) {
                                        console.log('Transaction logged for driver change');
                                        // Update the vehicle status based on the action
                                        vehicleData[index][7] = vehicleStatus === 'IN' ? 'OUT' : 'IN';
                                    })
                                    .catch(function(error) {
                                        console.error('Failed to log transaction:', error);
                                        showToast('Driver updated but transaction log failed', 'warning');
                                    })
                                    .finally(function() {
                                        // Reload data regardless
                                        setTimeout(function() {
                                            loadVehicles();
                                            displayVehicles();
                                        }, 500);
                                    });
                            } else {
                                // No transaction needed, just reload
                                setTimeout(function() {
                                    loadVehicles();
                                    displayVehicles();
                                }, 500);
                            }
                            
                            // Hide modal and show success
                            bootstrap.Modal.getInstance(document.getElementById('editVehicleModal')).hide();
                            const message = shouldLogTransaction ? 
                                `Driver changed to ${newDriverValue} and ${vehicleStatus === 'IN' ? 'OUT' : 'IN'} transaction logged` : 
                                'Driver updated successfully';
                            showToast(message, 'success');
                        } else {
                            showToast('Failed to update driver', 'danger');
                        }
                        showVehicleModalLoading(false, 'edit');
                    })
                    .withFailureHandler(function(error) {
                        showToast('Error updating driver: ' + error, 'danger');
                        showVehicleModalLoading(false, 'edit');
                    })
                    .updateVehicleRecord(index, updatedVehicleData, currentUser.role, currentUser.username);
                
                return; // Exit early for Security users
            }
            
            // Handle Admin, Supervisor, and Super-Admin roles - full edit capability
            const plateNumber = document.getElementById('editPlateNumber').value.trim();
            const model = document.getElementById('editModel').value.trim();
            
            if (!plateNumber || !model) {
                showToast('Plate number and model are required', 'danger');
                return;
            }
            
            // Define currentVehicle for admin role
            const currentVehicle = vehicleData[index];
            
            // Find the actual index in allVehicles for backend
            let actualIndex = -1;
            if (allVehicles && allVehicles.length > 1) {
                for (let i = 1; i < allVehicles.length; i++) {
                    if (allVehicles[i][0] === currentVehicle[0]) {
                        actualIndex = i;
                        break;
                    }
                }
            }
            
            // If not found in allVehicles, use index as fallback
            if (actualIndex === -1) {
                actualIndex = index;
            }
            
            // Check if plate number already exists (excluding current vehicle)
            const originalPlate = currentVehicle[1]; // Get original plate number from index 1
            const vehicleId = currentVehicle[0]; // Get vehicle ID from index 0
            
            // Only check for duplicates if the plate number has changed
            if (plateNumber !== originalPlate) {
                for (let i = 1; i < vehicleData.length; i++) {
                    if (vehicleData[i][1] === plateNumber) {
                        showToast('Another vehicle with this plate number already exists', 'danger');
                        return;
                    }
                }
            }
            
            const selectedEditGates = getSelectedGateCheckboxIds().join(',');
            console.log('Selected gates for edit vehicle:', selectedEditGates);
            
            const updatedVehicleData = [
                vehicleId,           // Keep original ID at index 0
                plateNumber,         // Plate number at index 1
                model,               // Make/Model at index 2
                document.getElementById('editColor').value || '',      // Color at index 3
                document.getElementById('editDepartment').value || '', // Department at index 4
                document.getElementById('editYear').value || '',       // Year at index 5
                document.getElementById('editType').value || 'Car',    // Type at index 6
                document.getElementById('editStatus').value || 'OUT',  // Status at index 7
                getDriverNameById(document.getElementById('editDriver').value) || '', // Current Driver at index 8
                getSelectedDriverCheckboxIds().join(','), // Assigned Drivers at index 9
                document.getElementById('editAccessStatus').value || 'Access', // Access Status at index 10
                document.getElementById('editOneTimePass').checked ? 'Yes' : 'No', // One Time Pass at index 11
                document.getElementById('editMVFile').value || '',     // MV File at index 12
                selectedEditGates                                      // Allowed Gates at index 13
            ];
            
            console.log('Sending updated vehicle data:', updatedVehicleData);
            console.log('Updated data length:', updatedVehicleData.length);
            
            showVehicleModalLoading(true, 'edit');
            google.script.run
                .withSuccessHandler(function(success) {
                    if (success) {
                        // Update local data
                        vehicleData[index] = updatedVehicleData;
                        
                        // Reload vehicles to ensure consistency
                        loadVehicles();
                        
                        // Update display
                        displayVehicles();
                        updateStatistics();
                        
                        // Hide modal
                        bootstrap.Modal.getInstance(document.getElementById('editVehicleModal')).hide();
                        
                        showToast('Vehicle updated successfully!', 'success');
                    }
                    showVehicleModalLoading(false, 'edit');
                })
                .withFailureHandler(function(error) {
                    showToast('Failed to update vehicle: ' + error, 'danger');
                    showVehicleModalLoading(false, 'edit');
                })
                .saveVehicleRecord({
                    vehicleId: vehicleId, // Pass the vehicle ID for updates
                    plateNumber: updatedVehicleData[1],
                    model: updatedVehicleData[2],
                    color: updatedVehicleData[3],
                    department: updatedVehicleData[4],
                    year: updatedVehicleData[5],
                    type: updatedVehicleData[6],
                    status: updatedVehicleData[7],
                    driver: updatedVehicleData[8],
                    assignedDrivers: updatedVehicleData[9],
                    accessStatus: updatedVehicleData[10],
                    oneTimePass: updatedVehicleData[11] === 'Yes',
                    mvFile: updatedVehicleData[12] || '',
                    allowedGates: updatedVehicleData[13] || ''
                }, currentUser.role, vehicleId, currentUser.username);
        }

        function deleteVehicle(index) {
            if (!hasPermission('vehicles', 'delete')) {
                showToast('Access denied: Only Super Admin can delete vehicles', 'danger');
                return;
            }
            
            const vehicle = vehicleData[index];
            const plateNumber = vehicle[1];
            
            // Confirm deletion
            if (!confirm(`Are you sure you want to delete vehicle ${plateNumber}?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            showLoading(true);
            google.script.run
                .withSuccessHandler(function(success) {
                    if (success) {
                        // Remove from local data
                        allVehicles.splice(index, 1);
                        vehicleData = allVehicles;
                        
                        // Update display
                        displayVehicles();
                        updateStatistics();
                        
                        showToast('Vehicle deleted successfully!', 'success');
                    }
                    showLoading(false);
                })
                .withFailureHandler(function(error) {
                    showToast('Failed to delete vehicle: ' + error, 'danger');
                    showLoading(false);
                })
                .deleteVehicleRecord(index, currentUser.role);
        }

        // User Management Functions
        let allUsers = [];

        function showUserManagement() {
            // Debug logging
            console.log('Current user:', currentUser);
            console.log('Has user read permission:', hasPermission('users', 'read'));
            console.log('Has user create permission:', hasPermission('users', 'create'));
            
            if (!hasPermission('users', 'read')) {
                showToast('Access denied: Insufficient permissions for user management', 'danger');
                return;
            }

            const modal = new bootstrap.Modal(document.getElementById('userManagementModal'));
            modal.show();
            
            loadUsers();
        }

        function loadUsers() {
            console.log('Loading users...');
            console.log('Current user object:', currentUser);
            console.log('Current user role:', currentUser ? currentUser.role : 'undefined');
            
            // Check if user is logged in and has proper role
            if (!currentUser || !currentUser.role) {
                console.error('User not logged in or role missing');
                showToast('❌ User session invalid. Please log in again.', 'danger');
                return;
            }
            
            if (currentUser.role !== 'super-admin' && currentUser.role !== 'admin') {
                console.error('User does not have sufficient role:', currentUser.role);
                showToast('❌ Access denied: Admin or Super Admin role required', 'danger');
                return;
            }
            
            // Show loading animation in the modern table
            showUserLoadingState();
            
            google.script.run
                .withSuccessHandler(function(data) {
                    console.log('✅ Users data received successfully:', data);
                    console.log('Data length:', data ? data.length : 'null');
                    allUsers = data;
                    displayUsers();
                    showToast('✅ Users loaded successfully', 'success');
                })
                .withFailureHandler(function(error) {
                    console.error('❌ Error loading users:', error);
                    showToast('❌ Failed to load users: ' + error, 'danger');
                    
                    // Show detailed error state
                    container.innerHTML = `
                        <div class="text-center py-5 text-danger">
                            <i class="bi bi-exclamation-triangle-fill fs-1 mb-3"></i>
                            <div class="fw-bold mb-2">Failed to Load Users</div>
                            <div class="text-muted mb-3">${error}</div>
                            <div class="small text-info mb-3">
                                Debug Info:<br>
                                User: ${currentUser ? currentUser.username : 'undefined'}<br>
                                Role: ${currentUser ? currentUser.role : 'undefined'}
                            </div>
                            <button class="btn btn-outline-primary" onclick="loadUsers()">
                                <i class="bi bi-arrow-clockwise me-2"></i>Retry
                            </button>
                        </div>
                    `;
                })
                .getUserList(currentUser.role);
        }
        
        function showUserLoadingState() {
            const tableBody = document.getElementById('userTableBody');
            const usersTable = document.getElementById('usersDataTable');
            const noUsersState = document.getElementById('noUsersState');
            const userListContainer = document.getElementById('userListContainer');
            const totalUsersCount = document.getElementById('totalUsersCount');
            
            // Hide other states
            if (noUsersState) noUsersState.classList.add('d-none');
            if (userListContainer) userListContainer.classList.add('d-none');
            
            // Show table and loading in tbody
            if (usersTable) usersTable.style.display = 'table';
            if (totalUsersCount) totalUsersCount.textContent = '...';
            
            if (tableBody) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <div class="d-flex flex-column align-items-center">
                                <div class="mb-3" style="color: #0d6efd;">
                                    <div class="bouncing-dots size-xl">
                                        <span class="dot"></span>
                                        <span class="dot"></span>
                                        <span class="dot"></span>
                                    </div>
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <h6 class="text-muted mb-2">Loading User Directory</h6>
                                <p class="text-muted mb-1">Fetching user data from database...</p>
                                <small class="text-info">Role: ${currentUser ? currentUser.role : 'undefined'}</small>
                                <div class="mt-3">
                                    <div class="progress" style="width: 200px; height: 4px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                                             style="width: 100%"></div>
                                    </div>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        function displayUsers() {
            console.log('=== displayUsers called ===');
            console.log('allUsers:', allUsers);
            console.log('allUsers length:', allUsers ? allUsers.length : 'null');
            
            // Check if new UI elements exist, if not fall back to old UI
            const modernTable = document.getElementById('usersDataTable');
            const legacyContainer = document.getElementById('userListContainer');
            
            if (modernTable) {
                console.log('Using modern table UI');
                // Hide legacy container and show modern table
                if (legacyContainer) {
                    legacyContainer.classList.add('d-none');
                }
                modernTable.closest('.card').style.display = 'block';
                displayUsersModern();
            } else if (legacyContainer) {
                console.log('Using legacy container UI');
                // Show legacy container and hide modern table if it exists
                legacyContainer.classList.remove('d-none');
                if (modernTable) {
                    modernTable.closest('.card').style.display = 'none';
                }
                displayUsersLegacy();
            } else {
                console.error('No UI container found for users');
            }
        }
        
        function displayUsersLegacy() {
            const container = document.getElementById('userListContainer');
            
            if (!allUsers || allUsers.length < 2) {
                container.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-people fs-1 mb-3"></i>
                        <p class="mb-0">No users found</p>
                        <small>Click "Add User" to create your first user</small>
                        <div class="mt-3 text-info small">
                            Debug: allUsers length = ${allUsers ? allUsers.length : 'null'}
                        </div>
                    </div>
                `;
                return;
            }

            let usersHtml = '<div class="list-group">';
            
            for (let i = 1; i < allUsers.length; i++) {
                const user = allUsers[i];
                const username = user[1] || 'Unknown';
                const role = user[3] || 'security';
                const fullName = user[4] || 'No name provided';
                const email = user[5] || 'No email provided';
                const status = user[6] || 'active';
                const createdDate = user[7] ? new Date(user[7]).toLocaleDateString() : 'Unknown';
                
                const roleDisplay = role.charAt(0).toUpperCase() + role.slice(1);
                const isCurrentUser = username === currentUser.username;
                const userCardClass = isCurrentUser ? 'border-primary bg-light' : '';
                
                // Get role-specific icon and colors
                let roleIcon = 'bi-person';
                let roleColor = 'text-secondary';
                switch(role) {
                    case 'super-admin': 
                        roleIcon = 'bi-shield-fill-check'; 
                        roleColor = 'text-danger';
                        break;
                    case 'admin': 
                        roleIcon = 'bi-person-gear'; 
                        roleColor = 'text-warning';
                        break;
                    case 'security': 
                        roleIcon = 'bi-shield'; 
                        roleColor = 'text-primary';
                        break;
                    default: 
                        roleIcon = 'bi-person';
                        roleColor = 'text-secondary';
                }
                
                // Status badge styling
                let statusBadge = '';
                let statusIcon = '';
                switch(status) {
                    case 'active':
                        statusBadge = 'badge bg-success';
                        statusIcon = '✅';
                        break;
                    case 'inactive':
                        statusBadge = 'badge bg-warning text-dark';
                        statusIcon = '⏸️';
                        break;
                    case 'suspended':
                        statusBadge = 'badge bg-danger';
                        statusIcon = '🚫';
                        break;
                    default:
                        statusBadge = 'badge bg-secondary';
                        statusIcon = '❓';
                }
                
                usersHtml += `
                    <div class="list-group-item ${userCardClass}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="${roleIcon} me-2 ${roleColor}"></i>
                                    <span class="fw-bold fs-6">${username}</span>
                                    ${isCurrentUser ? '<span class="badge bg-info ms-2">You</span>' : ''}
                                    <span class="badge role-badge ${role} ms-2">${roleDisplay}</span>
                                    <span class="${statusBadge} ms-2">${statusIcon} ${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                                </div>
                                <div class="mb-2">
                                    <div class="text-muted small">
                                        <i class="bi bi-person-fill me-1"></i>
                                        <strong>${fullName}</strong>
                                    </div>
                                    <div class="text-muted small">
                                        <i class="bi bi-envelope me-1"></i>
                                        ${email}
                                    </div>
                                </div>
                                <div class="text-muted small">
                                    <i class="bi bi-calendar-plus me-1"></i>
                                    <span>Created: ${createdDate}</span>
                                </div>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="editUser(${i})" 
                                        title="Edit User Details"
                                        ${isCurrentUser && currentUser.role !== 'super-admin' ? 'disabled' : ''}>
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info" 
                                        onclick="viewUserDetails(${i})" 
                                        title="View User Details">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="deleteUser(${i})" 
                                        title="Delete User"
                                        ${isCurrentUser || (currentUser.role === 'admin' && role === 'super-admin') ? 'disabled' : ''}>
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            usersHtml += '</div>';
            
            // Add user count summary
            const userCount = allUsers.length - 1;
            const countSummary = `
                <div class="mt-3 text-center">
                    <div class="badge bg-primary fs-6 px-3 py-2">
                        <i class="bi bi-people me-2"></i>
                        Total Users: ${userCount}
                    </div>
                </div>
            `;
            
            container.innerHTML = usersHtml + countSummary;
        }
        
        function displayUsersModern() {
            const tableBody = document.getElementById('userTableBody');
            const noUsersState = document.getElementById('noUsersState');
            const usersTable = document.getElementById('usersDataTable');
            const totalUsersCount = document.getElementById('totalUsersCount');
            
            if (!allUsers || allUsers.length < 2) {
                usersTable.style.display = 'none';
                noUsersState.classList.remove('d-none');
                if (totalUsersCount) totalUsersCount.textContent = '0';
                return;
            }

            usersTable.style.display = 'table';
            noUsersState.classList.add('d-none');
            
            const userCount = allUsers.length - 1;
            if (totalUsersCount) totalUsersCount.textContent = userCount;
            
            let tableRows = '';
            
            for (let i = 1; i < allUsers.length; i++) {
                const user = allUsers[i];
                const username = user[1] || 'Unknown';
                const role = user[3] || 'security';
                const fullName = user[4] || 'No name provided';
                const email = user[5] || 'No email provided';
                const status = user[6] || 'active';
                const createdDate = user[7] ? new Date(user[7]).toLocaleDateString() : 'Unknown';
                
                const roleDisplay = role.charAt(0).toUpperCase() + role.slice(1);
                const isCurrentUser = username === currentUser.username;
                
                // Get role-specific styling
                let roleIcon = 'bi-person';
                let roleColor = 'text-secondary';
                switch(role) {
                    case 'super-admin': 
                        roleIcon = 'bi-shield-fill-check'; 
                        roleColor = 'text-danger';
                        break;
                    case 'admin': 
                        roleIcon = 'bi-person-gear'; 
                        roleColor = 'text-warning';
                        break;
                    case 'security': 
                        roleIcon = 'bi-shield'; 
                        roleColor = 'text-primary';
                        break;
                    default: 
                        roleIcon = 'bi-person';
                        roleColor = 'text-secondary';
                }
                
                // Status styling
                let statusBadge = '';
                let statusIcon = '';
                switch(status) {
                    case 'active':
                        statusBadge = 'badge bg-success';
                        statusIcon = '✅';
                        break;
                    case 'inactive':
                        statusBadge = 'badge bg-warning text-dark';
                        statusIcon = '⏸️';
                        break;
                    case 'suspended':
                        statusBadge = 'badge bg-danger';
                        statusIcon = '🚫';
                        break;
                    default:
                        statusBadge = 'badge bg-secondary';
                        statusIcon = '❓';
                }
                
                const rowClass = isCurrentUser ? 'table-primary' : '';
                
                tableRows += `
                    <tr class="${rowClass}" data-user-index="${i}">
                        <td class="px-4 py-3">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="rounded-circle bg-light d-flex align-items-center justify-content-center" 
                                         style="width: 40px; height: 40px;">
                                        <i class="${roleIcon} ${roleColor}"></i>
                                    </div>
                                </div>
                                <div>
                                    <div class="fw-bold text-dark">${username}</div>
                                    <div class="text-muted small">${fullName}</div>
                                    ${isCurrentUser ? '<span class="badge bg-info mt-1">Current User</span>' : ''}
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="badge role-badge ${role} px-3 py-2">
                                <i class="${roleIcon} me-1"></i>${roleDisplay}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-dark">${email}</div>
                            <small class="text-muted">
                                <i class="bi bi-envelope-fill me-1"></i>Contact
                            </small>
                        </td>
                        <td class="px-4 py-3">
                            <span class="${statusBadge} px-3 py-2">
                                ${statusIcon} ${status.charAt(0).toUpperCase() + status.slice(1)}
                            </span>
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-dark">${createdDate}</div>
                            <small class="text-muted">
                                <i class="bi bi-calendar3 me-1"></i>Registration
                            </small>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="editUser(${i})" 
                                        title="Edit User Details"
                                        ${isCurrentUser && currentUser.role !== 'super-admin' ? 'disabled' : ''}>
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info" 
                                        onclick="viewUserDetails(${i})" 
                                        title="View User Details">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="deleteUser(${i})" 
                                        title="Delete User"
                                        ${isCurrentUser || (currentUser.role === 'admin' && role === 'super-admin') ? 'disabled' : ''}>
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }
            
            tableBody.innerHTML = tableRows;
        }

        // Enhanced password toggle functionality
        function togglePasswordVisibility() {
            const passwordField = document.getElementById('userPassword');
            const toggleButton = document.getElementById('togglePassword');
            const toggleIcon = toggleButton.querySelector('i');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleIcon.className = 'bi bi-eye-slash';
                toggleButton.title = 'Hide password';
            } else {
                passwordField.type = 'password';
                toggleIcon.className = 'bi bi-eye';
                toggleButton.title = 'Show password';
            }
        }

        // Enhanced password validation
        function validatePasswords() {
            const password = document.getElementById('userPassword').value;
            const confirmPassword = document.getElementById('userPasswordConfirm').value;
            const confirmField = document.getElementById('userPasswordConfirm');
            const errorDiv = document.getElementById('passwordMismatchError');
            
            // Remove previous validation classes
            confirmField.classList.remove('is-invalid', 'is-valid');
            
            if (password !== confirmPassword) {
                confirmField.classList.add('is-invalid');
                errorDiv.style.display = 'block';
                return false;
            } else if (password && confirmPassword) {
                confirmField.classList.add('is-valid');
                errorDiv.style.display = 'none';
                return true;
            }
            
            errorDiv.style.display = 'none';
            return true;
        }

        function showAddUserForm() {
            document.getElementById('userForm').style.display = 'block';
            document.getElementById('userFormTitle').textContent = 'Add New User';
            document.getElementById('editUserIndex').value = '-1';
            
            // Reset form fields
            document.getElementById('userUsername').value = '';
            document.getElementById('userFullName').value = '';
            document.getElementById('userEmail').value = '';
            document.getElementById('userRole').value = 'security';
            document.getElementById('userPassword').value = '';
            document.getElementById('userPasswordConfirm').value = '';
            document.getElementById('userStatus').value = 'active';
            document.getElementById('userCreatedDate').value = '';
            
            // Show password required label and make password required
            document.getElementById('passwordRequiredLabel').classList.remove('d-none');
            document.getElementById('passwordOptionalLabel').classList.add('d-none');
            document.getElementById('userPassword').required = true;
            document.getElementById('userPasswordConfirm').required = true;
            
            // Clear validation classes
            document.getElementById('userPasswordConfirm').classList.remove('is-invalid', 'is-valid');
            
            // Add password validation listeners
            const passwordField = document.getElementById('userPassword');
            const confirmField = document.getElementById('userPasswordConfirm');
            
            passwordField.addEventListener('input', validatePasswords);
            confirmField.addEventListener('input', validatePasswords);
            
            document.getElementById('userUsername').focus();
        }

        function editUser(index) {
            const user = allUsers[index];
            document.getElementById('userForm').style.display = 'block';
            document.getElementById('userFormTitle').textContent = 'Edit User';
            document.getElementById('editUserIndex').value = index;
            
            // Populate form with all fields
            document.getElementById('userUsername').value = user[1] || '';
            document.getElementById('userRole').value = user[3] || 'security';
            document.getElementById('userFullName').value = user[4] || '';
            document.getElementById('userEmail').value = user[5] || '';
            document.getElementById('userStatus').value = user[6] || 'active';
            
            // Format and display created date
            const createdDate = user[7] ? new Date(user[7]).toLocaleDateString() : 'Not set';
            document.getElementById('userCreatedDate').value = createdDate;
            
            // Clear password fields for editing
            document.getElementById('userPassword').value = '';
            document.getElementById('userPasswordConfirm').value = '';
            
            // Show password optional label and make password not required for edits
            document.getElementById('passwordRequiredLabel').classList.add('d-none');
            document.getElementById('passwordOptionalLabel').classList.remove('d-none');
            document.getElementById('userPassword').required = false;
            document.getElementById('userPasswordConfirm').required = false;
            
            // Clear validation classes
            document.getElementById('userPasswordConfirm').classList.remove('is-invalid', 'is-valid');
            
            // Add password validation listeners
            const passwordField = document.getElementById('userPassword');
            const confirmField = document.getElementById('userPasswordConfirm');
            
            passwordField.addEventListener('input', validatePasswords);
            confirmField.addEventListener('input', validatePasswords);
            
            document.getElementById('userUsername').focus();
        }

        function cancelUserForm() {
            document.getElementById('userForm').style.display = 'none';
            document.getElementById('addEditUserForm').reset();
            
            // Clear validation classes and error displays
            document.getElementById('userPasswordConfirm').classList.remove('is-invalid', 'is-valid');
            document.getElementById('passwordMismatchError').style.display = 'none';
            
            // Reset password field type
            const passwordField = document.getElementById('userPassword');
            const toggleButton = document.getElementById('togglePassword');
            const toggleIcon = toggleButton.querySelector('i');
            
            passwordField.type = 'password';
            toggleIcon.className = 'bi bi-eye';
            toggleButton.title = 'Show password';
        }

        function saveUser() {
            const index = parseInt(document.getElementById('editUserIndex').value);
            const username = document.getElementById('userUsername').value.trim();
            const fullName = document.getElementById('userFullName').value.trim();
            const email = document.getElementById('userEmail').value.trim();
            const role = document.getElementById('userRole').value;
            const password = document.getElementById('userPassword').value;
            const confirmPassword = document.getElementById('userPasswordConfirm').value;
            const status = document.getElementById('userStatus').value;
            
            // Basic validation
            if (!username || !role || !fullName || !email) {
                showToast('Username, Full Name, Email, and Role are required', 'danger');
                return;
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('Please enter a valid email address', 'danger');
                document.getElementById('userEmail').focus();
                return;
            }
            
            // Password validation for new users
            const isNewUser = index === -1;
            if (isNewUser && !password) {
                showToast('Password is required for new users', 'danger');
                document.getElementById('userPassword').focus();
                return;
            }
            
            // Password confirmation validation
            if (password && !confirmPassword) {
                showToast('Please confirm your password', 'danger');
                document.getElementById('userPasswordConfirm').focus();
                return;
            }
            
            // Password match validation
            if (password && password !== confirmPassword) {
                showToast('Passwords do not match', 'danger');
                document.getElementById('userPasswordConfirm').focus();
                return;
            }
            
            // Password length validation
            if (password && password.length < 6) {
                showToast('Password must be at least 6 characters long', 'danger');
                document.getElementById('userPassword').focus();
                return;
            }

            // Check if username already exists (excluding current user)
            if (allUsers) {
                for (let i = 1; i < allUsers.length; i++) {
                if (i !== index && allUsers[i][1] === username) {
                    showToast('Username already exists', 'danger');
                    document.getElementById('userUsername').focus();
                    return;
                }
                }
            }

            // Build user data object
            const userData = {
                username: username,
                fullName: fullName,
                email: email,
                role: role,
                status: status
            };
            
            // Only include password if it's provided
            if (password) {
                userData.password = password;
            }

            // Show loading feedback
            const saveButton = event.target;
            const originalText = saveButton.innerHTML;
            saveButton.disabled = true;
            saveButton.innerHTML = '<span class="me-1" style="color: white;"><span class="bouncing-dots size-sm"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></span>Saving...';

            google.script.run
                .withSuccessHandler(function(result) {
                    saveButton.disabled = false;
                    saveButton.innerHTML = originalText;
                    
                    if (result.success) {
                        loadUsers();
                        cancelUserForm();
                        
                        // Enhanced success message
                        const action = isNewUser ? 'created' : 'updated';
                        let message = `User ${username} ${action} successfully!`;
                        if (password && !isNewUser) {
                            message += ' Password has been updated.';
                        }
                        showToast(message, 'success');
                    } else {
                        showToast(result.message || 'Failed to save user', 'danger');
                    }
                })
                .withFailureHandler(function(error) {
                    saveButton.disabled = false;
                    saveButton.innerHTML = originalText;
                    showToast('Failed to save user: ' + error, 'danger');
                })
                .saveUser(userData, currentUser.role, index);
        }

        function deleteUser(index) {
            if (!hasPermission('users', 'delete')) {
                showToast('Access denied: Only Super Admin can delete users', 'danger');
                return;
            }

            const user = allUsers[index];
            const username = user[1];
            const role = user[3] || 'user';

            // Prevent deleting yourself
            if (username === currentUser.username) {
                showToast('Cannot delete your own account', 'danger');
                return;
            }

            // This check is now handled by the backend permission system
            // Only super-admin role has 'delete' permission for users

            // Enhanced confirmation dialog with role information
            const confirmMessage = `⚠️ DELETE USER CONFIRMATION ⚠️\n\nUsername: ${username}\nRole: ${role.charAt(0).toUpperCase() + role.slice(1)}\n\nThis action cannot be undone.\nAre you sure you want to permanently delete this user?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }

            // Show loading feedback
            const deleteButton = event.target.closest('button');
            const originalContent = deleteButton.innerHTML;
            deleteButton.disabled = true;
            deleteButton.innerHTML = '<span class="me-1" style="color: white;"><span class="bouncing-dots size-sm"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></span>';

            google.script.run
                .withSuccessHandler(function(result) {
                    deleteButton.disabled = false;
                    deleteButton.innerHTML = originalContent;
                    
                    if (result.success) {
                        loadUsers();
                        showToast(`User "${username}" deleted successfully!`, 'success');
                    } else {
                        showToast(result.message || 'Failed to delete user', 'danger');
                    }
                })
                .withFailureHandler(function(error) {
                    deleteButton.disabled = false;
                    deleteButton.innerHTML = originalContent;
                    showToast('Failed to delete user: ' + error, 'danger');
                })
                .deleteUser(index, currentUser.role);
        }

        // Password Change Functions
        function showChangePassword() {
            if (!currentUser) {
                showToast('Please log in to change password', 'danger');
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('passwordChangeModal'));
            modal.show();
            
            // Reset form and clear any previous validation states
            const form = document.getElementById('passwordChangeForm');
            form.reset();
            form.classList.remove('was-validated');
            
            // Clear any existing validation feedback
            const inputs = form.querySelectorAll('.form-control');
            inputs.forEach(input => {
                input.classList.remove('is-invalid', 'is-valid');
            });
        }

        function submitPasswordChange() {
            const currentPassword = document.getElementById('currentPassword').value.trim();
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();
            
            // Clear previous validation states
            const form = document.getElementById('passwordChangeForm');
            const inputs = form.querySelectorAll('.form-control');
            inputs.forEach(input => {
                input.classList.remove('is-invalid', 'is-valid');
            });
            
            let hasErrors = false;
            
            // Validation
            if (!currentPassword) {
                setFieldError('currentPassword', 'Current password is required');
                hasErrors = true;
            }
            
            if (!newPassword) {
                setFieldError('newPassword', 'New password is required');
                hasErrors = true;
            } else if (newPassword.length < 6) {
                setFieldError('newPassword', 'Password must be at least 6 characters long');
                hasErrors = true;
            }
            
            if (!confirmPassword) {
                setFieldError('confirmPassword', 'Password confirmation is required');
                hasErrors = true;
            } else if (newPassword !== confirmPassword) {
                setFieldError('confirmPassword', 'New passwords do not match');
                hasErrors = true;
            }
            
            if (newPassword === currentPassword) {
                setFieldError('newPassword', 'New password must be different from current password');
                hasErrors = true;
            }
            
            if (hasErrors) {
                return;
            }
            
            // Show loading state
            const submitButton = document.getElementById('changePasswordBtn');
            const originalText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="me-1" style="color: white;"><span class="bouncing-dots size-sm"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></span>Changing Password...';
            
            // Google Apps Script call
            google.script.run
                .withSuccessHandler(function(result) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                    
                    if (result.success) {
                        // Hide modal and reset form
                        bootstrap.Modal.getInstance(document.getElementById('passwordChangeModal')).hide();
                        document.getElementById('passwordChangeForm').reset();
                        showToast('Password changed successfully!', 'success');
                    } else {
                        showToast('Error: ' + (result.error || 'Failed to change password'), 'danger');
                    }
                })
                .withFailureHandler(function(error) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                    showToast('Error changing password: ' + error, 'danger');
                })
                .changeUserPassword(currentUser.username, currentPassword, newPassword, confirmPassword);
        }

        function setFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const feedback = field.nextElementSibling;
            
            field.classList.add('is-invalid');
            if (feedback && feedback.classList.contains('invalid-feedback')) {
                feedback.textContent = message;
            }
        }

        function showRoleSettings() {
            const modal = new bootstrap.Modal(document.getElementById('roleSettingsModal'));
            modal.show();
        }

        // Gate Management Functions - Simplified
        let allGates = [];
        let activeGates = [];

        function loadActiveGates() {
            google.script.run
                .withSuccessHandler(function(gates) {
                    activeGates = gates;
                    updateGateSelector();
                })
                .withFailureHandler(function(error) {
                    console.error('Failed to load active gates:', error);
                    // Fallback to default gates
                    activeGates = [
                        { id: 'Main Gate', name: 'Main Gate' },
                        { id: 'Back Gate', name: 'Back Gate' }
                    ];
                    updateGateSelector();
                })
                .getActiveGates();
        }

        function updateGateSelector() {
            const gateSelector = document.getElementById('gateSelector');
            if (!gateSelector) return;

            // Clear existing options
            gateSelector.innerHTML = '';

            // Show loading state if no gates
            if (!activeGates || activeGates.length === 0) {
                const loadingOption = document.createElement('option');
                loadingOption.value = '';
                loadingOption.textContent = '⚠️ No gates available';
                loadingOption.disabled = true;
                gateSelector.appendChild(loadingOption);
                return;
            }

            // Add active gates with enhanced icon mapping
            activeGates.forEach(gate => {
                const option = document.createElement('option');
                option.value = gate.id;
                
                // Enhanced icon mapping based on gate name
                let icon = '🏛️'; // Default gate icon
                const gateName = gate.name.toLowerCase();
                
                if (gateName.includes('main') || gateName.includes('front')) icon = '🏛️';
                else if (gateName.includes('back') || gateName.includes('rear') || gateName.includes('side')) icon = '🚪';
                else if (gateName.includes('parking') || gateName.includes('park')) icon = '🅿️';
                else if (gateName.includes('service') || gateName.includes('maintenance')) icon = '🔧';
                else if (gateName.includes('emergency') || gateName.includes('exit')) icon = '🚨';
                else if (gateName.includes('security') || gateName.includes('guard')) icon = '🛡️';
                else if (gateName.includes('visitor') || gateName.includes('guest')) icon = '👥';
                else if (gateName.includes('delivery') || gateName.includes('cargo')) icon = '📦';
                else if (gateName.includes('pedestrian') || gateName.includes('walk')) icon = '🚶';
                
                option.textContent = `${icon} ${gate.name}`;
                gateSelector.appendChild(option);
            });

            // Restore previously selected gate or select first gate
            // Use setTimeout to ensure DOM is fully updated
            setTimeout(() => {
                const savedGate = sessionStorage.getItem('selectedGate');
                let gateSelected = false;
                
                console.log('Restoring gate selection:', savedGate);
                console.log('Available gates:', activeGates.map(g => ({id: g.id, name: g.name})));
                
                if (savedGate) {
                    // Check if saved gate still exists - compare as strings
                    const gateExists = activeGates.find(gate => gate.id.toString() === savedGate.toString());
                    if (gateExists) {
                        gateSelector.value = savedGate;
                        gateSelected = true;
                        console.log('Restored gate selection:', savedGate);
                    } else {
                        console.log('Saved gate no longer exists:', savedGate);
                    }
                }
                
                // If no saved gate or saved gate doesn't exist, select first gate
                if (!gateSelected && activeGates.length > 0) {
                    gateSelector.value = activeGates[0].id;
                    sessionStorage.setItem('selectedGate', activeGates[0].id);
                    console.log('Selected first available gate:', activeGates[0].id);
                }
            }, 100);
            
            // Add change event listener for persistence (only once)
            if (!gateSelector.hasAttribute('data-listener-added')) {
                gateSelector.addEventListener('change', function() {
                    if (this.value) {
                        sessionStorage.setItem('selectedGate', this.value);
                        const gateName = this.options[this.selectedIndex].text.replace(/^[^\s]+\s/, ''); // Remove emoji
                        console.log('Gate changed to:', this.value, '(' + gateName + ')');
                        showToast(`Active Gate: ${gateName}`, 'info');
                    }
                });
                gateSelector.setAttribute('data-listener-added', 'true');
            }
        }

        function refreshGateSelector() {
            // Show loading state
            const gateSelector = document.getElementById('gateSelector');
            if (gateSelector) {
                gateSelector.innerHTML = '<option value="">🔄 Refreshing gates...</option>';
            }
            
            // Reload gates and update selector
            loadActiveGates();
            
            // Show feedback
            showToast('Refreshing gates...', 'info');
        }

        function getCurrentGate() {
            const gateSelector = document.getElementById('gateSelector');
            if (gateSelector && gateSelector.value) {
                return {
                    id: gateSelector.value,
                    name: gateSelector.options[gateSelector.selectedIndex].text.replace(/^[^\s]+\s/, '') // Remove emoji
                };
            }
            return null;
        }

        function validateGateSelection() {
            const gate = getCurrentGate();
            if (!gate) {
                showToast('Please select a gate before performing vehicle operations', 'warning');
                return false;
            }
            return true;
        }

        function showGateManagement() {
            if (!hasPermission('gates', 'create') && !hasPermission('gates', 'read')) {
                showToast('Access denied: Insufficient permissions for gate management', 'danger');
                return;
            }

            const modal = new bootstrap.Modal(document.getElementById('gateManagementModal'));
            modal.show();
            
            loadGates();
        }

        function loadGates() {
            google.script.run
                .withSuccessHandler(function(data) {
                    allGates = data;
                    displayGates();
                })
                .withFailureHandler(function(error) {
                    showToast('Failed to load gates: ' + error, 'danger');
                })
                .getGateList();
        }

        function displayGates() {
            const container = document.getElementById('gateListContainer');
            
            if (allGates.length <= 1) {
                container.innerHTML = '<div class="text-center py-3 text-muted">No gates found</div>';
                return;
            }

            let gatesHtml = '<div class="list-group">';
            
            for (let i = 1; i < allGates.length; i++) {
                const gate = allGates[i];
                const gateId = gate[0];
                const gateName = gate[1] || gate[0]; // Fallback to ID if name is missing
                
                gatesHtml += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <span class="fw-bold">${gateName}</span>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-primary" onclick="editGate(${i})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteGate(${i})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }
            
            gatesHtml += '</div>';
            container.innerHTML = gatesHtml;
        }

        function showAddGateForm() {
            document.getElementById('gateForm').style.display = 'block';
            document.getElementById('gateFormTitle').textContent = 'Add New Gate';
            document.getElementById('editGateIndex').value = '-1';
            document.getElementById('gateName').value = '';
            document.getElementById('gateName').focus();
        }

        function editGate(index) {
            const gate = allGates[index];
            const gateName = gate[1] || gate[0]; // Use gate name, fallback to ID if name missing
            
            document.getElementById('gateForm').style.display = 'block';
            document.getElementById('gateFormTitle').textContent = 'Edit Gate';
            document.getElementById('editGateIndex').value = index;
            document.getElementById('gateName').value = gateName;
            document.getElementById('gateName').focus();
        }

        function cancelGateForm() {
            document.getElementById('gateForm').style.display = 'none';
            document.getElementById('addEditGateForm').reset();
        }

        function saveGate() {
            const gateName = document.getElementById('gateName').value.trim();
            const editIndex = parseInt(document.getElementById('editGateIndex').value);

            if (!gateName) {
                showToast('Gate name is required', 'danger');
                return;
            }

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        loadGates();
                        loadActiveGates(); // Refresh gate selector
                        loadGatesForQRScanner(); // Refresh QR scanner gate selector
                        cancelGateForm();
                        showToast(`Gate ${result.action} successfully!`, 'success');
                    }
                })
                .withFailureHandler(function(error) {
                    showToast('Failed to save gate: ' + error, 'danger');
                })
                .saveGateSimple(gateName, currentUser.role, editIndex);
        }

        function deleteGate(index) {
            const gate = allGates[index];
            const gateName = gate[1] || gate[0]; // Use gate name, fallback to ID
            
            if (!confirm(`Are you sure you want to delete "${gateName}"?`)) {
                return;
            }

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        loadGates();
                        loadActiveGates(); // Refresh gate selector
                        loadGatesForQRScanner(); // Refresh QR scanner gate selector
                        showToast('Gate deleted successfully!', 'success');
                    }
                })
                .withFailureHandler(function(error) {
                    showToast('Failed to delete gate: ' + error, 'danger');
                })
                .deleteGate(index, currentUser.role);
        }


        function showVehicleManagement() {
            if (!hasPermission('vehicles', 'create')) {
                showToast('Access denied: Insufficient permissions to create vehicles', 'danger');
                return;
            }

            document.getElementById('addVehicleForm').reset();
            
            // Load gates for gate restriction selection
            loadGatesForModal('vehicleAllowedGatesContainer', 'add-gate-checkbox');
            
            const modal = new bootstrap.Modal(document.getElementById('vehicleManagementModal'));
            modal.show();
            
            // Focus on first input field
            setTimeout(() => {
                document.getElementById('vehiclePlateNumber').focus();
            }, 300);
        }

        // Driver Management Functions
        function showDriverManagement() {
            const role = currentUser.role;
            if (role !== 'admin' && role !== 'super-admin') {
                showToast('Access denied: Only Admin and Super Admin can manage drivers', 'danger');
                return;
            }

            loadDriversForManagement();
            const modal = new bootstrap.Modal(document.getElementById('driverManagementModal'));
            modal.show();
        }

        function loadDriversForManagement() {
            const tableBody = document.getElementById('driverTableBody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <div style="color: #0d6efd;">
                            <div class="bouncing-dots size-lg">
                                <span class="dot"></span>
                                <span class="dot"></span>
                                <span class="dot"></span>
                            </div>
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Loading drivers...</p>
                    </td>
                </tr>
            `;

            google.script.run
                .withSuccessHandler(function(drivers) {
                    displayDriverList(drivers);
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading drivers:', error);
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-4 text-danger">
                                Failed to load drivers. Please try again.
                            </td>
                        </tr>
                    `;
                })
                .getDriverListForManagement();
        }

        function displayDriverList(drivers) {
            const tableBody = document.getElementById('driverTableBody');
            
            if (drivers.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4 text-muted">
                            No drivers found. Click "Add New Driver" to get started.
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = drivers.map(driver => {
                // Escape single quotes in driver data
                const escapedName = (driver.name || '').replace(/'/g, "\\'");
                const escapedLicense = (driver.licenseNumber || '').replace(/'/g, "\\'");
                const escapedPhone = (driver.phone || '').replace(/'/g, "\\'");
                
                return `
                    <tr>
                        <td>${driver.id}</td>
                        <td>${driver.name}</td>
                        <td>${driver.licenseNumber}</td>
                        <td>${driver.phone || '-'}</td>
                        <td>
                            <span class="badge ${driver.status === 'Active' ? 'bg-success' : 'bg-secondary'}">
                                ${driver.status}
                            </span>
                        </td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="editDriver(${driver.id}, '${escapedName}', '${escapedLicense}', '${escapedPhone}', '${driver.status}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteDriver(${driver.id}, '${escapedName}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showAddDriverForm() {
            document.getElementById('driverFormTitle').textContent = 'Add New Driver';
            document.getElementById('addEditDriverForm').reset();
            document.getElementById('editDriverId').value = '';
            document.getElementById('driverForm').style.display = 'block';
        }

        function editDriver(id, name, licenseNumber, phone, status) {
            document.getElementById('driverFormTitle').textContent = 'Edit Driver';
            document.getElementById('editDriverId').value = id;
            document.getElementById('driverName').value = name;
            document.getElementById('driverLicenseNumber').value = licenseNumber;
            document.getElementById('driverPhone').value = phone;
            document.getElementById('driverStatus').value = status;
            document.getElementById('driverForm').style.display = 'block';
        }

        function cancelDriverForm() {
            document.getElementById('driverForm').style.display = 'none';
            document.getElementById('addEditDriverForm').reset();
        }

        function saveDriver() {
            const form = document.getElementById('addEditDriverForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Get the save button and disable it
            const saveButton = document.querySelector('#driverForm button[onclick="saveDriver()"]');
            const originalButtonHTML = saveButton.innerHTML;
            saveButton.disabled = true;
            saveButton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Saving...';

            const driverId = document.getElementById('editDriverId').value;
            const driverData = {
                name: document.getElementById('driverName').value.trim(),
                licenseNumber: document.getElementById('driverLicenseNumber').value.trim(),
                phone: document.getElementById('driverPhone').value.trim(),
                status: document.getElementById('driverStatus').value
            };

            // Re-enable button after operation
            const enableButton = function() {
                saveButton.disabled = false;
                saveButton.innerHTML = originalButtonHTML;
            };

            if (driverId) {
                // Update existing driver
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            showToast(result.message, 'success');
                            cancelDriverForm();
                            loadDriversForManagement();
                            loadDrivers(); // Refresh driver dropdowns
                        } else {
                            showToast(result.error || 'Failed to update driver', 'danger');
                            enableButton(); // Re-enable on error
                        }
                    })
                    .withFailureHandler(function(error) {
                        showToast('Error updating driver: ' + error, 'danger');
                        enableButton(); // Re-enable on error
                    })
                    .updateDriverRecord(parseInt(driverId), driverData);
            } else {
                // Add new driver
                google.script.run
                    .withSuccessHandler(function(result) {
                        if (result.success) {
                            showToast(result.message, 'success');
                            cancelDriverForm();
                            loadDriversForManagement();
                            loadDrivers(); // Refresh driver dropdowns
                        } else {
                            showToast(result.error || 'Failed to add driver', 'danger');
                            enableButton(); // Re-enable on error
                        }
                    })
                    .withFailureHandler(function(error) {
                        showToast('Error adding driver: ' + error, 'danger');
                        enableButton(); // Re-enable on error
                    })
                    .saveDriverRecord(driverData);
            }
        }

        function deleteDriver(id, name) {
            if (!confirm(`Are you sure you want to delete driver "${name}"?`)) {
                return;
            }

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        showToast(result.message, 'success');
                        loadDriversForManagement();
                        loadDrivers(); // Refresh driver dropdowns
                    } else {
                        showToast(result.error || 'Failed to delete driver', 'danger');
                    }
                })
                .withFailureHandler(function(error) {
                    showToast('Error deleting driver: ' + error, 'danger');
                })
                .deleteDriverRecord(id);
        }

        // Table optimization functions for large datasets
        function optimizeTablePerformance() {
            const table = document.getElementById('vehiclesTable');
            if (!table) return;
            
            // Add virtual scrolling optimization for very large datasets
            if (vehicleData.length > DISPLAY_BATCH_SIZE) {
                console.log(`Large dataset detected: ${vehicleData.length} vehicles. Consider implementing virtual scrolling.`);
            }
        }
        
        function optimizeForMobile() {
            // Detect if mobile device
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile || window.innerWidth <= 768) {
                // Reduce animation durations for better performance
                document.documentElement.style.setProperty('--animation-duration', '0.1s');
                
                // Add touch-friendly classes
                document.body.classList.add('touch-device');
                
                // Optimize vehicle card interactions
                const vehicleCards = document.querySelectorAll('.vehicle-card');
                vehicleCards.forEach(card => {
                    card.addEventListener('touchstart', function() {
                        this.classList.add('touch-active');
                    }, { passive: true });
                    
                    card.addEventListener('touchend', function() {
                        setTimeout(() => this.classList.remove('touch-active'), 100);
                    }, { passive: true });
                });
                
                // Improve modal backdrop for mobile
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    modal.addEventListener('shown.bs.modal', function() {
                        // Prevent body scroll when modal is open
                        document.body.style.overflow = 'hidden';
                        document.body.style.position = 'fixed';
                        document.body.style.width = '100%';
                    });
                    
                    modal.addEventListener('hidden.bs.modal', function() {
                        // Restore body scroll
                        document.body.style.overflow = '';
                        document.body.style.position = '';
                        document.body.style.width = '';
                    });
                });
            }
            
            // Add viewport height fix for mobile browsers
            function setViewportHeight() {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }
            
            setViewportHeight();
            window.addEventListener('resize', setViewportHeight);
            window.addEventListener('orientationchange', setViewportHeight);
        }

        function saveVehicle() {
            const plateNumber = document.getElementById('vehiclePlateNumber').value.trim();
            const model = document.getElementById('vehicleModel').value.trim();

            if (!plateNumber || !model) {
                showToast('Plate number and make/model are required', 'danger');
                return;
            }

            const selectedGates = getSelectedAddGateCheckboxIds().join(',');
            console.log('Selected gates for new vehicle:', selectedGates);
            
            const vehicleData = {
                plateNumber: plateNumber,
                model: model,
                color: document.getElementById('vehicleColor').value.trim(),
                department: document.getElementById('vehicleDepartment').value.trim(),
                year: document.getElementById('vehicleYear').value,
                type: document.getElementById('vehicleType').value,
                status: document.getElementById('vehicleStatus').value,
                driver: document.getElementById('vehicleDriver').value.trim(),
                assignedDrivers: getSelectedAddDriverCheckboxIds().join(','),
                accessStatus: document.getElementById('vehicleAccessStatus').value,
                oneTimePass: document.getElementById('vehicleOneTimePass').checked,
                mvFile: document.getElementById('vehicleMVFile').value.trim(),
                allowedGates: selectedGates
            };
            
            console.log('Sending vehicle data:', vehicleData);

            // Show loading state
            showVehicleModalLoading(true, 'add');

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        loadVehicles(); // Refresh main dashboard
                        document.getElementById('addVehicleForm').reset();
                        bootstrap.Modal.getInstance(document.getElementById('vehicleManagementModal')).hide();
                        showToast('Vehicle added successfully!', 'success');
                    }
                    showVehicleModalLoading(false, 'add');
                })
                .withFailureHandler(function(error) {
                    showToast('Failed to save vehicle: ' + error, 'danger');
                    showVehicleModalLoading(false, 'add');
                })
                .saveVehicleRecord(vehicleData, currentUser.role, -1);
        }

        // QR Scanner Functions
        let qrScannerStream = null;
        let qrScannerAnimationFrame = null;
        let qrScannerActive = false;
        let qrScanCount = 0; // Track successful scans in session
        let scanSessionStartTime = null; // Track session duration

        function showQRScanner() {
            const modal = new bootstrap.Modal(document.getElementById('qrScannerModal'), {
                backdrop: 'static',
                keyboard: false
            });
            
            // Reset modal state
            resetQRScannerModal();
            
            modal.show();
            
            // Load gates and set default gate once when modal is shown
            loadGatesForQRScanner();
            
            // Initialize scanner after modal is fully shown
            document.getElementById('qrScannerModal').addEventListener('shown.bs.modal', function() {
                initQRScanner();
            }, { once: true });
            
            // Clean up when modal is hidden
            document.getElementById('qrScannerModal').addEventListener('hidden.bs.modal', function() {
                stopQRScanner();
                resetQRScannerModal();
            }, { once: true });
        }

        function resetQRScannerModal() {
            // Reset UI elements
            document.getElementById('noScanResult').classList.remove('d-none');
            document.getElementById('scanResultData').classList.add('d-none');
            document.getElementById('transactionForm').classList.add('d-none');
            document.getElementById('cameraError').classList.add('d-none');
            
            // Reset form
            document.getElementById('qrTransactionForm').reset();
            
            // Reset status
            document.getElementById('qrScannerStatus').textContent = 'Position QR code within the frame';
            document.getElementById('qrScannerStatus').style.background = 'rgba(0, 0, 0, 0.7)';
            
            // Reset alert style
            const nextActionInfo = document.getElementById('nextActionInfo');
            nextActionInfo.className = 'alert alert-info';
            
            // Reset scan counter and start time when modal is reopened
            qrScanCount = 0;
            scanSessionStartTime = new Date();
        }

        function loadGatesForQRScanner() {
            google.script.run
                .withSuccessHandler(function(gates) {
                    const select = document.getElementById('qrGateSelect');
                    select.innerHTML = '';
                    
                    if (gates && gates.length > 1) { // Skip header row
                        for (let i = 1; i < gates.length; i++) {
                            const gate = gates[i];
                            const gateId = gate[0];
                            const gateName = gate[1] || gate[0]; // Fallback to ID if name missing
                            
                            if (gateId) {
                                const option = document.createElement('option');
                                option.value = gateId; // Still use ID as value for backend
                                option.textContent = gateName; // Show name to user
                                select.appendChild(option);
                            }
                        }
                        
                        // Auto-select first gate as default for continuous scanning
                        if (select.options.length > 0) {
                            select.selectedIndex = 0;
                            const defaultGate = select.options[0].textContent;
                            console.log('Default gate set:', defaultGate);
                            
                            // Show notification about the selected gate
                            const status = document.getElementById('qrScannerStatus');
                            status.textContent = `Ready to scan - Using ${defaultGate}`;
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('Error loading gates:', error);
                    // Fallback to manual selection
                    const select = document.getElementById('qrGateSelect');
                    select.innerHTML = '<option value="">Select Gate</option>';
                })
                .getGateList();
        }

        async function initQRScanner() {
            const video = document.getElementById('qrScannerVideo');
            const canvas = document.getElementById('qrScannerCanvas');
            const status = document.getElementById('qrScannerStatus');
            const cameraError = document.getElementById('cameraError');
            const scannerContainer = document.getElementById('qrScannerContainer');
            const cameraSelect = document.getElementById('cameraSelect');

            try {
                // Hide error and show scanner
                cameraError.classList.add('d-none');
                video.style.display = 'block';
                
                // Stop any existing stream
                if (qrScannerStream) {
                    stopQRScanner();
                }

                // Get selected camera mode
                const selectedCamera = cameraSelect ? cameraSelect.value : 'environment';

                // Request camera access
                qrScannerStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: selectedCamera, // Use selected camera
                        width: { ideal: 400 },
                        height: { ideal: 400 }
                    }
                });

                video.srcObject = qrScannerStream;
                await video.play();

                // Set canvas size to match video
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                qrScannerActive = true;
                status.textContent = 'Camera ready - Position QR code within frame';
                
                // Start scanning
                scanQRCode();
                
            } catch (error) {
                console.error('Camera access error:', error);
                video.style.display = 'none';
                cameraError.classList.remove('d-none');
                status.textContent = 'Camera access denied';
            }
        }

        // Function to switch camera when dropdown changes
        async function switchCamera() {
            const cameraSelect = document.getElementById('cameraSelect');
            const status = document.getElementById('qrScannerStatus');
            
            if (qrScannerActive && cameraSelect) {
                status.textContent = 'Switching camera...';
                // Restart scanner with new camera
                await initQRScanner();
            }
        }

        function scanQRCode() {
            if (!qrScannerActive) return;

            const video = document.getElementById('qrScannerVideo');
            const canvas = document.getElementById('qrScannerCanvas');
            const context = canvas.getContext('2d');
            const status = document.getElementById('qrScannerStatus');

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                    status.textContent = 'QR Code detected! Processing...';
                    processQRCodeData(code.data);
                    return; // Stop scanning once we find a code
                } else {
                    status.textContent = 'Scanning for QR code...';
                }
            }

            qrScannerAnimationFrame = requestAnimationFrame(scanQRCode);
        }

        function processQRCodeData(qrData) {
            console.log('QR Code scanned:', qrData);
            
            const scannedData = qrData.trim();
            
            // Detect if scanned data is a vehicle ID (numeric) or plate number
            const isVehicleId = /^\d+$/.test(scannedData);
            
            // First, try to find vehicle in already loaded data for faster processing
            const vehicleInfo = isVehicleId ? 
                findVehicleByIdInLoadedData(scannedData) : 
                findVehicleInLoadedData(scannedData.toUpperCase());
            
            if (vehicleInfo) {
                displayVehicleInfo(vehicleInfo);
                // Auto-process transaction for continuous scanning
                autoProcessTransaction(vehicleInfo);
            } else {
                // Fallback to server lookup if not found in loaded data
                if (isVehicleId) {
                    // Lookup by vehicle ID
                    google.script.run
                        .withSuccessHandler(function(serverVehicleInfo) {
                            if (serverVehicleInfo.found) {
                                displayVehicleInfo(serverVehicleInfo);
                                autoProcessTransaction(serverVehicleInfo);
                            } else {
                                showQRScanError('Vehicle not found: ' + scannedData);
                            }
                        })
                        .withFailureHandler(function(error) {
                            showQRScanError('Error verifying vehicle: ' + error);
                        })
                        .getVehicleById(scannedData);
                } else {
                    // Lookup by plate number
                    google.script.run
                        .withSuccessHandler(function(serverVehicleInfo) {
                            if (serverVehicleInfo.found) {
                                displayVehicleInfo(serverVehicleInfo);
                                autoProcessTransaction(serverVehicleInfo);
                            } else {
                                showQRScanError('Vehicle not found: ' + scannedData);
                            }
                        })
                        .withFailureHandler(function(error) {
                            showQRScanError('Error verifying vehicle: ' + error);
                        })
                        .getVehicleByPlate(scannedData.toUpperCase());
                }
            }
        }

        function findVehicleInLoadedData(plateNumber) {
            // Search in the already loaded vehicle data for faster processing
            if (!vehicleData || vehicleData.length <= 1) return null;
            
            for (let i = 1; i < vehicleData.length; i++) {
                const vehicle = vehicleData[i];
                if (vehicle && vehicle[1] && vehicle[1].trim().toUpperCase() === plateNumber) {
                    // Return vehicle info in the same format as server response
                    return {
                        found: true,
                        vehicleId: vehicle[0] || '',
                        plateNumber: vehicle[1] || '',
                        makeModel: vehicle[2] || '',
                        color: vehicle[3] || '',
                        department: vehicle[4] || '',
                        year: vehicle[5] || '',
                        type: vehicle[6] || '',
                        currentStatus: vehicle[7] || 'OUT',
                        currentDriver: vehicle[8] || '',
                        assignedDrivers: vehicle[9] || '',
                        accessStatus: vehicle[10] || 'Access'
                    };
                }
            }
            
            return null;
        }

        function findVehicleByIdInLoadedData(vehicleId) {
            // Search in the already loaded vehicle data by vehicle ID for faster processing
            if (!vehicleData || vehicleData.length <= 1) return null;
            
            const searchId = vehicleId.toString().trim();
            const paddedSearchId = searchId.padStart(6, '0');
            
            for (let i = 1; i < vehicleData.length; i++) {
                const vehicle = vehicleData[i];
                if (vehicle && vehicle[0]) {
                    const vehicleIdInData = vehicle[0].toString().trim();
                    // Match both padded and unpadded IDs
                    if (vehicleIdInData === searchId || vehicleIdInData === paddedSearchId) {
                        // Return vehicle info in the same format as server response
                        return {
                            found: true,
                            vehicleId: vehicle[0] || '',
                            plateNumber: vehicle[1] || '',
                            makeModel: vehicle[2] || '',
                            color: vehicle[3] || '',
                            department: vehicle[4] || '',
                            year: vehicle[5] || '',
                            type: vehicle[6] || '',
                            currentStatus: vehicle[7] || 'OUT',
                            currentDriver: vehicle[8] || '',
                            assignedDrivers: vehicle[9] || '',
                            accessStatus: vehicle[10] || 'Access'
                        };
                    }
                }
            }
            
            return null;
        }

        function autoProcessTransaction(vehicleInfo) {
            // Check for restricted access first and show alerts
            if (vehicleInfo.accessStatus === 'Banned') {
                showAccessDeniedAlert(vehicleInfo, 'BANNED', 'This vehicle is BANNED from the premises. Contact security supervisor immediately.');
                return;
            }
            
            if (vehicleInfo.accessStatus === 'No Access' && vehicleInfo.currentStatus === 'OUT') {
                showAccessDeniedAlert(vehicleInfo, 'NO ACCESS', 'This vehicle does not have access permission to enter the premises.');
                return;
            }
            
            // Auto-process transaction for continuous scanning
            setTimeout(() => {
                const gate = document.getElementById('qrGateSelect').value;
                const nextAction = vehicleInfo.currentStatus === 'IN' ? 'OUT' : 'IN';
                
                // Only auto-process if gate is selected and vehicle has access (or is going OUT)
                if (gate && (vehicleInfo.accessStatus === 'Access' || nextAction === 'OUT')) {
                    const transactionData = {
                        plateNumber: vehicleInfo.plateNumber,
                        action: nextAction,
                        gate: gate,
                        driverId: vehicleInfo.currentDriver || '',
                        remarks: 'QR Scanner auto-transaction',
                        username: currentUser.username
                    };

                    // Update status to show processing
                    const status = document.getElementById('qrScannerStatus');
                    status.textContent = `Processing ${nextAction} for ${vehicleInfo.plateNumber}...`;

                    google.script.run
                        .withSuccessHandler(function(result) {
                            if (result.success) {
                                qrScanCount++; // Increment successful scan counter
                                
                                // Calculate session performance
                                const sessionDuration = (new Date() - scanSessionStartTime) / 1000 / 60; // minutes
                                const scansPerMinute = sessionDuration > 0 ? (qrScanCount / sessionDuration).toFixed(1) : '0';
                                
                                status.textContent = `✓ Press 'Start Scanning' to initiate the next transaction.`;
                                status.style.background = 'rgba(40, 167, 69, 0.8)'; // Green background
                                
                                // Update local vehicle data for immediate UI refresh
                                updateLocalVehicleData(vehicleInfo.plateNumber, nextAction);
                                
                                // Update one-time pass status if it was disabled
                                if (result.oneTimePassUsed) {
                                    updateLocalVehicleOneTimePass(vehicleInfo.plateNumber, 'No');
                                }
                                
                                // Refresh dashboard in background
                                loadVehicles();
                                loadTransactionLogs();
                                
                                // Quick toast notification for additional feedback with one-time pass info
                                let message = `${vehicleInfo.plateNumber} ${nextAction} logged successfully`;
                                if (result.oneTimePassUsed) {
                                    message += ' - One-time pass disabled';
                                }
                                showToast(message, 'success');
                               
                                // setTimeout(() => {
                                //     resetForNextScan();
                                //     continuousScanning();
                                // }, 1200)
                            } else {
                                showQRScanError('Transaction failed: ' + result.message);
                            }
                        })
                        .withFailureHandler(function(error) {
                            showQRScanError('Error logging transaction: ' + error);
                        })
                        .logVehicleAction(transactionData);
                } else {
                    // Manual confirmation needed for restricted access
                    const nextActionText = document.getElementById('nextActionText');
                    if (vehicleInfo.accessStatus === 'No Access') {
                        nextActionText.textContent = '⚠️ NO ACCESS - Manual supervisor override required';
                        nextActionText.parentElement.className = 'alert alert-warning';
                    } else {
                        nextActionText.textContent = 'Manual confirmation required - Select action below';
                    }
                    document.getElementById('transactionForm').classList.remove('d-none');
                }
            }, 1000); // Small delay to show vehicle info
        }

        function updateLocalVehicleData(plateNumber, newStatus) {
            // Update the local vehicle data for immediate UI response
            if (vehicleData && vehicleData.length > 1) {
                for (let i = 1; i < vehicleData.length; i++) {
                    if (vehicleData[i] && vehicleData[i][1] === plateNumber) {
                        vehicleData[i][7] = newStatus; // Update status
                        break;
                    }
                }
                // Refresh the vehicle display
                displayVehicles();
                updateStatistics();
            }
        }

        function updateLocalVehicleOneTimePass(plateNumber, oneTimePassStatus) {
            // Update the one-time pass status in local vehicle data
            if (vehicleData && vehicleData.length > 1) {
                for (let i = 1; i < vehicleData.length; i++) {
                    if (vehicleData[i] && vehicleData[i][1] === plateNumber) {
                        vehicleData[i][11] = oneTimePassStatus; // Update one-time pass status at index 11
                        break;
                    }
                }
                // Refresh the vehicle display to update the OTP column
                displayVehicles();
            }
        }

        function resetForNextScan() {
            // Reset UI for next scan while keeping gate selection
            document.getElementById('noScanResult').classList.remove('d-none');
            document.getElementById('scanResultData').classList.add('d-none');
            document.getElementById('transactionForm').classList.add('d-none');
            
            // Reset status background but keep gate info
            const status = document.getElementById('qrScannerStatus');
            status.style.background = 'rgba(0, 0, 0, 0.7)';
            
            const gateSelect = document.getElementById('qrGateSelect');
            const selectedGate = gateSelect.options[gateSelect.selectedIndex]?.textContent || 'Gate';
            if (qrScanCount > 0) {
                status.textContent = `Ready for scan #${qrScanCount + 1} - Using ${selectedGate}`;
            } else {
                status.textContent = `Ready to scan - Using ${selectedGate}`;
            }
        }

        function continuousScanning() {
            // Enhanced continuous scanning without full restart
            if (qrScannerActive && qrScannerStream) {
                // Camera is still active, just resume QR detection
                if (!qrScannerAnimationFrame) {
                    qrScannerAnimationFrame = requestAnimationFrame(scanQRCode);
                }
                
                const status = document.getElementById('qrScannerStatus');
                const gateSelect = document.getElementById('qrGateSelect');
                const selectedGate = gateSelect.options[gateSelect.selectedIndex]?.textContent || 'Gate';
                if (qrScanCount > 0) {
                    status.textContent = `Press 'Start Scanning' to initiate the next transaction.`;
                } else {
                    status.textContent = `🔍 Scanning for QR code - ${selectedGate}`;
                }
            } else {
                // Camera was stopped, need to reinitialize
                console.log('Camera stream lost, reinitializing...');
                initQRScanner();
            }
        }

        function displayVehicleInfo(vehicleInfo) {
            const status = document.getElementById('qrScannerStatus');
            const noResult = document.getElementById('noScanResult');
            const scanData = document.getElementById('scanResultData');
            const transactionForm = document.getElementById('transactionForm');

            // Update UI elements
            document.getElementById('scannedPlate').textContent = vehicleInfo.plateNumber;
            document.getElementById('scannedDriver').textContent = vehicleInfo.currentDriver || 'Not assigned';
            document.getElementById('scannedDepartment').textContent = vehicleInfo.department || 'Not specified';
            
            // Set access status badge
            const accessBadge = document.getElementById('scannedAccessStatus');
            accessBadge.textContent = vehicleInfo.accessStatus;
            accessBadge.className = 'ms-2 badge ' + 
                (vehicleInfo.accessStatus === 'Access' ? 'bg-success' :
                 vehicleInfo.accessStatus === 'No Access' ? 'bg-warning' : 'bg-danger');

            // Set current status badge
            const currentBadge = document.getElementById('scannedCurrentStatus');
            currentBadge.textContent = vehicleInfo.currentStatus;
            currentBadge.className = 'ms-2 badge ' + 
                (vehicleInfo.currentStatus === 'IN' ? 'bg-primary' : 'bg-secondary');

            // Determine next action and pre-select it
            const nextAction = vehicleInfo.currentStatus === 'IN' ? 'OUT' : 'IN';
            const nextActionText = document.getElementById('nextActionText');
            
            if (vehicleInfo.accessStatus === 'Access' || nextAction === 'OUT') {
                nextActionText.textContent = `Access Granted - ${nextAction}`;
                nextActionText.parentElement.className = 'alert alert-info';
                document.getElementById(`qrAction${nextAction}`).checked = true;
                transactionForm.classList.remove('d-none');
            } else if (vehicleInfo.accessStatus === 'Banned') {
                nextActionText.textContent = '🚫 BANNED VEHICLE - Access strictly prohibited';
                nextActionText.parentElement.className = 'alert alert-danger';
                transactionForm.classList.add('d-none');
            } else if (vehicleInfo.accessStatus === 'No Access') {
                nextActionText.textContent = '⚠️ NO ACCESS - Supervisor override required';
                nextActionText.parentElement.className = 'alert alert-warning';
                // Show form but with warning
                if (nextAction === 'IN') {
                    transactionForm.classList.remove('d-none');
                    document.getElementById(`qrAction${nextAction}`).checked = true;
                } else {
                    transactionForm.classList.remove('d-none');
                    document.getElementById(`qrAction${nextAction}`).checked = true;
                }
            } else {
                nextActionText.textContent = 'Vehicle access denied - cannot enter';
                nextActionText.parentElement.className = 'alert alert-danger';
                transactionForm.classList.add('d-none');
            }

            // Show results briefly for feedback
            noResult.classList.add('d-none');
            scanData.classList.remove('d-none');
            
            // Show both vehicle ID and plate number if available
            const displayText = vehicleInfo.vehicleId ? 
                `✓ Vehicle ${vehicleInfo.vehicleId} (${vehicleInfo.plateNumber}) verified - Processing...` :
                `✓ ${vehicleInfo.plateNumber} verified - Processing...`;
            status.textContent = displayText;
            
            // Keep scanner active for continuous scanning
        }

        function showAccessDeniedAlert(vehicleInfo, alertType, message) {
            const status = document.getElementById('qrScannerStatus');
            const noResult = document.getElementById('noScanResult');
            const scanData = document.getElementById('scanResultData');
            
            // Update vehicle info display
            document.getElementById('scannedPlate').textContent = vehicleInfo.plateNumber;
            document.getElementById('scannedDriver').textContent = vehicleInfo.currentDriver || 'Not assigned';
            document.getElementById('scannedDepartment').textContent = vehicleInfo.department || 'Not specified';
            
            // Set access status badge with appropriate styling
            const accessBadge = document.getElementById('scannedAccessStatus');
            accessBadge.textContent = vehicleInfo.accessStatus;
            accessBadge.className = vehicleInfo.accessStatus === 'Banned' ? 'ms-2 badge bg-danger text-white' : 'ms-2 badge bg-warning text-dark';
            
            // Set current status badge
            const currentBadge = document.getElementById('scannedCurrentStatus');
            currentBadge.textContent = vehicleInfo.currentStatus;
            currentBadge.className = 'ms-2 badge ' + (vehicleInfo.currentStatus === 'IN' ? 'bg-primary' : 'bg-secondary');
            
            // Show critical alert message
            const nextActionText = document.getElementById('nextActionText');
            nextActionText.textContent = message;
            nextActionText.parentElement.className = alertType === 'BANNED' ? 'alert alert-danger' : 'alert alert-warning';
            
            // Hide transaction form for banned vehicles
            if (alertType === 'BANNED') {
                document.getElementById('transactionForm').classList.add('d-none');
            } else {
                document.getElementById('transactionForm').classList.remove('d-none');
            }
            
            // Show vehicle info
            noResult.classList.add('d-none');
            scanData.classList.remove('d-none');
            
            // Update status with alert and manual action instruction
            const alertIcon = alertType === 'BANNED' ? '🚫' : '⚠️';
            status.textContent = `${alertIcon} ${alertType}: ${vehicleInfo.plateNumber} - Review complete, click "Start Scanning" to continue`;
            status.style.background = alertType === 'BANNED' ? 'rgba(220, 53, 69, 0.9)' : 'rgba(255, 193, 7, 0.9)';
            
            // Show toast notification for additional alert
            showToast(`${alertIcon} ${alertType}: ${vehicleInfo.plateNumber} - ${message}`, alertType === 'BANNED' ? 'danger' : 'warning');
            
            // For restricted access vehicles, do NOT auto-continue scanning
            // User must manually click "Start Scanning" to continue after reviewing vehicle info
            // This ensures security personnel have adequate time to review restricted vehicle details
            
            // Note: Auto-continue is disabled for Banned and No Access vehicles to allow proper security review
        }
        
        function showQRScanError(message) {
            const status = document.getElementById('qrScannerStatus');
            status.textContent = `❌ ${message}`;
            status.style.background = 'rgba(220, 53, 69, 0.8)'; // Red background
            
            setTimeout(() => {
                resetForNextScan();
                // Continue scanning immediately for better UX
                continuousScanning();
            }, 1500); // Faster error recovery
        }

        // pauseResumeScanner function removed - pause button no longer exists in UI

        function stopQRScanner() {
            qrScannerActive = false;
            
            if (qrScannerAnimationFrame) {
                cancelAnimationFrame(qrScannerAnimationFrame);
                qrScannerAnimationFrame = null;
            }

            if (qrScannerStream) {
                qrScannerStream.getTracks().forEach(track => track.stop());
                qrScannerStream = null;
            }

            const video = document.getElementById('qrScannerVideo');
            if (video) {
                video.srcObject = null;
            }
            
            // Reset pause button state
            const pauseBtn = document.getElementById('pauseResumeBtn');
            if (pauseBtn) {
                pauseBtn.innerHTML = '<i class="bi bi-pause-fill me-1"></i>Pause';
                pauseBtn.className = 'btn btn-warning';
            }
        }

        // Handle QR transaction form submission
        document.addEventListener('DOMContentLoaded', function() {
            const qrForm = document.getElementById('qrTransactionForm');
            if (qrForm) {
                qrForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitQRTransaction();
                });
            }
        });

        function submitQRTransaction() {
            // Prevent multiple submissions
            if (isTransactionInProgress) {
                console.log('QR Transaction already in progress, ignoring submission');
                return;
            }
            
            // Mobile debouncing to prevent double-taps
            const currentTime = Date.now();
            const isMobile = window.innerWidth <= 767;
            if (isMobile && (currentTime - lastTransactionTime) < MOBILE_DEBOUNCE_TIME) {
                console.log('QR Mobile double-tap detected, ignoring submission');
                return;
            }
            lastTransactionTime = currentTime;

            const form = document.getElementById('qrTransactionForm');
            const plateNumber = document.getElementById('scannedPlate').textContent;
            const gate = document.getElementById('qrGateSelect').value;
            const action = document.querySelector('input[name="qrAction"]:checked')?.value;
            const driverId = document.getElementById('qrDriverId').value.trim();
            const remarks = document.getElementById('qrRemarks').value.trim();
            const accessStatus = document.getElementById('scannedAccessStatus').textContent;

            if (!gate || !action) {
                showToast('Please select gate and action', 'warning');
                return;
            }

            // Set transaction in progress for QR scanner
            setTransactionInProgress(true, -1);

            // Special handling for restricted access vehicles
            if (accessStatus === 'Banned') {
                if (!confirm(`⚠️ CRITICAL WARNING ⚠️\n\nVehicle ${plateNumber} is BANNED!\n\nThis vehicle should NOT be allowed on premises under any circumstances.\n\nAre you absolutely certain you want to proceed with this transaction?\n\n(This action will be logged with your username for audit purposes)`)) {
                    setTransactionInProgress(false); // Re-enable buttons if cancelled
                    return;
                }
            } else if (accessStatus === 'No Access' && action === 'IN') {
                if (!confirm(`⚠️ ACCESS WARNING ⚠️\n\nVehicle ${plateNumber} does not have access permission.\n\nProceeding will allow entry despite restrictions.\n\nDo you have supervisor authorization to override this restriction?\n\n(This override will be logged for security review)`)) {
                    setTransactionInProgress(false); // Re-enable buttons if cancelled
                    return;
                }
            }

            // Build transaction data with enhanced remarks for restricted access
            let enhancedRemarks = remarks || 'QR Scanner transaction';
            if (accessStatus === 'Banned') {
                enhancedRemarks = `🚨 BANNED VEHICLE OVERRIDE - ${enhancedRemarks}`;
            } else if (accessStatus === 'No Access' && action === 'IN') {
                enhancedRemarks = `⚠️ NO ACCESS OVERRIDE - ${enhancedRemarks}`;
            }

            const transactionData = {
                plateNumber: plateNumber,
                action: action,
                gate: gate,
                driverId: driverId,
                remarks: enhancedRemarks,
                username: currentUser.username
            };

            // Disable form
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="me-1" style="color: white;"><span class="bouncing-dots size-sm"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></span>Processing...';

            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        // Enhanced success message for restricted access
                        let successMessage = 'Transaction logged successfully!';
                        if (result.oneTimePassUsed) {
                            successMessage += ' One-time pass has been disabled.';
                        }
                        
                        if (accessStatus === 'Banned') {
                            successMessage = '🚨 BANNED VEHICLE transaction logged - Security audit trail created';
                            if (result.oneTimePassUsed) {
                                successMessage += ' One-time pass disabled.';
                            }
                            showToast(successMessage, 'warning');
                        } else if (accessStatus === 'No Access' && action === 'IN') {
                            successMessage = '⚠️ NO ACCESS override logged - Supervisor review required';
                            if (result.oneTimePassUsed) {
                                successMessage += ' One-time pass disabled.';
                            }
                            showToast(successMessage, 'warning');
                        } else {
                            showToast(successMessage, 'success');
                        }
                        
                        // Close modal and refresh dashboard
                        bootstrap.Modal.getInstance(document.getElementById('qrScannerModal')).hide();
                        loadVehicles();
                        loadTransactionLogs();
                    } else {
                        showToast('Transaction failed: ' + result.message, 'danger');
                    }
                    
                    // Re-enable form
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    setTransactionInProgress(false); // Re-enable all transaction buttons
                })
                .withFailureHandler(function(error) {
                    showToast('Error logging transaction: ' + error, 'danger');
                    
                    // Re-enable form
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    setTransactionInProgress(false); // Re-enable all transaction buttons
                })
                .logVehicleAction(transactionData);
        }
        

        // Transaction Logs Functions
        function loadTransactionLogs() {
            const logsBody = document.getElementById('transactionLogsBody');
            logsBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-4">
                        <div style="color: #0d6efd;">
                            <div class="bouncing-dots size-lg">
                                <span class="dot"></span>
                                <span class="dot"></span>
                                <span class="dot"></span>
                            </div>
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted mb-0">Loading transaction logs...</p>
                    </td>
                </tr>
            `;

            google.script.run
                .withSuccessHandler(displayTransactionLogs)
                .withFailureHandler(function(error) {
                    console.error('Error loading transaction logs:', error);
                    logsBody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center py-4 text-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Failed to load transaction logs
                            </td>
                        </tr>
                    `;
                })
                .getRecentTransactions(50);
        }

        function displayTransactionLogs(transactions) {
            const logsBody = document.getElementById('transactionLogsBody');
            const noTransactionsMessage = document.getElementById('noTransactionsMessage');
            const transactionCount = document.getElementById('transactionCount');

            if (!transactions || transactions.length === 0) {
                logsBody.innerHTML = '';
                logsBody.parentElement.style.display = 'none';
                noTransactionsMessage.classList.remove('d-none');
                transactionCount.textContent = '0';
                return;
            }

            logsBody.parentElement.style.display = '';
            noTransactionsMessage.classList.add('d-none');
            transactionCount.textContent = transactions.length;

            const rows = transactions.map(log => {
                const actionBadge = log.action === 'IN' 
                    ? '<span class="badge bg-success badge-sm">IN</span>' 
                    : '<span class="badge bg-danger badge-sm">OUT</span>';
                
                // Format timestamp to show date and time like "June 26, 13:30"
                let formattedDateTime = '-';
                if (log.timestamp) {
                    try {
                        const date = new Date(log.timestamp);
                        const options = { 
                            month: 'short', 
                            day: 'numeric',
                            hour: '2-digit', 
                            minute: '2-digit',
                            hour12: false
                        };
                        formattedDateTime = date.toLocaleDateString('en-US', options).replace(',', ', ');
                    } catch (e) {
                        formattedDateTime = log.timestamp;
                    }
                }

                return `
                    <tr>
                        <td style="padding: 8px 8px; font-size: 0.85rem;">${formattedDateTime}</td>
                        <td style="padding: 8px 8px; font-size: 0.85rem;" class="fw-bold">${log.plate || '-'}</td>
                        <td style="padding: 8px 8px; font-size: 0.85rem;">${log.driver || '-'}</td>
                        <td style="padding: 8px 8px; font-size: 0.85rem;">${log.gate || '-'}</td>
                        <td style="padding: 8px 8px;" class="text-center">${actionBadge}</td>
                    </tr>
                `;
            }).join('');

            logsBody.innerHTML = rows;
        }

        function refreshTransactionLogs() {
            const refreshBtn = event.target.closest('button');
            const originalContent = refreshBtn.innerHTML;
            
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<span class="me-1" style="color: white;"><span class="bouncing-dots size-sm"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></span>Refreshing...';
            
            google.script.run
                .withSuccessHandler(function(logs) {
                    displayTransactionLogs(logs);
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = originalContent;
                    
                    // Show success feedback
                    const badge = document.getElementById('transactionCount');
                    badge.classList.add('bg-success');
                    setTimeout(() => badge.classList.remove('bg-success'), 1000);
                })
                .withFailureHandler(function(error) {
                    console.error('Error refreshing logs:', error);
                    refreshBtn.disabled = false;
                    refreshBtn.innerHTML = originalContent;
                    alert('Failed to refresh transaction logs');
                })
                .getRecentTransactions(50);
        }

        // Refresh page function
        function refreshPage() {
            const refreshBtn = document.getElementById('refreshBtn');
            const icon = refreshBtn.querySelector('i');
            
            // Add spinning animation during refresh
            icon.style.animation = 'spin 1s linear infinite';
            refreshBtn.disabled = true;
            
            // Show toast to indicate refresh is happening
            showToast('Refreshing data...', 'info');
            
            // Refresh all data instead of reloading the page
            Promise.all([
                new Promise(resolve => {
                    // Reload vehicles
                    loadVehicles();
                    setTimeout(resolve, 500);
                }),
                new Promise(resolve => {
                    // Reload drivers
                    loadDrivers();
                    setTimeout(resolve, 300);
                }),
                new Promise(resolve => {
                    // Reload transaction logs
                    loadTransactionLogs();
                    setTimeout(resolve, 400);
                }),
                new Promise(resolve => {
                    // Reload statistics
                    loadDatabaseStatistics();
                    setTimeout(resolve, 200);
                }),
                new Promise(resolve => {
                    // Reload gates
                    loadActiveGates();
                    setTimeout(resolve, 100);
                })
            ]).then(() => {
                // Reset button state
                icon.style.animation = '';
                refreshBtn.disabled = false;
                showToast('Data refreshed successfully!', 'success');
            }).catch((error) => {
                console.error('Error during refresh:', error);
                icon.style.animation = '';
                refreshBtn.disabled = false;
                showToast('Error refreshing data', 'danger');
            });
        }
        
        // Apply role-based field restrictions for security users
        function applySecurityRoleRestrictions() {
            if (!currentUser || currentUser.role !== 'security') {
                return; // No restrictions for non-security users
            }
            
            // Make MV File Number read-only for security users
            const mvFileInput = document.getElementById('editMVFile');
            if (mvFileInput) {
                mvFileInput.readOnly = true;
                mvFileInput.style.backgroundColor = '#f8f9fa';
                mvFileInput.style.cursor = 'not-allowed';
                mvFileInput.title = '';
            }
            
            // Make Authorized Drivers read-only for security users
            const assignedDriversContainer = document.getElementById('editAssignedDriversContainer');
            if (assignedDriversContainer) {
                // Disable all checkboxes in the container
                const checkboxes = assignedDriversContainer.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.disabled = true;
                    checkbox.style.cursor = 'not-allowed';
                });
                
                // Add visual indication
                assignedDriversContainer.style.backgroundColor = '#f8f9fa';
                assignedDriversContainer.style.border = '1px solid #dee2e6';
                assignedDriversContainer.title = '';
                
            }
            
            // Make Allowed Gates read-only for security users
            const allowedGatesContainer = document.getElementById('editAllowedGatesContainer');
            if (allowedGatesContainer) {
                // Disable all checkboxes in the container
                const gateCheckboxes = allowedGatesContainer.querySelectorAll('input[type="checkbox"]');
                gateCheckboxes.forEach(checkbox => {
                    checkbox.disabled = true;
                    checkbox.style.cursor = 'not-allowed';
                });
                
                // Add visual indication
                allowedGatesContainer.style.backgroundColor = '#f8f9fa';
                allowedGatesContainer.style.border = '1px solid #dee2e6';
                allowedGatesContainer.title = 'Gate access control is read-only for security role';
                
                // Update section header to show read-only status
                const gateSection = allowedGatesContainer.closest('.form-section');
                if (gateSection) {
                    const gateSectionHeader = gateSection.querySelector('h6');
                    if (gateSectionHeader) {
                        gateSectionHeader.innerHTML = '<i class="bi bi-door-open me-2"></i>Gate Access Control <small class="text-muted ms-2">(Read-Only for Security)</small>';
                    }
                }
            }
            
            // Current Driver remains editable for security users (no restrictions)
            console.log('Applied security role restrictions to edit form');
        }
        
        // Add spin animation for refresh button
        const refreshStyle = document.createElement('style');
        refreshStyle.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(refreshStyle);
        
        // Mobile-specific touch event handling for fullscreen toolbar
        document.addEventListener('DOMContentLoaded', function() {
            // Check if login page is visible on initial load
            const loginPage = document.getElementById('loginPage');
            if (loginPage && !loginPage.classList.contains('hidden')) {
                document.body.classList.add('login-active');
            }
            
            // Ensure fullscreen toolbar buttons work on mobile
            const focusModeBtn = document.getElementById('focusModeBtn');
            if (focusModeBtn) {
                // Add touch event support
                focusModeBtn.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    toggleFocusMode();
                }, { passive: false });
            }
            
            // Fix for mobile button overlap - ensure proper z-index
            const style = document.createElement('style');
            style.textContent = `
                @media (max-width: 768px) {
                    /* Ensure buttons don't overlap and have proper touch targets */
                    .qr-scanner-btn,
                    .refresh-btn,
                    .add-vehicle-btn {
                        min-width: 50px;
                        min-height: 50px;
                        touch-action: manipulation; /* Prevent double-tap zoom */
                    }
                    
                    /* Ensure fullscreen toolbar is accessible */
                    .fullscreen-mode .fullscreen-toolbar {
                        z-index: 9999;
                    }
                }
            `;
            document.head.appendChild(style);
        });
    </script>
</body>
</html>
