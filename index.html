<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
      .vehicle-card {
        transition: transform 0.2s;
        cursor: pointer;
      }
      .vehicle-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      }
      .status-in {
        background-color: #28a745;
        color: white;
      }
      .status-out {
        background-color: #dc3545;
        color: white;
      }
      .loading-spinner {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
      }
      .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      .filter-section {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
      }
    </style>
    <script>
      let vehicleData = [];
      let driverData = [];
      let userRole = '';

      window.onload = function() {
        userRole = sessionStorage.getItem('userRole') || 'user';
        document.getElementById('userRole').textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1);
        loadDashboard();
      };

      function loadDashboard() {
        showLoading(true);
        Promise.all([
          new Promise((resolve) => {
            google.script.run.withSuccessHandler(resolve).getVehicleList();
          }),
          new Promise((resolve) => {
            google.script.run.withSuccessHandler(resolve).getDriverList();
          })
        ]).then(([vehicles, drivers]) => {
          vehicleData = vehicles;
          driverData = drivers;
          displayVehicles();
          updateStatistics();
          showLoading(false);
        }).catch(error => {
          showError('Failed to load data: ' + error);
          showLoading(false);
        });
      }

      function displayVehicles() {
        const container = document.getElementById('vehicleContainer');
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const filterStatus = document.getElementById('filterStatus').value;
        
        container.innerHTML = '';
        
        for (let i = 1; i < vehicleData.length; i++) {
          const vehicle = vehicleData[i];
          const plateNumber = vehicle[0];
          const model = vehicle[1];
          const status = vehicle[4] || 'OUT';
          const driver = vehicle[5] || 'Unassigned';
          
          // Apply filters
          if (searchTerm && !plateNumber.toLowerCase().includes(searchTerm) && 
              !model.toLowerCase().includes(searchTerm)) {
            continue;
          }
          
          if (filterStatus && filterStatus !== status) {
            continue;
          }
          
          const card = createVehicleCard(plateNumber, model, status, driver, i);
          container.appendChild(card);
        }
      }

      function createVehicleCard(plateNumber, model, status, driver, index) {
        const col = document.createElement('div');
        col.className = 'col-md-4 mb-4';
        
        col.innerHTML = `
          <div class="card vehicle-card h-100" onclick="showVehicleDetails(${index})">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <h5 class="card-title mb-0">${plateNumber}</h5>
                <span class="badge ${status === 'IN' ? 'status-in' : 'status-out'}">${status}</span>
              </div>
              <p class="card-text">
                <i class="bi bi-truck me-2"></i>${model}<br>
                <i class="bi bi-person-fill me-2"></i>${driver}
              </p>
              <div class="mt-3">
                <button class="btn btn-sm ${status === 'IN' ? 'btn-danger' : 'btn-success'}" 
                        onclick="event.stopPropagation(); toggleVehicleStatus(${index})">
                  <i class="bi ${status === 'IN' ? 'bi-box-arrow-right' : 'bi-box-arrow-in-left'} me-1"></i>
                  ${status === 'IN' ? 'Check Out' : 'Check In'}
                </button>
                ${userRole === 'admin' ? `
                  <button class="btn btn-sm btn-warning ms-2" onclick="event.stopPropagation(); editVehicle(${index})">
                    <i class="bi bi-pencil"></i>
                  </button>
                ` : ''}
              </div>
            </div>
          </div>
        `;
        
        return col;
      }

      function toggleVehicleStatus(index) {
        const vehicle = vehicleData[index];
        const currentStatus = vehicle[4] || 'OUT';
        const newStatus = currentStatus === 'IN' ? 'OUT' : 'IN';
        
        const gate = prompt('Enter gate number/name:');
        if (!gate) return;
        
        const logData = {
          plateNumber: vehicle[0],
          driverId: vehicle[5] || 'Unknown',
          action: newStatus,
          gate: gate,
          remarks: ''
        };
        
        showLoading(true);
        google.script.run.withSuccessHandler(function(success) {
          if (success) {
            vehicleData[index][4] = newStatus;
            displayVehicles();
            updateStatistics();
            showSuccess(`Vehicle ${newStatus === 'IN' ? 'checked in' : 'checked out'} successfully!`);
          }
          showLoading(false);
        }).logVehicleAction(logData);
      }

      function showVehicleDetails(index) {
        const vehicle = vehicleData[index];
        const modal = new bootstrap.Modal(document.getElementById('vehicleModal'));
        
        document.getElementById('modalTitle').textContent = vehicle[0];
        document.getElementById('modalBody').innerHTML = `
          <table class="table">
            <tr><th>Model</th><td>${vehicle[1]}</td></tr>
            <tr><th>Year</th><td>${vehicle[2]}</td></tr>
            <tr><th>Type</th><td>${vehicle[3]}</td></tr>
            <tr><th>Status</th><td><span class="badge ${vehicle[4] === 'IN' ? 'status-in' : 'status-out'}">${vehicle[4] || 'OUT'}</span></td></tr>
            <tr><th>Current Driver</th><td>${vehicle[5] || 'Unassigned'}</td></tr>
            <tr><th>Assigned Drivers</th><td>${vehicle[6] || 'None'}</td></tr>
          </table>
        `;
        
        modal.show();
      }

      function editVehicle(index) {
        if (userRole !== 'admin') {
          showError('Only administrators can edit vehicle records.');
          return;
        }
        
        const vehicle = vehicleData[index];
        const newDriver = prompt('Enter new driver ID:', vehicle[5] || '');
        
        if (newDriver !== null) {
          const updatedData = [...vehicle];
          updatedData[5] = newDriver;
          
          showLoading(true);
          google.script.run.withSuccessHandler(function(success) {
            if (success) {
              vehicleData[index] = updatedData;
              displayVehicles();
              showSuccess('Vehicle updated successfully!');
            }
            showLoading(false);
          }).withFailureHandler(function(error) {
            showError(error.message);
            showLoading(false);
          }).updateVehicleRecord(index, updatedData, userRole);
        }
      }

      function updateStatistics() {
        let totalVehicles = vehicleData.length - 1;
        let vehiclesIn = 0;
        let vehiclesOut = 0;
        
        for (let i = 1; i < vehicleData.length; i++) {
          if (vehicleData[i][4] === 'IN') {
            vehiclesIn++;
          } else {
            vehiclesOut++;
          }
        }
        
        document.getElementById('totalVehicles').textContent = totalVehicles;
        document.getElementById('vehiclesIn').textContent = vehiclesIn;
        document.getElementById('vehiclesOut').textContent = vehiclesOut;
      }

      function showLoading(show) {
        document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
      }

      function showError(message) {
        showToast(message, 'danger');
      }

      function showSuccess(message) {
        showToast(message, 'success');
      }

      function showToast(message, type) {
        const toastContainer = document.getElementById('toastContainer');
        const toastId = 'toast-' + Date.now();
        
        const toastHtml = `
          <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
              <div class="toast-body">
                ${message}
              </div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
          </div>
        `;
        
        toastContainer.innerHTML += toastHtml;
        const toast = new bootstrap.Toast(document.getElementById(toastId));
        toast.show();
        
        setTimeout(() => {
          document.getElementById(toastId).remove();
        }, 5000);
      }

      function logout() {
        sessionStorage.removeItem('userRole');
        google.script.run.withSuccessHandler(function(html) {
          document.open();
          document.write(html);
          document.close();
        }).doGet();
      }

      function refreshData() {
        loadDashboard();
      }

      function goToVehicleList() {
        google.script.run.withSuccessHandler(function(html) {
          document.open();
          document.write(html);
          document.close();
        }).loadVehicleList();
      }
    </script>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <i class="bi bi-truck me-2"></i>Vehicle Monitoring System
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link active" href="#">
                <i class="bi bi-speedometer2 me-1"></i>Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="goToVehicleList(); return false;">
                <i class="bi bi-list-ul me-1"></i>Vehicle Master
              </a>
            </li>
          </ul>
          <div class="navbar-nav">
            <span class="navbar-text me-3">
              <i class="bi bi-person-circle me-1"></i>Role: <span id="userRole"></span>
            </span>
            <button class="btn btn-outline-light btn-sm" onclick="logout()">
              <i class="bi bi-box-arrow-right me-1"></i>Logout
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Container -->
    <div class="container-fluid py-4">
      <!-- Statistics Cards -->
      <div class="row mb-4">
        <div class="col-md-4">
          <div class="card stats-card">
            <div class="card-body text-center">
              <h3 class="mb-0" id="totalVehicles">0</h3>
              <p class="mb-0">Total Vehicles</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card bg-success text-white">
            <div class="card-body text-center">
              <h3 class="mb-0" id="vehiclesIn">0</h3>
              <p class="mb-0">Vehicles In</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card bg-danger text-white">
            <div class="card-body text-center">
              <h3 class="mb-0" id="vehiclesOut">0</h3>
              <p class="mb-0">Vehicles Out</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Filter Section -->
      <div class="filter-section">
        <div class="row align-items-end">
          <div class="col-md-4">
            <label class="form-label">Search</label>
            <input type="text" class="form-control" id="searchInput" placeholder="Search by plate or model..." onkeyup="displayVehicles()">
          </div>
          <div class="col-md-3">
            <label class="form-label">Filter by Status</label>
            <select class="form-select" id="filterStatus" onchange="displayVehicles()">
              <option value="">All</option>
              <option value="IN">In</option>
              <option value="OUT">Out</option>
            </select>
          </div>
          <div class="col-md-5 text-end">
            <button class="btn btn-primary" onclick="refreshData()">
              <i class="bi bi-arrow-clockwise me-1"></i>Refresh
            </button>
          </div>
        </div>
      </div>

      <!-- Vehicle Cards -->
      <div class="row" id="vehicleContainer">
        <!-- Vehicle cards will be loaded here -->
      </div>
    </div>

    <!-- Vehicle Details Modal -->
    <div class="modal fade" id="vehicleModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="modalBody">
            <!-- Vehicle details will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
      <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer">
      <!-- Toasts will be added here -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>