<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <style>
      .status-badge-in {
        background-color: #28a745;
        color: white;
      }
      .status-badge-out {
        background-color: #dc3545;
        color: white;
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      }
      .action-buttons .btn {
        margin: 0 2px;
      }
      .table-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 0 15px rgba(0,0,0,0.1);
      }
      .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 30px;
      }
    </style>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script>
      let vehicleData = [];
      let userRole = '';
      let dataTable = null;

      window.onload = function() {
        userRole = sessionStorage.getItem('userRole') || 'user';
        document.getElementById('userRole').textContent = userRole.charAt(0).toUpperCase() + userRole.slice(1);
        
        // Show/hide admin features
        if (userRole === 'admin') {
          document.getElementById('addVehicleBtn').style.display = 'inline-block';
        }
        
        loadVehicleData();
      };

      function loadVehicleData() {
        showLoading(true);
        google.script.run.withSuccessHandler(function(data) {
          vehicleData = data;
          displayVehicleTable();
          showLoading(false);
        }).withFailureHandler(function(error) {
          showError('Failed to load vehicle data: ' + error);
          showLoading(false);
        }).getVehicleList();
      }

      function displayVehicleTable() {
        const tbody = document.getElementById('vehicleTableBody');
        tbody.innerHTML = '';
        
        for (let i = 1; i < vehicleData.length; i++) {
          const vehicle = vehicleData[i];
          const row = createTableRow(vehicle, i);
          tbody.appendChild(row);
        }
        
        // Initialize DataTable
        if (dataTable) {
          dataTable.destroy();
        }
        
        dataTable = $('#vehicleTable').DataTable({
          pageLength: 25,
          responsive: true,
          order: [[0, 'asc']],
          columnDefs: [
            { targets: -1, orderable: false } // Disable sorting for actions column
          ],
          language: {
            search: "Search vehicles:",
            lengthMenu: "Show _MENU_ vehicles per page",
            info: "Showing _START_ to _END_ of _TOTAL_ vehicles",
            paginate: {
              first: "First",
              last: "Last",
              next: "Next",
              previous: "Previous"
            }
          }
        });
      }

      function createTableRow(vehicle, index) {
        const tr = document.createElement('tr');
        const status = vehicle[4] || 'OUT';
        const statusClass = status === 'IN' ? 'status-badge-in' : 'status-badge-out';
        
        tr.innerHTML = `
          <td>${vehicle[0] || ''}</td>
          <td>${vehicle[1] || ''}</td>
          <td>${vehicle[2] || ''}</td>
          <td>${vehicle[3] || ''}</td>
          <td><span class="badge ${statusClass}">${status}</span></td>
          <td>${vehicle[5] || 'Unassigned'}</td>
          <td>${vehicle[6] || 'None'}</td>
          <td class="action-buttons">
            <button class="btn btn-sm btn-info" onclick="viewVehicleDetails(${index})" title="View Details">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-sm ${status === 'IN' ? 'btn-danger' : 'btn-success'}" 
                    onclick="toggleVehicleStatus(${index})" 
                    title="${status === 'IN' ? 'Check Out' : 'Check In'}">
              <i class="bi ${status === 'IN' ? 'bi-box-arrow-right' : 'bi-box-arrow-in-left'}"></i>
            </button>
            ${userRole === 'admin' ? `
              <button class="btn btn-sm btn-warning" onclick="editVehicle(${index})" title="Edit">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteVehicle(${index})" title="Delete">
                <i class="bi bi-trash"></i>
              </button>
            ` : ''}
          </td>
        `;
        
        return tr;
      }

      function viewVehicleDetails(index) {
        const vehicle = vehicleData[index];
        const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
        
        document.getElementById('detailsModalTitle').textContent = 'Vehicle Details - ' + vehicle[0];
        document.getElementById('detailsModalBody').innerHTML = `
          <table class="table table-striped">
            <tr><th width="40%">Plate Number</th><td>${vehicle[0] || ''}</td></tr>
            <tr><th>Model</th><td>${vehicle[1] || ''}</td></tr>
            <tr><th>Year</th><td>${vehicle[2] || ''}</td></tr>
            <tr><th>Type</th><td>${vehicle[3] || ''}</td></tr>
            <tr><th>Status</th><td><span class="badge ${vehicle[4] === 'IN' ? 'status-badge-in' : 'status-badge-out'}">${vehicle[4] || 'OUT'}</span></td></tr>
            <tr><th>Current Driver</th><td>${vehicle[5] || 'Unassigned'}</td></tr>
            <tr><th>Assigned Drivers</th><td>${vehicle[6] || 'None'}</td></tr>
          </table>
        `;
        
        modal.show();
      }

      function toggleVehicleStatus(index) {
        const vehicle = vehicleData[index];
        const currentStatus = vehicle[4] || 'OUT';
        const newStatus = currentStatus === 'IN' ? 'OUT' : 'IN';
        
        const modal = new bootstrap.Modal(document.getElementById('checkInOutModal'));
        document.getElementById('checkInOutTitle').textContent = `${newStatus === 'IN' ? 'Check In' : 'Check Out'} Vehicle`;
        document.getElementById('vehicleInfo').textContent = `${vehicle[0]} - ${vehicle[1]}`;
        document.getElementById('actionType').value = newStatus;
        document.getElementById('vehicleIndex').value = index;
        
        // Clear form
        document.getElementById('gateNumber').value = '';
        document.getElementById('remarks').value = '';
        
        modal.show();
      }

      function submitCheckInOut() {
        const index = parseInt(document.getElementById('vehicleIndex').value);
        const vehicle = vehicleData[index];
        const gate = document.getElementById('gateNumber').value;
        const remarks = document.getElementById('remarks').value;
        const action = document.getElementById('actionType').value;
        
        if (!gate) {
          showError('Please enter gate number');
          return;
        }
        
        const logData = {
          plateNumber: vehicle[0],
          driverId: vehicle[5] || 'Unknown',
          action: action,
          gate: gate,
          remarks: remarks
        };
        
        showLoading(true);
        google.script.run.withSuccessHandler(function(success) {
          if (success) {
            vehicleData[index][4] = action;
            displayVehicleTable();
            bootstrap.Modal.getInstance(document.getElementById('checkInOutModal')).hide();
            showSuccess(`Vehicle ${action === 'IN' ? 'checked in' : 'checked out'} successfully!`);
          }
          showLoading(false);
        }).withFailureHandler(function(error) {
          showError('Failed to update vehicle status: ' + error);
          showLoading(false);
        }).logVehicleAction(logData);
      }

      function editVehicle(index) {
        if (userRole !== 'admin') {
          showError('Only administrators can edit vehicles');
          return;
        }
        
        const vehicle = vehicleData[index];
        const modal = new bootstrap.Modal(document.getElementById('editModal'));
        
        // Populate form
        document.getElementById('editIndex').value = index;
        document.getElementById('editPlateNumber').value = vehicle[0] || '';
        document.getElementById('editModel').value = vehicle[1] || '';
        document.getElementById('editYear').value = vehicle[2] || '';
        document.getElementById('editType').value = vehicle[3] || '';
        document.getElementById('editCurrentDriver').value = vehicle[5] || '';
        document.getElementById('editAssignedDrivers').value = vehicle[6] || '';
        
        modal.show();
      }

      function saveVehicleEdit() {
        const index = parseInt(document.getElementById('editIndex').value);
        const plateNumber = document.getElementById('editPlateNumber').value.trim();
        
        if (!plateNumber) {
          showError('Plate number is required');
          return;
        }
        
        const updatedData = [
          plateNumber,
          document.getElementById('editModel').value,
          document.getElementById('editYear').value,
          document.getElementById('editType').value,
          index === -1 ? 'OUT' : vehicleData[index][4], // New vehicles start as OUT
          document.getElementById('editCurrentDriver').value,
          document.getElementById('editAssignedDrivers').value
        ];
        
        showLoading(true);
        google.script.run.withSuccessHandler(function(success) {
          if (success) {
            vehicleData[index] = updatedData;
            displayVehicleTable();
            bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
            showSuccess('Vehicle updated successfully!');
          }
          showLoading(false);
        }).withFailureHandler(function(error) {
          showError('Failed to update vehicle: ' + error);
          showLoading(false);
        }).updateVehicleRecord(index, updatedData, userRole);
      }

      function deleteVehicle(index) {
        if (userRole !== 'admin') {
          showError('Only administrators can delete vehicles');
          return;
        }
        
        const vehicle = vehicleData[index];
        if (confirm(`Are you sure you want to delete vehicle ${vehicle[0]}?`)) {
          showError('Delete functionality not implemented in backend');
          // TODO: Implement delete in Google Apps Script
        }
      }

      function addNewVehicle() {
        if (userRole !== 'admin') {
          showError('Only administrators can add vehicles');
          return;
        }
        
        // Clear form and show edit modal for new vehicle
        document.getElementById('editIndex').value = -1;
        document.getElementById('editPlateNumber').value = '';
        document.getElementById('editModel').value = '';
        document.getElementById('editYear').value = '';
        document.getElementById('editType').value = '';
        document.getElementById('editCurrentDriver').value = '';
        document.getElementById('editAssignedDrivers').value = '';
        
        const modal = new bootstrap.Modal(document.getElementById('editModal'));
        modal.show();
      }

      function exportToCSV() {
        let csv = 'Plate Number,Model,Year,Type,Status,Current Driver,Assigned Drivers\n';
        
        for (let i = 1; i < vehicleData.length; i++) {
          const vehicle = vehicleData[i];
          csv += `"${vehicle[0] || ''}","${vehicle[1] || ''}","${vehicle[2] || ''}","${vehicle[3] || ''}","${vehicle[4] || 'OUT'}","${vehicle[5] || ''}","${vehicle[6] || ''}"\n`;
        }
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('href', url);
        a.setAttribute('download', 'vehicle_master_' + new Date().toISOString().split('T')[0] + '.csv');
        a.click();
      }

      function showLoading(show) {
        document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
      }

      function showError(message) {
        showToast(message, 'danger');
      }

      function showSuccess(message) {
        showToast(message, 'success');
      }

      function showToast(message, type) {
        const toastContainer = document.getElementById('toastContainer');
        const toastId = 'toast-' + Date.now();
        
        const toastHtml = `
          <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert">
            <div class="d-flex">
              <div class="toast-body">${message}</div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
          </div>
        `;
        
        toastContainer.innerHTML += toastHtml;
        const toast = new bootstrap.Toast(document.getElementById(toastId));
        toast.show();
        
        setTimeout(() => {
          document.getElementById(toastId)?.remove();
        }, 5000);
      }

      function goToDashboard() {
        google.script.run.withSuccessHandler(function(html) {
          document.open();
          document.write(html);
          document.close();
        }).loadIndex();
      }

      function logout() {
        sessionStorage.removeItem('userRole');
        google.script.run.withSuccessHandler(function(html) {
          document.open();
          document.write(html);
          document.close();
        }).doGet();
      }
    </script>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <i class="bi bi-truck me-2"></i>Vehicle Monitoring System
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link" href="#" onclick="goToDashboard(); return false;">
                <i class="bi bi-speedometer2 me-1"></i>Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="#">
                <i class="bi bi-list-ul me-1"></i>Vehicle Master
              </a>
            </li>
          </ul>
          <div class="navbar-nav">
            <span class="navbar-text me-3">
              <i class="bi bi-person-circle me-1"></i>Role: <span id="userRole"></span>
            </span>
            <button class="btn btn-outline-light btn-sm" onclick="logout()">
              <i class="bi bi-box-arrow-right me-1"></i>Logout
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Container -->
    <div class="container-fluid py-4">
      <!-- Page Header -->
      <div class="page-header">
        <div class="row align-items-center">
          <div class="col">
            <h2 class="mb-0">
              <i class="bi bi-list-ul me-2"></i>Vehicle Master List
            </h2>
            <p class="mb-0 mt-2">Manage and view all vehicles in the system</p>
          </div>
          <div class="col-auto">
            <button class="btn btn-light" onclick="exportToCSV()">
              <i class="bi bi-download me-1"></i>Export CSV
            </button>
            <button class="btn btn-success ms-2" onclick="addNewVehicle()" id="addVehicleBtn" style="display: none;">
              <i class="bi bi-plus-circle me-1"></i>Add Vehicle
            </button>
          </div>
        </div>
      </div>

      <!-- Table Container -->
      <div class="table-container">
        <table id="vehicleTable" class="table table-striped table-hover">
          <thead>
            <tr>
              <th>Plate Number</th>
              <th>Model</th>
              <th>Year</th>
              <th>Type</th>
              <th>Status</th>
              <th>Current Driver</th>
              <th>Assigned Drivers</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="vehicleTableBody">
            <!-- Table rows will be populated here -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Vehicle Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="detailsModalTitle">Vehicle Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="detailsModalBody">
            <!-- Details will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Check In/Out Modal -->
    <div class="modal fade" id="checkInOutModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="checkInOutTitle">Check In/Out Vehicle</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="vehicleIndex">
            <input type="hidden" id="actionType">
            
            <div class="mb-3">
              <label class="form-label">Vehicle</label>
              <p class="form-control-plaintext" id="vehicleInfo"></p>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Gate Number/Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="gateNumber" required>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Remarks (Optional)</label>
              <textarea class="form-control" id="remarks" rows="3"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="submitCheckInOut()">Submit</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Vehicle Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Vehicle</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editIndex">
            
            <div class="mb-3">
              <label class="form-label">Plate Number <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="editPlateNumber" required>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Model</label>
              <input type="text" class="form-control" id="editModel">
            </div>
            
            <div class="mb-3">
              <label class="form-label">Year</label>
              <input type="text" class="form-control" id="editYear">
            </div>
            
            <div class="mb-3">
              <label class="form-label">Type</label>
              <select class="form-select" id="editType">
                <option value="">Select Type</option>
                <option value="Car">Car</option>
                <option value="Truck">Truck</option>
                <option value="Van">Van</option>
                <option value="Bus">Bus</option>
                <option value="Motorcycle">Motorcycle</option>
                <option value="Other">Other</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label class="form-label">Current Driver</label>
              <input type="text" class="form-control" id="editCurrentDriver">
            </div>
            
            <div class="mb-3">
              <label class="form-label">Assigned Drivers</label>
              <input type="text" class="form-control" id="editAssignedDrivers" 
                     placeholder="Comma-separated driver IDs">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveVehicleEdit()">Save Changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
      <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>